<!DOCTYPE html>
<html lang="en">
<!-- 
========================================
ADMIN MANAGEMENT SYSTEM - FRONTEND
========================================

This file contains the complete frontend interface for the Admin Management System.
It provides a comprehensive dashboard for managing compliance-related modules:

MODULES INCLUDED:
- Assessments: Create and manage security/compliance assessments
- Risks: Risk identification, assessment, and management
- Assets: IT asset inventory and management
- Controls: Compliance controls management
- DPIAs: Data Protection Impact Assessments

KEY FEATURES:
- Mobile-first responsive design
- Real-time Wix database integration
- Multi-module navigation with tabs
- Status-based filtering (Draft/Published/Assigned)
- User assignment with modal interface
- Toast notifications for user feedback
- Form validation and error handling

ARCHITECTURE:
- Frontend: This HTML file with embedded CSS and JavaScript
- Backend: wix.js file handles all database operations
- Communication: PostMessage API between frontend and Wix backend
- Database: Wix Data collections for each module
- UI Framework: Bootstrap 5 for responsive design

DATA FLOW:
1. User interacts with forms and buttons
2. JavaScript validates and collects data
3. sendToWixDatabase() sends postMessage to Wix
4. wix.js receives message and performs database operations
5. Database response sent back to update UI
6. Local arrays updated for immediate UI feedback

MOBILE OPTIMIZATION:
- Touch-friendly button sizes (44px minimum)
- Fixed bottom action buttons
- Responsive breakpoints for different screen sizes
- Optimized form inputs to prevent zoom on iOS
- Smooth scrolling and touch feedback

========================================
-->
<head>
    <!-- ========================================
         DOCUMENT HEAD AND META CONFIGURATION
         ======================================== -->
    <meta charset="UTF-8">
    <!-- Viewport meta tag optimized for mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Assessment Management System</title>

    <!-- Bootstrap 5 CSS Framework for responsive design and components -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for icons (loaded via CDN in body) -->

    <style>
        /* ========================================
           CUSTOM CSS STYLES
           Mobile-first responsive design approach
           ======================================== */

        /* Universal box-sizing for consistent layout */
        * {
            box-sizing: border-box;
        }

        /* ========================================
           BASE STYLES AND TYPOGRAPHY
           ======================================== */

        body {
            font-size: 14px;                           /* Base font size for mobile readability */
            line-height: 1.4;                          /* Comfortable line spacing */
            -webkit-font-smoothing: antialiased;       /* Smooth fonts on WebKit browsers */
            -moz-osx-font-smoothing: grayscale;        /* Smooth fonts on Firefox/Mac */
        }

        .container {
            padding-left: 10px;                        /* Reduced padding for mobile */
            padding-right: 10px;
        }

        h1 {
            font-size: 1.5rem;                         /* Mobile-friendly heading size */
            margin-bottom: 1rem;
        }

        /* ========================================
           FORM AND CONTENT CONTAINERS
           ======================================== */

        .question-container {
            border: 1px solid #ddd;                    /* Light border for definition */
            padding: 12px;                             /* Comfortable padding */
            margin: 8px 0;                             /* Vertical spacing */
            border-radius: 8px;                        /* Rounded corners */
            background: #fff;                          /* White background */
        }

        .answer-option {
            margin: 8px 0;                             /* Vertical spacing between options */
            padding: 8px;                              /* Internal padding */
            border: 1px solid #eee;                    /* Subtle border */
            border-radius: 6px;                        /* Rounded corners */
            background: #fafafa;                       /* Light background */
        }

        /* Utility class to hide elements */
        .hidden {
            display: none !important;
        }

        /* ========================================
           MOBILE-OPTIMIZED ACTION BUTTONS
           Fixed bottom bar for primary actions
           ======================================== */

        .action-buttons {
            position: fixed;                           /* Fixed to bottom of screen */
            bottom: 0;                                 /* Stick to bottom */
            left: 0;                                   /* Full width */
            right: 0;
            background: white;                         /* White background */
            padding: 10px;                             /* Internal padding */
            box-shadow: 0 -3px 15px rgba(0,0,0,0.15); /* Shadow above */
            z-index: 1000;                             /* Above other content */
            border-top: 1px solid #dee2e6;            /* Top border for separation */
        }

        .content-wrapper {
            margin-bottom: 100px;
            padding-bottom: 20px;
        }

        /* Add Question button positioned at top right */
        .add-question-btn {
            position: static;
            border-radius: 6px;
            padding: 8px 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            margin-left: auto;
        }

        /* Mobile-optimized assessment cards */
        .assessment-card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }

        .assessment-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .assessment-status {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-draft {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-published {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-assigned {
            background-color: #d4edda;
            color: #155724;
        }

        /* Mobile-optimized button groups */
        .btn-group .btn.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        /* Toast notifications for mobile */
        .toast-container {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1050;
        }

        .toast {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .container {
                padding-left: 8px;
                padding-right: 8px;
            }

            h1 {
                font-size: 1.3rem;
                text-align: center;
            }

            /* Stack filter buttons vertically on mobile */
            .btn-group {
                flex-direction: column;
                gap: 8px;
            }

            .btn-group .btn {
                border-radius: 8px !important;
                padding: 12px;
                font-size: 0.9rem;
                font-weight: 500;
            }

            /* Mobile assessment cards */
            .assessment-card {
                padding: 12px;
                margin-bottom: 10px;
                border-radius: 10px;
            }

            .assessment-card h5 {
                font-size: 1rem;
                margin-bottom: 8px;
            }

            .assessment-card p {
                font-size: 0.85rem;
                margin-bottom: 10px;
            }

            /* Mobile action buttons in cards */
            .action-buttons-inline {
                display: flex;
                flex-direction: column;
                gap: 6px;
                width: 100%;
                margin-top: 10px;
            }

            .action-buttons-inline .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
                border-radius: 6px;
                width: 100%;
            }

            /* Mobile form optimization */
            .form-control, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                border-radius: 8px;
            }

            .form-label {
                font-weight: 600;
                margin-bottom: 6px;
                font-size: 0.9rem;
            }

            /* Mobile modal optimization */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100vw - 20px);
            }

            .modal-body {
                padding: 15px;
            }

            .members-list {
                max-height: 300px !important;
            }

            .list-group-item {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 4px;
            }

            /* Mobile create button */
            .btn-primary.mb-4 {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
                font-weight: 600;
                border-radius: 8px;
            }

            /* Mobile action buttons at bottom */
            .action-buttons .btn {
                font-size: 0.85rem;
                padding: 10px 8px;
                border-radius: 6px;
            }

            .action-buttons .row {
                gap: 8px;
            }

            .action-buttons .col {
                flex: 1;
                min-width: 0;
            }
        }

        /* Extra small devices */
        @media (max-width: 576px) {
            .container {
                padding-left: 5px;
                padding-right: 5px;
            }

            .assessment-card {
                padding: 10px;
                margin-bottom: 8px;
            }

            .btn-group .btn {
                padding: 10px;
                font-size: 0.85rem;
            }

            .action-buttons {
                padding: 8px;
            }

            .action-buttons .btn {
                font-size: 0.8rem;
                padding: 8px 6px;
            }

            .add-question-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }

        /* Touch-friendly interactions */
        .btn, .form-control, .form-select, .list-group-item {
            min-height: 44px; /* Apple's recommended touch target size */
        }

        .btn:active {
            transform: scale(0.95);
        }

        /* Improved scrolling on mobile */
        .members-list {
            -webkit-overflow-scrolling: touch;
        }

        /* Loading states */
        .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        /* Badge optimization for mobile */
        .badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 8px;
        }

        /* Module content styling */
        .module-content {
            display: block;
        }

        .module-content.hidden {
            display: none !important;
        }

        /* Module navigation styling */
        .btn-group .btn-outline-primary.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        /* Logo styles for reports */
        .report-logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .report-logo-image {
            max-height: 120px;
            max-width: 300px;
            height: auto;
            width: auto;
        }
    </style>
</head>
<body>
    <!-- ========================================
         MAIN APPLICATION CONTAINER
         ======================================== -->
    <div class="container mt-4">
        <div class="content-wrapper">
            <!-- Main application title -->
            <h1 class="mb-4">Admin Management System</h1>

            <!-- ========================================
                 MODULE NAVIGATION TABS
                 Horizontal tabs to switch between different modules
                 ======================================== -->
            <div class="row mb-4">
                <div class="col-12">
                    <!-- Button group for module navigation -->
                    <div class="btn-group w-100" role="group" aria-label="Module navigation">
                        <!-- Assessments tab - active by default -->
                        <button type="button" class="btn btn-outline-primary active" id="assessmentsTab" onclick="showModule('assessments')">
                            <i class="fas fa-clipboard-list"></i>
                            <!-- Text hidden on small screens, shown on larger screens -->
                            <span class="d-none d-sm-inline">Assessments</span>
                        </button>
                        <!-- Risks management tab -->
                        <button type="button" class="btn btn-outline-primary" id="risksTab" onclick="showModule('risks')">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="d-none d-sm-inline">Risks</span>
                        </button>
                        <!-- Assets management tab -->
                        <button type="button" class="btn btn-outline-primary" id="assetsTab" onclick="showModule('assets')">
                            <i class="fas fa-server"></i>
                            <span class="d-none d-sm-inline">Assets</span>
                        </button>
                        <!-- Controls management tab -->
                        <button type="button" class="btn btn-outline-primary" id="frameworkTab" onclick="showModule('framework')">
                            <i class="fas fa-shield-alt"></i>
                            <span class="d-none d-sm-inline">Controls</span>
                        </button>
                        <!-- DPIA management tab -->
                        <button type="button" class="btn btn-outline-primary" id="dpiasTab" onclick="showModule('dpias')">
                            <i class="fas fa-user-shield"></i>
                            <span class="d-none d-sm-inline">DPIAs</span>
                        </button>
                        <!-- Reports tab -->
                        <button type="button" class="btn btn-outline-primary" id="reportsTab" onclick="showModule('reports')">
                            <i class="fas fa-chart-bar"></i>
                            <span class="d-none d-sm-inline">Reports</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- ASSESSMENTS MODULE -->
            <div id="assessmentsModule" class="module-content">
                <!-- Create Assessment Button and Add Question Button on same line -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-primary" onclick="showCreateAssessmentForm()">Create New Assessment</button>
                    <button class="btn btn-success add-question-btn hidden" onclick="addQuestion()">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                </div>

                <!-- Assessment Filter Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="btn-group w-100" role="group" aria-label="Assessment filters">
                            <button type="button" class="btn btn-outline-secondary active" id="assessmentDraftBtn" onclick="showAssessments('draft')">
                                <i class="fas fa-edit"></i> Draft
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="assessmentPublishedBtn" onclick="showAssessments('published')">
                                <i class="fas fa-globe"></i> Published
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="assessmentAssignedBtn" onclick="showAssessments('assigned')">
                                <i class="fas fa-users"></i> Assigned
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Assessments Display Container -->
                <div id="assessmentsContainer" class="mb-4">
                    <div id="loadingMessage" class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading assessments...</p>
                    </div>
                    <div id="noAssessmentsMessage" class="text-center py-4 d-none">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No assessments found for this category.</p>
                    </div>
                    <div id="assessmentsList"></div>
                </div>
            </div>

            <!-- RISKS MODULE -->
            <div id="risksModule" class="module-content hidden">
                <!-- Create Risk Button -->
                <button class="btn btn-primary mb-4" onclick="showCreateRiskForm()">Create New Risk</button>

                <!-- Risk Filter Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="btn-group w-100" role="group" aria-label="Risk filters">
                            <button type="button" class="btn btn-outline-secondary active" id="riskDraftBtn" onclick="showRisks('draft')">
                                <i class="fas fa-edit"></i> Draft
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="riskPublishedBtn" onclick="showRisks('published')">
                                <i class="fas fa-globe"></i> Published
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="riskAssignedBtn" onclick="showRisks('assigned')">
                                <i class="fas fa-users"></i> Assigned
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Risks Display Container -->
                <div id="risksContainer" class="mb-4">
                    <div id="risksLoadingMessage" class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading risks...</p>
                    </div>
                    <div id="noRisksMessage" class="text-center py-4 d-none">
                        <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No risks found for this category.</p>
                    </div>
                    <div id="risksList"></div>
                </div>

                <!-- Create Risk Form -->
                <div id="createRiskForm" class="hidden">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Create New Risk</h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="riskName" class="form-label">Risk Name</label>
                                    <input type="text" class="form-control" id="riskName" placeholder="Enter risk name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="riskCategory" class="form-label">Category</label>
                                    <select class="form-select" id="riskCategory" required>
                                        <option value="">Select category</option>
                                        <option value="Operational">Operational</option>
                                        <option value="Financial">Financial</option>
                                        <option value="Strategic">Strategic</option>
                                        <option value="Compliance">Compliance</option>
                                        <option value="Technology">Technology</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="riskOwner" class="form-label">Risk Owner</label>
                                    <input type="text" class="form-control" id="riskOwner" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="riskLikelihood" class="form-label">Likelihood</label>
                                    <select class="form-select" id="riskLikelihood" required>
                                        <option value="">Select likelihood</option>
                                        <option value="Very Low">Very Low</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="riskImpact" class="form-label">Impact</label>
                                    <select class="form-select" id="riskImpact" required>
                                        <option value="">Select impact</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Critical">Critical</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="riskStatus" class="form-label">Status</label>
                                    <select class="form-select" id="riskStatus" required>
                                        <option value="">Select status</option>
                                        <option value="Active">Active</option>
                                        <option value="Mitigated">Mitigated</option>
                                        <option value="Accepted">Accepted</option>
                                        <option value="Transferred">Transferred</option>
                                        <option value="Avoided">Avoided</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="riskLevel" class="form-label">Risk Level</label>
                                    <input type="text" class="form-control" id="riskLevel" readonly style="background-color: #f8f9fa;">
                                    <small class="text-muted">Auto-calculated based on likelihood and impact</small>
                                </div>
                                <div class="col-12">
                                    <label for="riskDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="riskDescription" rows="3" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="riskControls" class="form-label">Existing Controls</label>
                                    <textarea class="form-control" id="riskControls" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ASSETS MODULE -->
            <div id="assetsModule" class="module-content hidden">
                <!-- Create Asset Button -->
                <button class="btn btn-primary mb-4" onclick="showCreateAssetForm()">Create New Asset</button>

                <!-- Asset Filter Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="btn-group w-100" role="group" aria-label="Asset filters">
                            <button type="button" class="btn btn-outline-secondary active" id="assetDraftBtn" onclick="showAssets('draft')">
                                <i class="fas fa-edit"></i> Draft
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="assetPublishedBtn" onclick="showAssets('published')">
                                <i class="fas fa-globe"></i> Published
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="assetAssignedBtn" onclick="showAssets('assigned')">
                                <i class="fas fa-users"></i> Assigned
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Assets Display Container -->
                <div id="assetsContainer" class="mb-4">
                    <div id="assetsLoadingMessage" class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading assets...</p>
                    </div>
                    <div id="noAssetsMessage" class="text-center py-4 d-none">
                        <i class="fas fa-server fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No assets found for this category.</p>
                    </div>
                    <div id="assetsList"></div>
                </div>

                <!-- Create Asset Form -->
                <div id="createAssetForm" class="hidden">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Create New Asset</h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="assetName" class="form-label">Asset Name</label>
                                    <input type="text" class="form-control" id="assetName" placeholder="Enter asset name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="assetType" class="form-label">Asset Type</label>
                                    <select class="form-select" id="assetType" required>
                                        <option value="">Select type</option>
                                        <option value="Hardware">Hardware</option>
                                        <option value="Software">Software</option>
                                        <option value="Data">Data</option>
                                        <option value="Network">Network</option>
                                        <option value="Facility">Facility</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="assetOwner" class="form-label">Asset Owner</label>
                                    <input type="text" class="form-control" id="assetOwner" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="assetLocation" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="assetLocation" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="assetCriticality" class="form-label">Criticality</label>
                                    <select class="form-select" id="assetCriticality" required>
                                        <option value="">Select criticality</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Critical">Critical</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="assetStatus" class="form-label">Status</label>
                                    <select class="form-select" id="assetStatus" required>
                                        <option value="">Select status</option>
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                        <option value="Retired">Retired</option>
                                        <option value="In Development">In Development</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="assetClassification" class="form-label">Classification</label>
                                    <select class="form-select" id="assetClassification" required>
                                        <option value="">Select classification</option>
                                        <option value="Public">Public</option>
                                        <option value="Internal">Internal</option>
                                        <option value="Confidential">Confidential</option>
                                        <option value="Restricted">Restricted</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="assetDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="assetDescription" rows="3" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="assetPurpose" class="form-label">Purpose</label>
                                    <textarea class="form-control" id="assetPurpose" rows="2"></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="assetRisks" class="form-label">Associated Risks</label>
                                    <div class="bg-light p-3 rounded">
                                        <div class="max-height-150 overflow-auto">
                                            <div id="assetRisksContainer" class="row">
                                                <!-- Risk checkboxes will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTROLS MODULE -->
            <div id="frameworkModule" class="module-content hidden">
                <!-- Create Control Button -->
                <button class="btn btn-primary mb-4" onclick="showCreateFrameworkForm()">Create New Control</button>

                <!-- Control Filter Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="btn-group w-100" role="group" aria-label="Control filters">
                            <button type="button" class="btn btn-outline-secondary active" id="frameworkDraftBtn" onclick="showFrameworks('draft')">
                                <i class="fas fa-edit"></i> Draft
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="frameworkPublishedBtn" onclick="showFrameworks('published')">
                                <i class="fas fa-globe"></i> Published
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="frameworkAssignedBtn" onclick="showFrameworks('assigned')">
                                <i class="fas fa-users"></i> Assigned
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Controls Display Container -->
                <div id="frameworksContainer" class="mb-4">
                    <div id="frameworksLoadingMessage" class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading controls...</p>
                    </div>
                    <div id="noFrameworksMessage" class="text-center py-4 d-none">
                        <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No controls found for this category.</p>
                    </div>
                    <div id="frameworksList"></div>
                </div>

                <!-- Create Control Form -->
                <div id="createFrameworkForm" class="hidden">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Create New Control</h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="frameworkName" class="form-label">Control Name</label>
                                    <input type="text" class="form-control" id="frameworkName" placeholder="Enter control name" required>
                                </div>
                                <div class="col-12">
                                    <label for="frameworkDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="frameworkDescription" rows="3" required></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="frameworkType" class="form-label">Control Type</label>
                                    <select class="form-select" id="frameworkType" required>
                                        <option value="">Select type</option>
                                        <option value="ISO 27001">ISO 27001</option>
                                        <option value="NIST">NIST</option>
                                        <option value="SOC 2">SOC 2</option>
                                        <option value="GDPR">GDPR</option>
                                        <option value="HIPAA">HIPAA</option>
                                        <option value="PCI DSS">PCI DSS</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="frameworkVersion" class="form-label">Version</label>
                                    <input type="text" class="form-control" id="frameworkVersion" placeholder="e.g., 2022, v1.0">
                                </div>
                                <div class="col-md-6">
                                    <label for="frameworkControls" class="form-label">Total Sub-Controls</label>
                                    <input type="number" class="form-control" id="frameworkControls" min="1" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="frameworkCompliance" class="form-label">Compliance %</label>
                                    <input type="number" class="form-control" id="frameworkCompliance" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-6">
                                    <label for="frameworkStatus" class="form-label">Status</label>
                                    <select class="form-select" id="frameworkStatus" required>
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Readiness</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frameworkReadiness" id="readinessReady" value="ready">
                                        <label class="form-check-label" for="readinessReady">Ready</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frameworkReadiness" id="readinessNotReady" value="not-ready" checked>
                                        <label class="form-check-label" for="readinessNotReady">Not Ready</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DPIAS MODULE -->
            <div id="dpiasModule" class="module-content hidden">
                <!-- Create DPIA Button -->
                <button class="btn btn-primary mb-4" onclick="showCreateDpiaForm()">Create New DPIA</button>

                <!-- DPIA Filter Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="btn-group w-100" role="group" aria-label="DPIA filters">
                            <button type="button" class="btn btn-outline-secondary active" id="dpiaDraftBtn" onclick="showDpias('draft')">
                                <i class="fas fa-edit"></i> Draft
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="dpiaPublishedBtn" onclick="showDpias('published')">
                                <i class="fas fa-globe"></i> Published
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="dpiaAssignedBtn" onclick="showDpias('assigned')">
                                <i class="fas fa-users"></i> Assigned
                            </button>
                        </div>
                    </div>
                </div>

                <!-- DPIAs Display Container -->
                <div id="dpiasContainer" class="mb-4">
                    <div id="dpiasLoadingMessage" class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading DPIAs...</p>
                    </div>
                    <div id="noDpiasMessage" class="text-center py-4 d-none">
                        <i class="fas fa-user-shield fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No DPIAs found for this category.</p>
                    </div>
                    <div id="dpiasList"></div>
                </div>

                <!-- Create DPIA Form -->
                <div id="createDpiaForm" class="hidden">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Create New DPIA</h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="dpiaName" class="form-label">DPIA Name</label>
                                    <input type="text" class="form-control" id="dpiaName" placeholder="Enter DPIA name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="dpiaDepartment" class="form-label">Department</label>
                                    <input type="text" class="form-control" id="dpiaDepartment" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="dpiaDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="dpiaDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="dpiaRisk" class="form-label">Risk Level</label>
                                    <select class="form-select" id="dpiaRisk" required>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="dpiaReviewer" class="form-label">Reviewer</label>
                                    <input type="text" class="form-control" id="dpiaReviewer">
                                </div>
                                <div class="col-md-6">
                                    <label for="dpiaProgress" class="form-label">Progress (%)</label>
                                    <input type="number" class="form-control" id="dpiaProgress" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-6">
                                    <label for="dpiaStatus" class="form-label">Status</label>
                                    <select class="form-select" id="dpiaStatus" required>
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="dpiaActivity" class="form-label">Processing Activity</label>
                                    <textarea class="form-control" id="dpiaActivity" rows="3" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="dpiaDataCategories" class="form-label">Data Categories</label>
                                    <textarea class="form-control" id="dpiaDataCategories" rows="2" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="dpiaRiskAssessment" class="form-label">Risk Assessment</label>
                                    <textarea class="form-control" id="dpiaRiskAssessment" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPORTS MODULE -->
            <div id="reportsModule" class="module-content hidden">
                <!-- Reports Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Assessment Reports</h3>
                    <button class="btn btn-primary" onclick="refreshReports()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Reports Filter Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="btn-group w-100" role="group" aria-label="Report filters">
                            <button type="button" class="btn btn-outline-secondary active" id="allReportsBtn" onclick="showReports('all')">
                                <i class="fas fa-list"></i> All Reports
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="recentReportsBtn" onclick="showReports('recent')">
                                <i class="fas fa-clock"></i> Recent
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="highRiskReportsBtn" onclick="showReports('high-risk')">
                                <i class="fas fa-exclamation-triangle"></i> High Risk
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading Message -->
                <div id="reportsLoadingMessage" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading reports...</p>
                </div>

                <!-- No Reports Message -->
                <div id="noReportsMessage" class="text-center py-5 d-none">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Reports Available</h5>
                    <p class="text-muted">Assessment reports will appear here once users complete assessments.</p>
                </div>

                <!-- Reports Container -->
                <div id="reportsContainer" class="row">
                    <!-- Reports will be populated dynamically -->
                </div>
            </div>

            <!-- Create Assessment Form -->
            <div id="createAssessmentForm" class="hidden">
                <div class="card mb-4">
                    <div class="card-body">
                        <!-- Mobile-optimized form layout -->
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="assessmentName" class="form-label">Assessment Name</label>
                                    <input type="text" class="form-control" id="assessmentName"
                                           placeholder="Enter assessment name" required>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="mb-3">
                                    <label for="assessmentDayOfCompletion" class="form-label">Day of Completion</label>
                                    <input type="date" class="form-control" id="assessmentDayOfCompletion" required>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="mb-3">
                                    <label for="assessmentEndDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="assessmentEndDate" required>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="assessmentDescription" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="assessmentDescription"
                                           placeholder="Brief description" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Questions Container -->
            <div id="questionsContainer"></div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <div class="container">
                <!-- Assessment Action Buttons -->
                <div id="assessmentActionButtons" class="row hidden">
                    <div class="col-12 mb-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="cancelAssessmentCreation()">
                            <i class="fas fa-arrow-left"></i> Back to Assessments
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-secondary w-100" onclick="saveAsDraft()">
                            <i class="fas fa-save"></i> Save as Draft
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" onclick="publishAssessment()">
                            <i class="fas fa-globe"></i> Publish to All
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-info w-100" onclick="assignAssessment()">
                            <i class="fas fa-users"></i> Assign to Users
                        </button>
                    </div>
                </div>

                <!-- Risk Action Buttons -->
                <div id="riskActionButtons" class="row hidden">
                    <div class="col-12 mb-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="cancelRiskCreation()">
                            <i class="fas fa-arrow-left"></i> Back to Risks
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-secondary w-100" onclick="saveRiskAsDraft()">
                            <i class="fas fa-save"></i> Save as Draft
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" onclick="publishRisk()">
                            <i class="fas fa-globe"></i> Publish to All
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-info w-100" onclick="assignRisk()">
                            <i class="fas fa-users"></i> Assign to Users
                        </button>
                    </div>
                </div>

                <!-- Asset Action Buttons -->
                <div id="assetActionButtons" class="row hidden">
                    <div class="col-12 mb-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="cancelAssetCreation()">
                            <i class="fas fa-arrow-left"></i> Back to Assets
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-secondary w-100" onclick="saveAssetAsDraft()">
                            <i class="fas fa-save"></i> Save as Draft
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" onclick="publishAsset()">
                            <i class="fas fa-globe"></i> Publish to All
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-info w-100" onclick="assignAsset()">
                            <i class="fas fa-users"></i> Assign to Users
                        </button>
                    </div>
                </div>

                <!-- Control Action Buttons -->
                <div id="frameworkActionButtons" class="row hidden">
                    <div class="col-12 mb-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="cancelFrameworkCreation()">
                            <i class="fas fa-arrow-left"></i> Back to Controls
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-secondary w-100" onclick="saveFrameworkAsDraft()">
                            <i class="fas fa-save"></i> Save as Draft
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" onclick="publishFramework()">
                            <i class="fas fa-globe"></i> Publish to All
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-info w-100" onclick="assignFramework()">
                            <i class="fas fa-users"></i> Assign to Users
                        </button>
                    </div>
                </div>

                <!-- DPIA Action Buttons -->
                <div id="dpiaActionButtons" class="row hidden">
                    <div class="col-12 mb-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="cancelDpiaCreation()">
                            <i class="fas fa-arrow-left"></i> Back to DPIAs
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-secondary w-100" onclick="saveDpiaAsDraft()">
                            <i class="fas fa-save"></i> Save as Draft
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" onclick="publishDpia()">
                            <i class="fas fa-globe"></i> Publish to All
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-info w-100" onclick="assignDpia()">
                            <i class="fas fa-users"></i> Assign to Users
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign to Users Modal - Mobile Optimized -->
    <div class="modal fade" id="assignModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignModalTitle">Assign Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Search Bar -->
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="memberSearch"
                                   placeholder="Search members..." autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchMembers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Count -->
                    <div class="mb-3">
                        <small class="text-muted">
                            <span id="selectedCount">0</span> member(s) selected
                        </small>
                    </div>

                    <!-- Members List -->
                    <div class="members-list" style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <div class="list-group">
                            <!-- Sample members - In real app, this would be populated from a database -->
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">John Doe</h6>
                                        <small class="text-muted">john.doe@example.com</small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="1"
                                               onchange="updateSelectedCount()">
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">Jane Smith</h6>
                                        <small class="text-muted">jane.smith@example.com</small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="2"
                                               onchange="updateSelectedCount()">
                                    </div>
                                </div>
                            </div>
                            <!-- Add more sample members here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="assignToSelectedUsers()">
                        <i class="fas fa-check"></i> Assign Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Results Modal -->
    <div class="modal fade" id="assessmentResultsModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assessmentResultsTitle">Assessment Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading State -->
                    <div id="resultsLoadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading assessment results...</p>
                    </div>

                    <!-- No Results State -->
                    <div id="noResultsState" class="text-center py-5 d-none">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Results Available</h5>
                        <p class="text-muted">This assessment hasn't been completed by any users yet.</p>
                    </div>

                    <!-- Results Content -->
                    <div id="resultsContent" class="d-none">
                        <!-- Assessment Overview -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h6 class="text-muted mb-2">Assessment Overview</h6>
                                <h4 id="resultAssessmentName">Assessment Name</h4>
                                <p id="resultAssessmentDescription" class="text-muted">Assessment description</p>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Overall Status</h6>
                                        <span id="resultOverallStatus" class="badge bg-success fs-6">Completed</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3 col-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 id="resultTotalQuestions" class="card-title" style="color: black !important;">0</h5>
                                        <p class="card-text small text-muted">Total Questions</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 id="resultMaturityScore" class="card-title" style="color: green !important;">0/5</h5>
                                        <p class="card-text small text-muted">Maturity Score</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 id="resultRisksIdentified" class="card-title" style="color: green !important;">0</h5>
                                        <p class="card-text small text-muted">Risks Identified</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 id="resultSubmissionDate" class="card-title text-info">-</h5>
                                        <p class="card-text small text-muted">Submitted</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Responses Tabs -->
                        <div class="mb-3">
                            <ul class="nav nav-tabs" id="responsesTabs" role="tablist">
                                <!-- Tabs will be populated dynamically for each user -->
                            </ul>
                        </div>

                        <!-- Tab Content -->
                        <div class="tab-content" id="responsesTabContent">
                            <!-- Tab panes will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportAssessmentResults()">
                        <i class="fas fa-download"></i> Export Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successToastBody">
                Assessment updated successfully!
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // GLOBAL VARIABLES AND STATE MANAGEMENT
        // ========================================

        /**
         * Local data storage arrays for each module
         * These arrays store data retrieved from Wix database for UI performance
         * and immediate updates without waiting for database responses
         */
        let allAssessments = [];    // Stores all assessment data from database
        let allRisks = [];          // Stores all risk data from database
        let allAssets = [];         // Stores all asset data from database
        let allFrameworks = [];     // Stores all controls data from database
        let allDpias = [];          // Stores all DPIA data from database
        let allReports = [];        // Stores all report data from database

        /**
         * Application state variables
         * Track current user selections and active views
         */
        let currentModule = 'assessments';  // Which module tab is currently active
        let currentFilter = 'draft';        // Which status filter is active (draft/published/assigned)

        // ========================================
        // MODULE NAVIGATION AND UI MANAGEMENT
        // ========================================

        /**
         * Switches between different modules (Assessments, Risks, Assets, Controls, DPIAs)
         * @param {string} module - The module to switch to ('assessments', 'risks', 'assets', 'framework', 'dpias')
         */
        function showModule(module) {
            currentModule = module;

            // Update navigation tab visual states
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(module + 'Tab').classList.add('active');

            // Hide all module content sections
            document.querySelectorAll('.module-content').forEach(mod => mod.classList.add('hidden'));

            // Hide all forms and action buttons to prevent cross-module interference
            hideAllForms();
            hideAllActionButtons();

            // Clear any editing states and special buttons
            window.editingAssessmentId = null;
            const addQuestionBtn = document.querySelector('.add-question-btn');
            if (addQuestionBtn) {
                addQuestionBtn.classList.add('hidden');
            }

            // Show the selected module content
            document.getElementById(module + 'Module').classList.remove('hidden');

            // Load data for the selected module from Wix database
            console.log(' Loading data for module:', module);
            switch(module) {
                case 'assessments':
                    console.log(' Loading assessments...');
                    showAssessmentsView();  // Ensure proper view state
                    loadAssessments();      // Load assessment data
                    break;
                case 'risks':
                    console.log(' Loading risks...');
                    showRisksView();        // Ensure proper view state
                    loadRisks();            // Load risk data
                    break;
                case 'assets':
                    console.log(' Loading assets...');
                    showAssetsView();       // Ensure proper view state
                    loadAssets();           // Load asset data
                    break;
                case 'framework':
                    console.log(' Loading controls...');
                    showFrameworksView();   // Ensure proper view state
                    loadFrameworks();       // Load controls data
                    break;
                case 'dpias':
                    console.log(' Loading DPIAs...');
                    showDpiasView();        // Ensure proper view state
                    loadDpias();            // Load DPIA data
                    break;
                case 'reports':
                    console.log(' Loading reports...');
                    loadReports();          // Load report data
                    break;
            }
        }

        /**
         * Displays toast notifications to the user
         * @param {string} message - The message to display
         * @param {string} type - The type of notification ('success', 'error', etc.)
         */
        function showToast(message, type = 'success') {
            const toastElement = document.getElementById('successToast');
            const toastBody = document.getElementById('successToastBody');

            // Set the message content
            toastBody.textContent = message;

            // Create and show the Bootstrap toast
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,     // Auto-hide after delay
                delay: 4000         // Show for 4 seconds
            });

            toast.show();
        }

        // Assessment management functions
        /**
         * Loads assessment data from Wix database
         * Sends postMessage to parent window (Wix) to request assessment data
         * All data now comes dynamically from database - no hardcoded mock data
         */
        function loadAssessments() {
            console.log(' Loading assessments from Wix database...');

            // Always request from Wix database - no mock data fallback
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadAssessments' }, '*');
            } else {
                // If not in Wix environment, show empty state
                console.log(' Not in Wix environment - no assessments available');
                handleAssessmentsLoaded([]);
            }
        }

        function handleAssessmentsLoaded(assessments) {
            console.log('Assessments loaded:', assessments);
            allAssessments = assessments;

            // Debug: Log the structure of the first assessment
            if (assessments.length > 0) {
                console.log('First assessment structure:', assessments[0]);
                console.log('Assessment ID field:', assessments[0].id);
            }

            showAssessments(currentFilter);
        }

        function showAssessments(filter) {
            currentFilter = filter;

            // Update button states
            document.querySelectorAll('#assessmentsModule .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('assessment' + filter.charAt(0).toUpperCase() + filter.slice(1) + 'Btn').classList.add('active');

            // Clear the form and reset state when switching tabs
            document.getElementById('assessmentName').value = '';
            document.getElementById('assessmentDayOfCompletion').value = '';
            document.getElementById('assessmentEndDate').value = '';
            document.getElementById('assessmentDescription').value = '';
            document.getElementById('questionsContainer').innerHTML = '';
            questionCount = 0;
            window.editingAssessmentId = null;

            // Hide the form and action buttons
            document.getElementById('createAssessmentForm').classList.add('hidden');
            document.getElementById('assessmentActionButtons').classList.add('hidden');
            document.querySelector('.add-question-btn').classList.add('hidden');

            // Filter assessments
            const filteredAssessments = allAssessments.filter(assessment => assessment.status === filter);

            // Hide loading message
            document.getElementById('loadingMessage').classList.add('d-none');

            // Show/hide no assessments message
            const noAssessmentsMsg = document.getElementById('noAssessmentsMessage');
            if (filteredAssessments.length === 0) {
                noAssessmentsMsg.classList.remove('d-none');
            } else {
                noAssessmentsMsg.classList.add('d-none');
            }

            // Render assessments
            renderAssessments(filteredAssessments, filter);
        }

        function renderAssessments(assessments, filter) {
            const container = document.getElementById('assessmentsList');
            container.innerHTML = '';

            assessments.forEach(assessment => {
                const card = createAssessmentCard(assessment, filter);
                container.appendChild(card);
            });

            // Remove existing event listeners to prevent duplication
            const existingHandler = container._assessmentClickHandler;
            if (existingHandler) {
                container.removeEventListener('click', existingHandler);
            }

            // Add event delegation for button clicks
            const clickHandler = function(event) {
                const button = event.target.closest('button[data-action]');
                if (!button) return;

                event.preventDefault();
                event.stopPropagation();

                const action = button.getAttribute('data-action');
                const assessmentId = button.getAttribute('data-assessment-id');

                console.log('Button clicked:', action, 'Assessment ID:', assessmentId);

                switch(action) {
                    case 'edit':
                        editAssessment(assessmentId);
                        break;
                    case 'publish':
                        publishAssessmentFromList(assessmentId);
                        break;
                    case 'assign':
                        assignAssessmentFromList(assessmentId);
                        break;
                    case 'copy':
                        copyAssessmentFromList(assessmentId);
                        break;
                    case 'view-results':
                        viewAssessmentResults(assessmentId);
                        break;
                    case 'delete':
                        deleteAssessmentFromList(assessmentId);
                        break;
                    default:
                        console.log('Unknown action:', action);
                }
            };

            container.addEventListener('click', clickHandler);
            container._assessmentClickHandler = clickHandler; // Store reference for cleanup
        }

        function createAssessmentCard(assessment, filter) {
            const card = document.createElement('div');
            card.className = 'assessment-card';

            const statusClass = `status-${assessment.status}`;
            const questionCount = assessment.questions ? assessment.questions.length : 0;
            const formattedDate = new Date(assessment.date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            let actionButtons = '';
            if (filter === 'draft') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-assessment-id="${assessment.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                    <button class="btn btn-outline-success btn-sm" data-action="publish" data-assessment-id="${assessment.id}">
                        <i class="fas fa-globe"></i> <span class="d-none d-sm-inline">Publish</span>
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-action="assign" data-assessment-id="${assessment.id}">
                        <i class="fas fa-users"></i> <span class="d-none d-sm-inline">Assign</span>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" data-action="delete" data-assessment-id="${assessment.id}">
                        <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">Delete</span>
                    </button>
                `;
            } else if (filter === 'published') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-assessment-id="${assessment.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-action="assign" data-assessment-id="${assessment.id}">
                        <i class="fas fa-users"></i> <span class="d-none d-sm-inline">Assign</span>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" data-action="copy" data-assessment-id="${assessment.id}">
                        <i class="fas fa-copy"></i> <span class="d-none d-sm-inline">Copy</span>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" data-action="delete" data-assessment-id="${assessment.id}">
                        <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">Delete</span>
                    </button>
                `;
            } else if (filter === 'assigned') {
                const assignedUsers = assessment.assignedUsers || [];
                const usersList = assignedUsers.map(user =>
                    `<span class="badge bg-secondary">${user.name}</span>`
                ).join(' ');
                actionButtons = `
                    <div class="mt-2">
                        <small class="text-muted d-block mb-1">Assigned to:</small>
                        <div class="d-flex flex-wrap gap-1">
                            ${usersList}
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-outline-primary btn-sm" data-action="edit" data-assessment-id="${assessment.id}">
                                <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" data-action="copy" data-assessment-id="${assessment.id}">
                                <i class="fas fa-copy"></i> <span class="d-none d-sm-inline">Copy</span>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" data-action="delete" data-assessment-id="${assessment.id}">
                                <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">Delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }

            // Mobile-optimized card layout
            card.innerHTML = `
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1 mb-2 mb-sm-0">
                        <h5 class="mb-1 text-truncate">${assessment.name}</h5>
                        <span class="assessment-status ${statusClass}">${assessment.status.toUpperCase()}</span>
                    </div>
                    <small class="text-muted flex-shrink-0">${formattedDate}</small>
                </div>
                <p class="text-muted mb-2 small">${assessment.description}</p>
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start">
                    <small class="text-muted mb-2 mb-sm-0">
                        <i class="fas fa-question-circle"></i> ${questionCount} question${questionCount !== 1 ? 's' : ''}
                    </small>
                    <div class="action-buttons-inline w-100 w-sm-auto">
                        ${actionButtons}
                    </div>
                </div>
            `;

            return card;
        }

        // ========================================
        // RISKS MODULE FUNCTIONS
        // ========================================

        /**
         * Loads risk data from Wix database
         * All data now comes dynamically from database - no hardcoded mock data
         */
        function loadRisks() {
            console.log(' Loading risks from Wix database...');

            // Always request from Wix database - no mock data fallback
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadRisks' }, '*');
            } else {
                // If not in Wix environment, show empty state
                console.log(' Not in Wix environment - no risks available');
                handleRisksLoaded([]);
            }
        }

        function handleRisksLoaded(risks) {
            console.log(' Risks received in admin interface:', risks.length);
            console.log(' Risk data:', risks);
            allRisks = risks;
            showRisks(currentFilter);
        }

        function showRisks(filter) {
            console.log(' Showing risks with filter:', filter);
            console.log(' Total risks available:', allRisks.length);

            currentFilter = filter;
            document.querySelectorAll('#risksModule .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('risk' + filter.charAt(0).toUpperCase() + filter.slice(1) + 'Btn').classList.add('active');

            const filteredRisks = allRisks.filter(risk => risk.status === filter);
            console.log(' Filtered risks for', filter + ':', filteredRisks.length);
            console.log(' Filtered risk items:', filteredRisks.map(r => ({ id: r.id, name: r.name, status: r.status })));

            document.getElementById('risksLoadingMessage').classList.add('d-none');

            const noRisksMsg = document.getElementById('noRisksMessage');
            if (filteredRisks.length === 0) {
                noRisksMsg.classList.remove('d-none');
            } else {
                noRisksMsg.classList.add('d-none');
            }

            renderRisks(filteredRisks, filter);
        }

        function renderRisks(risks, filter) {
            const container = document.getElementById('risksList');
            container.innerHTML = '';

            risks.forEach(risk => {
                const card = createRiskCard(risk, filter);
                container.appendChild(card);
            });

            // Add event delegation for risk button clicks
            const existingHandler = container._riskClickHandler;
            if (existingHandler) {
                container.removeEventListener('click', existingHandler);
            }

            const clickHandler = function(event) {
                const button = event.target.closest('button[data-action]');
                if (!button) return;

                event.preventDefault();
                event.stopPropagation();

                const action = button.getAttribute('data-action');
                const riskId = button.getAttribute('data-risk-id');

                console.log('Risk button clicked:', action, 'Risk ID:', riskId, 'Type:', typeof riskId);

                switch(action) {
                    case 'edit':
                        editRisk(riskId);
                        break;
                    case 'publish':
                        publishRiskFromList(riskId);
                        break;
                    case 'assign':
                        assignRiskFromList(riskId);
                        break;
                    default:
                        console.log('Unknown action:', action);
                }
            };

            container.addEventListener('click', clickHandler);
            container._riskClickHandler = clickHandler;
        }

        function createRiskCard(risk, filter) {
            const card = document.createElement('div');
            card.className = 'assessment-card';

            const statusClass = `status-${risk.status}`;
            const formattedDate = new Date(risk.createdAt || Date.now()).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            let actionButtons = '';
            if (filter === 'draft') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-risk-id="${risk.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                    <button class="btn btn-outline-success btn-sm" data-action="publish" data-risk-id="${risk.id}">
                        <i class="fas fa-globe"></i> <span class="d-none d-sm-inline">Publish</span>
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-action="assign" data-risk-id="${risk.id}">
                        <i class="fas fa-users"></i> <span class="d-none d-sm-inline">Assign</span>
                    </button>
                `;
            } else if (filter === 'published' || filter === 'assigned') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-risk-id="${risk.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                `;
            }

            card.innerHTML = `
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1 mb-2 mb-sm-0">
                        <h5 class="mb-1 text-truncate">${risk.name}</h5>
                        <span class="assessment-status ${statusClass}">${risk.status.toUpperCase()}</span>
                    </div>
                    <small class="text-muted flex-shrink-0">${formattedDate}</small>
                </div>
                <p class="text-muted mb-2 small">${risk.description || 'No description'}</p>
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start">
                    <small class="text-muted mb-2 mb-sm-0">
                        <i class="fas fa-exclamation-triangle"></i> ${risk.likelihood || 'Unknown'} likelihood, ${risk.impact || 'Unknown'} impact - ${risk.level || 'Unknown'} level
                    </small>
                    <div class="action-buttons-inline w-100 w-sm-auto">
                        ${actionButtons}
                    </div>
                </div>
            `;

            return card;
        }

        // ========================================
        // ASSETS MODULE FUNCTIONS
        // ========================================

        /**
         * Loads asset data from Wix database
         * All data now comes dynamically from database - no hardcoded mock data
         */
        function loadAssets() {
            console.log(' Loading assets from Wix database...');

            // Always request from Wix database - no mock data fallback
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadAssets' }, '*');
            } else {
                // If not in Wix environment, show empty state
                console.log(' Not in Wix environment - no assets available');
                handleAssetsLoaded([]);
            }
        }

        function handleAssetsLoaded(assets) {
            allAssets = assets;
            showAssets(currentFilter);
        }

        function showAssets(filter) {
            currentFilter = filter;
            document.querySelectorAll('#assetsModule .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('asset' + filter.charAt(0).toUpperCase() + filter.slice(1) + 'Btn').classList.add('active');

            const filteredAssets = allAssets.filter(asset => asset.status === filter);
            document.getElementById('assetsLoadingMessage').classList.add('d-none');

            const noAssetsMsg = document.getElementById('noAssetsMessage');
            if (filteredAssets.length === 0) {
                noAssetsMsg.classList.remove('d-none');
            } else {
                noAssetsMsg.classList.add('d-none');
            }

            renderAssets(filteredAssets, filter);
        }

        function renderAssets(assets, filter) {
            const container = document.getElementById('assetsList');
            container.innerHTML = '';

            assets.forEach(asset => {
                const card = createAssetCard(asset, filter);
                container.appendChild(card);
            });

            // Add event delegation for asset button clicks
            const existingHandler = container._assetClickHandler;
            if (existingHandler) {
                container.removeEventListener('click', existingHandler);
            }

            const clickHandler = function(event) {
                const button = event.target.closest('button[data-action]');
                if (!button) return;

                event.preventDefault();
                event.stopPropagation();

                const action = button.getAttribute('data-action');
                const assetId = button.getAttribute('data-asset-id');

                console.log('Asset button clicked:', action, 'Asset ID:', assetId, 'Type:', typeof assetId);

                switch(action) {
                    case 'edit':
                        editAsset(assetId);
                        break;
                    case 'publish':
                        publishAssetFromList(assetId);
                        break;
                    case 'assign':
                        assignAssetFromList(assetId);
                        break;
                    default:
                        console.log('Unknown action:', action);
                }
            };

            container.addEventListener('click', clickHandler);
            container._assetClickHandler = clickHandler;
        }

        function createAssetCard(asset, filter) {
            const card = document.createElement('div');
            card.className = 'assessment-card';

            const statusClass = `status-${asset.status}`;
            const formattedDate = new Date(asset.createdAt || Date.now()).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            let actionButtons = '';
            if (filter === 'draft') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-asset-id="${asset.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                    <button class="btn btn-outline-success btn-sm" data-action="publish" data-asset-id="${asset.id}">
                        <i class="fas fa-globe"></i> <span class="d-none d-sm-inline">Publish</span>
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-action="assign" data-asset-id="${asset.id}">
                        <i class="fas fa-users"></i> <span class="d-none d-sm-inline">Assign</span>
                    </button>
                `;
            } else if (filter === 'published' || filter === 'assigned') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-asset-id="${asset.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                `;
            }

            card.innerHTML = `
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1 mb-2 mb-sm-0">
                        <h5 class="mb-1 text-truncate">${asset.name}</h5>
                        <span class="assessment-status ${statusClass}">${asset.status.toUpperCase()}</span>
                    </div>
                    <small class="text-muted flex-shrink-0">${formattedDate}</small>
                </div>
                <p class="text-muted mb-2 small">${asset.description || 'No description'}</p>
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start">
                    <small class="text-muted mb-2 mb-sm-0">
                        <i class="fas fa-server"></i> ${asset.type || 'Unknown'} - ${asset.criticality || 'Unknown'} criticality - ${asset.location || 'Unknown location'}
                    </small>
                    <div class="action-buttons-inline w-100 w-sm-auto">
                        ${actionButtons}
                    </div>
                </div>
            `;

            return card;
        }

        // ========================================
        // CONTROLS MODULE FUNCTIONS
        // ========================================

        /**
         * Loads controls data from Wix database
         * All data now comes dynamically from database - no hardcoded mock data
         */
        function loadFrameworks() {
            console.log(' Loading controls from Wix database...');

            // Always request from Wix database - no mock data fallback
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadFrameworks' }, '*');
            } else {
                // If not in Wix environment, show empty state
                console.log(' Not in Wix environment - no controls available');
                handleFrameworksLoaded([]);
            }
        }

        function handleFrameworksLoaded(frameworks) {
            allFrameworks = frameworks;
            showFrameworks(currentFilter);
        }

        function showFrameworks(filter) {
            currentFilter = filter;
            document.querySelectorAll('#frameworkModule .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('framework' + filter.charAt(0).toUpperCase() + filter.slice(1) + 'Btn').classList.add('active');

            const filteredFrameworks = allFrameworks.filter(framework => framework.status === filter);
            document.getElementById('frameworksLoadingMessage').classList.add('d-none');

            const noFrameworksMsg = document.getElementById('noFrameworksMessage');
            if (filteredFrameworks.length === 0) {
                noFrameworksMsg.classList.remove('d-none');
            } else {
                noFrameworksMsg.classList.add('d-none');
            }

            renderFrameworks(filteredFrameworks, filter);
        }

        function renderFrameworks(frameworks, filter) {
            const container = document.getElementById('frameworksList');
            container.innerHTML = '';

            frameworks.forEach(framework => {
                const card = createFrameworkCard(framework, filter);
                container.appendChild(card);
            });

            // Add event delegation for control button clicks
            const existingHandler = container._frameworkClickHandler;
            if (existingHandler) {
                container.removeEventListener('click', existingHandler);
            }

            const clickHandler = function(event) {
                const button = event.target.closest('button[data-action]');
                if (!button) return;

                event.preventDefault();
                event.stopPropagation();

                const action = button.getAttribute('data-action');
                const frameworkId = button.getAttribute('data-framework-id');

                console.log('Control button clicked:', action, 'Control ID:', frameworkId, 'Type:', typeof frameworkId);

                switch(action) {
                    case 'edit':
                        editFramework(frameworkId);
                        break;
                    case 'publish':
                        publishFrameworkFromList(frameworkId);
                        break;
                    case 'assign':
                        assignFrameworkFromList(frameworkId);
                        break;
                    default:
                        console.log('Unknown action:', action);
                }
            };

            container.addEventListener('click', clickHandler);
            container._frameworkClickHandler = clickHandler;
        }

        function createFrameworkCard(framework, filter) {
            const card = document.createElement('div');
            card.className = 'assessment-card';

            const statusClass = `status-${framework.status}`;
            const formattedDate = new Date(framework.createdAt || Date.now()).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            let actionButtons = '';
            if (filter === 'draft') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-framework-id="${framework.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                    <button class="btn btn-outline-success btn-sm" data-action="publish" data-framework-id="${framework.id}">
                        <i class="fas fa-globe"></i> <span class="d-none d-sm-inline">Publish</span>
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-action="assign" data-framework-id="${framework.id}">
                        <i class="fas fa-users"></i> <span class="d-none d-sm-inline">Assign</span>
                    </button>
                `;
            } else if (filter === 'published' || filter === 'assigned') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-framework-id="${framework.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                `;
            }

            card.innerHTML = `
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1 mb-2 mb-sm-0">
                        <h5 class="mb-1 text-truncate">${framework.name}</h5>
                        <span class="assessment-status ${statusClass}">${framework.status.toUpperCase()}</span>
                    </div>
                    <small class="text-muted flex-shrink-0">${formattedDate}</small>
                </div>
                <p class="text-muted mb-2 small">${framework.description || 'No description'}</p>
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start">
                    <small class="text-muted mb-2 mb-sm-0">
                        <i class="fas fa-shield-alt"></i> ${framework.readiness || 'Unknown'} readiness - ${framework.compliance || 0}% compliance
                    </small>
                    <div class="action-buttons-inline w-100 w-sm-auto">
                        ${actionButtons}
                    </div>
                </div>
            `;

            return card;
        }

        // ========================================
        // DPIAS MODULE FUNCTIONS
        // ========================================

        /**
         * Loads DPIA data from Wix database
         * All data now comes dynamically from database - no hardcoded mock data
         */
        function loadDpias() {
            console.log(' Loading DPIAs from Wix database...');

            // Always request from Wix database - no mock data fallback
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadDpias' }, '*');
            } else {
                // If not in Wix environment, show empty state
                console.log(' Not in Wix environment - no DPIAs available');
                handleDpiasLoaded([]);
            }
        }

        function handleDpiasLoaded(dpias) {
            allDpias = dpias;
            showDpias(currentFilter);
        }

        function showDpias(filter) {
            currentFilter = filter;
            document.querySelectorAll('#dpiasModule .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('dpia' + filter.charAt(0).toUpperCase() + filter.slice(1) + 'Btn').classList.add('active');

            const filteredDpias = allDpias.filter(dpia => dpia.status === filter);
            document.getElementById('dpiasLoadingMessage').classList.add('d-none');

            const noDpiasMsg = document.getElementById('noDpiasMessage');
            if (filteredDpias.length === 0) {
                noDpiasMsg.classList.remove('d-none');
            } else {
                noDpiasMsg.classList.add('d-none');
            }

            renderDpias(filteredDpias, filter);
        }

        function renderDpias(dpias, filter) {
            const container = document.getElementById('dpiasList');
            container.innerHTML = '';

            dpias.forEach(dpia => {
                const card = createDpiaCard(dpia, filter);
                container.appendChild(card);
            });

            // Add event delegation for DPIA button clicks
            const existingHandler = container._dpiaClickHandler;
            if (existingHandler) {
                container.removeEventListener('click', existingHandler);
            }

            const clickHandler = function(event) {
                const button = event.target.closest('button[data-action]');
                if (!button) return;

                event.preventDefault();
                event.stopPropagation();

                const action = button.getAttribute('data-action');
                const dpiaId = button.getAttribute('data-dpia-id');

                console.log('DPIA button clicked:', action, 'DPIA ID:', dpiaId, 'Type:', typeof dpiaId);

                switch(action) {
                    case 'edit':
                        editDpia(dpiaId);
                        break;
                    case 'publish':
                        publishDpiaFromList(dpiaId);
                        break;
                    case 'assign':
                        assignDpiaFromList(dpiaId);
                        break;
                    default:
                        console.log('Unknown action:', action);
                }
            };

            container.addEventListener('click', clickHandler);
            container._dpiaClickHandler = clickHandler;
        }

        function createDpiaCard(dpia, filter) {
            const card = document.createElement('div');
            card.className = 'assessment-card';

            const statusClass = `status-${dpia.status}`;
            const formattedDate = new Date(dpia.createdAt || Date.now()).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            let actionButtons = '';
            if (filter === 'draft') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-dpia-id="${dpia.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                    <button class="btn btn-outline-success btn-sm" data-action="publish" data-dpia-id="${dpia.id}">
                        <i class="fas fa-globe"></i> <span class="d-none d-sm-inline">Publish</span>
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-action="assign" data-dpia-id="${dpia.id}">
                        <i class="fas fa-users"></i> <span class="d-none d-sm-inline">Assign</span>
                    </button>
                `;
            } else if (filter === 'published' || filter === 'assigned') {
                actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" data-action="edit" data-dpia-id="${dpia.id}">
                        <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Edit</span>
                    </button>
                `;
            }

            card.innerHTML = `
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1 mb-2 mb-sm-0">
                        <h5 class="mb-1 text-truncate">${dpia.name}</h5>
                        <span class="assessment-status ${statusClass}">${dpia.status.toUpperCase()}</span>
                    </div>
                    <small class="text-muted flex-shrink-0">${formattedDate}</small>
                </div>
                <p class="text-muted mb-2 small">${dpia.activity || 'No activity description'}</p>
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start">
                    <small class="text-muted mb-2 mb-sm-0">
                        <i class="fas fa-user-shield"></i> ${dpia.department || 'Unknown'} - ${dpia.risk || 'Unknown'} risk - ${dpia.progress || 0}% complete
                    </small>
                    <div class="action-buttons-inline w-100 w-sm-auto">
                        ${actionButtons}
                    </div>
                </div>
            `;

            return card;
        }

        // Create form functions - Show inline forms like assessments
        function showCreateRiskForm() {
            // Hide all forms and only this module's action buttons
            hideAllForms();
            hideRiskActionButtons();

            // Show risk form and action buttons
            document.getElementById('createRiskForm').classList.remove('hidden');
            document.getElementById('riskActionButtons').classList.remove('hidden');
            document.getElementById('risksContainer').style.display = 'none';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dpiaDate').value = today;
        }

        function showCreateAssetForm() {
            // Hide all forms and only this module's action buttons
            hideAllForms();
            hideAssetActionButtons();

            // Show asset form and action buttons
            document.getElementById('createAssetForm').classList.remove('hidden');
            document.getElementById('assetActionButtons').classList.remove('hidden');
            document.getElementById('assetsContainer').style.display = 'none';
        }

        function showCreateFrameworkForm() {
            // Hide all forms and only this module's action buttons
            hideAllForms();
            hideFrameworkActionButtons();

            // Show framework form and action buttons
            document.getElementById('createFrameworkForm').classList.remove('hidden');
            document.getElementById('frameworkActionButtons').classList.remove('hidden');
            document.getElementById('frameworksContainer').style.display = 'none';
        }

        function showCreateDpiaForm() {
            // Hide all forms and only this module's action buttons
            hideAllForms();
            hideDpiaActionButtons();

            // Show DPIA form and action buttons
            document.getElementById('createDpiaForm').classList.remove('hidden');
            document.getElementById('dpiaActionButtons').classList.remove('hidden');
            document.getElementById('dpiasContainer').style.display = 'none';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dpiaDate').value = today;
        }

        // Helper functions to manage form visibility
        function hideAllForms() {
            document.getElementById('createAssessmentForm').classList.add('hidden');
            document.getElementById('createRiskForm').classList.add('hidden');
            document.getElementById('createAssetForm').classList.add('hidden');
            document.getElementById('createFrameworkForm').classList.add('hidden');
            document.getElementById('createDpiaForm').classList.add('hidden');

            // Clear questions container to prevent questions from showing in other tabs
            document.getElementById('questionsContainer').innerHTML = '';
            questionCount = 0;
        }

        function hideAllActionButtons() {
            document.getElementById('assessmentActionButtons').classList.add('hidden');
            document.getElementById('riskActionButtons').classList.add('hidden');
            document.getElementById('assetActionButtons').classList.add('hidden');
            document.getElementById('frameworkActionButtons').classList.add('hidden');
            document.getElementById('dpiaActionButtons').classList.add('hidden');
        }

        // Module-specific action button management functions
        function hideAssessmentActionButtons() {
            document.getElementById('assessmentActionButtons').classList.add('hidden');
        }

        function hideRiskActionButtons() {
            document.getElementById('riskActionButtons').classList.add('hidden');
        }

        function hideAssetActionButtons() {
            document.getElementById('assetActionButtons').classList.add('hidden');
        }

        function hideFrameworkActionButtons() {
            document.getElementById('frameworkActionButtons').classList.add('hidden');
        }

        function hideDpiaActionButtons() {
            document.getElementById('dpiaActionButtons').classList.add('hidden');
        }

        function showAssessmentsView() {
            hideAllForms();
            hideAssessmentActionButtons();
            document.getElementById('assessmentsContainer').style.display = 'block';
        }

        function showRisksView() {
            hideAllForms();
            hideRiskActionButtons();
            document.getElementById('risksContainer').style.display = 'block';
        }

        function showAssetsView() {
            hideAllForms();
            hideAssetActionButtons();
            document.getElementById('assetsContainer').style.display = 'block';
        }

        function showFrameworksView() {
            hideAllForms();
            hideFrameworkActionButtons();
            document.getElementById('frameworksContainer').style.display = 'block';
        }

        function showDpiasView() {
            hideAllForms();
            hideDpiaActionButtons();
            document.getElementById('dpiasContainer').style.display = 'block';
        }

        // ========================================
        // RISK MODULE ACTION BUTTON FUNCTIONS
        // These functions handle the three main actions for risks:
        // Save as Draft, Publish, and Assign to Users
        // ========================================

        /**
         * Saves a risk as draft status
         * Validates form, collects data, sends to database, updates UI
         */
        function saveRiskAsDraft() {
            // Validate all required fields before proceeding
            if (!validateRiskForm()) return;

            // Collect form data and set status
            const riskData = collectRiskData();
            riskData.status = 'draft';

            // Check if editing existing risk
            if (window.editingRiskId) {
                riskData.id = window.editingRiskId;
                sendToWixDatabase(riskData, 'UPDATE_RISK');
                showToast(`Risk "${riskData.name}" updated!`);
            } else {
                riskData.id = Date.now(); // Generate simple timestamp-based ID
                riskData.createdAt = new Date().toISOString();
                sendToWixDatabase(riskData, 'SAVE_RISK_DRAFT');
                showToast(`Risk "${riskData.name}" saved as draft!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetRiskFormAndShowList();
        }

        /**
         * Publishes a risk to all users
         * Similar to draft but with published status and timestamp
         */
        function publishRisk() {
            // Validate form data
            if (!validateRiskForm()) return;

            // Collect data and set published status
            const riskData = collectRiskData();
            riskData.status = 'published';
            riskData.publishedAt = new Date().toISOString(); // Track when published

            // Check if editing existing risk
            if (window.editingRiskId) {
                riskData.id = window.editingRiskId;
                sendToWixDatabase(riskData, 'UPDATE_RISK');
                showToast(`Risk "${riskData.name}" updated and published!`);
            } else {
                riskData.id = Date.now();
                riskData.createdAt = new Date().toISOString();
                sendToWixDatabase(riskData, 'PUBLISH_RISK');
                showToast(`Risk "${riskData.name}" published to all users!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetRiskFormAndShowList();
        }

        /**
         * Assigns a risk to specific users
         * Stores data temporarily and opens user selection modal
         */
        function assignRisk() {
            // Validate form before assignment
            if (!validateRiskForm()) return;

            // Prepare risk data for assignment
            const riskData = collectRiskData();
            riskData.status = 'assigned';

            // Check if editing existing risk
            if (window.editingRiskId) {
                riskData.id = window.editingRiskId;
            } else {
                riskData.id = Date.now();
                riskData.createdAt = new Date().toISOString();
            }

            // Store in global variable for assignment modal to access
            window.assigningRiskData = riskData;

            // Set modal title for risk assignment
            document.getElementById('assignModalTitle').textContent = 'Assign Risk';

            // Open user selection modal (reuses existing assignment modal)
            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        // Functions for handling button clicks from risk list
        function editRisk(riskId) {
            console.log('Edit risk called with ID:', riskId);
            const risk = allRisks.find(r => r.id === riskId);
            if (!risk) {
                console.error('Risk not found with ID:', riskId);
                alert('Risk not found!');
                return;
            }

            // Populate form with risk data
            document.getElementById('riskName').value = risk.name;
            document.getElementById('riskDescription').value = risk.description || '';
            document.getElementById('riskLikelihood').value = risk.likelihood || '';
            document.getElementById('riskImpact').value = risk.impact || '';
            document.getElementById('riskLevel').value = risk.level || '';

            // Store editing ID for update
            window.editingRiskId = riskId;

            // Show form
            showCreateRiskForm();
        }

        function publishRiskFromList(riskId) {
            console.log('Publish risk called with ID:', riskId);
            const risk = allRisks.find(r => r.id === riskId);
            if (!risk) {
                console.error('Risk not found with ID:', riskId);
                alert('Risk not found!');
                return;
            }

            if (confirm(`Are you sure you want to publish "${risk.name}" to all users?`)) {
                risk.status = 'published';
                risk.publishedAt = new Date().toISOString();

                sendToWixDatabase(risk, 'UPDATE_RISK');

                const index = allRisks.findIndex(r => r.id === riskId);
                if (index !== -1) {
                    allRisks[index] = risk;
                }

                showRisks(currentFilter);
                showToast(`"${risk.name}" has been published!`);
            }
        }

        function assignRiskFromList(riskId) {
            console.log('Assign risk called with ID:', riskId);
            const risk = allRisks.find(r => r.id === riskId);
            if (!risk) {
                console.error('Risk not found with ID:', riskId);
                alert('Risk not found!');
                return;
            }

            window.assigningRiskId = riskId;
            document.getElementById('assignModalTitle').textContent = 'Assign Risk';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        // Helper functions for Risk module
        function validateRiskForm() {
            const name = document.getElementById('riskName').value.trim();
            const category = document.getElementById('riskCategory').value;
            const owner = document.getElementById('riskOwner').value.trim();
            const likelihood = document.getElementById('riskLikelihood').value;
            const impact = document.getElementById('riskImpact').value;
            const status = document.getElementById('riskStatus').value;
            const description = document.getElementById('riskDescription').value.trim();

            if (!name) {
                showToast('Please enter a risk name', 'error');
                document.getElementById('riskName').focus();
                return false;
            }
            if (!category) {
                showToast('Please select a category', 'error');
                return false;
            }
            if (!owner) {
                showToast('Please enter a risk owner', 'error');
                return false;
            }
            if (!likelihood) {
                showToast('Please select likelihood', 'error');
                return false;
            }
            if (!impact) {
                showToast('Please select impact', 'error');
                return false;
            }
            if (!status) {
                showToast('Please select status', 'error');
                return false;
            }
            if (!description) {
                showToast('Please enter a description', 'error');
                return false;
            }
            return true;
        }

        function collectRiskData() {
            const name = document.getElementById('riskName').value;
            const category = document.getElementById('riskCategory').value;
            const owner = document.getElementById('riskOwner').value;
            const likelihood = document.getElementById('riskLikelihood').value;
            const impact = document.getElementById('riskImpact').value;
            const status = document.getElementById('riskStatus').value;
            const description = document.getElementById('riskDescription').value;
            const controls = document.getElementById('riskControls').value;
            const level = calculateRiskLevel(likelihood, impact);

            return {
                id: Date.now(),
                name,
                category,
                owner,
                likelihood,
                impact,
                status,
                level,
                description,
                controls,
                createdAt: new Date().toISOString()
            };
        }

        function resetRiskFormAndShowList() {
            // Clear form
            document.getElementById('riskName').value = '';
            document.getElementById('riskCategory').value = '';
            document.getElementById('riskOwner').value = '';
            document.getElementById('riskLikelihood').value = '';
            document.getElementById('riskImpact').value = '';
            document.getElementById('riskStatus').value = '';
            document.getElementById('riskLevel').value = '';
            document.getElementById('riskDescription').value = '';
            document.getElementById('riskControls').value = '';

            // Clear editing state
            window.editingRiskId = null;

            // Hide form and show list
            showRisksView();
            showRisks(currentFilter);
        }

        // Asset module functions
        function saveAssetAsDraft() {
            if (!validateAssetForm()) return;

            const assetData = collectAssetData();
            assetData.status = 'draft';

            // Check if editing existing asset
            if (window.editingAssetId) {
                assetData.id = window.editingAssetId;
                sendToWixDatabase(assetData, 'UPDATE_ASSET');
                showToast(`Asset "${assetData.name}" updated!`);
            } else {
                assetData.id = Date.now(); // Generate simple ID
                assetData.createdAt = new Date().toISOString();
                sendToWixDatabase(assetData, 'SAVE_ASSET_DRAFT');
                showToast(`Asset "${assetData.name}" saved as draft!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetAssetFormAndShowList();
        }

        function publishAsset() {
            if (!validateAssetForm()) return;

            const assetData = collectAssetData();
            assetData.status = 'published';
            assetData.publishedAt = new Date().toISOString();

            // Check if editing existing asset
            if (window.editingAssetId) {
                assetData.id = window.editingAssetId;
                sendToWixDatabase(assetData, 'UPDATE_ASSET');
                showToast(`Asset "${assetData.name}" updated and published!`);
            } else {
                assetData.id = Date.now(); // Generate simple ID
                assetData.createdAt = new Date().toISOString();
                sendToWixDatabase(assetData, 'PUBLISH_ASSET');
                showToast(`Asset "${assetData.name}" published to all users!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetAssetFormAndShowList();
        }

        function assignAsset() {
            if (!validateAssetForm()) return;

            // Store asset data for assignment
            const assetData = collectAssetData();
            assetData.status = 'assigned';

            // Check if editing existing asset
            if (window.editingAssetId) {
                assetData.id = window.editingAssetId;
            } else {
                assetData.id = Date.now();
                assetData.createdAt = new Date().toISOString();
            }

            window.assigningAssetData = assetData;

            // Set modal title for asset assignment
            document.getElementById('assignModalTitle').textContent = 'Assign Asset';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        // Functions for handling button clicks from asset list
        function editAsset(assetId) {
            console.log('Edit asset called with ID:', assetId);
            const asset = allAssets.find(a => a.id === assetId);
            if (!asset) {
                console.error('Asset not found with ID:', assetId);
                alert('Asset not found!');
                return;
            }

            // Populate form with asset data
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetType').value = asset.type || '';
            document.getElementById('assetOwner').value = asset.owner || '';
            document.getElementById('assetLocation').value = asset.location || '';
            document.getElementById('assetCriticality').value = asset.criticality || '';
            document.getElementById('assetDescription').value = asset.description || '';

            // Store editing ID for update
            window.editingAssetId = assetId;

            // Show form
            showCreateAssetForm();
        }

        function publishAssetFromList(assetId) {
            console.log('Publish asset called with ID:', assetId);
            const asset = allAssets.find(a => a.id === assetId);
            if (!asset) {
                console.error('Asset not found with ID:', assetId);
                alert('Asset not found!');
                return;
            }

            if (confirm(`Are you sure you want to publish "${asset.name}" to all users?`)) {
                asset.status = 'published';
                asset.publishedAt = new Date().toISOString();

                sendToWixDatabase(asset, 'UPDATE_ASSET');

                const index = allAssets.findIndex(a => a.id === assetId);
                if (index !== -1) {
                    allAssets[index] = asset;
                }

                showAssets(currentFilter);
                showToast(`"${asset.name}" has been published!`);
            }
        }

        function assignAssetFromList(assetId) {
            console.log('Assign asset called with ID:', assetId);
            const asset = allAssets.find(a => a.id === assetId);
            if (!asset) {
                console.error('Asset not found with ID:', assetId);
                alert('Asset not found!');
                return;
            }

            window.assigningAssetId = assetId;
            document.getElementById('assignModalTitle').textContent = 'Assign Asset';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        function validateAssetForm() {
            const name = document.getElementById('assetName').value.trim();
            const type = document.getElementById('assetType').value;
            const owner = document.getElementById('assetOwner').value.trim();
            const location = document.getElementById('assetLocation').value.trim();
            const criticality = document.getElementById('assetCriticality').value;
            const status = document.getElementById('assetStatus').value;
            const classification = document.getElementById('assetClassification').value;
            const description = document.getElementById('assetDescription').value.trim();

            if (!name) {
                showToast('Please enter an asset name', 'error');
                document.getElementById('assetName').focus();
                return false;
            }
            if (!type) {
                showToast('Please select an asset type', 'error');
                return false;
            }
            if (!owner) {
                showToast('Please enter an asset owner', 'error');
                return false;
            }
            if (!location) {
                showToast('Please enter a location', 'error');
                return false;
            }
            if (!criticality) {
                showToast('Please select criticality', 'error');
                return false;
            }
            if (!status) {
                showToast('Please select status', 'error');
                return false;
            }
            if (!classification) {
                showToast('Please select classification', 'error');
                return false;
            }
            if (!description) {
                showToast('Please enter a description', 'error');
                return false;
            }
            return true;
        }

        function collectAssetData() {
            return {
                id: Date.now(),
                name: document.getElementById('assetName').value,
                type: document.getElementById('assetType').value,
                owner: document.getElementById('assetOwner').value,
                location: document.getElementById('assetLocation').value,
                criticality: document.getElementById('assetCriticality').value,
                status: document.getElementById('assetStatus').value,
                classification: document.getElementById('assetClassification').value,
                description: document.getElementById('assetDescription').value,
                purpose: document.getElementById('assetPurpose').value,
                createdAt: new Date().toISOString()
            };
        }

        function resetAssetFormAndShowList() {
            // Clear form
            document.getElementById('assetName').value = '';
            document.getElementById('assetType').value = '';
            document.getElementById('assetOwner').value = '';
            document.getElementById('assetLocation').value = '';
            document.getElementById('assetCriticality').value = '';
            document.getElementById('assetStatus').value = '';
            document.getElementById('assetClassification').value = '';
            document.getElementById('assetDescription').value = '';
            document.getElementById('assetPurpose').value = '';

            // Clear editing state
            window.editingAssetId = null;

            // Hide form and show list
            showAssetsView();
            showAssets(currentFilter);
        }

        // Framework module functions
        function saveFrameworkAsDraft() {
            if (!validateFrameworkForm()) return;

            const frameworkData = collectFrameworkData();
            frameworkData.status = 'draft';

            // Check if editing existing framework
            if (window.editingFrameworkId) {
                frameworkData.id = window.editingFrameworkId;
                sendToWixDatabase(frameworkData, 'UPDATE_FRAMEWORK');
                showToast(`Control "${frameworkData.name}" updated!`);
            } else {
                frameworkData.id = Date.now(); // Generate simple ID
                frameworkData.createdAt = new Date().toISOString();
                sendToWixDatabase(frameworkData, 'SAVE_FRAMEWORK_DRAFT');
                showToast(`Control "${frameworkData.name}" saved as draft!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetFrameworkFormAndShowList();
        }

        function publishFramework() {
            if (!validateFrameworkForm()) return;

            const frameworkData = collectFrameworkData();
            frameworkData.status = 'published';
            frameworkData.publishedAt = new Date().toISOString();

            // Check if editing existing framework
            if (window.editingFrameworkId) {
                frameworkData.id = window.editingFrameworkId;
                sendToWixDatabase(frameworkData, 'UPDATE_FRAMEWORK');
                showToast(`Control "${frameworkData.name}" updated and published!`);
            } else {
                frameworkData.id = Date.now(); // Generate simple ID
                frameworkData.createdAt = new Date().toISOString();
                sendToWixDatabase(frameworkData, 'PUBLISH_FRAMEWORK');
                showToast(`Control "${frameworkData.name}" published to all users!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetFrameworkFormAndShowList();
        }

        function assignFramework() {
            if (!validateFrameworkForm()) return;

            // Store framework data for assignment
            const frameworkData = collectFrameworkData();
            frameworkData.status = 'assigned';

            // Check if editing existing framework
            if (window.editingFrameworkId) {
                frameworkData.id = window.editingFrameworkId;
            } else {
                frameworkData.id = Date.now();
                frameworkData.createdAt = new Date().toISOString();
            }

            window.assigningFrameworkData = frameworkData;

            // Set modal title for control assignment
            document.getElementById('assignModalTitle').textContent = 'Assign Control';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        // Functions for handling button clicks from controls list
        function editFramework(frameworkId) {
            console.log('Edit control called with ID:', frameworkId);
            const framework = allFrameworks.find(f => f.id === frameworkId);
            if (!framework) {
                console.error('Control not found with ID:', frameworkId);
                alert('Control not found!');
                return;
            }

            // Populate form with control data
            document.getElementById('frameworkName').value = framework.name;
            document.getElementById('frameworkDescription').value = framework.description || '';
            document.getElementById('frameworkReadiness').value = framework.readiness || '';
            document.getElementById('frameworkCompliance').value = framework.compliance || '';

            // Store editing ID for update
            window.editingFrameworkId = frameworkId;

            // Show form
            showCreateFrameworkForm();
        }

        function publishFrameworkFromList(frameworkId) {
            console.log('Publish control called with ID:', frameworkId);
            const framework = allFrameworks.find(f => f.id === frameworkId);
            if (!framework) {
                console.error('Control not found with ID:', frameworkId);
                alert('Control not found!');
                return;
            }

            if (confirm(`Are you sure you want to publish "${framework.name}" to all users?`)) {
                framework.status = 'published';
                framework.publishedAt = new Date().toISOString();

                sendToWixDatabase(framework, 'UPDATE_FRAMEWORK');

                const index = allFrameworks.findIndex(f => f.id === frameworkId);
                if (index !== -1) {
                    allFrameworks[index] = framework;
                }

                showFrameworks(currentFilter);
                showToast(`"${framework.name}" has been published!`);
            }
        }

        function assignFrameworkFromList(frameworkId) {
            console.log('Assign control called with ID:', frameworkId);
            const framework = allFrameworks.find(f => f.id === frameworkId);
            if (!framework) {
                console.error('Control not found with ID:', frameworkId);
                alert('Control not found!');
                return;
            }

            window.assigningFrameworkId = frameworkId;
            document.getElementById('assignModalTitle').textContent = 'Assign Control';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        function validateFrameworkForm() {
            const name = document.getElementById('frameworkName').value.trim();
            const description = document.getElementById('frameworkDescription').value.trim();
            const type = document.getElementById('frameworkType').value;
            const controls = document.getElementById('frameworkControls').value;

            if (!name) {
                showToast('Please enter a control name', 'error');
                document.getElementById('frameworkName').focus();
                return false;
            }
            if (!description) {
                showToast('Please enter a description', 'error');
                return false;
            }
            if (!type) {
                showToast('Please select a control type', 'error');
                return false;
            }
            if (!controls || controls < 1) {
                showToast('Please enter a valid number of controls', 'error');
                return false;
            }
            return true;
        }

        function collectFrameworkData() {
            return {
                id: Date.now(),
                name: document.getElementById('frameworkName').value,
                description: document.getElementById('frameworkDescription').value,
                type: document.getElementById('frameworkType').value,
                version: document.getElementById('frameworkVersion').value,
                controls: parseInt(document.getElementById('frameworkControls').value),
                compliance: parseInt(document.getElementById('frameworkCompliance').value),
                status: document.getElementById('frameworkStatus').value,
                readiness: document.querySelector('input[name="frameworkReadiness"]:checked').value,
                createdAt: new Date().toISOString()
            };
        }

        function resetFrameworkFormAndShowList() {
            // Clear form
            document.getElementById('frameworkName').value = '';
            document.getElementById('frameworkDescription').value = '';
            document.getElementById('frameworkType').value = '';
            document.getElementById('frameworkVersion').value = '';
            document.getElementById('frameworkControls').value = '';
            document.getElementById('frameworkCompliance').value = '0';
            document.getElementById('frameworkStatus').value = 'Active';
            document.getElementById('readinessNotReady').checked = true;

            // Clear editing state
            window.editingFrameworkId = null;

            // Hide form and show list
            showFrameworksView();
            showFrameworks(currentFilter);
        }

        // Cancel control creation and return to list
        function cancelFrameworkCreation() {
            // Clear form without saving
            document.getElementById('frameworkName').value = '';
            document.getElementById('frameworkDescription').value = '';
            document.getElementById('frameworkType').value = '';
            document.getElementById('frameworkVersion').value = '';
            document.getElementById('frameworkControls').value = '';
            document.getElementById('frameworkCompliance').value = '0';
            document.getElementById('frameworkStatus').value = 'Active';
            document.getElementById('readinessNotReady').checked = true;

            // Hide form and show list
            showFrameworksView();
            showFrameworks(currentFilter);
        }

        // Cancel assessment creation and return to list
        function cancelAssessmentCreation() {
            // Clear form without saving
            document.getElementById('assessmentName').value = '';
            document.getElementById('assessmentDayOfCompletion').value = '';
            document.getElementById('assessmentEndDate').value = '';
            document.getElementById('assessmentDescription').value = '';
            document.getElementById('questionsContainer').innerHTML = '';
            questionCount = 0;

            // Hide form and show list
            showAssessmentsView();
            loadAssessments();
        }

        // Cancel risk creation and return to list
        function cancelRiskCreation() {
            // Clear form without saving
            document.getElementById('riskName').value = '';
            document.getElementById('riskCategory').value = '';
            document.getElementById('riskOwner').value = '';
            document.getElementById('riskLikelihood').value = '';
            document.getElementById('riskImpact').value = '';
            document.getElementById('riskStatus').value = '';
            document.getElementById('riskLevel').value = '';
            document.getElementById('riskDescription').value = '';

            // Clear editing state
            window.editingRiskId = null;

            // Hide form and show list
            showRisksView();
            showRisks(currentFilter);
        }

        // Cancel asset creation and return to list
        function cancelAssetCreation() {
            console.log(' Cancel asset creation called');
            try {
                // Clear form without saving
                document.getElementById('assetName').value = '';
                document.getElementById('assetType').value = '';
                document.getElementById('assetOwner').value = '';
                document.getElementById('assetLocation').value = '';
                document.getElementById('assetCriticality').value = '';
                document.getElementById('assetStatus').value = '';
                document.getElementById('assetClassification').value = '';
                document.getElementById('assetDescription').value = '';

                // Hide form and show list
                console.log(' Calling showAssetsView()');
                showAssetsView();
                console.log(' Calling showAssets() with filter:', currentFilter || 'draft');
                showAssets(currentFilter || 'draft');
                console.log(' Asset cancel completed successfully');
            } catch (error) {
                console.error(' Error in cancelAssetCreation:', error);
            }
        }

        // Cancel DPIA creation and return to list
        function cancelDpiaCreation() {
            console.log(' Cancel DPIA creation called');
            try {
                // Clear form without saving
                document.getElementById('dpiaName').value = '';
                document.getElementById('dpiaDepartment').value = '';
                document.getElementById('dpiaDate').value = '';
                document.getElementById('dpiaRisk').value = 'Low';
                document.getElementById('dpiaReviewer').value = '';
                document.getElementById('dpiaProgress').value = '0';
                document.getElementById('dpiaStatus').value = 'Not Started';
                // Clear additional DPIA fields
                const dpiaActivity = document.getElementById('dpiaActivity');
                if (dpiaActivity) dpiaActivity.value = '';
                const dpiaDataCategories = document.getElementById('dpiaDataCategories');
                if (dpiaDataCategories) dpiaDataCategories.value = '';
                const dpiaRiskAssessment = document.getElementById('dpiaRiskAssessment');
                if (dpiaRiskAssessment) dpiaRiskAssessment.value = '';

                // Clear editing state
                window.editingDpiaId = null;

                // Hide form and show list
                console.log(' Calling showDpiasView()');
                showDpiasView();
                console.log(' Calling showDpias() with filter:', currentFilter || 'draft');
                showDpias(currentFilter || 'draft');
                console.log(' DPIA cancel completed successfully');
            } catch (error) {
                console.error(' Error in cancelDpiaCreation:', error);
            }
        }

        // DPIA module functions
        function saveDpiaAsDraft() {
            if (!validateDpiaForm()) return;

            const dpiaData = collectDpiaData();
            dpiaData.status = 'draft';

            // Check if editing existing DPIA
            if (window.editingDpiaId) {
                dpiaData.id = window.editingDpiaId;
                sendToWixDatabase(dpiaData, 'UPDATE_DPIA');
                showToast(`DPIA "${dpiaData.name}" updated!`);
            } else {
                dpiaData.id = Date.now(); // Generate simple ID
                dpiaData.createdAt = new Date().toISOString();
                sendToWixDatabase(dpiaData, 'SAVE_DPIA_DRAFT');
                showToast(`DPIA "${dpiaData.name}" saved as draft!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetDpiaFormAndShowList();
        }

        function publishDpia() {
            if (!validateDpiaForm()) return;

            const dpiaData = collectDpiaData();
            dpiaData.status = 'published';
            dpiaData.publishedAt = new Date().toISOString();

            // Check if editing existing DPIA
            if (window.editingDpiaId) {
                dpiaData.id = window.editingDpiaId;
                sendToWixDatabase(dpiaData, 'UPDATE_DPIA');
                showToast(`DPIA "${dpiaData.name}" updated and published!`);
            } else {
                dpiaData.id = Date.now(); // Generate simple ID
                dpiaData.createdAt = new Date().toISOString();
                sendToWixDatabase(dpiaData, 'PUBLISH_DPIA');
                showToast(`DPIA "${dpiaData.name}" published to all users!`);
            }

            // Reset form and show list (data will be reloaded from database)
            resetDpiaFormAndShowList();
        }

        function assignDpia() {
            if (!validateDpiaForm()) return;

            // Store DPIA data for assignment
            const dpiaData = collectDpiaData();
            dpiaData.status = 'assigned';

            // Check if editing existing DPIA
            if (window.editingDpiaId) {
                dpiaData.id = window.editingDpiaId;
            } else {
                dpiaData.id = Date.now();
                dpiaData.createdAt = new Date().toISOString();
            }

            window.assigningDpiaData = dpiaData;

            // Set modal title for DPIA assignment
            document.getElementById('assignModalTitle').textContent = 'Assign DPIA';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        // Functions for handling button clicks from DPIA list
        function editDpia(dpiaId) {
            console.log('Edit DPIA called with ID:', dpiaId);
            const dpia = allDpias.find(d => d.id === dpiaId);
            if (!dpia) {
                console.error('DPIA not found with ID:', dpiaId);
                alert('DPIA not found!');
                return;
            }

            // Populate form with DPIA data
            document.getElementById('dpiaName').value = dpia.name;
            document.getElementById('dpiaDepartment').value = dpia.department || '';
            document.getElementById('dpiaActivity').value = dpia.activity || '';
            document.getElementById('dpiaRisk').value = dpia.risk || '';
            document.getElementById('dpiaProgress').value = dpia.progress || '';

            // Store editing ID for update
            window.editingDpiaId = dpiaId;

            // Show form
            showCreateDpiaForm();
        }

        function publishDpiaFromList(dpiaId) {
            console.log('Publish DPIA called with ID:', dpiaId);
            const dpia = allDpias.find(d => d.id === dpiaId);
            if (!dpia) {
                console.error('DPIA not found with ID:', dpiaId);
                alert('DPIA not found!');
                return;
            }

            if (confirm(`Are you sure you want to publish "${dpia.name}" to all users?`)) {
                dpia.status = 'published';
                dpia.publishedAt = new Date().toISOString();

                sendToWixDatabase(dpia, 'UPDATE_DPIA');

                const index = allDpias.findIndex(d => d.id === dpiaId);
                if (index !== -1) {
                    allDpias[index] = dpia;
                }

                showDpias(currentFilter);
                showToast(`"${dpia.name}" has been published!`);
            }
        }

        function assignDpiaFromList(dpiaId) {
            console.log('Assign DPIA called with ID:', dpiaId);
            const dpia = allDpias.find(d => d.id === dpiaId);
            if (!dpia) {
                console.error('DPIA not found with ID:', dpiaId);
                alert('DPIA not found!');
                return;
            }

            window.assigningDpiaId = dpiaId;
            document.getElementById('assignModalTitle').textContent = 'Assign DPIA';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        function validateDpiaForm() {
            const name = document.getElementById('dpiaName').value.trim();
            const department = document.getElementById('dpiaDepartment').value.trim();
            const date = document.getElementById('dpiaDate').value;
            const activity = document.getElementById('dpiaActivity').value.trim();
            const dataCategories = document.getElementById('dpiaDataCategories').value.trim();
            const riskAssessment = document.getElementById('dpiaRiskAssessment').value.trim();

            if (!name) {
                showToast('Please enter a DPIA name', 'error');
                document.getElementById('dpiaName').focus();
                return false;
            }
            if (!department) {
                showToast('Please enter a department', 'error');
                return false;
            }
            if (!date) {
                showToast('Please select a date', 'error');
                return false;
            }
            if (!activity) {
                showToast('Please enter processing activity', 'error');
                return false;
            }
            if (!dataCategories) {
                showToast('Please enter data categories', 'error');
                return false;
            }
            if (!riskAssessment) {
                showToast('Please enter risk assessment', 'error');
                return false;
            }
            return true;
        }

        function collectDpiaData() {
            return {
                id: Date.now(),
                name: document.getElementById('dpiaName').value,
                department: document.getElementById('dpiaDepartment').value,
                date: document.getElementById('dpiaDate').value,
                risk: document.getElementById('dpiaRisk').value,
                reviewer: document.getElementById('dpiaReviewer').value,
                progress: parseInt(document.getElementById('dpiaProgress').value),
                status: document.getElementById('dpiaStatus').value,
                activity: document.getElementById('dpiaActivity').value,
                dataCategories: document.getElementById('dpiaDataCategories').value,
                riskAssessment: document.getElementById('dpiaRiskAssessment').value,
                createdAt: new Date().toISOString()
            };
        }

        function resetDpiaFormAndShowList() {
            // Clear form
            document.getElementById('dpiaName').value = '';
            document.getElementById('dpiaDepartment').value = '';
            document.getElementById('dpiaDate').value = '';
            document.getElementById('dpiaRisk').value = 'Low';
            document.getElementById('dpiaReviewer').value = '';
            document.getElementById('dpiaProgress').value = '0';
            document.getElementById('dpiaStatus').value = 'Not Started';
            document.getElementById('dpiaActivity').value = '';
            document.getElementById('dpiaDataCategories').value = '';
            document.getElementById('dpiaRiskAssessment').value = '';

            // Clear editing state
            window.editingDpiaId = null;

            // Hide form and show list
            showDpiasView();
            showDpias(currentFilter);
        }

        // Helper function to calculate risk level
        function calculateRiskLevel(likelihood, impact) {
            const levels = {
                'Very Low': 1, 'Low': 2, 'Medium': 3, 'High': 4, 'Critical': 5
            };

            const likelihoodScore = levels[likelihood] || 0;
            const impactScore = levels[impact] || 0;
            const score = likelihoodScore * impactScore;

            if (score <= 4) return 'Low';
            if (score <= 9) return 'Medium';
            if (score <= 16) return 'High';
            return 'Critical';
        }

        // Helper function to get color based on score (1-5)
        function getScoreColor(score) {
            const numScore = parseFloat(score);
            if (numScore === 1) return 'red';
            if (numScore === 2) return 'orange';
            if (numScore === 3) return 'yellow';
            if (numScore === 4) return 'blue';
            if (numScore === 5) return 'green';
            return 'gray';
        }

        // Function to update risk level when likelihood or impact changes
        function updateRiskLevel() {
            const likelihood = document.getElementById('riskLikelihood').value;
            const impact = document.getElementById('riskImpact').value;

            if (likelihood && impact) {
                const level = calculateRiskLevel(likelihood, impact);
                document.getElementById('riskLevel').value = level;
            }
        }

        // ========================================
        // REPORTS MODULE FUNCTIONS
        // ========================================

        /**
         * Loads report data from Wix database
         */
        function loadReports() {
            console.log(' Loading reports from Wix database...');

            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadReports' }, '*');
            } else {
                console.log(' Not in Wix environment - no reports available');
                handleReportsLoaded([]);
            }
        }

        function loadLogo() {
            console.log(' Loading logo from admin.js...');

            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadLogo' }, '*');
            } else {
                console.log(' Not in Wix environment - using default logo');
                // Set a default logo for testing
                const logoImg = document.getElementById('reportLogoImage');
                if (logoImg) {
                    logoImg.src = 'https://static.wixstatic.com/media/4a2e79_351f0a60259e4bf8805bb34f2eb943b1~mv2.png';
                }
            }
        }

        /**
         * Handles loaded reports data from Wix database
         */
        function handleReportsLoaded(reports) {
            allReports = reports;
            console.log(' Reports loaded:', reports.length);
            console.log(' Full reports data:', JSON.stringify(reports, null, 2));
            showReports(currentFilter);
        }

        function showReports(filter) {
            currentFilter = filter;

            // Update button states
            document.querySelectorAll('#reportsModule .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(filter === 'all' ? 'allReportsBtn' :
                                   filter === 'recent' ? 'recentReportsBtn' : 'highRiskReportsBtn').classList.add('active');

            // Filter reports
            let filteredReports = allReports;
            if (filter === 'recent') {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                filteredReports = allReports.filter(report => new Date(report.generatedAt) >= oneWeekAgo);
            } else if (filter === 'high-risk') {
                filteredReports = allReports.filter(report =>
                    report.identifiedRisks && report.identifiedRisks.length > 0
                );
            }

            // Hide loading message
            document.getElementById('reportsLoadingMessage').classList.add('d-none');

            // Show/hide no reports message
            const noReportsMsg = document.getElementById('noReportsMessage');
            if (filteredReports.length === 0) {
                noReportsMsg.classList.remove('d-none');
            } else {
                noReportsMsg.classList.add('d-none');
            }

            renderReports(filteredReports);
        }

        function renderReports(reports) {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '';

            console.log(' Rendering reports:');
            reports.forEach((report, index) => {
                console.log(`  Report ${index + 1}:`, {
                    id: report._id,
                    submissionId: report.submissionId,
                    assessmentId: report.assessmentId,
                    title: report.assessmentTitle,
                    score: report.overallScore,
                    risks: report.identifiedRisks.length,
                    userId: report.userId
                });
                const reportCard = createReportCard(report);
                container.appendChild(reportCard);
            });
        }

        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = 'col-12 col-md-6 col-lg-4 mb-4';

            const riskCount = report.identifiedRisks ? report.identifiedRisks.length : 0;
            const riskBadge = riskCount > 0 ?
                `<span class="badge" style="background-color: red !important; color: white !important;">${riskCount} risks</span>` :
                '<span class="badge" style="background-color: green !important; color: white !important;">No risks</span>';

            // Get color based on score
            const scoreColor = getScoreColor(report.overallScore);
            const scoreColorMap = {
                'red': '#dc3545',
                'orange': '#fd7e14',
                'yellow': '#ffc107',
                'blue': '#0d6efd',
                'green': '#198754'
            };
            const scoreColorHex = scoreColorMap[scoreColor] || '#6c757d';

            card.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">${report.assessmentTitle || 'Assessment Report'}</h6>
                            ${riskBadge}
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Overall Score</span>
                                <span class="badge" style="background-color: ${scoreColorHex} !important; color: white !important;">${report.overallScore}/5</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="background-color: ${scoreColorHex} !important; width: ${(report.overallScore / 5) * 100}%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i> ${new Date(report.generatedAt).toLocaleDateString()}
                            </small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewReport('${report._id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="viewAssessmentResultsFromReport('${report.submissionId}', '${report.assessmentId}', '${report.assessmentTitle}')">
                                <i class="fas fa-chart-line"></i> Results
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="downloadReport('${report._id}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        function refreshReports() {
            loadReports();
        }

        function viewReport(reportId) {
            const report = allReports.find(r => r._id === reportId);
            if (!report) {
                alert('Report not found!');
                return;
            }

            // Create modal to display report content
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-file-alt me-2"></i>Assessment Report - ${report.assessmentTitle || 'N/A'}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-0">
                            <div class="report-header text-center py-4" style="background: linear-gradient(135deg, #1e4f73 0%, #2c5f8a 100%); color: white;">
                                <div class="report-logo mb-3">
                                    <img id="reportLogoImage" src="" alt="Cyber Wheelhouse" class="report-logo-image"
                                         style="max-height: 60px; max-width: 200px;"
                                         onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';"
                                         onload="this.style.display='block'; document.getElementById('logoFallback').style.display='none';" />
                                    <div id="logoFallback" style="display: block; font-size: 24px; font-weight: bold;">
                                        Cyber Wheelhouse
                                        <div style="font-size: 14px; font-weight: normal; opacity: 0.9;">
                                            Information Security and Data Privacy Specialists
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="info-card p-3 bg-light rounded">
                                            <h6 class="text-muted mb-1">Generated</h6>
                                            <p class="mb-0 fw-bold">${new Date(report.generatedAt).toLocaleDateString('en-GB', {
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-card p-3 bg-light rounded">
                                            <h6 class="text-muted mb-1">Overall Score</h6>
                                            <p class="mb-0 fw-bold text-primary fs-4">${report.overallScore}/5</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-content-container">
                                    <div class="report-content" style="white-space: pre-wrap; line-height: 1.6; max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; background: #fafafa;">
                                        ${report.reportContent || 'No report content available.'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Close
                            </button>
                            <button type="button" class="btn btn-primary" onclick="downloadReport('${reportId}')">
                                <i class="fas fa-download me-1"></i>Download Report
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // Load logo after modal is shown
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadLogo' }, '*');
            }

            // Remove modal from DOM when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function downloadReport(reportId) {
            console.log(' Downloading report with ID:', reportId);

            if (window.parent && window.parent !== window) {
                // Show loading toast
                showToast('Preparing report download...', 'info');

                window.parent.postMessage({
                    action: 'downloadReport',
                    payload: { reportId: reportId }
                }, '*');
            } else {
                // Fallback for testing - download the report content directly
                const report = allReports.find(r => r._id === reportId);
                if (report && report.reportContent) {
                    const filename = `assessment-report-${report.assessmentTitle || 'report'}.txt`;
                    downloadTextFile(report.reportContent, filename);
                    showToast('Report downloaded successfully!', 'success');
                } else {
                    showToast('Report content not available for download.', 'error');
                }
            }
        }

        // Download file helper function (supports both text and HTML)
        function downloadTextFile(content, filename) {
            // Determine MIME type based on file extension
            const mimeType = filename.endsWith('.html') ? 'text/html' : 'text/plain';

            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Add event listeners for risk level calculation
        document.addEventListener('DOMContentLoaded', function() {
            const likelihoodSelect = document.getElementById('riskLikelihood');
            const impactSelect = document.getElementById('riskImpact');

            if (likelihoodSelect) {
                likelihoodSelect.addEventListener('change', updateRiskLevel);
            }
            if (impactSelect) {
                impactSelect.addEventListener('change', updateRiskLevel);
            }
        });

        // Add this below all functions inside <script>
        window.addEventListener('message', (event) => {
          const { action, payload, success } = event.data || {};

          if (action === 'loadMembers' && Array.isArray(payload)) {
            const listContainer = document.querySelector('.members-list .list-group');
            listContainer.innerHTML = ''; // Clear existing

            payload.forEach(member => {
              const item = document.createElement('div');
              item.className = 'list-group-item';
              item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-0">${member.name}</h6>
                    <small class="text-muted">${member.email}</small>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${member.id}" onchange="updateSelectedCount()">
                  </div>
                </div>
              `;
              listContainer.appendChild(item);
            });

            // Initialize the button state after loading members
            updateSelectedCount();
          }

          if (action === 'assessmentsLoaded' && Array.isArray(payload)) {
            handleAssessmentsLoaded(payload);
          }

          // Handle loaded data for other modules
          if (action === 'risksLoaded' && Array.isArray(payload)) {
            handleRisksLoaded(payload);
          }

          if (action === 'assetsLoaded' && Array.isArray(payload)) {
            handleAssetsLoaded(payload);
          }

          if (action === 'frameworksLoaded' && Array.isArray(payload)) {
            handleFrameworksLoaded(payload);
          }

          if (action === 'dpiasLoaded' && Array.isArray(payload)) {
            handleDpiasLoaded(payload);
          }

          if (action === 'reportsLoaded' && Array.isArray(payload)) {
            handleReportsLoaded(payload);
          }

          // Handle logo loaded
          if (action === 'logoLoaded' && payload) {
            console.log(' Logo loaded:', payload.logoUrl);
            const logoImg = document.getElementById('reportLogoImage');
            const logoFallback = document.getElementById('logoFallback');

            if (logoImg && payload.logoUrl) {
              logoImg.src = payload.logoUrl;
              logoImg.onerror = function() {
                console.warn(' Logo failed to load, showing fallback text');
                this.style.display = 'none';
                if (logoFallback) logoFallback.style.display = 'block';
              };
              logoImg.onload = function() {
                console.log(' Logo image loaded successfully');
                this.style.display = 'block';
                if (logoFallback) logoFallback.style.display = 'none';
              };
            } else if (logoFallback) {
              // If no logo URL, show fallback
              logoFallback.style.display = 'block';
            }
          }

          // Handle report download
          if (action === 'downloadReportContent') {
            console.log(' Received report content for download:', payload.filename);
            downloadTextFile(payload.content, payload.filename);
            showToast('Report downloaded successfully!', 'success');
          }

          // Handle database operation responses
          if (action === 'assessmentUpdated' && success) {
            console.log('Assessment updated successfully in database');
            // Reload assessments to get fresh data
            loadAssessments();
          }

          if (action === 'assessmentCreated' && success) {
            console.log('Assessment created successfully in database');
            // Add the new assessment to local array
            if (payload) {
              allAssessments.push(payload);
              showAssessments(currentFilter);
            }
          }

          if (action === 'assessmentPublished' && success) {
            console.log('Assessment published successfully in database');
            // Reload assessments to get fresh data
            loadAssessments();
          }

          if (action === 'assessmentDeleted' && success) {
            console.log('Assessment deleted successfully from database');
            // Remove the assessment from local array
            if (payload && payload.id) {
              const index = allAssessments.findIndex(a => a.id === payload.id);
              if (index !== -1) {
                const deletedAssessment = allAssessments[index];
                allAssessments.splice(index, 1);
                showToast(`"${deletedAssessment.name}" has been deleted successfully.`);
                showAssessments(currentFilter);
              }
            }
            // Also reload assessments to ensure consistency
            loadAssessments();
          }

          if (action === 'assessmentDeleted' && !success) {
            console.error('Failed to delete assessment:', error);
            showToast(`Failed to delete assessment: ${error || 'Unknown error'}`, 'error');
          }

          if (action === 'assessmentCopied' && success) {
            console.log('Assessment copied successfully:', payload);
            showToast(payload.message || 'Assessment copied successfully!', 'success');
            // Reload assessments to show the new copy
            loadAssessments();
            // Switch to draft view to show the copied assessment
            showAssessments('draft');
          }

          if (action === 'assessmentCopied' && !success) {
            console.error('Failed to copy assessment:', error);
            showToast(`Failed to copy assessment: ${error || 'Unknown error'}`, 'error');
          }

          if (action === 'assessmentAssigned' && success) {
            console.log('Assessment assigned successfully in database');
            // Reload assessments to get fresh data
            loadAssessments();
          }

          // Handle assessment results response
          if (action === 'assessmentResultsLoaded') {
            console.log('Assessment results loaded:', payload);
            if (success && payload) {
              populateAssessmentResults(payload);
            } else {
              // Show no results state
              document.getElementById('resultsLoadingState').classList.add('d-none');
              document.getElementById('noResultsState').classList.remove('d-none');
            }
          }

          // ========================================
          // RISK MODULE RESPONSES
          // ========================================
          if (action === 'riskCreated' && success) {
            console.log(' Risk created successfully in database');
            loadRisks();
          }

          if (action === 'riskCreated' && !success) {
            console.error(' Failed to create risk:', event.data.error);
            showToast(`Failed to create risk: ${event.data.error || 'Unknown error'}`, 'error');
          }

          // ========================================
          // ASSET MODULE RESPONSES
          // ========================================
          if (action === 'assetCreated' && success) {
            console.log(' Asset created successfully in database');
            loadAssets();
          }

          if (action === 'assetCreated' && !success) {
            console.error(' Failed to create asset:', event.data.error);
            showToast(`Failed to create asset: ${event.data.error || 'Unknown error'}`, 'error');
          }

          // ========================================
          // FRAMEWORK MODULE RESPONSES
          // ========================================
          if (action === 'frameworkCreated' && success) {
            console.log(' Framework created successfully in database');
            loadFrameworks();
          }

          if (action === 'frameworkCreated' && !success) {
            console.error(' Failed to create framework:', event.data.error);
            showToast(`Failed to create framework: ${event.data.error || 'Unknown error'}`, 'error');
          }

          // ========================================
          // DPIA MODULE RESPONSES
          // ========================================
          if (action === 'dpiaCreated' && success) {
            console.log(' DPIA created successfully in database');
            loadDpias();
          }

          if (action === 'dpiaCreated' && !success) {
            console.error(' Failed to create DPIA:', event.data.error);
            showToast(`Failed to create DPIA: ${event.data.error || 'Unknown error'}`, 'error');
          }
        });

        // Assessment action functions
        function editAssessment(assessmentId) {
            console.log('Edit assessment called with ID:', assessmentId);
            console.log('All assessments:', allAssessments);

            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found with ID:', assessmentId);
                alert('Assessment not found!');
                return;
            }

            console.log('Found assessment:', assessment);

            // Hide assessments container and show create form
            document.getElementById('assessmentsContainer').style.display = 'none';
            document.getElementById('createAssessmentForm').classList.remove('hidden');
            document.querySelector('.add-question-btn').classList.remove('hidden');

            // Show action buttons for editing
            document.getElementById('assessmentActionButtons').classList.remove('hidden');

            // Populate form with assessment data
            document.getElementById('assessmentName').value = assessment.name;
            document.getElementById('assessmentDayOfCompletion').value = assessment.dayOfCompletion || assessment.date || '';
            document.getElementById('assessmentEndDate').value = assessment.endDate || '';
            document.getElementById('assessmentDescription').value = assessment.description;

            // Clear existing questions and add assessment questions
            document.getElementById('questionsContainer').innerHTML = '';
            questionCount = 0;

            if (assessment.questions && assessment.questions.length > 0) {
                assessment.questions.forEach(question => {
                    addQuestionFromData(question);
                });
            }

            // Store the assessment ID for updating
            window.editingAssessmentId = assessmentId;
        }

        function addQuestionFromData(questionData) {
            questionCount++;
            const questionsContainer = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-container';

            let optionsHtml = '';
            if (questionData.answerType === 'exact') {
                optionsHtml = `
                    <div class="mb-3">
                        <label class="form-label">Exact Answer</label>
                        <div class="answer-option">
                            <input type="text" class="form-control" value="${questionData.options[0]?.text || ''}" required>
                        </div>
                        <small class="text-muted">The answer must match exactly (case-sensitive)</small>
                    </div>
                `;
            } else {
                const inputType = questionData.answerType === 'multiple' ? 'checkbox' : 'radio';
                const labelText = questionData.answerType === 'multiple' ? 'Answer Options (Select all that apply)' : 'Answer Options (Select one)';

                optionsHtml = `<div class="mb-3"><label class="form-label">${labelText}</label>`;
                questionData.options.forEach((option, index) => {
                    const deleteButtonDisplay = questionData.options.length > 1 ? 'block' : 'none';
                    optionsHtml += `
                        <div class="answer-option">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" value="${option.text}" placeholder="Option ${index + 1}">
                                <div class="form-check">
                                    <input type="${inputType}" class="form-check-input" name="correct${questionCount}" value="${index}" ${option.isCorrect ? 'checked' : ''}>
                                    <label class="form-check-label">Correct</label>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnswerOption(this)" style="display: ${deleteButtonDisplay};" title="Delete this option">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                optionsHtml += '</div>';
            }

            questionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Question ${questionCount}</h4>
                    <button class="btn btn-danger btn-sm" onclick="removeQuestion(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Domain Name</label>
                    <input type="text" class="form-control" name="domainName" value="${questionData.domainName || ''}" placeholder="e.g., Security, Compliance, Risk Management">
                </div>
                <div class="mb-3">
                    <label class="form-label">Question Text</label>
                    <input type="text" class="form-control" name="questionText" value="${questionData.questionText}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Answer Type</label>
                    <select class="form-select" onchange="handleAnswerTypeChange(this)">
                        <option value="single" ${questionData.answerType === 'single' ? 'selected' : ''}>Single Choice</option>
                        <option value="multiple" ${questionData.answerType === 'multiple' ? 'selected' : ''}>Multiple Choice</option>
                        <option value="exact" ${questionData.answerType === 'exact' ? 'selected' : ''}>Exact Answer</option>
                    </select>
                </div>
                <div class="answer-options">
                    ${optionsHtml}
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-secondary btn-sm" onclick="addAnswerOption(this)">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
            `;
            questionsContainer.appendChild(questionDiv);
        }

        function publishAssessmentFromList(assessmentId) {
            console.log('Publish assessment called with ID:', assessmentId);
            console.log('All assessments:', allAssessments);

            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found with ID:', assessmentId);
                alert('Assessment not found!');
                return;
            }

            console.log('Found assessment for publishing:', assessment);

            if (confirm(`Are you sure you want to publish "${assessment.name}" to all users?`)) {
                // Update assessment status
                assessment.status = 'published';
                assessment.publishedAt = new Date().toISOString();

                // Send update to Wix database
                sendToWixDatabase(assessment, 'UPDATE_ASSESSMENT');

                // Update local array
                const index = allAssessments.findIndex(a => a.id === assessmentId);
                if (index !== -1) {
                    allAssessments[index] = assessment;
                }

                // Refresh current view
                showAssessments(currentFilter);

                // Show toast notification with guidance
                showToast(`"${assessment.name}" has been published! Click the "Published" tab to view it.`);
            }
        }

        function assignAssessmentFromList(assessmentId) {
            console.log('Assign assessment called with ID:', assessmentId);
            console.log('All assessments:', allAssessments);

            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found with ID:', assessmentId);
                alert('Assessment not found!');
                return;
            }

            console.log('Found assessment for assignment:', assessment);

            window.assigningAssessmentId = assessmentId;

            // Set modal title for assessment assignment
            document.getElementById('assignModalTitle').textContent = 'Assign Assessment';

            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        function copyAssessmentFromList(assessmentId) {
            console.log('Copy assessment called with ID:', assessmentId);
            console.log('All assessments:', allAssessments);

            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found with ID:', assessmentId);
                alert('Assessment not found!');
                return;
            }

            console.log('Found assessment for copying:', assessment);

            // Show confirmation dialog
            if (confirm(`Are you sure you want to create a copy of "${assessment.name}"? The copy will be created as a draft.`)) {
                // Send copy request to Wix database
                sendToWixDatabase({
                    assessmentId: assessment._id || assessment.id,
                    assessmentData: assessment
                }, 'COPY_ASSESSMENT');
            }
        }

        function deleteAssessmentFromList(assessmentId) {
            console.log('Delete assessment called with ID:', assessmentId);
            console.log('All assessments:', allAssessments);

            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found with ID:', assessmentId);
                alert('Assessment not found!');
                return;
            }

            console.log('Found assessment for deletion:', assessment);

            // Show confirmation dialog
            if (confirm(`Are you sure you want to delete "${assessment.name}"? This action cannot be undone.`)) {
                // Send delete request to Wix database using the standard function
                sendToWixDatabase({ assessmentId: assessmentId }, 'DELETE_ASSESSMENT');
            }
        }

        // View Assessment Results Function
        function viewAssessmentResults(assessmentId) {
            console.log('View assessment results called with ID:', assessmentId);

            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found with ID:', assessmentId);
                alert('Assessment not found!');
                return;
            }

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('assessmentResultsModal'));

            // Set assessment title
            document.getElementById('assessmentResultsTitle').textContent = `Results: ${assessment.name}`;

            // Show loading state
            document.getElementById('resultsLoadingState').classList.remove('d-none');
            document.getElementById('noResultsState').classList.add('d-none');
            document.getElementById('resultsContent').classList.add('d-none');

            modal.show();

            // Request assessment results from database
            console.log('Requesting assessment results for:', assessment._id || assessment.id);

            // Send request to database via parent window (Wix)
            window.parent.postMessage({
                action: 'getAssessmentResults',
                payload: {
                    assessmentId: assessment._id || assessment.id,
                    assessmentTitle: assessment.name
                }
            }, '*');
        }

        // View Assessment Results Function from Reports Section
        function viewAssessmentResultsFromReport(submissionId, assessmentId, assessmentTitle) {
            console.log('View assessment results called from Reports section with Submission ID:', submissionId, 'Assessment ID:', assessmentId, 'Title:', assessmentTitle);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('assessmentResultsModal'));

            // Set assessment title
            document.getElementById('assessmentResultsTitle').textContent = `Results: ${assessmentTitle}`;

            // Show loading state
            document.getElementById('resultsLoadingState').classList.remove('d-none');
            document.getElementById('noResultsState').classList.add('d-none');
            document.getElementById('resultsContent').classList.add('d-none');

            modal.show();

            // Request assessment results from database
            console.log('Requesting assessment results for submission:', submissionId);

            // Send request to database via parent window (Wix)
            window.parent.postMessage({
                action: 'getAssessmentResultsForSubmission',
                payload: {
                    submissionId: submissionId,
                    assessmentId: assessmentId,
                    assessmentTitle: assessmentTitle
                }
            }, '*');
        }

        // Function to populate assessment results modal
        function populateAssessmentResults(resultsData) {
            console.log('Populating assessment results:', resultsData);

            // Hide loading state
            document.getElementById('resultsLoadingState').classList.add('d-none');

            if (!resultsData || !resultsData.responses || resultsData.responses.length === 0) {
                // Show no results state
                document.getElementById('noResultsState').classList.remove('d-none');
                return;
            }

            // Show results content
            document.getElementById('resultsContent').classList.remove('d-none');

            // Populate assessment overview
            document.getElementById('resultAssessmentName').textContent = resultsData.assessmentTitle || 'Assessment';
            document.getElementById('resultAssessmentDescription').textContent = resultsData.description || 'No description available';

            // Calculate summary statistics using pre-calculated values from admin.js
            const responses = resultsData.responses;
            const totalQuestions = responses.length > 0 ? (responses[0].totalQuestions || responses[0].answers.length) : 0;
            let totalMaturityScore = 0;
            let totalRisksIdentified = 0;
            let completedResponses = 0;
            let latestSubmission = null;

            responses.forEach(response => {
                if (response.status === 'completed') {
                    completedResponses++;

                    // Use pre-calculated maturity score from admin.js
                    if (response.maturityScore !== undefined && response.maturityScore !== null) {
                        totalMaturityScore += response.maturityScore;
                        console.log(`Using pre-calculated maturity score for user ${response.userName}: ${response.maturityScore}`);
                    }

                    // Use pre-calculated risks from admin.js
                    if (response.risksIdentified && Array.isArray(response.risksIdentified)) {
                        totalRisksIdentified += response.risksIdentified.length;
                        console.log(`Using pre-calculated risks for user ${response.userName}: ${response.risksIdentified.length} risks`);
                    }

                    // Track latest submission
                    if (response.submittedAt) {
                        const submissionDate = new Date(response.submittedAt);
                        if (!latestSubmission || submissionDate > latestSubmission) {
                            latestSubmission = submissionDate;
                        }
                    }
                }
            });

            // Calculate average maturity score from pre-calculated values
            const avgMaturityScore = completedResponses > 0 ? (totalMaturityScore / completedResponses).toFixed(1) : 0;

            console.log(`Summary calculation: ${completedResponses} completed responses, total maturity: ${totalMaturityScore}, avg: ${avgMaturityScore}, total risks: ${totalRisksIdentified}`);

            // Update summary statistics
            document.getElementById('resultTotalQuestions').textContent = totalQuestions;

            // Update Maturity Score with color coding
            const maturityScoreElement = document.getElementById('resultMaturityScore');
            maturityScoreElement.textContent = `${avgMaturityScore}/5`;
            const maturityColor = getScoreColor(avgMaturityScore);
            maturityScoreElement.style.cssText = `color: ${maturityColor} !important;`;

            // Update Risks Identified with color coding
            const risksElement = document.getElementById('resultRisksIdentified');
            risksElement.textContent = totalRisksIdentified;
            const risksColor = totalRisksIdentified > 0 ? 'red' : 'green';
            risksElement.style.cssText = `color: ${risksColor} !important;`;

            document.getElementById('resultSubmissionDate').textContent = latestSubmission ?
                latestSubmission.toLocaleDateString() : 'Not submitted';

            // Update overall status
            const statusElement = document.getElementById('resultOverallStatus');
            if (completedResponses === responses.length) {
                statusElement.textContent = 'All Completed';
                statusElement.className = 'badge bg-success fs-6';
            } else if (completedResponses > 0) {
                statusElement.textContent = `${completedResponses}/${responses.length} Completed`;
                statusElement.className = 'badge bg-warning fs-6';
            } else {
                statusElement.textContent = 'Not Started';
                statusElement.className = 'badge bg-secondary fs-6';
            }

            // Populate user response tabs
            populateUserResponseTabs(responses);
        }

        // Function to populate user response tabs
        function populateUserResponseTabs(responses) {
            const tabsContainer = document.getElementById('responsesTabs');
            const tabContentContainer = document.getElementById('responsesTabContent');

            // Clear existing tabs
            tabsContainer.innerHTML = '';
            tabContentContainer.innerHTML = '';

            responses.forEach((response, index) => {
                const userId = response.userId || `user-${index + 1}`;
                const userName = response.userName || `User ${index + 1}`;
                const isActive = index === 0;

                // Create tab
                const tabId = `user-tab-${userId}`;
                const tabPaneId = `user-pane-${userId}`;

                const tab = document.createElement('li');
                tab.className = 'nav-item';
                tab.innerHTML = `
                    <button class="nav-link ${isActive ? 'active' : ''}" id="${tabId}" data-bs-toggle="tab"
                            data-bs-target="#${tabPaneId}" type="button" role="tab">
                        ${userName}
                        <span class="badge bg-${response.status === 'completed' ? 'success' : 'warning'} ms-2">
                            ${response.status === 'completed' ? 'Complete' : 'In Progress'}
                        </span>
                    </button>
                `;
                tabsContainer.appendChild(tab);

                // Create tab pane
                const tabPane = document.createElement('div');
                tabPane.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
                tabPane.id = tabPaneId;
                tabPane.setAttribute('role', 'tabpanel');

                // User info header
                let userInfoHtml = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">User Information</h6>
                            <p><strong>Name:</strong> ${userName}</p>
                            <p><strong>Status:</strong>
                                <span class="badge bg-${response.status === 'completed' ? 'success' : 'warning'}">
                                    ${response.status === 'completed' ? 'Completed' : 'In Progress'}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Progress Information</h6>
                            <p><strong>Progress:</strong> ${response.progress || 0}%</p>
                            <p><strong>Completed:</strong> ${response.completed || 0}/${response.totalQuestions || 0} questions</p>
                            ${response.submittedAt ? `<p><strong>Submitted:</strong> ${new Date(response.submittedAt).toLocaleString()}</p>` : ''}
                        </div>
                    </div>
                `;

                // Questions and answers
                let questionsHtml = '<h6 class="text-muted mb-3">Questions & Answers</h6>';

                if (response.answers && response.answers.length > 0) {
                    response.answers.forEach((answer, qIndex) => {
                        const question = answer.question;
                        const userAnswer = answer.answer;

                        let answerDisplay = '';
                        let answerClass = 'text-muted';

                        if (userAnswer === null || userAnswer === '') {
                            answerDisplay = '<em>Not answered</em>';
                            answerClass = 'text-warning';
                        } else if (Array.isArray(userAnswer)) {
                            answerDisplay = userAnswer.join(', ');
                            answerClass = 'text-success';
                        } else {
                            answerDisplay = userAnswer.toString();
                            answerClass = 'text-success';

                            // Special formatting for maturity scores
                            if (question.answerType === 'maturity') {
                                const score = parseInt(userAnswer);
                                const maturityLabels = {
                                    0: 'Not in place',
                                    1: 'Informal',
                                    2: 'Partially in place',
                                    3: 'Fully in place',
                                    4: 'Measured and monitored',
                                    5: 'Best practice'
                                };
                                answerDisplay = `${score}/5 - ${maturityLabels[score] || 'Unknown'}`;
                                answerClass = score < 3 ? 'text-danger' : score < 4 ? 'text-warning' : 'text-success';
                            }
                        }

                        questionsHtml += `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Question ${qIndex + 1}</h6>
                                    <p class="card-text">${question.questionText || question.text}</p>
                                    <div class="mt-2">
                                        <strong>Answer:</strong>
                                        <span class="${answerClass}">${answerDisplay}</span>
                                    </div>
                                    ${question.domain ? `<small class="text-muted">Domain: ${question.domain}</small>` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    questionsHtml += '<p class="text-muted">No answers recorded yet.</p>';
                }

                tabPane.innerHTML = userInfoHtml + questionsHtml;
                tabContentContainer.appendChild(tabPane);
            });
        }

        // Function to export assessment results
        function exportAssessmentResults() {
            // This would typically generate a report and download it
            // For now, we'll show a placeholder message
            alert('Export functionality will be implemented to generate detailed assessment reports.');
        }

        let questionCount = 0;

        function showCreateAssessmentForm() {
            // Hide all forms and only this module's action buttons
            hideAllForms();
            hideAssessmentActionButtons();

            // Show assessment form and action buttons
            document.getElementById('createAssessmentForm').classList.remove('hidden');
            document.getElementById('assessmentActionButtons').classList.remove('hidden');
            document.querySelector('.add-question-btn').classList.remove('hidden');
            document.getElementById('assessmentsContainer').style.display = 'none';

            // Clear editing state
            window.editingAssessmentId = null;
        }

        function addQuestion() {
            questionCount++;
            const questionsContainer = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-container';
            questionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Question ${questionCount}</h4>
                    <button class="btn btn-danger btn-sm" onclick="removeQuestion(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Domain Name</label>
                    <input type="text" class="form-control" name="domainName" placeholder="e.g., Security, Compliance, Risk Management">
                </div>
                <div class="mb-3">
                    <label class="form-label">Question Text</label>
                    <input type="text" class="form-control" name="questionText" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Answer Type</label>
                    <select class="form-select" onchange="handleAnswerTypeChange(this)">
                        <option value="single">Single Choice</option>
                        <option value="multiple">Multiple Choice</option>
                        <option value="exact">Exact Answer</option>
                    </select>
                </div>
                <div class="answer-options">
                    <div class="mb-3">
                        <label class="form-label">Answer Options (Select one)</label>
                        <div class="answer-option">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" placeholder="Option 1">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="correct${questionCount}" value="0">
                                    <label class="form-check-label">Correct</label>
                                </div>
                            </div>
                        </div>
                        <div class="answer-option">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" placeholder="Option 2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="correct${questionCount}" value="1">
                                    <label class="form-check-label">Correct</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-secondary btn-sm" onclick="addAnswerOption(this)">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
            `;
            questionsContainer.appendChild(questionDiv);
        }

        function handleAnswerTypeChange(selectElement) {
            const answerOptions = selectElement.closest('.question-container').querySelector('.answer-options');
            const questionNumber = selectElement.closest('.question-container').querySelector('h4').textContent.split(' ')[1];

            if (selectElement.value === 'multiple') {
                answerOptions.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">Answer Options (Select all that apply)</label>
                        <div class="answer-option">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" placeholder="Option 1">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="correct${questionNumber}" value="0">
                                    <label class="form-check-label">Correct</label>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnswerOption(this)" style="display: none;" title="Delete this option">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="answer-option">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" placeholder="Option 2">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="correct${questionNumber}" value="1">
                                    <label class="form-check-label">Correct</label>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnswerOption(this)" style="display: none;" title="Delete this option">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (selectElement.value === 'exact') {
                answerOptions.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">Exact Answer</label>
                        <div class="answer-option">
                            <input type="text" class="form-control" placeholder="Enter the exact correct answer" required>
                        </div>
                        <small class="text-muted">The answer must match exactly (case-sensitive)</small>
                    </div>
                `;
            } else {
                // Single choice (radio buttons)
                answerOptions.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">Answer Options (Select one)</label>
                        <div class="answer-option">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" placeholder="Option 1">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="correct${questionNumber}" value="0">
                                    <label class="form-check-label">Correct</label>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnswerOption(this)" style="display: none;" title="Delete this option">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="answer-option">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" placeholder="Option 2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="correct${questionNumber}" value="1">
                                    <label class="form-check-label">Correct</label>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnswerOption(this)" style="display: none;" title="Delete this option">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function addAnswerOption(button) {
            const questionContainer = button.closest('.question-container');
            const answerOptions = questionContainer.querySelector('.answer-options');
            const optionCount = answerOptions.querySelectorAll('.answer-option').length;
            const questionNumber = questionContainer.querySelector('h4').textContent.split(' ')[1];
            const answerType = questionContainer.querySelector('select').value;

            if (answerType === 'exact') {
                return; // Don't add more options for exact answer type
            }

            const newOption = document.createElement('div');
            newOption.className = 'answer-option';
            const inputType = answerType === 'multiple' ? 'checkbox' : 'radio';

            newOption.innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    <input type="text" class="form-control" placeholder="Option ${optionCount + 1}">
                    <div class="form-check">
                        <input type="${inputType}" class="form-check-input" name="correct${questionNumber}" value="${optionCount}">
                        <label class="form-check-label">Correct</label>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAnswerOption(this)" title="Delete this option">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            answerOptions.appendChild(newOption);

            // Update delete buttons visibility for all options
            updateOptionDeleteButtons(questionContainer);
        }

        function removeAnswerOption(button) {
            const questionContainer = button.closest('.question-container');
            const answerOptions = questionContainer.querySelector('.answer-options');
            const optionCount = answerOptions.querySelectorAll('.answer-option').length;

            // Don't allow deletion if only 1 option remains
            if (optionCount <= 1) {
                showToast('At least one option must remain', 'error');
                return;
            }

            button.closest('.answer-option').remove();

            // Update delete buttons visibility for remaining options
            updateOptionDeleteButtons(questionContainer);
        }

        function updateOptionDeleteButtons(questionContainer) {
            const answerOptions = questionContainer.querySelector('.answer-options');
            const optionCount = answerOptions.querySelectorAll('.answer-option').length;
            const deleteButtons = answerOptions.querySelectorAll('button[onclick="removeAnswerOption(this)"]');

            // Show delete buttons only if there are more than 1 option
            deleteButtons.forEach(btn => {
                if (optionCount > 1) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            });
        }

        function removeQuestion(button) {
            button.closest('.question-container').remove();
        }

        // Function to collect all assessment data
         function collectAssessmentData() {
        const name = document.getElementById('assessmentName').value;
        const dayOfCompletion = document.getElementById('assessmentDayOfCompletion').value;
        const endDate = document.getElementById('assessmentEndDate').value;
        const description = document.getElementById('assessmentDescription').value;

        const questions = Array.from(document.querySelectorAll('.question-container')).map((qEl, i) => {
            const domainName = qEl.querySelector('[name="domainName"]').value;
            const questionText = qEl.querySelector('[name="questionText"]').value;
            const answerType = qEl.querySelector('select').value;

            let options = [];
            if (answerType === 'exact') {
                const answer = qEl.querySelector('input[type="text"]').value;
                options.push({ text: answer, isCorrect: true });
            } else {
                const opts = qEl.querySelectorAll('.answer-option');
                opts.forEach((opt, idx) => {
                    const input = opt.querySelector('input[type="text"]');
                    const answerInput = opt.querySelector('input[type="radio"], input[type="checkbox"]');
                    if (input && answerInput) {
                        options.push({
                            text: input.value,
                            isCorrect: answerInput.checked
                        });
                    }
                });
            }

            return { domainName, questionText, answerType, options };
        });

        return { name, dayOfCompletion, endDate, description, questions };
    }

        // Function to send data to Wix database via postMessage
        function sendToWixDatabase(data, action) {
            const message = {
                type: 'ASSESSMENT_ACTION',
                action: action,
                data: data,
                timestamp: new Date().toISOString()
            };

            // Map actions to specific postMessage actions
            let postMessageAction = action;
            switch(action) {
                // Assessment actions
                case 'SAVE_DRAFT':
                    postMessageAction = 'saveDraft';
                    break;
                case 'PUBLISH':
                    postMessageAction = 'publishAssessment';
                    break;
                case 'UPDATE_ASSESSMENT':
                    postMessageAction = 'updateAssessment';
                    break;
                case 'ASSIGN_TO_USERS':
                    postMessageAction = 'assignAssessment';
                    break;
                case 'DELETE_ASSESSMENT':
                    postMessageAction = 'deleteAssessment';
                    break;
                case 'COPY_ASSESSMENT':
                    postMessageAction = 'copyAssessment';
                    break;

                // Risk actions
                case 'SAVE_RISK_DRAFT':
                    postMessageAction = 'saveRiskDraft';
                    break;
                case 'PUBLISH_RISK':
                    postMessageAction = 'publishRisk';
                    break;
                case 'UPDATE_RISK':
                    postMessageAction = 'updateRisk';
                    break;
                case 'ASSIGN_RISK':
                    postMessageAction = 'assignRisk';
                    break;

                // Asset actions
                case 'SAVE_ASSET_DRAFT':
                    postMessageAction = 'saveAssetDraft';
                    break;
                case 'PUBLISH_ASSET':
                    postMessageAction = 'publishAsset';
                    break;
                case 'UPDATE_ASSET':
                    postMessageAction = 'updateAsset';
                    break;
                case 'ASSIGN_ASSET':
                    postMessageAction = 'assignAsset';
                    break;

                // Control actions
                case 'SAVE_FRAMEWORK_DRAFT':
                    postMessageAction = 'saveFrameworkDraft';
                    break;
                case 'PUBLISH_FRAMEWORK':
                    postMessageAction = 'publishFramework';
                    break;
                case 'UPDATE_FRAMEWORK':
                    postMessageAction = 'updateFramework';
                    break;
                case 'ASSIGN_FRAMEWORK':
                    postMessageAction = 'assignFramework';
                    break;

                // DPIA actions
                case 'SAVE_DPIA_DRAFT':
                    postMessageAction = 'saveDpiaDraft';
                    break;
                case 'PUBLISH_DPIA':
                    postMessageAction = 'publishDpia';
                    break;
                case 'UPDATE_DPIA':
                    postMessageAction = 'updateDpia';
                    break;
                case 'ASSIGN_DPIA':
                    postMessageAction = 'assignDpia';
                    break;

                default:
                    postMessageAction = 'saveAssessment';
            }

            // Send message to parent window (Wix)
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                action: postMessageAction,
                payload: data
              }, '*');
            } else {
                // For testing purposes when not in iframe
                console.log('PostMessage would send:', {
                    action: postMessageAction,
                    payload: data
                });

                // Simulate successful response for testing
                setTimeout(() => {
                    let responseAction;
                    if (postMessageAction === 'updateAssessment') {
                        responseAction = 'assessmentUpdated';
                    } else if (postMessageAction === 'deleteAssessment') {
                        responseAction = 'assessmentDeleted';
                    } else if (postMessageAction === 'copyAssessment') {
                        responseAction = 'assessmentCopied';
                    } else {
                        responseAction = 'assessmentCreated';
                    }

                    window.dispatchEvent(new MessageEvent('message', {
                        data: {
                            action: responseAction,
                            success: true,
                            payload: data
                        }
                    }));
                }, 500);
            }
        }

        function saveAsDraft() {
            // Use mobile-optimized validation
            if (!validateMobileForm()) {
                return;
            }

            const assessmentData = collectAssessmentData();
            if (!assessmentData) return;

            assessmentData.status = 'draft';

            // Check if we're editing an existing assessment
            if (window.editingAssessmentId) {
                assessmentData.id = window.editingAssessmentId;
                sendToWixDatabase(assessmentData, 'UPDATE_ASSESSMENT');
                showToast(`"${assessmentData.name}" has been updated successfully!`);
            } else {
                // Creating new assessment
                assessmentData.id = Date.now(); // Generate simple ID
                assessmentData.createdAt = new Date().toISOString();
                sendToWixDatabase(assessmentData, 'SAVE_DRAFT');
                showToast(`"${assessmentData.name}" has been saved as draft!`);
            }

            // Reset form and show assessments
            resetFormAndShowAssessments();
        }

        function publishAssessment() {
            // Use mobile-optimized validation
            if (!validateMobileForm()) {
                return;
            }

            const assessmentData = collectAssessmentData();
            if (!assessmentData) return;

            // Check for questions before publishing
            if (assessmentData.questions.length === 0) {
                showToast('Please add at least one question before publishing', 'error');
                return;
            }

            // Mobile-friendly confirmation
            if (isMobileDevice()) {
                if (!confirm(`Publish "${assessmentData.name}" to all users?`)) {
                    return;
                }
            }

            assessmentData.status = 'published';
            assessmentData.publishedAt = new Date().toISOString();

            // Check if we're editing an existing assessment
            if (window.editingAssessmentId) {
                assessmentData.id = window.editingAssessmentId;
                sendToWixDatabase(assessmentData, 'UPDATE_ASSESSMENT');
                showToast(`"${assessmentData.name}" has been updated and published! Click the "Published" tab to view it.`);
            } else {
                // Creating new assessment
                assessmentData.id = Date.now(); // Generate simple ID
                assessmentData.createdAt = new Date().toISOString();
                sendToWixDatabase(assessmentData, 'PUBLISH');
                showToast(`"${assessmentData.name}" has been published to all users! Click the "Published" tab to view it.`);
            }

            // Reset form and show assessments
            resetFormAndShowAssessments();
        }

        function resetFormAndShowAssessments() {
            // Clear form
            document.getElementById('assessmentName').value = '';
            document.getElementById('assessmentDayOfCompletion').value = '';
            document.getElementById('assessmentEndDate').value = '';
            document.getElementById('assessmentDescription').value = '';
            document.getElementById('questionsContainer').innerHTML = '';
            questionCount = 0;

            // Hide form and show assessments
            showAssessmentsView();
            document.querySelector('.add-question-btn').classList.add('hidden');

            // Clear editing state
            window.editingAssessmentId = null;

            // Reload assessments
            loadAssessments();
        }

        function assignAssessment() {
            // Use mobile-optimized validation
            if (!validateMobileForm()) {
                return;
            }

            const assessmentData = collectAssessmentData();
            if (!assessmentData) return;

            // Check for questions before assigning
            if (assessmentData.questions.length === 0) {
                showToast('Please add at least one question before assigning', 'error');
                return;
            }

            // Set modal title for assessment assignment
            document.getElementById('assignModalTitle').textContent = 'Assign Assessment';

            // Show assignment modal
            const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            assignModal.show();
        }

        function searchMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const memberItems = document.querySelectorAll('.list-group-item');

            memberItems.forEach(item => {
                const name = item.querySelector('h6').textContent.toLowerCase();
                const email = item.querySelector('small').textContent.toLowerCase();

                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function assignToSelectedUsers() {
            // Only get checkboxes from the assign modal, not from questions
            const modalCheckboxes = document.querySelectorAll('#assignModal .list-group-item .form-check-input:checked');
            const selectedUsers = Array.from(modalCheckboxes)
                .map(checkbox => {
                    const listItem = checkbox.closest('.list-group-item');
                    if (!listItem) return null; // Safety check

                    const nameElement = listItem.querySelector('h6');
                    const emailElement = listItem.querySelector('small');

                    if (!nameElement || !emailElement) return null; // Safety check

                    return {
                        id: checkbox.value,
                        name: nameElement.textContent,
                        email: emailElement.textContent
                    };
                })
                .filter(user => user !== null); // Remove any null entries

            if (selectedUsers.length === 0) {
                alert('Please select at least one user');
                return;
            }

            let itemData;
            let isFromList = false;
            let itemType = 'assessment'; // Default
            let action = 'ASSIGN_TO_USERS';

            // Determine what type of item we're assigning
            if (window.assigningAssessmentId) {
                itemData = allAssessments.find(a => a.id === window.assigningAssessmentId);
                itemType = 'assessment';
                action = 'UPDATE_ASSESSMENT';
                isFromList = true;
            } else if (window.assigningRiskId) {
                itemData = allRisks.find(r => r.id === window.assigningRiskId);
                itemType = 'risk';
                action = 'UPDATE_RISK';
                isFromList = true;
            } else if (window.assigningAssetId) {
                itemData = allAssets.find(a => a.id === window.assigningAssetId);
                itemType = 'asset';
                action = 'UPDATE_ASSET';
                isFromList = true;
            } else if (window.assigningFrameworkId) {
                itemData = allFrameworks.find(f => f.id === window.assigningFrameworkId);
                itemType = 'framework';
                action = 'UPDATE_FRAMEWORK';
                isFromList = true;
            } else if (window.assigningDpiaId) {
                itemData = allDpias.find(d => d.id === window.assigningDpiaId);
                itemType = 'dpia';
                action = 'UPDATE_DPIA';
                isFromList = true;
            } else if (window.assigningRiskData) {
                itemData = window.assigningRiskData;
                itemType = 'risk';
                action = 'ASSIGN_RISK';
            } else if (window.assigningAssetData) {
                itemData = window.assigningAssetData;
                itemType = 'asset';
                action = 'ASSIGN_ASSET';
            } else if (window.assigningFrameworkData) {
                itemData = window.assigningFrameworkData;
                itemType = 'framework';
                action = 'ASSIGN_FRAMEWORK';
            } else if (window.assigningDpiaData) {
                itemData = window.assigningDpiaData;
                itemType = 'dpia';
                action = 'ASSIGN_DPIA';
            } else {
                // Default to assessment from form
                itemData = collectAssessmentData();
                if (!itemData) return;
                itemData.id = window.editingAssessmentId || Date.now();
                if (!window.editingAssessmentId) {
                    itemData.createdAt = new Date().toISOString();
                }
                itemType = 'assessment';
                action = 'ASSIGN_TO_USERS';
            }

            if (!itemData) {
                alert(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} not found`);
                return;
            }

            // Prepare assignment data
            const assignmentData = {
                ...itemData,
                assignedUsers: selectedUsers,
                assignedAt: new Date().toISOString(),
                status: 'assigned'
            };

            console.log('Assignment Data:', assignmentData);

            // Send to Wix database
            sendToWixDatabase(assignmentData, action);

            // Update local data and refresh view based on item type
            const userNames = selectedUsers.map(u => u.name).join(', ');

            switch(itemType) {
                case 'assessment':
                    if (isFromList) {
                        const index = allAssessments.findIndex(a => a.id === window.assigningAssessmentId);
                        if (index !== -1) {
                            allAssessments[index] = assignmentData;
                        }
                        showAssessments(currentFilter);
                    } else {
                        resetFormAndShowAssessments();
                    }
                    break;
                case 'risk':
                    if (isFromList) {
                        const index = allRisks.findIndex(r => r.id === window.assigningRiskId);
                        if (index !== -1) {
                            allRisks[index] = assignmentData;
                        }
                        showRisks(currentFilter);
                    } else {
                        resetRiskFormAndShowList();
                    }
                    break;
                case 'asset':
                    if (isFromList) {
                        const index = allAssets.findIndex(a => a.id === window.assigningAssetId);
                        if (index !== -1) {
                            allAssets[index] = assignmentData;
                        }
                        showAssets(currentFilter);
                    } else {
                        resetAssetFormAndShowList();
                    }
                    break;
                case 'framework':
                    if (isFromList) {
                        const index = allFrameworks.findIndex(f => f.id === window.assigningFrameworkId);
                        if (index !== -1) {
                            allFrameworks[index] = assignmentData;
                        }
                        showFrameworks(currentFilter);
                    } else {
                        resetFrameworkFormAndShowList();
                    }
                    break;
                case 'dpia':
                    if (isFromList) {
                        const index = allDpias.findIndex(d => d.id === window.assigningDpiaId);
                        if (index !== -1) {
                            allDpias[index] = assignmentData;
                        }
                        showDpias(currentFilter);
                    } else {
                        resetDpiaFormAndShowList();
                    }
                    break;
            }

            showToast(`"${itemData.name}" has been assigned to ${userNames}! Click the "Assigned" tab to view it.`);

            // Close the modal safely
            try {
                const assignModalElement = document.getElementById('assignModal');
                if (assignModalElement) {
                    const assignModal = bootstrap.Modal.getInstance(assignModalElement);
                    if (assignModal) {
                        assignModal.hide();
                    }
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }

            // Clear checkboxes for next use
            if (modalCheckboxes && modalCheckboxes.length > 0) {
                modalCheckboxes.forEach(checkbox => checkbox.checked = false);
            }

            // Clear assignment states
            window.assigningAssessmentId = null;
            window.assigningRiskId = null;
            window.assigningAssetId = null;
            window.assigningFrameworkId = null;
            window.assigningDpiaId = null;
            window.assigningRiskData = null;
            window.assigningAssetData = null;
            window.assigningFrameworkData = null;
            window.assigningDpiaData = null;
        }

        // Mobile-specific functions
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#assignModal .members-list input[type="checkbox"]:checked');
            const count = checkboxes.length;

            // Update button text and state
            const assignBtn = document.querySelector('#assignModal .modal-footer .btn-primary');
            if (assignBtn) {
                if (count > 0) {
                    assignBtn.innerHTML = `<i class="fas fa-check"></i> Assign to ${count} member${count !== 1 ? 's' : ''}`;
                    assignBtn.disabled = false;
                } else {
                    assignBtn.innerHTML = `<i class="fas fa-check"></i> Assign Selected`;
                    assignBtn.disabled = true;
                }
            }
        }

        // Touch-friendly interactions
        function addTouchFeedback() {
            // Add touch feedback to buttons
            document.addEventListener('touchstart', function(e) {
                if (e.target.classList.contains('btn')) {
                    e.target.style.transform = 'scale(0.95)';
                }
            });

            document.addEventListener('touchend', function(e) {
                if (e.target.classList.contains('btn')) {
                    setTimeout(() => {
                        e.target.style.transform = '';
                    }, 100);
                }
            });
        }

        // Improved mobile search
        function searchMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const memberItems = document.querySelectorAll('.members-list .list-group-item');

            memberItems.forEach(item => {
                const name = item.querySelector('h6').textContent.toLowerCase();
                const email = item.querySelector('small').textContent.toLowerCase();

                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Mobile-optimized form validation
        function validateMobileForm() {
            const name = document.getElementById('assessmentName').value.trim();
            const dayOfCompletion = document.getElementById('assessmentDayOfCompletion').value;
            const endDate = document.getElementById('assessmentEndDate').value;
            const description = document.getElementById('assessmentDescription').value.trim();

            if (!name) {
                showToast('Please enter an assessment name', 'error');
                document.getElementById('assessmentName').focus();
                return false;
            }

            if (!dayOfCompletion) {
                showToast('Please select a Day of Completion', 'error');
                document.getElementById('assessmentDayOfCompletion').focus();
                return false;
            }

            if (!endDate) {
                showToast('Please select an End Date', 'error');
                document.getElementById('assessmentEndDate').focus();
                return false;
            }

            // Validate that end date is after day of completion
            const dayOfCompletionDate = new Date(dayOfCompletion);
            const endDateObj = new Date(endDate);
            if (endDateObj < dayOfCompletionDate) {
                showToast('End Date must be after Day of Completion', 'error');
                document.getElementById('assessmentEndDate').focus();
                return false;
            }

            if (!description) {
                showToast('Please enter a description', 'error');
                document.getElementById('assessmentDescription').focus();
                return false;
            }

            return true;
        }

        // Detect mobile device
        function isMobileDevice() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Mobile-specific initialization
        function initializeMobile() {
            if (isMobileDevice()) {
                // Add mobile-specific classes
                document.body.classList.add('mobile-device');

                // Initialize touch feedback
                addTouchFeedback();

                // Optimize viewport for mobile
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover');
                }

                // Add mobile-specific event listeners
                document.addEventListener('orientationchange', function() {
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);
                });
            }
        }

        // Add event listener for search input
        document.getElementById('memberSearch').addEventListener('input', searchMembers);

        // Debug function to test buttons
        window.testButtons = function() {
            console.log('Testing button functions...');
            console.log('All assessments:', allAssessments);
            if (allAssessments.length > 0) {
                const firstAssessment = allAssessments[0];
                console.log('Testing with first assessment:', firstAssessment);
                console.log('Assessment ID:', firstAssessment.id);

                // Test each function
                console.log('Testing editAssessment...');
                try {
                    editAssessment(firstAssessment.id);
                    console.log(' editAssessment works');
                } catch(e) {
                    console.error(' editAssessment failed:', e);
                }
            }
        };

        // Function to manually trigger button actions for testing
        window.testAction = function(action, assessmentId) {
            console.log(`Testing ${action} with ID: ${assessmentId}`);
            switch(action) {
                case 'edit':
                    editAssessment(assessmentId);
                    break;
                case 'publish':
                    publishAssessmentFromList(assessmentId);
                    break;
                case 'assign':
                    assignAssessmentFromList(assessmentId);
                    break;
                case 'copy':
                    copyAssessmentFromList(assessmentId);
                    break;
                default:
                    console.log('Unknown action');
            }
        };

        // Make functions globally accessible for debugging
        window.editAssessment = editAssessment;
        window.publishAssessmentFromList = publishAssessmentFromList;
        window.assignAssessmentFromList = assignAssessmentFromList;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mobile optimizations
            initializeMobile();

            // Load assessments when page loads
            loadAssessments();

            // Load logo for report modal
            loadLogo();

            // Request members list for assignment modal
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'loadMembers' }, '*');
            }

            // Initialize selected count for assignment modal
            updateSelectedCount();

            // Add mobile-specific form enhancements
            if (isMobileDevice()) {
                // Auto-focus prevention on mobile (prevents keyboard popup)
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        // Scroll element into view on mobile
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</body>
</html>