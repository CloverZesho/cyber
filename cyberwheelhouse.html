<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cyber Wheelhouse Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Cyber Wheelhouse Brand Colors with #114E7B */
        :root {
            --cw-primary: #114E7B;
            --cw-primary-dark: #0d3a5c;
            --cw-primary-light: #1a6ba8;
            --cw-secondary: #1e293b;
            --cw-accent: #0ea5e9;
            --cw-success: #10b981;
            --cw-warning: #f59e0b;
            --cw-error: #ef4444;
            --cw-gray-50: #f8fafc;
            --cw-gray-100: #f1f5f9;
            --cw-gray-200: #e2e8f0;
            --cw-gray-300: #cbd5e1;
            --cw-gray-400: #94a3b8;
            --cw-gray-500: #64748b;
            --cw-gray-600: #475569;
            --cw-gray-700: #334155;
            --cw-gray-800: #1e293b;
            --cw-gray-900: #0f172a;
        }

        /* Mobile-first responsive design */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            background-color: var(--cw-gray-50);
        }

        /* Enhanced sidebar with Cyber Wheelhouse branding */
        .sidebar {
            background: linear-gradient(135deg, var(--cw-primary) 0%, var(--cw-primary-dark) 100%);
            transition: transform 0.3s ease, width 0.3s ease;
            will-change: transform;
            box-shadow: 0 4px 20px rgba(17, 78, 123, 0.15);
        }

        .sidebar-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-brand {
            font-weight: 700;
            font-size: 1.25rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            margin: 6px 16px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: rgba(255, 255, 255, 0.8);
            transform: scaleY(0);
            transition: transform 0.3s ease;
            border-radius: 0 4px 4px 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-item:hover::before {
            transform: scaleY(1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transform: translateX(8px);
        }

        .nav-item.active::before {
            transform: scaleY(1);
            background: #ffffff;
            width: 5px;
        }

        .nav-item .nav-icon {
            transition: all 0.3s ease;
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-item:hover .nav-icon {
            transform: scale(1.1);
            color: #ffffff;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.15);
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .nav-item .nav-text {
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-item:hover .nav-text {
            font-weight: 600;
            color: #ffffff;
        }

        .nav-item.active .nav-text {
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100vh;
                z-index: 50;
                transform: translateX(-100%);
                width: 280px !important;
                top: 0;
                left: 0;
                box-shadow: 0 8px 32px rgba(17, 78, 123, 0.3);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }

            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(15, 23, 42, 0.6);
                z-index: 40;
                display: none;
                backdrop-filter: blur(4px);
            }

            .overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }

            /* Mobile header optimization */
            header {
                position: sticky;
                top: 0;
                z-index: 30;
                backdrop-filter: blur(10px);
                background-color: rgba(255, 255, 255, 0.95);
                border-bottom: 1px solid var(--cw-gray-200);
            }
        }

        /* Mobile-optimized Risk Matrix Styles */
        .risk-matrix-cell {
            min-height: 3rem;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            touch-action: manipulation;
        }

        .risk-matrix-cell:hover,
        .risk-matrix-cell:active {
            transform: scale(1.02);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 768px) {
            .risk-matrix-cell {
                min-height: 2.5rem;
                margin: 2px !important;
            }

            .risk-matrix-cell span {
                font-size: 0.75rem;
            }

            .risk-matrix-cell .text-lg {
                font-size: 1rem !important;
            }
        }

        /* Mobile-optimized Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow-y: auto;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: white;
            margin: 1rem auto;
            padding: 1rem;
            border-radius: 0.75rem;
            max-width: 700px;
            width: calc(100% - 2rem);
            position: relative;
            animation: modalFadeIn 0.3s ease;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        .modal-lg {
            max-width: 900px;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 0.5rem auto;
                padding: 1rem;
                width: calc(100% - 1rem);
                max-height: calc(100vh - 1rem);
                border-radius: 0.5rem;
            }

            .modal-lg {
                max-width: calc(100% - 1rem);
            }
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Search results dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 30;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        /* Mobile-optimized responsive tables */
        .responsive-table {
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .responsive-table {
                display: block;
                width: 100%;
                overflow-x: auto;
                border-radius: 0.5rem;
            }

            .responsive-table table {
                min-width: 600px;
            }

            .responsive-table th,
            .responsive-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }

            .stats-grid {
                grid-template-columns: repeat(1, 1fr) !important;
                gap: 1rem !important;
            }

            .charts-grid {
                grid-template-columns: repeat(1, 1fr) !important;
                gap: 1rem !important;
            }

            /* Mobile grid optimizations */
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(1, 1fr) !important;
            }

            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(1, 1fr) !important;
            }

            .grid.grid-cols-1.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Mobile spacing */
            .space-y-6 > * + * {
                margin-top: 1rem !important;
            }

            .space-y-4 > * + * {
                margin-top: 0.75rem !important;
            }

            /* Mobile padding */
            .p-6 {
                padding: 1rem !important;
            }

            .p-4 {
                padding: 0.75rem !important;
            }

            .px-6 {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }

            .py-3 {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
        }

        @media (max-width: 640px) {
            .grid.grid-cols-1.md\\:grid-cols-4 {
                grid-template-columns: repeat(1, 1fr) !important;
            }

            .responsive-table table {
                min-width: 500px;
            }

            .responsive-table th,
            .responsive-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }
        }

        /* Cyber Wheelhouse Badge Colors */
        .badge-high {
            background-color: #fef2f2;
            color: var(--cw-error);
            border: 1px solid #fecaca;
        }

        .badge-medium {
            background-color: #fffbeb;
            color: var(--cw-warning);
            border: 1px solid #fed7aa;
        }

        .badge-low {
            background-color: #f0fdf4;
            color: var(--cw-success);
            border: 1px solid #bbf7d0;
        }

        .badge-critical {
            background-color: #faf5ff;
            color: var(--cw-primary);
            border: 1px solid #e9d5ff;
        }

        .badge-active {
            background-color: #eff6ff;
            color: var(--cw-accent);
            border: 1px solid #bfdbfe;
        }

        .badge-mitigated {
            background-color: #f0fdf4;
            color: var(--cw-success);
            border: 1px solid #bbf7d0;
        }

        /* Enhanced Risk Matrix Colors */
        .risk-critical {
            background: linear-gradient(135deg, var(--cw-error) 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .risk-high {
            background: linear-gradient(135deg, var(--cw-warning) 0%, #ea580c 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .risk-medium {
            background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
            box-shadow: 0 2px 8px rgba(234, 179, 8, 0.3);
        }

        .risk-low {
            background: linear-gradient(135deg, var(--cw-success) 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        /* Enhanced Tab Styles */
        .tab-active {
            border-bottom: 2px solid var(--cw-primary);
            color: var(--cw-primary);
            background: linear-gradient(135deg, rgba(67, 56, 202, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .tab-inactive {
            color: var(--cw-gray-600);
            transition: all 0.2s ease;
        }

        .tab-inactive:hover {
            color: var(--cw-primary);
            background: rgba(67, 56, 202, 0.05);
        }

        /* Enhanced Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--cw-gray-300);
            transition: all 0.3s ease;
            border-radius: 24px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked+.toggle-slider {
            background: linear-gradient(135deg, var(--cw-primary) 0%, var(--cw-primary-light) 100%);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        /* Enhanced Toast Notifications */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: fadeInOut 3s ease-in-out;
            max-width: 400px;
            margin: 0 auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toast-success {
            background: linear-gradient(135deg, var(--cw-success) 0%, #059669 100%);
        }

        .toast-error {
            background: linear-gradient(135deg, var(--cw-error) 0%, #dc2626 100%);
        }

        .toast-info {
            background: linear-gradient(135deg, var(--cw-accent) 0%, #0284c7 100%);
        }

        @media (max-width: 768px) {
            .toast-notification {
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                margin: 0;
            }
        }

        /* Touch-friendly interactions */
        .btn, button, .cursor-pointer {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
            transition: all 0.2s ease;
        }

        .btn:active, button:active, .cursor-pointer:active {
            transform: scale(0.95);
        }

        /* Mobile-specific button styles */
        @media (max-width: 768px) {
            .btn, button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                border-radius: 0.5rem;
            }

            .btn-sm, .btn.btn-sm {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-height: 36px;
            }

            /* Mobile search input */
            input[type="text"], input[type="search"] {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
                border-radius: 0.5rem;
            }

            /* Mobile navigation items */
            .nav-item {
                margin: 4px 8px !important;
                padding: 1rem !important;
                font-size: 0.9rem;
            }

            .nav-item .nav-icon {
                margin-right: 0.75rem !important;
                width: 1.25rem;
                text-align: center;
                font-size: 14px !important;
            }

            .nav-item .nav-text {
                font-size: 0.9rem !important;
            }

            /* Enhanced mobile touch targets */
            .nav-item {
                min-height: 48px !important;
                display: flex !important;
                align-items: center !important;
            }
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            10% {
                opacity: 1;
                transform: translateY(0);
            }

            90% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Enhanced Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--cw-gray-200);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--cw-gray-200);
            background: linear-gradient(135deg, var(--cw-gray-50) 0%, white 100%);
            border-radius: 12px 12px 0 0;
        }

        /* Enhanced Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--cw-primary) 0%, var(--cw-primary-light) 100%);
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(17, 78, 123, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(17, 78, 123, 0.3);
        }

        /* Mobile-specific utility classes */
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none !important;
            }

            .mobile-full-width {
                width: 100% !important;
            }

            .mobile-text-center {
                text-align: center !important;
            }

            .mobile-flex-col {
                flex-direction: column !important;
            }

            .mobile-space-y-2 > * + * {
                margin-top: 0.5rem !important;
            }

            .mobile-p-2 {
                padding: 0.5rem !important;
            }

            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
        <!-- Enhanced Sidebar with Cyber Wheelhouse Branding -->
        <div id="sidebar" class="sidebar text-white w-64">
            <div class="sidebar-header flex items-center justify-between p-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white"></i>
                    </div>
                    <h1 class="sidebar-brand">Cyber Wheelhouse</h1>
                </div>
                <button id="sidebarToggle" class="p-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="mt-8 px-2">
                <!-- Enhanced Navigation Items with Better Selection -->
                <div class="mb-2">
                    <div class="px-4 py-2 text-xs font-semibold text-white text-opacity-60 uppercase tracking-wider">
                        Main Menu
                    </div>
                </div>

                <div id="navDashboard" class="nav-item flex items-center p-4 cursor-pointer" onclick="setActiveNav('navDashboard'); switchModule('dashboard')">
                    <i class="fas fa-home nav-icon mr-4"></i>
                    <span class="nav-text">Dashboard</span>
                    <div class="ml-auto opacity-0 transition-opacity duration-300">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </div>

                <div id="navRisk" class="nav-item active flex items-center p-4 cursor-pointer" onclick="setActiveNav('navRisk'); switchModule('risk')">
                    <i class="fas fa-exclamation-triangle nav-icon mr-4"></i>
                    <span class="nav-text">Risk Management</span>
                    <div class="ml-auto opacity-100 transition-opacity duration-300">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </div>

                <div id="navAsset" class="nav-item flex items-center p-4 cursor-pointer" onclick="setActiveNav('navAsset'); switchModule('asset')">
                    <i class="fas fa-database nav-icon mr-4"></i>
                    <span class="nav-text">Asset Inventory</span>
                    <div class="ml-auto opacity-0 transition-opacity duration-300">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </div>

                <div id="navFramework" class="nav-item flex items-center p-4 cursor-pointer" onclick="setActiveNav('navFramework'); switchModule('frameworks')">
                    <i class="fas fa-book-open nav-icon mr-4"></i>
                    <span class="nav-text">Controls</span>
                    <div class="ml-auto opacity-0 transition-opacity duration-300">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </div>

                <div id="navDpia" class="nav-item flex items-center p-4 cursor-pointer" onclick="setActiveNav('navDpia'); switchModule('dpias')">
                    <i class="fas fa-file-alt nav-icon mr-4"></i>
                    <span class="nav-text">Privacy Impact</span>
                    <div class="ml-auto opacity-0 transition-opacity duration-300">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </div>

                <div id="navAssessment" class="nav-item flex items-center p-4 cursor-pointer" onclick="setActiveNav('navAssessment'); switchModule('assessments')">
                    <i class="fas fa-tasks nav-icon mr-4"></i>
                    <span class="nav-text">Assessments</span>
                    <div class="ml-auto opacity-0 transition-opacity duration-300">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </div>
                <!-- Enhanced Admin Section -->
                <div id="adminPortalToggle" class="mt-8 border-t border-white border-opacity-20 pt-6 hidden">
                    <div class="mb-2">
                        <div class="px-4 py-2 text-xs font-semibold text-white text-opacity-60 uppercase tracking-wider">
                            Administration
                        </div>
                    </div>
                    <div id="navAdmin" class="nav-item flex items-center p-4 cursor-pointer" onclick="setActiveNav('navAdmin'); switchModule('admin')">
                        <i class="fas fa-cog nav-icon mr-4"></i>
                        <span class="nav-text">Admin Portal</span>
                        <div class="ml-auto opacity-0 transition-opacity duration-300">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Platform Info Footer -->
                <div class="mt-auto p-6 border-t border-white border-opacity-20">
                    <div class="text-xs text-white text-opacity-70 text-center">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <span class="font-semibold">Cyber Wheelhouse Platform</span>
                        </div>
                        <p class="text-white text-opacity-50">Making security simple, smart & stress-free</p>
                    </div>
                </div>
            </nav>
        </div>

        <!-- Mobile overlay -->
        <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

        <!-- Enhanced Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden main-content">
            <!-- Enhanced Header with Cyber Wheelhouse Styling -->
            <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="flex items-center justify-between p-3 md:p-4">
                    <div class="flex items-center flex-1">
                        <button id="mobileMenuButton"
                            class="md:hidden p-2 mr-3 rounded-lg text-gray-500 hover:bg-gray-100 touch-manipulation transition-colors">
                            <i class="fas fa-bars text-lg"></i>
                        </button>
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-800 to-blue-900 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #114E7B 0%, #0d3a5c 100%);">
                                <i class="fas fa-shield-alt text-white text-sm"></i>
                            </div>
                            <h2 class="text-base md:text-lg font-semibold text-gray-800 truncate" id="moduleTitle">Risk Management</h2>
                        </div>
                    </div>

                </div>
            </header>

            <!-- Enhanced Content Area -->
            <main class="flex-1 overflow-auto p-3 md:p-6 bg-gray-50">
                <!-- Enhanced Risk Management Module -->
                <div id="risk-module" class="space-y-4 md:space-y-6">
                    <!-- Welcome Banner -->
                    <div class="rounded-xl p-6 text-white mb-6" style="background: linear-gradient(135deg, #114E7B 0%, #1a6ba8 100%);">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-xl md:text-2xl font-bold mb-2">Risk Management Dashboard</h1>
                                <p class="text-blue-100 text-sm md:text-base">Making cybersecurity simple, smart, and stress-free</p>
                            </div>
                            <div class="hidden md:block">
                                <i class="fas fa-shield-alt text-4xl text-white opacity-20"></i>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col space-y-3 md:flex-row md:justify-between md:items-center md:space-y-0">
                        <div class="relative w-full md:w-64">
                            <input id="searchRisk" type="text" placeholder="Search risks..."
                                class="w-full pl-10 pr-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 text-base shadow-sm"
                                style="--tw-ring-color: #114E7B; border-color: #e2e8f0;"
                                onfocus="this.style.borderColor='#114E7B'; this.style.boxShadow='0 0 0 2px rgba(17, 78, 123, 0.2)'"
                                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" />
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                <i class="fas fa-search text-sm"></i>
                            </div>

                            <!-- Search Results Dropdown -->
                            <div id="riskSearchResults" class="search-results">
                                <div class="p-2 border-b">
                                    <span id="searchResultsCount" class="text-sm font-medium">0 results found</span>
                                </div>
                                <ul id="searchResultsList" class="py-1">
                                    <!-- Search results will be populated here -->
                                </ul>
                            </div>
                        </div>
                        <button id="addRiskButton"
                            class="flex items-center justify-center text-white px-6 py-3 md:py-2 rounded-lg transition-all duration-200 w-full md:w-auto mobile-full-width shadow-lg hover:shadow-xl transform hover:scale-105"
                            style="background: linear-gradient(135deg, #114E7B 0%, #1a6ba8 100%);"
                            onmouseover="this.style.background='linear-gradient(135deg, #0d3a5c 0%, #114E7B 100%)'"
                            onmouseout="this.style.background='linear-gradient(135deg, #114E7B 0%, #1a6ba8 100%)'">
                            <i class="fas fa-plus-circle mr-2"></i>
                            <span class="font-medium">Add New Risk</span>
                        </button>
                    </div>

                    <!-- Enhanced Risk Matrix -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                        <div class="p-4 md:p-6">
                            <div class="flex items-center justify-between mb-4 md:mb-6">
                                <h3 class="text-lg md:text-xl font-semibold text-gray-800">Risk Assessment Matrix</h3>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Click cells to view risks
                                </div>
                            </div>
                            <div class="flex flex-col md:flex-row">
                                <!-- Y-axis labels (Likelihood) - Mobile optimized -->
                                <div class="hidden md:flex md:flex-col justify-between pt-10 pr-2">
                                    <div class="h-8 w-auto flex items-center font-medium text-sm justify-end">
                                        Likelihood</div>
                                    <div class="h-16 flex items-center text-sm justify-end">
                                        <span class="font-medium">High</span>
                                    </div>
                                    <div class="h-16 flex items-center text-sm justify-end">
                                        <span class="font-medium">Medium</span>
                                    </div>
                                    <div class="h-16 flex items-center text-sm justify-end">
                                        <span class="font-medium">Low</span>
                                    </div>
                                    <div class="h-16 flex items-center text-sm justify-end">
                                        <span class="font-medium">Very Low</span>
                                    </div>
                                </div>

                                <!-- Mobile-optimized Matrix grid -->
                                <div class="flex-1">
                                    <!-- X-axis labels (Impact) - Mobile optimized -->
                                    <div class="flex justify-between pl-1 md:pl-2 mb-2 mt-2 md:mt-0 order-last md:order-first">
                                        <div class="w-6 md:w-8 hidden md:block"></div> <!-- Spacer for desktop -->
                                        <div class="flex-1 text-center">
                                            <span class="text-xs md:text-sm font-medium">Low</span>
                                        </div>
                                        <div class="flex-1 text-center">
                                            <span class="text-xs md:text-sm font-medium">Medium</span>
                                        </div>
                                        <div class="flex-1 text-center">
                                            <span class="text-xs md:text-sm font-medium">High</span>
                                        </div>
                                        <div class="flex-1 text-center">
                                            <span class="text-xs md:text-sm font-medium">Critical</span>
                                        </div>
                                    </div>

                                    <!-- Mobile Likelihood Header -->
                                    <div class="md:hidden mb-2 flex items-center">
                                        <div class="w-16 text-xs font-medium text-gray-500 pr-2 flex-shrink-0">
                                            Likelihood
                                        </div>
                                        <div class="text-xs font-medium text-gray-500 text-center flex-1">
                                            Impact â†’
                                        </div>
                                    </div>

                                    <!-- Matrix cells -->
                                    <div class="risk-matrix-grid">
                                        <!-- High Likelihood Row -->
                                        <div class="flex items-center">
                                            <!-- Mobile likelihood label -->
                                            <div class="md:hidden w-16 text-xs font-medium text-gray-700 pr-2 flex-shrink-0">
                                                High
                                            </div>
                                            <div data-position="3-0"
                                                class="risk-matrix-cell flex-1 m-1 risk-medium rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="3-1"
                                                class="risk-matrix-cell flex-1 m-1 risk-high rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="3-2"
                                                class="risk-matrix-cell flex-1 m-1 risk-critical rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="3-3"
                                                class="risk-matrix-cell flex-1 m-1 risk-critical rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Medium Likelihood Row -->
                                        <div class="flex items-center">
                                            <!-- Mobile likelihood label -->
                                            <div class="md:hidden w-16 text-xs font-medium text-gray-700 pr-2 flex-shrink-0">
                                                Medium
                                            </div>
                                            <div data-position="2-0"
                                                class="risk-matrix-cell flex-1 m-1 risk-low rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="2-1"
                                                class="risk-matrix-cell flex-1 m-1 risk-medium rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">1</span>
                                                    <span class="text-white text-xs">Risk</span>
                                                </div>
                                            </div>
                                            <div data-position="2-2"
                                                class="risk-matrix-cell flex-1 m-1 risk-high rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">2</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="2-3"
                                                class="risk-matrix-cell flex-1 m-1 risk-critical rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Low Likelihood Row -->
                                        <div class="flex items-center">
                                            <!-- Mobile likelihood label -->
                                            <div class="md:hidden w-16 text-xs font-medium text-gray-700 pr-2 flex-shrink-0">
                                                Low
                                            </div>
                                            <div data-position="1-0"
                                                class="risk-matrix-cell flex-1 m-1 risk-low rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="1-1"
                                                class="risk-matrix-cell flex-1 m-1 risk-low rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">1</span>
                                                    <span class="text-white text-xs">Risk</span>
                                                </div>
                                            </div>
                                            <div data-position="1-2"
                                                class="risk-matrix-cell flex-1 m-1 risk-medium rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">2</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="1-3"
                                                class="risk-matrix-cell flex-1 m-1 risk-high rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">1</span>
                                                    <span class="text-white text-xs">Risk</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Very Low Likelihood Row -->
                                        <div class="flex items-center">
                                            <!-- Mobile likelihood label -->
                                            <div class="md:hidden w-16 text-xs font-medium text-gray-700 pr-2 flex-shrink-0">
                                                Very Low
                                            </div>
                                            <div data-position="0-0"
                                                class="risk-matrix-cell flex-1 m-1 risk-low rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="0-1"
                                                class="risk-matrix-cell flex-1 m-1 risk-low rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="0-2"
                                                class="risk-matrix-cell flex-1 m-1 risk-low rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">0</span>
                                                    <span class="text-white text-xs">Risks</span>
                                                </div>
                                            </div>
                                            <div data-position="0-3"
                                                class="risk-matrix-cell flex-1 m-1 risk-medium rounded-md p-2 cursor-pointer hover:opacity-90">
                                                <div class="flex flex-col h-full justify-center items-center">
                                                    <span class="text-white font-bold text-lg">1</span>
                                                    <span class="text-white text-xs">Risk</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Legend -->
                            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Risk Level Legend</h4>
                                <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 md:gap-6">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-gradient-to-br from-green-400 to-green-500 rounded-sm mr-2 shadow-sm"></div>
                                        <span class="text-sm font-medium text-gray-700">Low Risk</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-sm mr-2 shadow-sm"></div>
                                        <span class="text-sm font-medium text-gray-700">Medium Risk</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-gradient-to-br from-orange-400 to-orange-500 rounded-sm mr-2 shadow-sm"></div>
                                        <span class="text-sm font-medium text-gray-700">High Risk</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-gradient-to-br from-red-400 to-red-500 rounded-sm mr-2 shadow-sm"></div>
                                        <span class="text-sm font-medium text-gray-700">Critical Risk</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Risks Table -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg md:text-xl font-semibold text-gray-800">Risk Register</h3>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-list mr-1"></i>
                                    Comprehensive risk overview
                                </div>
                            </div>
                        </div>
                        <div class="responsive-table">
                            <table class="w-full min-w-full">
                                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Risk Name</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Category</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Likelihood</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Impact</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Risk Level</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Status</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 bg-white" id="risksTableBody">
                                    <!-- Table rows will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Asset Module -->
                <div id="asset-module" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center space-y-4 md:space-y-0">
                        <div class="relative w-full md:w-64">
                            <input id="searchAsset" type="text" placeholder="     Search assets..."
                                class="w-full pl-10 pr-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base" />
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                <i class="fas fa-search text-sm"></i>
                            </div>

                            <!-- Search Results Dropdown -->
                            <div id="assetSearchResults" class="search-results">
                                <div class="p-2 border-b">
                                    <span id="assetSearchResultsCount" class="text-sm font-medium">0 results
                                        found</span>
                                </div>
                                <ul id="assetSearchResultsList" class="py-1">
                                    <!-- Search results will be populated here -->
                                </ul>
                            </div>
                        </div>
                        <button id="addAssetButton"
                            class="flex items-center justify-center bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus-circle mr-2"></i>
                            <span>Add Asset</span>
                        </button>
                    </div>

                    <!-- Asset Categories -->
                    <!-- <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-medium">Asset Categories</h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="flex items-center p-4 bg-blue-50 rounded-lg">
                                <div
                                    class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 mr-4">
                                    <i class="fas fa-server fa-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium">Infrastructure</h4>
                                    <p class="text-sm text-gray-500">42 Assets</p>
                                </div>
                            </div>
                            <div class="flex items-center p-4 bg-green-50 rounded-lg">
                                <div
                                    class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-500 mr-4">
                                    <i class="fas fa-database fa-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium">Data</h4>
                                    <p class="text-sm text-gray-500">28 Assets</p>
                                </div>
                            </div>
                            <div class="flex items-center p-4 bg-purple-50 rounded-lg">
                                <div
                                    class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center text-purple-500 mr-4">
                                    <i class="fas fa-desktop fa-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium">Applications</h4>
                                    <p class="text-sm text-gray-500">36 Assets</p>
                                </div>
                            </div>
                            <div class="flex items-center p-4 bg-yellow-50 rounded-lg">
                                <div
                                    class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-500 mr-4">
                                    <i class="fas fa-network-wired fa-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium">Network</h4>
                                    <p class="text-sm text-gray-500">15 Assets</p>
                                </div>
                            </div>
                            <div class="flex items-center p-4 bg-red-50 rounded-lg">
                                <div
                                    class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center text-red-500 mr-4">
                                    <i class="fas fa-users fa-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium">People</h4>
                                    <p class="text-sm text-gray-500">5 Assets</p>
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- Assets Table -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="responsive-table">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Name</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Type</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Owner</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Location</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Cost</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Criticality</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="assetsTableBody">
                                    <!-- Table rows will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Frameworks Module -->
                <div id="frameworks-module" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center space-y-4 md:space-y-0">
                        <div class="relative w-full md:w-64">
                            <input id="searchFramework" type="text" placeholder="     Search frameworks..."
                                class="w-full pl-10 pr-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base" />
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                <i class="fas fa-search text-sm"></i>
                            </div>
                        </div>
                        <button id="addFrameworkButton"
                            class="flex items-center justify-center bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus-circle mr-2"></i>
                            <span>Add Framework</span>
                        </button>
                    </div>

                    <!-- Compliance Summary -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-medium">Compliance Overview</h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">

                            <!-- Overall Compliance Summary -->
                            <div>
                                <h4 class="font-medium mb-4">Overall Compliance</h4>
                                <div class="flex items-center">
                                    <div class="w-32 bg-gray-200 rounded-full h-4 mr-4">
                                        <div id="overallComplianceBar" class="bg-indigo-600 h-4 rounded-full"
                                            style="width: 0%"></div>
                                    </div>
                                    <span id="overallCompliancePercent" class="text-lg font-bold">0%</span>
                                </div>

                                <div class="mt-6 grid grid-cols-2 gap-4">
                                    <div>
                                        <span class="text-sm text-gray-500">Implemented Controls</span>
                                        <div id="implementedControls" class="text-2xl font-bold">0</div>
                                    </div>
                                    <div>
                                        <span class="text-sm text-gray-500">Total Controls</span>
                                        <div id="totalControls" class="text-2xl font-bold">0</div>
                                    </div>
                                    <div>
                                        <span class="text-sm text-gray-500">Frameworks</span>
                                        <div id="frameworkCount" class="text-2xl font-bold">0</div>
                                    </div>
                                    <div>
                                        <span class="text-sm text-gray-500">Next Assessment</span>
                                        <div id="nextAssessmentDate" class="text-lg font-medium">N/A</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Per-framework Compliance -->
                            <div>
                                <h4 class="font-medium mb-4">Framework Compliance</h4>
                                <div id="frameworkComplianceBreakdown" class="space-y-4"></div>
                            </div>

                        </div>
                    </div>

                    <!-- Frameworks Table -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="responsive-table">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Name</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Description</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Controls</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Compliance</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Readiness</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="frameworksTableBody">
                                    <!-- Table rows will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- DPIAs Module -->
                <div id="dpias-module" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center space-y-4 md:space-y-0">
                        <div class="relative w-full md:w-64">
                            <input id="searchDPIA" type="text" placeholder="     Search DPIAs..."
                                class="w-full pl-10 pr-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base" />
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                <i class="fas fa-search text-sm"></i>
                            </div>
                        </div>
                        <button id="addDPIAButton"
                            class="flex items-center justify-center bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus-circle mr-2"></i>
                            <span>New DPIA</span>
                        </button>
                    </div>

                    <!-- DPIA Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Total DPIAs</p>
                                    <p id="dpiaTotalCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-500">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Completed</p>
                                    <p id="dpiaCompletedCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-500">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">In Progress</p>
                                    <p id="dpiaInProgressCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-500">
                                    <i class="fas fa-spinner"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">High Risk</p>
                                    <p id="dpiaHighRiskCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-500">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- DPIAs Table -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="responsive-table">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Name</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Department</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Date</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Risk Level</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="dpiasTableBody">
                                    <!-- Table rows will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Assessments Module -->
                <div id="assessments-module" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center space-y-4 md:space-y-0">
                        <div class="relative w-full md:w-64">
                            <input id="searchAssessment" type="text" placeholder="     Search assessments..."
                                class="w-full pl-10 pr-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base" />
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                <i class="fas fa-search text-sm"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Status -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-medium">Assessment Status</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">Total</p>
                                    <p class="text-2xl font-bold" data-status="total">0</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">Completed</p>
                                    <p class="text-2xl font-bold" data-status="completed">0</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">In Progress</p>
                                    <p class="text-2xl font-bold" data-status="inProgress">0</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">Overdue</p>
                                    <p class="text-2xl font-bold" data-status="overdue">0</p>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Assessments Table -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="responsive-table">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Name</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Due Date</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Completion</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Score</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="assessmentsTableBody">
                                    <!-- Table rows will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Assessment Timeline and Results -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-medium">Assessment Timeline & Results</h3>
                        </div>
                        <div class="p-6">
                            <div id="assessmentTimeline" class="space-y-4">
                                <!-- Timeline entries will be populated dynamically -->
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                                    <p>Complete an assessment to see your timeline and scoring history</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Portal Module -->
                <div id="admin-module" class="hidden space-y-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-8">
                                <button id="assessmentsTab" class="py-2 px-1 border-b-2 font-medium text-sm tab-active"
                                    onclick="switchAdminTab('assessments')">
                                    Assessment Templates
                                </button>
                                <button id="questionsTab"
                                    class="py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                                    onclick="switchAdminTab('questions')">
                                    Question Bank
                                </button>
                                <button id="settingsTab"
                                    class="py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                                    onclick="switchAdminTab('settings')">
                                    Settings
                                </button>
                            </nav>
                        </div>

                        <!-- Assessment Templates Tab -->
                        <div id="assessmentsTabContent" class="mt-6">
                            <div class="flex justify-between mb-6">
                                <h3 class="text-lg font-medium">Assessment Templates</h3>
                                <button id="createTemplateBtn"
                                    class="flex items-center bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Create Template
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="templatesContainer">
                                <!-- Template cards will be populated here -->
                            </div>
                        </div>

                        <!-- Question Bank Tab -->
                        <div id="questionsTabContent" class="mt-6 hidden">
                            <div class="flex justify-between mb-6">
                                <h3 class="text-lg font-medium">Question Bank</h3>
                                <button id="addQuestionBtn"
                                    class="flex items-center bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700"
                                    onclick="toggleQuestionForm(true)">
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Add Question
                                </button>
                            </div>

                            <div id="questionFormContainer" class="bg-gray-50 p-6 rounded-lg mb-6 hidden">
                                <h4 class="font-medium mb-4">Add New Question</h4>
                                <div id="questionFormError"
                                    class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                                <form id="questionForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Question
                                            Text</label>
                                        <input type="text" id="questionText" class="w-full p-2 border rounded-md"
                                            placeholder="Enter your question..." required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Question
                                            Type</label>
                                        <div class="relative">
                                            <button id="questionTypeButton" type="button"
                                                class="flex items-center justify-between w-full p-2 text-sm border rounded-md bg-white"
                                                onclick="toggleQuestionTypeDropdown()">
                                                <span id="selectedQuestionType">Text Response</span>
                                                <i class="fas fa-chevron-down text-gray-400"></i>
                                            </button>
                                            <div id="questionTypeDropdown"
                                                class="absolute z-10 hidden mt-1 w-full bg-white border rounded-md shadow-lg">
                                                <ul class="py-1 text-sm">
                                                    <li class="hover:bg-indigo-50 cursor-pointer"
                                                        onclick="selectQuestionType('text', 'Text Response')">
                                                        <div class="px-3 py-2 border-b">
                                                            <div class="font-medium">Text Response</div>
                                                            <div class="text-xs text-gray-500">Allows users to type a
                                                                free-form answer.</div>
                                                        </div>
                                                    </li>
                                                    <li class="hover:bg-indigo-50 cursor-pointer"
                                                        onclick="selectQuestionType('yesno', 'Yes/No')">
                                                        <div class="px-3 py-2 border-b">
                                                            <div class="font-medium">Yes/No</div>
                                                            <div class="text-xs text-gray-500">Provides a binary option:
                                                                Yes or No.</div>
                                                        </div>
                                                    </li>
                                                    <li class="hover:bg-indigo-50 cursor-pointer"
                                                        onclick="selectQuestionType('multiple', 'Multiple Choice')">
                                                        <div class="px-3 py-2 border-b">
                                                            <div class="font-medium">Multiple Choice</div>
                                                            <div class="text-xs text-gray-500">Lets you define several
                                                                options; user selects one or more.</div>
                                                        </div>
                                                    </li>
                                                    <li class="hover:bg-indigo-50 cursor-pointer"
                                                        onclick="selectQuestionType('rating', 'Rating Scale')">
                                                        <div class="px-3 py-2 border-b">
                                                            <div class="font-medium">Rating Scale</div>
                                                            <div class="text-xs text-gray-500">Used for Likert-type
                                                                responses (e.g., 1 to 5 stars, satisfaction levels).
                                                            </div>
                                                        </div>
                                                    </li>
                                                    <li class="hover:bg-indigo-50 cursor-pointer"
                                                        onclick="selectQuestionType('file', 'File Upload')">
                                                        <div class="px-3 py-2">
                                                            <div class="font-medium">File Upload</div>
                                                            <div class="text-xs text-gray-500">User uploads a file as a
                                                                response (e.g., resume, image, document).</div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <input type="hidden" id="questionType" value="text">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                        <select id="questionCategory" class="w-full p-2 border rounded-md">
                                            <option value="Security">Security</option>
                                            <option value="Compliance">Compliance</option>
                                            <option value="Privacy">Privacy</option>
                                            <option value="Operations">Operations</option>
                                            <option value="Training">Training</option>
                                            <option value="Risk">Risk</option>
                                            <option value="Access Control">Access Control</option>
                                            <option value="Data Protection">Data Protection</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Help Text
                                            (Optional)</label>
                                        <textarea id="questionHelp" class="w-full p-2 border rounded-md" rows="2"
                                            placeholder="Enter additional guidance for the question..."></textarea>
                                    </div>

                                    <!-- Multiple Choice Options -->
                                    <div id="MultipleChoiceOptions" class="hidden mt-4 border-t pt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Multiple Choice
                                            Options</label>
                                        <div class="mb-2 flex items-center">
                                            <input type="checkbox" id="multipleAllowMultiple" class="mr-2">
                                            <label for="multipleAllowMultiple" class="text-sm text-gray-700">Allow
                                                selecting multiple options</label>
                                        </div>
                                        <div id="multipleChoiceOptionsList" class="space-y-2">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 mr-2">
                                                    <input type="checkbox"
                                                        class="correct-option h-4 w-4 text-indigo-600 border-gray-300 rounded"
                                                        title="Mark as correct answer">
                                                </div>
                                                <input type="text" class="w-full p-2 border rounded-md"
                                                    placeholder="Enter an option...">
                                                <button type="button" class="ml-2 text-red-600"
                                                    onclick="removeOption(this)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <button type="button"
                                            class="mt-2 px-3 py-1 text-sm text-indigo-600 border border-indigo-600 rounded-md hover:bg-indigo-50"
                                            onclick="addMultipleChoiceOption()">
                                            <i class="fas fa-plus mr-1"></i> Add Option
                                        </button>
                                    </div>

                                    <!-- Rating Scale Options -->
                                    <div id="RatingScaleOptions" class="hidden mt-4 border-t pt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Rating Scale
                                            Options</label>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1">Minimum Value</label>
                                                <input type="number" id="ratingMin" class="w-full p-2 border rounded-md"
                                                    value="1" min="0" max="10">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1">Maximum Value</label>
                                                <input type="number" id="ratingMax" class="w-full p-2 border rounded-md"
                                                    value="5" min="1" max="10">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <label class="block text-xs text-gray-500 mb-1">Scale Labels
                                                (Optional)</label>
                                            <input type="text" id="ratingLabels" class="w-full p-2 border rounded-md"
                                                placeholder="e.g., Poor, Fair, Good, Very Good, Excellent">
                                            <p class="text-xs text-gray-500 mt-1">Separate labels with commas. Number of
                                                labels should match the scale range.</p>
                                        </div>
                                    </div>

                                    <!-- File Upload Options -->
                                    <div id="FileUploadOptions" class="hidden mt-4 border-t pt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">File Upload
                                            Options</label>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1">Allowed File
                                                    Types</label>
                                                <input type="text" id="fileTypes" class="w-full p-2 border rounded-md"
                                                    placeholder="e.g., .pdf,.doc,.jpg">
                                                <p class="text-xs text-gray-500 mt-1">Separate file extensions with
                                                    commas</p>
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1">Maximum File Size
                                                    (MB)</label>
                                                <input type="number" id="fileMaxSize"
                                                    class="w-full p-2 border rounded-md" value="10" min="1" max="100">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button"
                                            class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                                            onclick="toggleQuestionForm(false)">
                                            Cancel
                                        </button>
                                        <button type="submit"
                                            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                                            Save Question
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div class="bg-white rounded-lg border mb-6">
                                <div
                                    class="py-4 px-6 border-b flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                                    <div class="flex space-x-4 items-center">
                                        <h4 class="font-medium">Question Filters</h4>
                                    </div>
                                    <div class="relative w-full md:w-64">
                                        <input id="searchQuestion" type="text" placeholder="Search questions..."
                                            class="w-full pl-10 pr-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base" />
                                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                            <i class="fas fa-search text-sm"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="flex flex-wrap gap-4">
                                        <div class="relative">
                                            <label class="block text-xs font-medium text-gray-500 mb-1">Type</label>
                                            <div class="relative">
                                                <button id="typeFilterButton"
                                                    class="flex items-center justify-between w-32 p-2 text-sm border rounded-md bg-white"
                                                    onclick="toggleTypeDropdown()">
                                                    <span id="selectedType">All Types</span>
                                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                                </button>
                                                <div id="typeDropdown"
                                                    class="absolute z-10 hidden mt-1 w-full bg-white border rounded-md shadow-lg">
                                                    <ul class="py-1 text-sm">
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectType('', 'All Types')">All Types</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectType('text', 'Text Response')">Text Response
                                                        </li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectType('yesno', 'Yes/No')">Yes/No</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectType('multiple', 'Multiple Choice')">Multiple
                                                            Choice</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectType('rating', 'Rating Scale')">Rating Scale
                                                        </li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectType('file', 'File Upload')">File Upload</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <input type="hidden" id="filterQuestionType" value="">
                                        </div>
                                        <div class="relative">
                                            <label class="block text-xs font-medium text-gray-500 mb-1">Category</label>
                                            <div class="relative">
                                                <button id="categoryFilterButton"
                                                    class="flex items-center justify-between w-32 p-2 text-sm border rounded-md bg-white"
                                                    onclick="toggleCategoryDropdown()">
                                                    <span id="selectedCategory">All Categories</span>
                                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                                </button>
                                                <div id="categoryDropdown"
                                                    class="absolute z-10 hidden mt-1 w-full bg-white border rounded-md shadow-lg">
                                                    <ul class="py-1 text-sm">
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('', 'All Categories')">All
                                                            Categories</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Security', 'Security')">Security
                                                        </li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Compliance', 'Compliance')">
                                                            Compliance</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Privacy', 'Privacy')">Privacy</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Operations', 'Operations')">
                                                            Operations</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Training', 'Training')">Training
                                                        </li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Risk', 'Risk')">Risk</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Access Control', 'Access Control')">
                                                            Access Control</li>
                                                        <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                                            onclick="selectCategory('Data Protection', 'Data Protection')">
                                                            Data Protection</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <input type="hidden" id="filterQuestionCategory" value="">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow overflow-hidden">
                                <div class="responsive-table">
                                    <table class="w-full min-w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Question</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Type</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Category</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200" id="questionsTableBody">
                                            <!-- Table rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div id="settingsTabContent" class="mt-6 hidden">
                            <h3 class="text-lg font-medium mb-6">Assessment Settings</h3>

                            <div class="space-y-8">
                                <div>
                                    <h4 class="text-md font-medium mb-4">General Settings</h4>
                                    <div class="space-y-4 max-w-2xl">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h5 class="font-medium">Auto-save Responses</h5>
                                                <p class="text-sm text-gray-500">Automatically save assessment progress
                                                    as users complete questions</p>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="autoSaveToggle" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>

                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h5 class="font-medium">Email Notifications</h5>
                                                <p class="text-sm text-gray-500">Send email notifications for assessment
                                                    assignments and completions</p>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="emailToggle" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium mb-1">Default Due Date
                                                (days)</label>
                                            <input type="number" id="defaultDueDays" class="w-32 p-2 border rounded-md"
                                                value="30">
                                            <p class="text-xs text-gray-500 mt-1">Default number of days to complete an
                                                assessment from assignment date</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="text-md font-medium mb-4">User Permissions</h4>
                                    <div class="max-w-2xl overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th
                                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Role</th>
                                                    <th
                                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        View</th>
                                                    <th
                                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Create</th>
                                                    <th
                                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Edit</th>
                                                    <th
                                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Delete</th>
                                                    <th
                                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Assign</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                <tr>
                                                    <td class="px-4 py-3 whitespace-nowrap">Admin</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                </tr>
                                                <tr>
                                                    <td class="px-4 py-3 whitespace-nowrap">Manager</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">-</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                </tr>
                                                <tr>
                                                    <td class="px-4 py-3 whitespace-nowrap">User</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">âœ“</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">-</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">-</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">-</td>
                                                    <td class="px-4 py-3 whitespace-nowrap">-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="pt-4 border-t border-gray-200">
                                    <button id="saveSettingsBtn"
                                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                                        Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Module -->
                <div id="dashboard-module" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <!-- Total Risks Card -->
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:scale-105" onclick="navigateToDashboardModule('risk')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Total Risks</h3>
                                    <p id="totalRisksCount" class="text-2xl font-bold mt-1">0</p>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Total Assets Card -->
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:scale-105" onclick="navigateToDashboardModule('asset')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Total Assets</h3>
                                    <p id="totalAssetsCount" class="text-2xl font-bold mt-1">0</p>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <i class="fas fa-database text-blue-500"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Frameworks Card -->
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:scale-105" onclick="navigateToDashboardModule('frameworks')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Controls</h3>
                                    <p id="totalFrameworksCount" class="text-2xl font-bold mt-1">0</p>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <i class="fas fa-book-open text-purple-500"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Assessments Card -->
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:scale-105" onclick="navigateToDashboardModule('assessments')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Assessments</h3>
                                    <p id="totalAssessmentsCount" class="text-2xl font-bold mt-1">0</p>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <i class="fas fa-tasks text-green-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="modal" style="display: none; z-index: 9999;">
        <div class="modal-content" style="max-width: 400px; margin: auto; margin-top: 20vh;">
            <div class="text-center">
                <p id="customAlertMessage" class="text-lg text-gray-800 mb-6"></p>
                <button onclick="closeCustomAlert()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Description Modal -->
    <div id="descriptionModal" class="modal" style="display: none; z-index: 9998;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="descriptionModalTitle" class="text-xl font-medium">Description</h3>
                <button onclick="closeDescriptionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="descriptionModalContent" class="text-gray-700 whitespace-pre-wrap mb-6"></div>
            <div class="flex justify-end">
                <button onclick="closeDescriptionModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Risk Details Modal -->
    <div id="riskDetailsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h3 id="riskDetailsTitle" class="text-xl font-medium">Risk Name</h3>
                    <span id="riskDetailsBadge" class="ml-3 px-2 py-1 text-xs rounded-full badge-medium">
                        Medium Risk
                    </span>
                </div>
                <button onclick="closeRiskModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Description</h4>
                        <p id="riskDetailsDescription" class="mt-1">Risk description will appear here.</p>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Controls</h4>
                        <p id="riskDetailsControls" class="mt-1">Controls information will appear here.</p>
                    </div>
                </div>

                <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Category</h4>
                            <p id="riskDetailsCategory">Security</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Status</h4>
                            <span id="riskDetailsStatus" class="px-2 py-1 text-xs rounded-full badge-active">
                                Active
                            </span>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Owner</h4>
                            <p id="riskDetailsOwner">Security Team</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Review Date</h4>
                            <p id="riskDetailsReviewDate">2025-06-15</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Likelihood</h4>
                            <span id="riskDetailsLikelihood" class="px-2 py-1 text-xs rounded-full badge-medium">
                                Medium
                            </span>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Impact</h4>
                            <span id="riskDetailsImpact" class="px-2 py-1 text-xs rounded-full badge-high">
                                High
                            </span>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Risk Assessment</h4>
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full bg-indigo-600 mr-2"></div>
                            <div class="text-sm">
                                <span id="riskDetailsFormula" class="font-medium">Medium Likelihood Ã— High Impact = High
                                    Risk</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100" onclick="closeRiskModal()">
                    Close
                </button>
                <button id="editRiskBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                    onclick="openEditRiskModal()">
                    Edit Risk
                </button>
            </div>
        </div>
    </div>

    <!-- Add Risk Modal -->
    <div id="addRiskModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Add New Risk</h3>
                <button onclick="closeAddRiskModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addRiskForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Risk Name</label>
                    <input type="text" name="name" id="newRiskName" class="w-full p-2 border rounded-md"
                        placeholder="Enter risk name" required />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select name="category" id="newRiskCategory" class="w-full p-2 border rounded-md">
                            <option value="Security">Security</option>
                            <option value="Compliance">Compliance</option>
                            <option value="Availability">Availability</option>
                            <option value="Data">Data</option>
                            <option value="Supply Chain">Supply Chain</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Owner</label>
                        <input type="text" name="owner" id="newRiskOwner" class="w-full p-2 border rounded-md"
                            placeholder="Enter risk owner" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Likelihood</label>
                        <select name="likelihood" id="newRiskLikelihood" class="w-full p-2 border rounded-md"
                            onchange="updateRiskLevel()">
                            <option value="Very Low">Very Low</option>
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Impact</label>
                        <select name="impact" id="newRiskImpact" class="w-full p-2 border rounded-md"
                            onchange="updateRiskLevel()">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="newRiskStatus" class="w-full p-2 border rounded-md">
                            <option value="Active" selected>Active</option>
                            <option value="Mitigated">Mitigated</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Transferred">Transferred</option>
                            <option value="Avoided">Avoided</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Risk Level</label>
                        <input type="text" id="newRiskLevel" class="w-full p-2 border rounded-md bg-gray-100"
                            value="Medium" readonly />
                        <p class="text-xs text-gray-500 mt-1">Auto-calculated based on likelihood and impact</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="newRiskDescription" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the risk"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Controls</label>
                    <textarea name="controls" id="newRiskControls" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="List mitigating controls"></textarea>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeAddRiskModal()">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Save Risk
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Risk Modal -->
    <div id="editRiskModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Edit Risk</h3>
                <button onclick="closeEditRiskModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editRiskForm" class="space-y-4">
                <input type="hidden" id="editRiskId" value="" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Risk Name</label>
                    <input type="text" name="name" id="editRiskName" class="w-full p-2 border rounded-md"
                        placeholder="Enter risk name" required />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select name="category" id="editRiskCategory" class="w-full p-2 border rounded-md">
                            <option value="Security">Security</option>
                            <option value="Compliance">Compliance</option>
                            <option value="Availability">Availability</option>
                            <option value="Data">Data</option>
                            <option value="Supply Chain">Supply Chain</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Owner</label>
                        <input type="text" name="owner" id="editRiskOwner" class="w-full p-2 border rounded-md"
                            placeholder="Enter risk owner" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Likelihood</label>
                        <select name="likelihood" id="editRiskLikelihood" class="w-full p-2 border rounded-md"
                            onchange="updateEditRiskLevel()">
                            <option value="Very Low">Very Low</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Impact</label>
                        <select name="impact" id="editRiskImpact" class="w-full p-2 border rounded-md"
                            onchange="updateEditRiskLevel()">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="editRiskStatus" class="w-full p-2 border rounded-md">
                            <option value="Active">Active</option>
                            <option value="Mitigated">Mitigated</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Transferred">Transferred</option>
                            <option value="Avoided">Avoided</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Risk Level</label>
                        <input type="text" id="editRiskLevel" class="w-full p-2 border rounded-md bg-gray-100"
                            readonly />
                        <p class="text-xs text-gray-500 mt-1">Auto-calculated based on likelihood and impact</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="editRiskDescription" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the risk"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Controls</label>
                    <textarea name="controls" id="editRiskControls" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="List mitigating controls"></textarea>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeEditRiskModal()">
                        Cancel
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                        onclick="confirmDeleteRisk()">
                        Delete
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Update Risk
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Asset Detail Modal -->
    <div id="assetDetailsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h3 id="assetDetailsTitle" class="text-xl font-medium">Asset Name</h3>
                    <span id="assetDetailsBadge" class="ml-3 px-2 py-1 text-xs rounded-full badge-medium">
                        Medium Criticality
                    </span>
                </div>
                <button onclick="closeAssetModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Description</h4>
                        <p id="assetDetailsDescription" class="mt-1">Asset description will appear here.</p>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Purpose</h4>
                        <p id="assetDetailsPurpose" class="mt-1">Asset purpose information will appear here.</p>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Associated Risks</h4>
                        <ul id="assetDetailsRisks" class="mt-1 list-disc pl-5">
                            <!-- Risks will be populated here -->
                        </ul>
                    </div>
                </div>

                <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Type</h4>
                            <p id="assetDetailsType">Server</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Owner</h4>
                            <p id="assetDetailsOwner">IT Department</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Location</h4>
                            <p id="assetDetailsLocation">Data Center</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Last Review</h4>
                            <p id="assetDetailsReview">2025-03-15</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Status</h4>
                            <span id="assetDetailsStatus" class="px-2 py-1 text-xs rounded-full badge-active">
                                Active
                            </span>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Classification</h4>
                            <span id="assetDetailsClassification" class="px-2 py-1 text-xs rounded-full badge-high">
                                Confidential
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100" onclick="closeAssetModal()">
                    Close
                </button>
                <button id="editAssetBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Edit Asset
                </button>
            </div>
        </div>
    </div>

    <!-- DPIA Detail Modal -->
    <div id="dpiaDetailsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h3 id="dpiaDetailsTitle" class="text-xl font-medium">DPIA Name</h3>
                    <span id="dpiaDetailsStatus" class="ml-3 px-2 py-1 text-xs rounded-full badge-medium">
                        In Progress
                    </span>
                </div>
                <button onclick="closeDpiaModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Processing Activity</h4>
                        <p id="dpiaDetailsActivity" class="mt-1">DPIA processing activity will appear here.</p>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Data Categories</h4>
                        <p id="dpiaDetailsDataCategories" class="mt-1">Data categories will appear here.</p>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Risk Assessment</h4>
                        <p id="dpiaDetailsRiskAssessment" class="mt-1">Risk assessment will appear here.</p>
                    </div>
                </div>

                <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Department</h4>
                            <p id="dpiaDetailsDepartment">Marketing</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Date</h4>
                            <p id="dpiaDetailsDate">2025-05-15</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Risk Level</h4>
                            <span id="dpiaDetailsRiskLevel" class="px-2 py-1 text-xs rounded-full badge-medium">
                                Medium
                            </span>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Reviewer</h4>
                            <p id="dpiaDetailsReviewer">Privacy Officer</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-500">Completion Progress</h4>
                        <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                            <div id="dpiaDetailsProgress" class="bg-blue-600 h-2.5 rounded-full" style="width: 65%">
                            </div>
                        </div>
                        <div class="mt-1 text-right text-xs text-gray-500" id="dpiaDetailsProgressText">65%</div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100" onclick="closeDpiaModal()">
                    Close
                </button>
                <button id="editDpiaBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                    onclick="openEditDpiaModal()">
                    Edit DPIA
                </button>
            </div>
        </div>
    </div>

    <!-- Add Control Modal -->
    <div id="addControlModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Add Control to Framework</h3>
                <button onclick="closeAddControlModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addControlForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Control Name</label>
                        <input type="text" name="name" id="newControlName" class="w-full p-2 border rounded-md"
                            placeholder="e.g., Information Security Policy" required />
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea name="description" id="newControlDescription" class="w-full p-2 border rounded-md" rows="3"
                            placeholder="Describe what this control does and how it mitigates risk"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Control Type</label>
                        <select name="type" id="newControlType" class="w-full p-2 border rounded-md">
                            <option value="Preventive">Preventive</option>
                            <option value="Detective">Detective</option>
                            <option value="Corrective">Corrective</option>
                            <option value="Administrative">Administrative</option>
                            <option value="Technical">Technical</option>
                            <option value="Physical">Physical</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Implementation Status</label>
                        <select name="status" id="newControlStatus" class="w-full p-2 border rounded-md">
                            <option value="Implemented">Implemented</option>
                            <option value="Partially Implemented">Partially Implemented</option>
                            <option value="Not Implemented">Not Implemented</option>
                            <option value="Not Applicable">Not Applicable</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Owner</label>
                        <input type="text" name="owner" id="newControlOwner" class="w-full p-2 border rounded-md"
                            placeholder="e.g., Security Team, IT Department" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Review Frequency</label>
                        <select name="reviewFrequency" id="newControlReviewFrequency" class="w-full p-2 border rounded-md">
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Semi-Annual">Semi-Annual</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Associated Frameworks</label>
                    <div class="text-sm text-gray-600 mb-3">
                        Select which frameworks this control applies to. You can associate it with multiple frameworks.
                    </div>
                    <div id="frameworkCheckboxes" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto border rounded-md p-3">
                        <!-- Framework checkboxes will be populated here -->
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeAddControlModal()">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Add Control
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Control Modal -->
    <div id="editControlModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Edit Control</h3>
                <button onclick="closeEditControlModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editControlForm" class="space-y-4">
                <input type="hidden" id="editControlId" value="" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Control Name</label>
                        <input type="text" name="name" id="editControlName" class="w-full p-2 border rounded-md"
                            placeholder="e.g., Information Security Policy" required />
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea name="description" id="editControlDescription" class="w-full p-2 border rounded-md" rows="3"
                            placeholder="Describe what this control does and how it mitigates risk"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Control Type</label>
                        <select name="type" id="editControlType" class="w-full p-2 border rounded-md">
                            <option value="Preventive">Preventive</option>
                            <option value="Detective">Detective</option>
                            <option value="Corrective">Corrective</option>
                            <option value="Administrative">Administrative</option>
                            <option value="Technical">Technical</option>
                            <option value="Physical">Physical</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Implementation Status</label>
                        <select name="status" id="editControlStatus" class="w-full p-2 border rounded-md">
                            <option value="Implemented">Implemented</option>
                            <option value="Partially Implemented">Partially Implemented</option>
                            <option value="Not Implemented">Not Implemented</option>
                            <option value="Not Applicable">Not Applicable</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Owner</label>
                        <input type="text" name="owner" id="editControlOwner" class="w-full p-2 border rounded-md"
                            placeholder="e.g., Security Team, IT Department" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Review Frequency</label>
                        <select name="reviewFrequency" id="editControlReviewFrequency" class="w-full p-2 border rounded-md">
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Semi-Annual">Semi-Annual</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Associated Frameworks</label>
                    <div class="text-sm text-gray-600 mb-3">
                        Select which frameworks this control applies to. You can associate it with multiple frameworks.
                    </div>
                    <div id="editFrameworkCheckboxes" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto border rounded-md p-3">
                        <!-- Framework checkboxes will be populated here -->
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeEditControlModal()">
                        Cancel
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                        onclick="confirmDeleteControl()">
                        Delete
                    </button>
                    <button type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                        onclick="handleEditControlSubmit()">
                        Update Control
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="text-center p-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Confirm Delete</h3>
                <p id="confirmDeleteText" class="text-sm text-gray-500">Are you sure you want to delete this item? This
                    action cannot be undone.</p>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button type="button" id="confirmDeleteBtn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    Delete
                </button>
                <button type="button"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                    onclick="closeConfirmDeleteModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Matrix Risks List Modal -->
    <div id="matrixRisksModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="matrixRisksTitle" class="text-xl font-medium">Risks in Selected Cell</h3>
                <button onclick="closeMatrixRisksModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <div class="flex items-center space-x-2 mb-2">
                    <div id="matrixRisksCellColor" class="w-6 h-6 rounded"></div>
                    <span id="matrixRisksDescription" class="text-sm font-medium">Medium Likelihood Ã— High Impact</span>
                </div>
                <p class="text-sm text-gray-500">The following risks are in this risk matrix cell:</p>
            </div>

            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <ul id="matrixRisksList" class="divide-y divide-gray-200">
                    <!-- Risks will be populated here -->
                </ul>
            </div>

            <div class="flex justify-end">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                    onclick="closeMatrixRisksModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div id="editTemplateModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium" id="templateModalTitle">Edit Assessment Template</h3>
                <button onclick="closeEditTemplateModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editTemplateForm" class="space-y-4" onsubmit="handleEditTemplate(event); return false;">
                <input type="hidden" id="editTemplateId" value="" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                    <input type="text" name="name" id="editTemplateName" class="w-full p-2 border rounded-md"
                        placeholder="Enter template name" required />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="editTemplateDescription" class="w-full p-2 border rounded-md"
                        rows="3" placeholder="Describe the template purpose"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Questions</label>
                    <div class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto">
                        <div id="editTemplateQuestions" class="space-y-2">
                            <!-- Questions will be populated here -->
                        </div>
                        <button type="button" id="addQuestionToTemplateButton"
                            class="mt-3 text-sm text-indigo-600 hover:text-indigo-900">
                            + Add Question
                        </button>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeEditTemplateModal()">
                        Cancel
                    </button>
                    <button type="submit" id="saveTemplateButton"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Save Template
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clone Template Modal -->
    <div id="cloneTemplateModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Clone Assessment Template</h3>
                <button onclick="closeCloneTemplateModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="cloneTemplateForm" class="space-y-4" onsubmit="handleCloneTemplate(event); return false;">
                <input type="hidden" id="sourceTemplateId" value="" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">New Template Name</label>
                    <input type="text" name="name" id="cloneTemplateName" class="w-full p-2 border rounded-md"
                        placeholder="Enter new template name" required />
                </div>

                <div>
                    <p class="text-sm text-gray-500 mb-2">
                        This will create a copy of the template "<span id="sourceTemplateName"></span>" with all its
                        questions.
                    </p>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeCloneTemplateModal()">
                        Cancel
                    </button>
                    <button type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                        onclick="handleCloneTemplate(event)">
                        Clone Template
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Template Confirmation Modal -->
    <div id="deleteTemplateModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="text-center mb-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Delete Template</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500">
                        Are you sure you want to delete the template "<span id="deleteTemplateName"></span>"? This
                        action cannot be undone.
                    </p>
                </div>
            </div>
            <input type="hidden" id="deleteTemplateId" value="" />
            <div class="flex justify-center space-x-4">
                <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                    onclick="confirmDeleteTemplate(); return false;">
                    Delete
                </button>
                <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                    onclick="closeDeleteTemplateModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div id="editQuestionModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Edit Question</h3>
                <button onclick="closeEditQuestionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editQuestionForm" class="space-y-4">
                <input type="hidden" id="editQuestionId" value="" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Question Text</label>
                    <input type="text" id="editQuestionText" class="w-full p-2 border rounded-md"
                        placeholder="Enter your question..." required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Question Type</label>
                    <div class="relative">
                        <button id="editQuestionTypeButton" type="button"
                            class="flex items-center justify-between w-full p-2 text-sm border rounded-md bg-white"
                            onclick="toggleEditQuestionTypeDropdown()">
                            <span id="selectedEditQuestionType">Text Response</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </button>
                        <div id="editQuestionTypeDropdown"
                            class="absolute z-10 hidden mt-1 w-full bg-white border rounded-md shadow-lg">
                            <ul class="py-1 text-sm">
                                <li class="hover:bg-indigo-50 cursor-pointer"
                                    onclick="selectEditQuestionType('text', 'Text Response')">
                                    <div class="px-3 py-2 border-b">
                                        <div class="font-medium">Text Response</div>
                                        <div class="text-xs text-gray-500">Allows users to type a free-form answer.
                                        </div>
                                    </div>
                                </li>
                                <li class="hover:bg-indigo-50 cursor-pointer"
                                    onclick="selectEditQuestionType('yesno', 'Yes/No')">
                                    <div class="px-3 py-2 border-b">
                                        <div class="font-medium">Yes/No</div>
                                        <div class="text-xs text-gray-500">Provides a binary option: Yes or No.</div>
                                    </div>
                                </li>
                                <li class="hover:bg-indigo-50 cursor-pointer"
                                    onclick="selectEditQuestionType('multiple', 'Multiple Choice')">
                                    <div class="px-3 py-2 border-b">
                                        <div class="font-medium">Multiple Choice</div>
                                        <div class="text-xs text-gray-500">Lets you define several options; user selects
                                            one or more.</div>
                                    </div>
                                </li>
                                <li class="hover:bg-indigo-50 cursor-pointer"
                                    onclick="selectEditQuestionType('rating', 'Rating Scale')">
                                    <div class="px-3 py-2 border-b">
                                        <div class="font-medium">Rating Scale</div>
                                        <div class="text-xs text-gray-500">Used for Likert-type responses (e.g., 1 to 5
                                            stars, satisfaction levels).</div>
                                    </div>
                                </li>
                                <li class="hover:bg-indigo-50 cursor-pointer"
                                    onclick="selectEditQuestionType('file', 'File Upload')">
                                    <div class="px-3 py-2">
                                        <div class="font-medium">File Upload</div>
                                        <div class="text-xs text-gray-500">User uploads a file as a response (e.g.,
                                            resume, image, document).</div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <input type="hidden" id="editQuestionType" value="text">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="editQuestionCategory" class="w-full p-2 border rounded-md">
                        <option value="Security">Security</option>
                        <option value="Compliance">Compliance</option>
                        <option value="Privacy">Privacy</option>
                        <option value="Operations">Operations</option>
                        <option value="Training">Training</option>
                        <option value="Risk">Risk</option>
                        <option value="Access Control">Access Control</option>
                        <option value="Data Protection">Data Protection</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Help Text (Optional)</label>
                    <textarea id="editQuestionHelp" class="w-full p-2 border rounded-md" rows="2"
                        placeholder="Enter additional guidance for the question..."></textarea>
                </div>

                <!-- Multiple Choice Options -->
                <div id="editMultipleChoiceOptions" class="hidden mt-4 border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Multiple Choice Options</label>
                    <div class="mb-2 flex items-center">
                        <input type="checkbox" id="editMultipleAllowMultiple" class="mr-2">
                        <label for="editMultipleAllowMultiple" class="text-sm text-gray-700">Allow selecting multiple
                            options</label>
                    </div>
                    <div id="editMultipleChoiceOptionsList" class="space-y-2">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 mr-2">
                                <input type="checkbox"
                                    class="correct-option h-4 w-4 text-indigo-600 border-gray-300 rounded"
                                    title="Mark as correct answer">
                            </div>
                            <input type="text" class="w-full p-2 border rounded-md" placeholder="Enter an option...">
                            <button type="button" class="ml-2 text-red-600" onclick="removeEditOption(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button"
                        class="mt-2 px-3 py-1 text-sm text-indigo-600 border border-indigo-600 rounded-md hover:bg-indigo-50"
                        onclick="addEditMultipleChoiceOption()">
                        <i class="fas fa-plus mr-1"></i> Add Option
                    </button>
                </div>

                <!-- Rating Scale Options -->
                <div id="editRatingScaleOptions" class="hidden mt-4 border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rating Scale Options</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Minimum Value</label>
                            <input type="number" id="editRatingMin" class="w-full p-2 border rounded-md" value="1"
                                min="0" max="10">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Maximum Value</label>
                            <input type="number" id="editRatingMax" class="w-full p-2 border rounded-md" value="5"
                                min="1" max="10">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-500 mb-1">Scale Labels (Optional)</label>
                        <input type="text" id="editRatingLabels" class="w-full p-2 border rounded-md"
                            placeholder="e.g., Poor, Fair, Good, Very Good, Excellent">
                        <p class="text-xs text-gray-500 mt-1">Separate labels with commas. Number of labels should match
                            the scale range.</p>
                    </div>
                </div>

                <!-- File Upload Options -->
                <div id="editFileUploadOptions" class="hidden mt-4 border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">File Upload Options</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Allowed File Types</label>
                            <input type="text" id="editFileTypes" class="w-full p-2 border rounded-md"
                                placeholder="e.g., .pdf,.doc,.jpg">
                            <p class="text-xs text-gray-500 mt-1">Separate file extensions with commas</p>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Maximum File Size (MB)</label>
                            <input type="number" id="editFileMaxSize" class="w-full p-2 border rounded-md" value="10"
                                min="1" max="100">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeEditQuestionModal()">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Save Question
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Question Confirmation Modal -->
    <div id="deleteQuestionModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="text-center mb-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Delete Question</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500">
                        Are you sure you want to delete this question? This action cannot be undone.
                    </p>
                </div>
            </div>
            <input type="hidden" id="deleteQuestionId" value="" />
            <div class="flex justify-center space-x-4">
                <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                    onclick="confirmDeleteQuestion()">
                    Delete
                </button>
                <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                    onclick="closeDeleteQuestionModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Add Question to Template Modal -->
    <div id="addQuestionToTemplateModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Add Questions to Template</h3>
                <button onclick="closeAddQuestionToTemplateModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addQuestionsToTemplateForm" class="space-y-4"
                onsubmit="handleAddQuestionsToTemplate(event); return false;">
                <input type="hidden" id="addQuestionToTemplateId" value="" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Available Questions</label>
                    <div class="bg-gray-50 p-2 rounded-lg max-h-80 overflow-y-auto">
                        <div id="availableQuestionsList" class="divide-y divide-gray-200">
                            <!-- Questions will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeAddQuestionToTemplateModal()">
                        Cancel
                    </button>
                    <button type="button" id="addSelectedQuestionsButton"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Add Selected Questions
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div id="addAssetModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Add New Asset</h3>
                <button onclick="closeAddAssetModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addAssetForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Asset Name</label>
                    <input type="text" name="name" id="newAssetName" class="w-full p-2 border rounded-md"
                        placeholder="Enter asset name" required />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select name="type" id="newAssetType" class="w-full p-2 border rounded-md">
                            <option value="Server">Server</option>
                            <option value="Database">Database</option>
                            <option value="Application">Application</option>
                            <option value="Network">Network</option>
                            <option value="Endpoint">Endpoint</option>
                            <option value="Cloud Service">Cloud Service</option>
                            <option value="IoT Device">IoT Device</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Owner</label>
                        <input type="text" name="owner" id="newAssetOwner" class="w-full p-2 border rounded-md"
                            placeholder="Enter asset owner" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" name="location" id="newAssetLocation" class="w-full p-2 border rounded-md"
                            placeholder="Enter asset location" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Criticality</label>
                        <select name="criticality" id="newAssetCriticality" class="w-full p-2 border rounded-md">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="newAssetStatus" class="w-full p-2 border rounded-md">
                            <option value="Active" selected>Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Retired">Retired</option>
                            <option value="In Development">In Development</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Classification</label>
                        <select name="classification" id="newAssetClassification" class="w-full p-2 border rounded-md">
                            <option value="Public">Public</option>
                            <option value="Internal" selected>Internal</option>
                            <option value="Confidential">Confidential</option>
                            <option value="Restricted">Restricted</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cost</label>
                        <input type="number" name="cost" id="newAssetCost" class="w-full p-2 border rounded-md"
                            placeholder="Enter asset cost" min="0" step="0.01" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="newAssetDescription" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the asset"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Purpose</label>
                    <textarea name="purpose" id="newAssetPurpose" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the purpose of this asset"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Associated Risks</label>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="max-h-40 overflow-y-auto">
                            <div id="newAssetRisksContainer" class="space-y-2">
                                <!-- Risks checkboxes will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeAddAssetModal()">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Save Asset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Asset Modal -->
    <div id="editAssetModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Edit Asset</h3>
                <button onclick="closeEditAssetModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editAssetForm" class="space-y-4">
                <input type="hidden" id="editAssetId" value="" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Asset Name</label>
                    <input type="text" name="name" id="editAssetName" class="w-full p-2 border rounded-md"
                        placeholder="Enter asset name" required />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select name="type" id="editAssetType" class="w-full p-2 border rounded-md">
                            <option value="Server">Server</option>
                            <option value="Database">Database</option>
                            <option value="Application">Application</option>
                            <option value="Network">Network</option>
                            <option value="Endpoint">Endpoint</option>
                            <option value="Cloud Service">Cloud Service</option>
                            <option value="IoT Device">IoT Device</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Owner</label>
                        <input type="text" name="owner" id="editAssetOwner" class="w-full p-2 border rounded-md"
                            placeholder="Enter asset owner" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" name="location" id="editAssetLocation" class="w-full p-2 border rounded-md"
                            placeholder="Enter asset location" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Criticality</label>
                        <select name="criticality" id="editAssetCriticality" class="w-full p-2 border rounded-md">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="editAssetStatus" class="w-full p-2 border rounded-md">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Retired">Retired</option>
                            <option value="In Development">In Development</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Classification</label>
                        <select name="classification" id="editAssetClassification" class="w-full p-2 border rounded-md">
                            <option value="Public">Public</option>
                            <option value="Internal">Internal</option>
                            <option value="Confidential">Confidential</option>
                            <option value="Restricted">Restricted</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cost</label>
                        <input type="number" name="cost" id="editAssetCost" class="w-full p-2 border rounded-md"
                            placeholder="Enter asset cost" min="0" step="0.01" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="editAssetDescription" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the asset"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Purpose</label>
                    <textarea name="purpose" id="editAssetPurpose" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the purpose of this asset"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Associated Risks</label>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="max-h-40 overflow-y-auto">
                            <div id="editAssetRisksContainer" class="space-y-2">
                                <!-- Risks checkboxes will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeEditAssetModal()">
                        Cancel
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                        onclick="confirmDeleteAsset()">
                        Delete
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Update Asset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add DPIA Modal -->
    <div id="addDpiaModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Add New DPIA</h3>
                <button onclick="closeAddDpiaModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addDpiaForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">DPIA Name</label>
                    <input type="text" name="name" id="newDpiaName" class="w-full p-2 border rounded-md"
                        placeholder="Enter DPIA name" required />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <input type="text" name="department" id="newDpiaDepartment" class="w-full p-2 border rounded-md"
                            placeholder="Enter department" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="newDpiaStatus" class="w-full p-2 border rounded-md">
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" name="date" id="newDpiaDate" class="w-full p-2 border rounded-md" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Risk Level</label>
                        <select name="risk" id="newDpiaRisk" class="w-full p-2 border rounded-md">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reviewer</label>
                        <input type="text" name="reviewer" id="newDpiaReviewer" class="w-full p-2 border rounded-md"
                            placeholder="Enter reviewer name" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Completion Progress (%)</label>
                        <input type="number" name="progress" id="newDpiaProgress" class="w-full p-2 border rounded-md"
                            min="0" max="100" value="0" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Processing Activity</label>
                    <textarea name="activity" id="newDpiaActivity" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the processing activity"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Categories</label>
                    <textarea name="dataCategories" id="newDpiaDataCategories" class="w-full p-2 border rounded-md"
                        rows="2" placeholder="List the categories of data being processed"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Risk Assessment</label>
                    <textarea name="riskAssessment" id="newDpiaRiskAssessment" class="w-full p-2 border rounded-md"
                        rows="3" placeholder="Provide a risk assessment for this processing activity"></textarea>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeAddDpiaModal()">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Save DPIA
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assessment View Modal -->
    <div id="assessmentViewModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h3 id="assessmentViewTitle" class="text-xl font-medium">Assessment Name</h3>
                    <span id="assessmentViewStatus" class="ml-3 px-2 py-1 text-xs rounded-full badge-medium">
                        In Progress
                    </span>
                </div>
                <button onclick="closeAssessmentViewModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-medium">Progress</h4>
                    <span id="assessmentViewCompletion" class="text-sm font-medium">Question 1 of 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="assessmentViewProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-xs text-gray-500 text-center">
                    <i class="fas fa-save mr-1"></i>
                    <span id="autoSaveStatus">Auto-save enabled</span>
                </div>
            </div>

            <div class="space-y-6">
                <div id="assessmentQuestionContainer" class="space-y-8">
                    <!-- Questions will be populated here -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <p class="text-center text-gray-500">No questions available for this assessment.</p>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button id="prevQuestionBtn"
                        class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100 disabled:opacity-50"
                        disabled>
                        <i class="fas fa-arrow-left mr-2"></i> Previous
                    </button>
                    <div id="submitAssessmentContainer" class="hidden">
                        <button id="submitAssessmentBtn"
                            class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i> Submit Assessment
                        </button>
                    </div>
                    <button id="nextQuestionBtn" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100">
                        Next <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Assessment Modal -->
    <div id="startAssessmentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Start Assessment</h3>
                <button onclick="closeStartAssessmentModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <h4 id="startAssessmentName" class="font-medium text-xl mb-2">Assessment Name</h4>
                    <p id="startAssessmentDescription" class="text-gray-700 mb-4">Assessment description will appear
                        here.</p>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        <h5 class="font-medium">Assessment Information</h5>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Framework:</p>
                            <p id="startAssessmentFramework" class="font-medium">ISO 27001</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Total Questions:</p>
                            <p id="startAssessmentQuestions" class="font-medium">45</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Due Date:</p>
                            <p id="startAssessmentDueDate" class="font-medium">2025-06-30</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Assignee:</p>
                            <p id="startAssessmentAssignee" class="font-medium">Security Team</p>
                        </div>
                    </div>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                        <h5 class="font-medium">Important Notes</h5>
                    </div>
                    <ul class="list-disc pl-5 text-sm space-y-1">
                        <li>Once started, the assessment status will change to "In Progress"</li>
                        <li>You can save your progress and return to complete the assessment later</li>
                        <li>All responses will be recorded and available for review by administrators</li>
                        <li>Please provide accurate and detailed information for each question</li>
                    </ul>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                    onclick="closeStartAssessmentModal()">
                    Cancel
                </button>
                <button id="confirmStartAssessmentBtn"
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    Begin Assessment
                </button>
            </div>
        </div>
    </div>

    <!-- Edit DPIA Modal -->
    <div id="editDpiaModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Edit DPIA</h3>
                <button onclick="closeEditDpiaModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editDpiaForm" class="space-y-4">
                <input type="hidden" id="editDpiaId" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">DPIA Name</label>
                    <input type="text" name="name" id="editDpiaName" class="w-full p-2 border rounded-md"
                        placeholder="Enter DPIA name" required />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <input type="text" name="department" id="editDpiaDepartment"
                            class="w-full p-2 border rounded-md" placeholder="Enter department" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="editDpiaStatus" class="w-full p-2 border rounded-md">
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" name="date" id="editDpiaDate" class="w-full p-2 border rounded-md" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Risk Level</label>
                        <select name="risk" id="editDpiaRisk" class="w-full p-2 border rounded-md">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reviewer</label>
                        <input type="text" name="reviewer" id="editDpiaReviewer" class="w-full p-2 border rounded-md"
                            placeholder="Enter reviewer name" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Completion Progress (%)</label>
                        <input type="number" name="progress" id="editDpiaProgress" class="w-full p-2 border rounded-md"
                            min="0" max="100" value="0" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Processing Activity</label>
                    <textarea name="activity" id="editDpiaActivity" class="w-full p-2 border rounded-md" rows="3"
                        placeholder="Describe the processing activity"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Categories</label>
                    <textarea name="dataCategories" id="editDpiaDataCategories" class="w-full p-2 border rounded-md"
                        rows="2" placeholder="List the categories of data being processed"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Risk Assessment</label>
                    <textarea name="riskAssessment" id="editDpiaRiskAssessment" class="w-full p-2 border rounded-md"
                        rows="3" placeholder="Provide a risk assessment for this processing activity"></textarea>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeEditDpiaModal()">
                        Cancel
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                        onclick="confirmDeleteDpia()">
                        Delete
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Update DPIA
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Framework Detail Modal -->
    <div id="frameworkDetailsModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h3 id="frameworkDetailsTitle" class="text-xl font-medium">Framework Name</h3>
                    <span id="frameworkDetailsStatus" class="ml-3 px-2 py-1 text-xs rounded-full badge-active">
                        Active
                    </span>
                </div>
                <button onclick="closeFrameworkModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-700 mb-1">Controls</h4>
                        <div class="text-3xl font-bold" id="frameworkDetailsControls">114</div>
                        <p class="text-sm text-blue-600 mt-1">Total controls in framework</p>
                    </div>

                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-1">Compliance</h4>
                        <div class="text-3xl font-bold" id="frameworkDetailsCompliance">78%</div>
                        <p class="text-sm text-green-600 mt-1">Overall compliance rate</p>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-medium text-purple-700 mb-1">Last Assessment</h4>
                        <div class="text-xl font-bold" id="frameworkDetailsLastAssessment">2025-03-10</div>
                        <p class="text-sm text-purple-600 mt-1">Date of last assessment</p>
                    </div>

                    <div id="frameworkReadinessCard" class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-medium text-yellow-700 mb-1">Readiness</h4>
                        <div class="text-xl font-bold" id="frameworkDetailsReadiness">Not Ready</div>
                        <div class="mt-2">
                            <button id="toggleReadinessBtn"
                                class="text-sm px-3 py-1 rounded bg-yellow-200 hover:bg-yellow-300 text-yellow-800"
                                onclick="toggleFrameworkReadiness(); event.stopPropagation();">
                                Mark as Ready
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="font-medium mb-2">Description</h4>
                    <p id="frameworkDetailsDescription" class="text-gray-700">Framework description will appear here.
                    </p>
                </div>

                <div>
                    <h4 class="font-medium mb-3">Compliance by Domain</h4>
                    <div class="space-y-4" id="frameworkDetailsDomains">
                        <!-- Domain progress bars will be populated here -->
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    <h4 class="font-medium mb-3">Controls</h4>
                    <div id="frameworkDetailsControlsList" class="space-y-2">
                        <!-- Controls will be populated here -->
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium">Uploaded Documents</h4>
                        <button id="uploadDocumentBtn"
                                class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                                onclick="openDocumentUploadModal()"
                                style="display: none;">
                            <i class="fas fa-upload mr-1"></i>Upload
                        </button>
                    </div>
                    <div id="frameworkDetailsDocuments" class="space-y-2">
                        <!-- Documents will be populated here -->
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium">Comments</h4>
                        <button id="addCommentBtn"
                                class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700"
                                onclick="openAddCommentModal()"
                                style="display: none;">
                            <i class="fas fa-comment mr-1"></i>Add Comment
                        </button>
                    </div>
                    <div id="frameworkDetailsComments" class="space-y-3 mb-4">
                        <!-- Comments will be populated here -->
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    <h4 class="font-medium mb-3">Recent Activities</h4>
                    <div class="space-y-3" id="frameworkDetailsActivities">
                        <!-- Activities will be populated here -->
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                    onclick="closeFrameworkModal()">
                    Close
                </button>
                <button id="editFrameworkBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                    onclick="openEditFrameworkModal()">
                    Edit Framework
                </button>
            </div>
        </div>
    </div>

    <!-- Add Framework Modal -->
    <div id="addFrameworkModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Add New Framework</h3>
                <button onclick="closeAddFrameworkModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addFrameworkForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Framework Name</label>
                    <input type="text" name="name" id="newFrameworkName" class="w-full p-2 border rounded-md"
                        placeholder="Enter framework name" required />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="newFrameworkDescription" class="w-full p-2 border rounded-md"
                        rows="3" placeholder="Describe the framework" required></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="newFrameworkStatus" class="w-full p-2 border rounded-md">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Controls</label>
                        <input type="number" id="newFrameworkTotalControls" class="w-full p-2 border rounded-md"
                            placeholder="Number of controls" min="0" value="0" readonly />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Controls</label>
                    <div id="newFrameworkControlsList" class="space-y-2 mb-3 max-h-48 overflow-y-auto border border-gray-200 rounded-md p-3">
                        <p class="text-sm text-gray-500">No controls available. Add controls after creating the framework.</p>
                    </div>
                    <button type="button" class="text-sm text-indigo-600 hover:text-indigo-900"
                        onclick="toggleNewFrameworkControlsPanel()">
                        <i class="fas fa-plus mr-1"></i>Add Controls
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Domains</label>
                    <div id="newFrameworkDomains" class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <input type="text" class="domain-name p-2 border rounded-md flex-grow"
                                placeholder="Domain name" />
                            <input type="number" class="domain-compliance p-2 border rounded-md w-24"
                                placeholder="Compliance %" min="0" max="100" />
                            <button type="button" class="p-2 text-red-500" onclick="removeDomainField(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="mt-2 text-sm text-indigo-600 hover:text-indigo-900"
                        onclick="addDomainField('newFrameworkDomains')">
                        + Add Domain
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Readiness</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="readiness" value="ready" class="h-4 w-4 text-indigo-600">
                            <span class="ml-2">Ready</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="readiness" value="not-ready" class="h-4 w-4 text-indigo-600"
                                checked>
                            <span class="ml-2">Not Ready</span>
                        </label>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeAddFrameworkModal()">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Save Framework
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Framework Modal -->
    <div id="editFrameworkModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Edit Framework</h3>
                <button onclick="closeEditFrameworkModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editFrameworkForm" class="space-y-4">
                <input type="hidden" id="editFrameworkId" value="" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Framework Name</label>
                    <input type="text" name="name" id="editFrameworkName" class="w-full p-2 border rounded-md"
                        placeholder="Enter framework name" required />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" id="editFrameworkDescription" class="w-full p-2 border rounded-md"
                        rows="3" placeholder="Describe the framework" required></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Controls</label>
                        <input type="number" name="controls" id="editFrameworkControls"
                            class="w-full p-2 border rounded-md" placeholder="Number of controls" min="1" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="editFrameworkStatus" class="w-full p-2 border rounded-md">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <!-- Controls Management Section -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-900">Framework Controls</h4>
                        <button type="button" onclick="openAddControlModal()"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">
                            <i class="fas fa-plus mr-2"></i>Add Control
                        </button>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-3">
                            Manage controls associated with this framework. Controls can be shared across multiple frameworks.
                        </div>

                        <!-- Controls List -->
                        <div id="frameworkControlsList" class="space-y-2">
                            <!-- Controls will be populated here -->
                        </div>

                        <!-- Empty State -->
                        <div id="frameworkControlsEmpty" class="text-center py-6 text-gray-500 hidden">
                            <i class="fas fa-shield-alt text-3xl mb-2"></i>
                            <p>No controls associated with this framework yet.</p>
                            <p class="text-sm">Click "Add Control" to get started.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Domains</label>
                    <div id="editFrameworkDomains" class="space-y-3">
                        <!-- Domain fields will be populated dynamically -->
                    </div>
                    <button type="button" class="mt-2 text-sm text-indigo-600 hover:text-indigo-900"
                        onclick="addDomainField('editFrameworkDomains')">
                        + Add Domain
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Readiness</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="editReadiness" id="editReadinessReady" value="ready"
                                class="h-4 w-4 text-indigo-600">
                            <span class="ml-2">Ready</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="editReadiness" id="editReadinessNotReady" value="not-ready"
                                class="h-4 w-4 text-indigo-600">
                            <span class="ml-2">Not Ready</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Documents</label>

                    <!-- Current Documents Display -->
                    <div id="editFrameworkCurrentDocuments" class="mb-4">
                        <!-- Current documents will be populated here -->
                    </div>

                    <!-- Upload New Documents -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload New Documents</label>
                        <input type="file" id="editFrameworkDocuments" multiple
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"
                               class="w-full p-2 border border-gray-300 rounded">
                        <p class="text-sm text-gray-500 mt-2">
                            Supports: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (Max: 10MB each)
                        </p>
                        <p class="text-sm text-amber-600 mt-1 font-medium">
                            âš ï¸ Note: Uploading new documents will replace all existing documents for this framework.
                        </p>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                        onclick="closeEditFrameworkModal()">
                        Cancel
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                        onclick="confirmDeleteFramework()">
                        Delete
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Update Framework
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Comment Modal -->
    <div id="addCommentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-medium">Add Comment</h3>
                <button onclick="closeAddCommentModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addCommentForm" onsubmit="handleSaveComment(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Comment</label>
                    <textarea id="commentText" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="Enter your comment here..." rows="5" required></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddCommentModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        <i class="fas fa-comment mr-2"></i>Post Comment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assessment Detail Modal -->
    <div id="assessmentDetailsModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h3 id="assessmentDetailsTitle" class="text-xl font-medium">Assessment Name</h3>
                    <span id="assessmentDetailsStatus" class="ml-3 px-2 py-1 text-xs rounded-full badge-medium">
                        In Progress
                    </span>
                </div>
                <button onclick="closeAssessmentModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-6">
                    <div>
                        <h4 class="font-medium mb-2">Description</h4>
                        <p id="assessmentDetailsDescription" class="text-gray-700">Assessment description will appear
                            here.</p>
                    </div>

                    <div>
                        <h4 class="font-medium mb-3">Assessment Progress</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium">Overall Completion</span>
                                    <span class="text-sm font-medium" id="assessmentDetailsCompletion">65%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="assessmentDetailsProgressBar" class="bg-blue-600 h-2.5 rounded-full"
                                        style="width: 65%"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                <div class="bg-gray-50 p-3 rounded-lg text-center">
                                    <div class="font-medium" id="assessmentDetailsTotalQuestions">45</div>
                                    <div class="text-xs text-gray-500">Total Questions</div>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg text-center">
                                    <div class="font-medium text-green-700" id="assessmentDetailsCompleted">29</div>
                                    <div class="text-xs text-gray-500">Completed</div>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded-lg text-center">
                                    <div class="font-medium text-yellow-700" id="assessmentDetailsPending">16</div>
                                    <div class="text-xs text-gray-500">Pending</div>
                                </div>
                                <div class="bg-red-50 p-3 rounded-lg text-center">
                                    <div class="font-medium text-red-700" id="assessmentDetailsIssues">5</div>
                                    <div class="text-xs text-gray-500">Issues</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-medium mb-3">Recent Activity</h4>
                        <div class="space-y-3" id="assessmentDetailsActivities">
                            <!-- Activities will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-3">Details</h4>
                        <div class="space-y-3">
                            <div>
                                <h5 class="text-sm text-gray-500">Type</h5>
                                <p id="assessmentDetailsType" class="font-medium">Internal</p>
                            </div>
                            <div>
                                <h5 class="text-sm text-gray-500">Due Date</h5>
                                <p id="assessmentDetailsDueDate" class="font-medium">2025-06-15</p>
                            </div>
                            <div>
                                <h5 class="text-sm text-gray-500">Assignee</h5>
                                <p id="assessmentDetailsAssignee" class="font-medium">Sarah Johnson</p>
                            </div>
                            <div>
                                <h5 class="text-sm text-gray-500">Framework</h5>
                                <p id="assessmentDetailsFramework" class="font-medium">ISO 27001</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-3 text-blue-700">Actions</h4>
                        <div class="space-y-2">
                            <button id="viewAssessmentBtn"
                                class="w-full py-2 px-3 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50"
                                onclick="viewAssessment()">
                                <i class="fas fa-eye mr-2"></i> View Assessment
                            </button>
                            <button id="viewResultsBtn"
                                class="w-full py-2 px-3 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 hidden"
                                onclick="viewAssessmentResults()">
                                <i class="fas fa-chart-line mr-2"></i> View Results
                            </button>
                            <button
                                class="w-full py-2 px-3 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
                                <i class="fas fa-file-export mr-2"></i> Export Results
                            </button>
                            <button
                                class="w-full py-2 px-3 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
                                <i class="fas fa-user-plus mr-2"></i> Assign User
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                    onclick="closeAssessmentModal()">
                    Close
                </button>
                <button id="editAssessmentBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                    onclick="alert('Edit Assessment functionality to be implemented')">
                    Edit Assessment
                </button>
            </div>
        </div>
        <button class="edit-btn" data-tpl-id="{{idOrCustomId}}">Edit</button>

    </div>

    <!-- Assessment Results Modal -->
    <div id="assessmentResultsModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="assessmentResultsTitle" class="text-xl font-medium">Assessment Results</h3>
                <button onclick="closeAssessmentResultsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Loading State -->
            <div id="resultsLoadingState" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <p class="mt-2 text-gray-600">Loading assessment results...</p>
            </div>

            <!-- No Results State -->
            <div id="noResultsState" class="text-center py-8 hidden">
                <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-3"></i>
                <h5 class="text-gray-600 font-medium">No Results Available</h5>
                <p class="text-gray-500">This assessment hasn't been completed yet.</p>
            </div>

            <!-- Results Content -->
            <div id="resultsContent" class="hidden">
                <!-- Assessment Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <h5 id="resultTotalQuestions" class="text-2xl font-bold text-blue-600">0</h5>
                        <p class="text-sm text-blue-600">Total Questions</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <h5 id="resultMaturityScore" class="text-2xl font-bold text-green-600">0/5</h5>
                        <p class="text-sm text-green-600">Maturity Score</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <h5 id="resultRisksIdentified" class="text-2xl font-bold text-yellow-600">0</h5>
                        <p class="text-sm text-yellow-600">Risks Identified</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <h5 id="resultSubmissionDate" class="text-2xl font-bold text-purple-600">-</h5>
                        <p class="text-sm text-purple-600">Submitted</p>
                    </div>
                </div>

                <!-- Assessment Details -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <h4 id="resultAssessmentName" class="text-lg font-medium mb-2">Assessment Name</h4>
                    <p id="resultAssessmentDescription" class="text-gray-700">Assessment description</p>
                </div>

                <!-- Questions and Answers -->
                <div class="space-y-4">
                    <h4 class="text-lg font-medium">Questions & Answers</h4>
                    <div id="questionsAnswersContainer" class="space-y-3">
                        <!-- Questions and answers will be populated here -->
                    </div>
                </div>

                <!-- Domain Scores -->
                <div id="domainScoresContainer" class="mt-6 hidden">
                    <h4 class="text-lg font-medium mb-4">Domain Scores</h4>
                    <div id="domainScoresList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Domain scores will be populated here -->
                    </div>
                </div>

                <!-- Identified Risks -->
                <div id="identifiedRisksContainer" class="mt-6 hidden">
                    <h4 class="text-lg font-medium mb-4">Identified Risks</h4>
                    <div id="identifiedRisksList" class="space-y-3">
                        <!-- Identified risks will be populated here -->
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100"
                    onclick="closeAssessmentResultsModal()">
                    Close
                </button>
                <button id="exportResultsBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                    onclick="exportAssessmentResults()">
                    <i class="fas fa-download mr-2"></i> Export Results
                </button>
            </div>
        </div>
    </div>

    <script>
        // // Risk data
        // const risks = [
        //     { id: 1, name: 'Unauthorized Access', category: 'Security', likelihood: 'Medium', impact: 'High', level: 'High', status: 'Active', owner: 'Security Team', reviewDate: '2025-06-15', controls: 'Access Control, MFA, Audit Logging', description: 'Risk of unauthorized users gaining access to sensitive systems or data.' },
        //     { id: 2, name: 'Data Breach', category: 'Security', likelihood: 'Low', impact: 'Critical', level: 'High', status: 'Mitigated', owner: 'CISO', reviewDate: '2025-05-10', controls: 'Encryption, DLP, Network Segmentation', description: 'Exposure of sensitive or confidential data to unauthorized parties.' },
        //     { id: 3, name: 'Service Outage', category: 'Availability', likelihood: 'Medium', impact: 'High', level: 'High', status: 'Active', owner: 'IT Operations', reviewDate: '2025-07-22', controls: 'HA Architecture, DR Plan, Monitoring', description: 'Temporary unavailability of critical business services.' },
        //     { id: 4, name: 'Malware Infection', category: 'Security', likelihood: 'Medium', impact: 'Medium', level: 'Medium', status: 'Active', owner: 'Security Team', reviewDate: '2025-05-30', controls: 'Antivirus, EDR, User Training', description: 'Systems infected with malicious software affecting operations.' },
        //     { id: 5, name: 'Regulatory Non-compliance', category: 'Compliance', likelihood: 'Low', impact: 'High', level: 'Medium', status: 'Mitigated', owner: 'Compliance Officer', reviewDate: '2025-04-15', controls: 'Compliance Monitoring, Audits, Policies', description: 'Failure to comply with applicable laws, regulations, or standards.' },
        //     { id: 6, name: 'Third-party Provider Failure', category: 'Supply Chain', likelihood: 'Low', impact: 'Medium', level: 'Medium', status: 'Active', owner: 'Vendor Management', reviewDate: '2025-06-20', controls: 'Vendor Assessment, SLAs, Backup Providers', description: 'Critical service provider unable to deliver expected services.' },
        //     { id: 7, name: 'Data Corruption', category: 'Data', likelihood: 'Very Low', impact: 'Critical', level: 'Medium', status: 'Active', owner: 'Data Management', reviewDate: '2025-08-05', controls: 'Backup Strategy, Data Validation, Recovery Testing', description: 'Loss of data integrity affecting business operations.' },
        //     { id: 8, name: 'Insider Threat', category: 'Security', likelihood: 'Low', impact: 'High', level: 'Medium', status: 'Active', owner: 'HR & Security', reviewDate: '2025-05-25', controls: 'Access Reviews, Monitoring, Separation of Duties', description: 'Malicious actions by current or former employees with privileged access.' },
        //     { id: 9, name: 'Cloud Service Outage', category: 'Availability', likelihood: 'Medium', impact: 'Medium', level: 'Medium', status: 'Active', owner: 'IT Operations', reviewDate: '2025-07-10', controls: 'Multi-cloud Strategy, Failover Systems, SLAs', description: 'Unavailability of cloud services affecting business operations.' },
        //     { id: 10, name: 'Social Engineering', category: 'Security', likelihood: 'Medium', impact: 'Medium', level: 'Medium', status: 'Active', owner: 'Security Team', reviewDate: '2025-06-05', controls: 'Security Awareness Training, Phishing Simulations, Verification Procedures', description: 'Manipulation of employees to gain unauthorized access or information.' },
        // ];

        // // Asset data
        // const assets = [
        //     { id: 1, name: 'Web Application Server', type: 'Server', owner: 'IT Department', location: 'Data Center', criticality: 'Critical', classification: 'Confidential', status: 'Active', lastReview: '2025-03-15', description: 'Primary server hosting the company\'s web applications.', purpose: 'Hosts customer-facing applications and services.', risks: [1, 3, 4] },
        //     { id: 2, name: 'Customer Database', type: 'Database', owner: 'Data Team', location: 'Cloud', criticality: 'Critical', classification: 'Restricted', status: 'Active', lastReview: '2025-02-20', description: 'Primary database storing customer information.', purpose: 'Stores and processes customer data for business operations.', risks: [1, 2, 7] },
        //     { id: 3, name: 'Office Workstations', type: 'Endpoint', owner: 'IT Department', location: 'Office', criticality: 'Medium', classification: 'Internal', status: 'Active', lastReview: '2025-04-10', description: 'Desktop computers and laptops used by employees.', purpose: 'Provides employees with computing resources for daily work.', risks: [4, 8] },
        //     { id: 4, name: 'Network Firewall', type: 'Network', owner: 'Security Team', location: 'Data Center', criticality: 'High', classification: 'Confidential', status: 'Active', lastReview: '2025-03-05', description: 'Perimeter firewall protecting the corporate network.', purpose: 'Filters network traffic and prevents unauthorized access.', risks: [1] },
        //     { id: 5, name: 'Company Website', type: 'Application', owner: 'Marketing', location: 'Cloud', criticality: 'Medium', classification: 'Public', status: 'Active', lastReview: '2025-01-30', description: 'Public-facing corporate website.', purpose: 'Provides information about the company and its services.', risks: [3, 4] },
        // ];

        // // Framework data
        // const frameworks = [
        //     {
        //         id: 1, name: 'ISO 27001', description: 'Information Security Management', controls: 114, compliance: 78, status: 'Active', readiness: 'ready', lastAssessment: '2025-03-10', domains: [
        //             { name: 'Information Security Policies', compliance: 85 },
        //             { name: 'Organization of Information Security', compliance: 70 },
        //             { name: 'Human Resource Security', compliance: 80 },
        //             { name: 'Asset Management', compliance: 75 },
        //             { name: 'Access Control', compliance: 82 }
        //         ], activities: [
        //             { date: '2025-03-10', action: 'Completed annual assessment', user: 'Jane Smith' },
        //             { date: '2025-02-22', action: 'Updated controls for A.9.2', user: 'John Doe' },
        //             { date: '2025-01-15', action: 'Added compliance evidence', user: 'Sarah Johnson' }
        //         ]
        //     },
        //     {
        //         id: 2, name: 'GDPR', description: 'Data Protection', controls: 87, compliance: 85, status: 'Active', readiness: 'ready', lastAssessment: '2025-02-05', domains: [
        //             { name: 'Lawful Basis for Processing', compliance: 90 },
        //             { name: 'Data Subject Rights', compliance: 85 },
        //             { name: 'Data Protection by Design', compliance: 75 },
        //             { name: 'Security of Processing', compliance: 88 },
        //             { name: 'Data Breach Notification', compliance: 92 }
        //         ], activities: [
        //             { date: '2025-02-05', action: 'Quarterly review completed', user: 'Privacy Officer' },
        //             { date: '2025-01-10', action: 'Updated DPIA procedures', user: 'Legal Team' },
        //             { date: '2024-12-18', action: 'Staff training on data handling', user: 'Training Team' }
        //         ]
        //     },
        //     {
        //         id: 3, name: 'NIST CSF', description: 'Cybersecurity Framework', controls: 108, compliance: 62, status: 'Active', readiness: 'not-ready', lastAssessment: '2025-01-20', domains: [
        //             { name: 'Identify', compliance: 68 },
        //             { name: 'Protect', compliance: 72 },
        //             { name: 'Detect', compliance: 65 },
        //             { name: 'Respond', compliance: 58 },
        //             { name: 'Recover', compliance: 45 }
        //         ], activities: [
        //             { date: '2025-01-20', action: 'Gap analysis completed', user: 'Security Team' },
        //             { date: '2024-12-15', action: 'Updated incident response procedures', user: 'CISO' },
        //             { date: '2024-11-30', action: 'Implemented new monitoring controls', user: 'IT Operations' }
        //         ]
        //     },
        //     {
        //         id: 4, name: 'SOC 2', description: 'Service Organization Controls', controls: 64, compliance: 91, status: 'Active', readiness: 'ready', lastAssessment: '2025-04-02', domains: [
        //             { name: 'Security', compliance: 94 },
        //             { name: 'Availability', compliance: 89 },
        //             { name: 'Processing Integrity', compliance: 92 },
        //             { name: 'Confidentiality', compliance: 88 },
        //             { name: 'Privacy', compliance: 90 }
        //         ], activities: [
        //             { date: '2025-04-02', action: 'Annual audit completed', user: 'External Auditor' },
        //             { date: '2025-03-15', action: 'Updated control documentation', user: 'Compliance Team' },
        //             { date: '2025-02-28', action: 'Pre-audit review', user: 'Internal Audit' }
        //         ]
        //     },
        //     {
        //         id: 5, name: 'PCI DSS', description: 'Payment Card Industry', controls: 78, compliance: 76, status: 'Inactive', readiness: 'not-ready', lastAssessment: '2025-01-05', domains: [
        //             { name: 'Build and Maintain Secure Network', compliance: 82 },
        //             { name: 'Protect Cardholder Data', compliance: 78 },
        //             { name: 'Maintain Vulnerability Management', compliance: 65 },
        //             { name: 'Access Control Measures', compliance: 80 },
        //             { name: 'Regular Monitoring and Testing', compliance: 72 }
        //         ], activities: [
        //             { date: '2025-01-05', action: 'Self-assessment completed', user: 'Finance Team' },
        //             { date: '2024-12-20', action: 'Updated cardholder data inventory', user: 'Data Team' },
        //             { date: '2024-11-15', action: 'Vulnerability scanning', user: 'Security Team' }
        //         ]
        //     },
        // ];

        // // DPIAs data
        // const dpias = [
        //     { id: 1, name: 'Customer Data Processing', department: 'Sales', status: 'Completed', date: '2025-03-15', risk: 'Low', reviewer: 'Privacy Officer', progress: 100, activity: 'Collection and processing of customer data for sales and marketing purposes.', dataCategories: 'Contact information, purchase history, preferences', riskAssessment: 'Low risk due to limited personal data collection and robust security controls.' },
        //     { id: 2, name: 'Employee Monitoring System', department: 'HR', status: 'In Progress', date: '2025-04-22', risk: 'Medium', reviewer: 'Legal Counsel', progress: 65, activity: 'Monitoring of employee computer usage and productivity tracking.', dataCategories: 'Employee activity logs, performance metrics, browsing history', riskAssessment: 'Medium risk due to privacy implications of workplace monitoring. Mitigation measures being implemented.' },
        //     { id: 3, name: 'Marketing Analytics Platform', department: 'Marketing', status: 'Completed', date: '2025-02-10', risk: 'Low', reviewer: 'Data Protection Officer', progress: 100, activity: 'Analysis of customer behavior for targeted marketing campaigns.', dataCategories: 'Browsing patterns, purchase history, demographic information', riskAssessment: 'Low risk as data is pseudonymized and used only for legitimate business purposes.' },
        //     { id: 4, name: 'Customer Support Chat System', department: 'Support', status: 'Not Started', date: '2025-05-30', risk: 'Medium', reviewer: 'Not Assigned', progress: 0, activity: 'Implementation of AI-powered chat system for customer support.', dataCategories: 'Chat transcripts, customer queries, personal information shared during support', riskAssessment: 'Initial assessment indicates medium risk due to AI processing of potentially sensitive information.' },
        //     { id: 5, name: 'Biometric Access Controls', department: 'Facilities', status: 'Completed', date: '2025-01-05', risk: 'High', reviewer: 'Security Director', progress: 100, activity: 'Implementation of fingerprint scanning for facility access.', dataCategories: 'Biometric data (fingerprints), employee access logs', riskAssessment: 'High risk due to processing of biometric data. Strict access controls and encryption implemented as mitigation.' },
        // ];

        // Assessment data
        // const assessments = [
        //     {
        //         id: 1, name: 'Annual Security Review', type: 'Internal', status: 'Completed', dueDate: '2025-01-20', completion: '100%', assignee: 'Security Team', framework: 'ISO 27001', description: 'Comprehensive review of security controls and policies to ensure compliance with ISO 27001 standards.', questions: 45, completed: 45, pending: 0, issues: 0, activities: [
        //             { date: '2025-01-20', action: 'Assessment completed', user: 'John Smith' },
        //             { date: '2025-01-15', action: 'Risk mitigation review', user: 'Sarah Johnson' },
        //             { date: '2025-01-10', action: 'Control testing completed', user: 'Technical Team' }
        //         ]
        //     },
        //     {
        //         id: 2, name: 'Vendor Security Assessment', type: 'External', status: 'In Progress', dueDate: '2025-05-15', completion: '45%', assignee: 'Vendor Management', framework: 'Internal', description: 'Assessment of key third-party vendors to ensure they meet security requirements.', questions: 60, completed: 27, pending: 33, issues: 5, activities: [
        //             { date: '2025-04-25', action: 'Cloud provider assessment started', user: 'Mike Wong' },
        //             { date: '2025-04-20', action: 'SaaS provider review completed', user: 'Vendor Team' },
        //             { date: '2025-04-15', action: 'Assessment schedule updated', user: 'Project Manager' }
        //         ]
        //     },
        //     {
        //         id: 3, name: 'ISO 27001 Readiness Assessment', type: 'Compliance', status: 'Not Started', dueDate: '2025-06-30', completion: '0%', assignee: 'Compliance Team', framework: 'ISO 27001', description: 'Pre-audit assessment to identify gaps in ISO 27001 compliance before external audit.', questions: 114, completed: 0, pending: 114, issues: 0, activities: [
        //             { date: '2025-04-15', action: 'Assessment plan approved', user: 'CISO' },
        //             { date: '2025-04-10', action: 'Assessment team formed', user: 'Project Office' },
        //             { date: '2025-04-05', action: 'Scope defined', user: 'Compliance Manager' }
        //         ]
        //     },
        //     {
        //         id: 4, name: 'Data Protection Compliance', type: 'Compliance', status: 'Completed', dueDate: '2025-02-28', completion: '100%', assignee: 'Legal Team', framework: 'GDPR', description: 'Assessment of data protection practices against GDPR requirements.', questions: 87, completed: 87, pending: 0, issues: 12, activities: [
        //             { date: '2025-02-28', action: 'Assessment completed', user: 'Privacy Officer' },
        //             { date: '2025-02-20', action: 'Data mapping review', user: 'Data Team' },
        //             { date: '2025-02-15', action: 'Processing activities documented', user: 'Legal Team' }
        //         ]
        //     },
        //     {
        //         id: 5, name: 'Business Continuity Testing', type: 'Internal', status: 'In Progress', dueDate: '2025-05-10', completion: '75%', assignee: 'IT Operations', framework: 'Internal', description: 'Assessment of business continuity and disaster recovery procedures.', questions: 35, completed: 26, pending: 9, issues: 3, activities: [
        //             { date: '2025-04-28', action: 'Backup systems testing', user: 'IT Team' },
        //             { date: '2025-04-22', action: 'Recovery procedures reviewed', user: 'Operations Team' },
        //             { date: '2025-04-18', action: 'Documentation updated', user: 'BCP Coordinator' }
        //         ]
        //     },
        //     {
        //         id: 6, name: 'Security Awareness Training Assessment', type: 'Internal', status: 'Not Started', dueDate: '2025-07-15', completion: '0%', assignee: 'Training Team', framework: 'Internal', description: 'Assessment of employee security awareness and training effectiveness.', questions: 25, completed: 0, pending: 25, issues: 0, activities: [
        //             { date: '2025-05-01', action: 'Assessment template created', user: 'Training Manager' },
        //             { date: '2025-04-25', action: 'Questions approved', user: 'Security Team' }
        //         ]
        //     },
        // ];

        // // Question data
        // const questions = [
        //     { id: 1, text: 'Do you have an information security policy?', type: 'yesno', category: 'Security', help: 'The policy should be documented, approved by management, and communicated to employees.' },
        //     { id: 2, text: 'How often do you perform security awareness training?', type: 'multiple', category: 'Training', help: 'Regular security training helps reduce the risk of security incidents caused by human error.' },
        //     { id: 3, text: 'Describe your data backup procedures.', type: 'text', category: 'Operations', help: 'Include frequency, storage locations, and testing of backups.' },
        //     { id: 4, text: 'Rate your organization\'s compliance with GDPR requirements.', type: 'rating', category: 'Compliance', help: 'Consider data protection principles, subject rights, and breach notification procedures.' },
        //     { id: 5, text: 'Upload your incident response plan.', type: 'file', category: 'Security', help: 'The plan should define roles, procedures, and communication strategies for security incidents.' },
        //     { id: 6, text: 'Do you have a formal risk assessment process?', type: 'yesno', category: 'Risk', help: 'A structured approach to identifying, analyzing, and mitigating risks.' },
        //     { id: 7, text: 'How do you manage access rights for employees?', type: 'text', category: 'Access Control', help: 'Include procedures for onboarding, changes, and offboarding.' },
        //     { id: 8, text: 'What encryption standards do you use for data at rest?', type: 'multiple', category: 'Data Protection', help: 'E.g., AES-256, TLS, etc.' },
        // ];

        // // Template data
        // const templates = [
        //     {
        //         id: 1,
        //         name: 'Annual Security Review',
        //         description: 'Comprehensive annual review of security controls and policies',
        //         questionCount: 25,
        //         lastUpdated: '2025-03-10',
        //         questionIds: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        //     },
        //     {
        //         id: 2,
        //         name: 'Vendor Security Assessment',
        //         description: 'Assessment for evaluating third-party vendor security practices',
        //         questionCount: 42,
        //         lastUpdated: '2025-02-15',
        //         questionIds: [3, 4, 5, 11, 12, 13, 14, 15]
        //     },
        //     {
        //         id: 3,
        //         name: 'ISO 27001 Readiness Assessment',
        //         description: 'Evaluation of readiness for ISO 27001 certification',
        //         questionCount: 114,
        //         lastUpdated: '2025-04-22',
        //         questionIds: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
        //     },
        //     {
        //         id: 4,
        //         name: 'GDPR Compliance Questionnaire',
        //         description: 'Assessment of compliance with GDPR requirements',
        //         questionCount: 35,
        //         lastUpdated: '2025-01-30',
        //         questionIds: [5, 6, 7, 8, 9, 10]
        //     },
        //     {
        //         id: 5,
        //         name: 'Business Continuity Assessment',
        //         description: 'Evaluation of business continuity and disaster recovery plans',
        //         questionCount: 28,
        //         lastUpdated: '2025-03-05',
        //         questionIds: [3, 4, 5, 11, 12, 13]
        //     },
        //     {
        //         id: 6,
        //         name: 'Data Protection Impact Assessment',
        //         description: 'Assessment of data protection measures and privacy controls',
        //         questionCount: 32,
        //         lastUpdated: '2025-02-20',
        //         questionIds: [1, 2, 3, 4, 5, 6, 7, 8]
        //     },
        // ];
        let risks = [];
        let assets = [];
        let frameworks = []
        let dpias = []
        let templates = []
        let questions = [];
        let assessments=[]
        let controls = [] // Global controls array
        window.onmessage = function (event) {
            if (event.data && Array.isArray(event.data.risks)) {
                risks = event.data.risks;

                // Initialize dynamic data now that we have it
                renderRisksTable(risks);
                updateRiskMatrix(risks);

                // Also trigger any matrix event setup
                const cells = document.querySelectorAll('.risk-matrix-cell');
                cells.forEach(cell => {
                    cell.removeEventListener('click', handleMatrixCellClick);
                    cell.addEventListener('click', handleMatrixCellClick);
                    cell.style.cursor = 'pointer';
                });
            }
        };
        function updateComplianceSummary(frameworks) {
            if (!Array.isArray(frameworks) || frameworks.length === 0) return;

            // Calculate total controls by counting actual controls arrays
            const totalControls = frameworks.reduce((sum, fw) => {
                const controlsCount = Array.isArray(fw.controls) ? fw.controls.length : (fw.controls || 0);
                return sum + controlsCount;
            }, 0);

            const implementedControls = frameworks.reduce((sum, fw) => {
                const controlsCount = Array.isArray(fw.controls) ? fw.controls.length : (fw.controls || 0);
                const complianceRatio = (fw.compliance || 0) / 100;
                return sum + Math.round(controlsCount * complianceRatio);
            }, 0);

            // Calculate average compliance from all frameworks
            const averageCompliance = frameworks.length > 0 ? Math.round(frameworks.reduce((sum, fw) => sum + (fw.compliance || 0), 0) / frameworks.length) : 0;

            const nextAssessment = frameworks
                .filter(fw => fw.lastAssessment)
                .map(fw => new Date(fw.lastAssessment))
                .sort((a, b) => a - b)[0];

            const nextAssessmentStr = nextAssessment
                ? nextAssessment.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : 'N/A';

            document.getElementById('overallCompliancePercent').textContent = `${averageCompliance}%`;
            document.getElementById('overallComplianceBar').style.width = `${averageCompliance}%`;

            document.getElementById('implementedControls').textContent = implementedControls;
            document.getElementById('totalControls').textContent = totalControls;
            document.getElementById('frameworkCount').textContent = frameworks.length;
            document.getElementById('nextAssessmentDate').textContent = nextAssessmentStr;

            const breakdownContainer = document.getElementById('frameworkComplianceBreakdown');
            breakdownContainer.innerHTML = '';

            frameworks.forEach(fw => {
                const fwCompliance = fw.compliance || 0;
                const fwDiv = document.createElement('div');
                fwDiv.innerHTML = `
        <div class="flex justify-between mb-1">
          <span class="text-sm font-medium">${fw.name}</span>
          <span class="text-sm font-medium">${fwCompliance}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
          <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${fwCompliance}%"></div>
        </div>
      `;
                breakdownContainer.appendChild(fwDiv);
            });
        }

        window.onmessage = function (event) {
            if (event.data) {
                if (Array.isArray(event.data.risks)) {
                    risks = event.data.risks;
                    let totalRisks=
                    document.getElementById('totalRisksCount').textContent = risks.length;
                    renderRisksTable(risks);
                    updateRiskMatrix(risks);
                }

                if (Array.isArray(event.data.assets)) {
                    assets = event.data.assets;
                    document.getElementById('totalAssetsCount').textContent = assets.length;
                    renderAssetsTable(event.data.assets);
                }

                if (Array.isArray(event.data.frameworks)) {
                    console.log('ðŸ“¥ Received frameworks from backend:', event.data.frameworks.length);

                    // Process frameworks and merge controls data
                    frameworks = event.data.frameworks.map(framework => {
                        console.log(`ðŸ” Processing framework: ${framework.name}, controls: ${framework.controls ? framework.controls.length : 0}, controlsData: ${framework.controlsData ? framework.controlsData.length : 0}`);

                        // Ensure controls property exists and is properly formatted
                        if (framework.controls && Array.isArray(framework.controls)) {
                            // Framework already has controls data from database
                            framework.controls = framework.controls;
                        } else {
                            // Initialize empty controls array if none exists
                            framework.controls = [];
                        }

                        console.log(`ðŸ“‹ Framework "${framework.name}" loaded with ${framework.controls.length} controls`);
                        return framework;
                    });

                    console.log('âœ… All frameworks processed:', frameworks.length);

                    document.getElementById('totalFrameworksCount').textContent = frameworks.length;
                    renderFrameworksTable(frameworks);
                    updateComplianceSummary(event.data.frameworks);

                    console.log('âœ… Frameworks loaded with controls data:', frameworks);
                }

            }
        };
        window.addEventListener("message", function (event) {
              // ðŸš€ Auto-open Admin Portal for admin
        if (event.data.role === 'Admin') {
          switchModule('admin');
        }
            if (event.data.role) {
        const adminToggle = document.getElementById('adminPortalToggle');
        if (adminToggle) {
          adminToggle.classList.toggle('hidden', event.data.role !== 'Admin');
        }

        const roleText = document.getElementById('userRoleLabel');
    if (roleText) {
      roleText.textContent = event.data.role === 'Admin' ? 'Admin' : 'Member';
    }

        const roleRestricted = ['navRisk', 'navAsset', 'navFramework', 'navDpia', 'navAssessment'];
        roleRestricted.forEach(id => {
          const elem = document.getElementById(id);
          if (elem) {
            elem.style.display = event.data.role === 'Admin' ? 'none' : 'flex';
          }
        });
      }
            if (Array.isArray(event.data.dpias)) {
                dpias = event.data.dpias;

                const total = dpias.length;
                const completed = dpias.filter(d => d.status === 'Completed').length;
                const inProgress = dpias.filter(d => d.status === 'In Progress').length;
                const highRisk = dpias.filter(d => d.risk === 'High').length;

                // Update DOM dynamically
                document.getElementById('dpiaTotalCount').textContent = total;
                document.getElementById('dpiaCompletedCount').textContent = completed;
                document.getElementById('dpiaInProgressCount').textContent = inProgress;
                document.getElementById('dpiaHighRiskCount').textContent = highRisk;

                renderDPIAsTable(dpias);
            }

        });

        window.addEventListener("message", function (event) {
            if (Array.isArray(event.data.templates)) {
                templates = event.data.templates;
                renderTemplates(templates);
            }
        });


        window.addEventListener('message', function (event) {
            if (event.data.action === 'templateCreated') {
                const template = event.data.payload;
                document.getElementById('editTemplateId').value = template.id;
                console.log('Template inserted into database with ID:', template.id);
            }
        });

        // Add response handlers for CRUD operations
        window.addEventListener('message', function (event) {
            const { action, payload, success, error } = event.data || {};

            if (action === 'riskAdded' && success) {
                // Add the new risk to local array and refresh UI
                if (payload && payload._id) {
                    risks.push(payload);
                    renderRisksTable(risks);
                    updateRiskMatrix(risks);
                    showSuccessMessage('Risk added successfully!');
                }
            } else if (action === 'riskAdded' && error) {
                showErrorMessage('Failed to add risk: ' + error);
            }

            if (action === 'assetAdded' && success) {
                if (payload && payload._id) {
                    assets.push(payload);
                    renderAssetsTable(assets);
                    showSuccessMessage('Asset added successfully!');
                }
            } else if (action === 'assetAdded' && error) {
                showErrorMessage('Failed to add asset: ' + error);
            }

            if (action === 'frameworkAdded' && success) {
                if (payload && payload._id) {
                    frameworks.push(payload);
                    renderFrameworksTable(frameworks);
                    updateComplianceSummary(frameworks);
                    showSuccessMessage('Framework added successfully!');
                }
            } else if (action === 'frameworkAdded' && error) {
                showErrorMessage('Failed to add framework: ' + error);
            }

            if (action === 'dpiaAdded' && success) {
                if (payload && payload._id) {
                    dpias.push(payload);
                    renderDPIAsTable(dpias);
                    showSuccessMessage('DPIA added successfully!');
                }
            } else if (action === 'dpiaAdded' && error) {
                showErrorMessage('Failed to add DPIA: ' + error);
            }

            // Handle framework file upload response
            if (action === 'frameworkFilesUploaded' && success) {
                if (payload && payload.framework) {
                    // Update the framework in local array
                    const frameworkIndex = frameworks.findIndex(f =>
                        String(f._id) === String(payload.framework._id) ||
                        String(f.id) === String(payload.framework._id)
                    );

                    if (frameworkIndex !== -1) {
                        frameworks[frameworkIndex] = payload.framework;
                        renderFrameworksTable(frameworks);
                        updateComplianceSummary(frameworks);
                    }

                    alert(`${payload.uploadedFiles.length} document(s) uploaded successfully! URLs saved to framework.`);
                }
            } else if (action === 'frameworkFilesUploaded' && error) {
                alert('Failed to upload files: ' + error);
            }

            // Handle control add response
            if (action === 'controlAdded' && success) {
                if (payload) {
                    console.log('âœ… Control added response received:', payload);
                    console.log('ðŸ“‹ Control frameworks:', payload.frameworks);

                    // Remove any temporary control with the same name (if it exists)
                    controls = controls.filter(c => !(c.name === payload.name && !c._id));

                    // Add control to global controls array with database ID
                    if (!controls.find(c => c.id === payload.id || c._id === payload._id)) {
                        controls.push(payload);
                        console.log('âœ… Control added to global array with ID:', payload.id);
                    }

                    // Update frameworks with the new control
                    if (payload.frameworks && Array.isArray(payload.frameworks)) {
                        console.log('ðŸ”„ Updating frameworks with control. Frameworks to update:', payload.frameworks.length);
                        payload.frameworks.forEach(frameworkId => {
                            console.log('ðŸ” Looking for framework:', frameworkId);
                            const framework = frameworks.find(f =>
                                String(f._id) === String(frameworkId) || String(f.id) === String(frameworkId)
                            );
                            if (framework) {
                                console.log('âœ… Found framework:', framework.name);
                                if (!framework.controls) framework.controls = [];
                                // Remove temporary control if it exists
                                framework.controls = framework.controls.filter(c => !(c.name === payload.name && !c._id));
                                // Add the control with database ID
                                if (!framework.controls.find(c => c.id === payload.id || c._id === payload._id)) {
                                    framework.controls.push(payload);
                                    console.log('âœ… Control added to framework:', framework.name, 'Total controls now:', framework.controls.length);
                                }
                            } else {
                                console.warn('âš ï¸ Framework not found:', frameworkId);
                            }
                        });
                    }

                    console.log('ðŸ“Š Rendering frameworks table with', frameworks.length, 'frameworks');
                    renderFrameworksTable(frameworks);
                    updateComplianceSummary(frameworks);
                    showSuccessMessage('Control added successfully!');
                }
            } else if (action === 'controlAdded' && error) {
                showErrorMessage('Failed to add control: ' + error);
            }

            // Handle control update response
            if (action === 'controlUpdated' && success) {
                if (payload) {
                    console.log('âœ… Control updated response received:', payload);

                    // Update in global controls array (match by id or _id)
                    const controlIndex = controls.findIndex(c => c.id === payload.id || c._id === payload._id);
                    if (controlIndex !== -1) {
                        controls[controlIndex] = payload;
                        console.log('âœ… Control updated in global array');
                    }

                    // Update in all frameworks
                    frameworks.forEach(framework => {
                        if (framework.controls && Array.isArray(framework.controls)) {
                            const fwControlIndex = framework.controls.findIndex(c => c.id === payload.id || c._id === payload._id);
                            if (fwControlIndex !== -1) {
                                framework.controls[fwControlIndex] = payload;
                                console.log('âœ… Control updated in framework:', framework.name);
                            }
                        }
                    });

                    renderFrameworksTable(frameworks);
                    updateComplianceSummary(frameworks);
                    showSuccessMessage('Control updated successfully!');
                }
            } else if (action === 'controlUpdated' && error) {
                showErrorMessage('Failed to update control: ' + error);
            }

            // Handle control delete response
            if (action === 'controlDeleted' && success) {
                if (payload && payload.controlId) {
                    console.log('âœ… Control deleted response received:', payload.controlId);

                    // Remove from global controls array (match by id or _id)
                    controls = controls.filter(c => c.id !== payload.controlId && c._id !== payload.controlId);

                    // Remove from all frameworks
                    frameworks.forEach(framework => {
                        if (framework.controls && Array.isArray(framework.controls)) {
                            framework.controls = framework.controls.filter(c => c.id !== payload.controlId && c._id !== payload.controlId);
                        }
                    });

                    renderFrameworksTable(frameworks);
                    updateComplianceSummary(frameworks);
                    showSuccessMessage('Control deleted successfully!');
                }
            } else if (action === 'controlDeleted' && error) {
                showErrorMessage('Failed to delete control: ' + error);
            }
        });

        window.addEventListener("message", function (event) {
            if (Array.isArray(event.data.questions)) {
                questions = event.data.questions;
                renderQuestionsTable(questions);
            }
        });

             window.addEventListener("message", function (event) {
    if (Array.isArray(event.data.assessments)) {
        assessments = event.data.assessments;
        console.log('ðŸ“Š Assessments data received:', assessments);
        console.log('ðŸ“Š Assessment statuses:', assessments.map(a => ({ id: a.id, name: a.title, status: a.userStatus, progress: a.userProgress, progressType: typeof a.userProgress })));
         document.getElementById('totalAssessmentsCount').textContent = assessments.length
        // Update Total
        document.querySelector('[data-status="total"]').textContent = assessments.length;

        // Initialize counters
        let completed = 0;
        let inProgress = 0;
        let overdue = 0;
        const today = new Date();

        assessments.forEach(a => {
            const status = a.userStatus
            const dueDate = new Date(a.date);

            if (status === 'completed') completed++;
            else if (status === 'in progress') inProgress++;

            if (status !== 'completed' && dueDate < today) {
                overdue++;
            }
        });

        // Set UI values
        document.querySelector('[data-status="completed"]').textContent = completed;
        document.querySelector('[data-status="inProgress"]').textContent = inProgress;
        document.querySelector('[data-status="overdue"]').textContent = overdue;

        // Render table
        renderAssessmentsTable(assessments);
    }
});

        // Handle assessment progress and submission responses
        window.addEventListener("message", function (event) {
            const { action, success, error, payload } = event.data || {};

            if (action === 'assessmentProgressSaved') {
                if (success) {
                    console.log('âœ… Assessment progress saved successfully:', payload);
                    // The assessments list will be automatically refreshed by the backend
                    // Show success message
                    showNotification('Progress saved successfully!', 'success');
                } else {
                    console.error('âŒ Failed to save assessment progress:', error);
                    showNotification('Failed to save progress: ' + (error || 'Unknown error'), 'error');
                }
            }

            if (action === 'assessmentSubmitted') {
                if (success) {
                    console.log('âœ… Assessment submitted successfully:', payload);

                    // Immediately update the assessment status in the local assessments array
                    const submittedAssessmentId = payload.assessmentId;
                    console.log('ðŸ” Looking for assessment with ID:', submittedAssessmentId);
                    console.log('ðŸ” Available assessments:', assessments.map(a => ({
                        id: a.id,
                        _id: a._id,
                        title: a.title,
                        currentStatus: a.userStatus
                    })));

                    // Try multiple ID matching strategies
                    let assessmentIndex = assessments.findIndex(a => a.id === submittedAssessmentId || a._id === submittedAssessmentId);

                    // If not found, try string comparison (in case of type mismatch)
                    if (assessmentIndex === -1) {
                        assessmentIndex = assessments.findIndex(a =>
                            String(a.id) === String(submittedAssessmentId) ||
                            String(a._id) === String(submittedAssessmentId)
                        );
                    }

                    if (assessmentIndex !== -1) {
                        console.log('âœ… Found assessment at index:', assessmentIndex);
                        console.log('ðŸ“Š Current assessment data:', assessments[assessmentIndex]);

                        // Update the assessment status immediately
                        assessments[assessmentIndex].userStatus = 'Completed';
                        assessments[assessmentIndex].userProgress = '100%'; // Ensure it's a percentage string
                        assessments[assessmentIndex].completion = '100%';
                        assessments[assessmentIndex].status = 'completed';

                        console.log('ðŸ“Š Updated assessment status locally:', {
                            id: submittedAssessmentId,
                            status: 'Completed',
                            progress: '100%',
                            updatedAssessment: assessments[assessmentIndex]
                        });

                        // Re-render the assessments table to show updated status
                        renderAssessmentsTable(assessments);
                        console.log('ðŸ”„ Assessment table re-rendered');
                    } else {
                        console.error('âŒ Assessment not found in local array for ID:', submittedAssessmentId);
                        console.log('ðŸ” This might be a timing issue. Forcing refresh from backend...');

                        // Force refresh from backend if local update fails
                        window.parent.postMessage({
                            action: 'refreshAssessments'
                        }, '*');
                    }

                    // Show success message with scoring information
                    const scoreInfo = payload.overallScore ? ` (Score: ${payload.overallScore}/5)` : '';
                    showNotification(`Assessment submitted successfully!${scoreInfo}`, 'success');

                    // Close the assessment modal
                    closeModal('assessmentModal');

                    // Load assessment timeline to show new results
                    loadAssessmentTimeline();

                    // Safety net: Force refresh from backend after a short delay to ensure UI is updated
                    setTimeout(() => {
                        console.log('ðŸ”„ Safety refresh: Requesting fresh assessment data from backend...');
                        window.parent.postMessage({
                            action: 'refreshAssessments'
                        }, '*');
                    }, 2000); // 2 second delay to allow backend processing to complete
                } else {
                    console.error('âŒ Failed to submit assessment:', error);
                    showNotification('Failed to submit assessment: ' + (error || 'Unknown error'), 'error');
                }
            }

            // Handle timeline display
            if (action === 'displayTimeline') {
                displayTimelineEntries(payload);
            }

            // Handle report generation notification
            if (action === 'reportGenerated') {
                if (success) {
                    showNotification('Assessment report generated successfully!', 'success');
                }
            }

            // Handle report download
            if (action === 'downloadReportContent') {
                downloadTextFile(payload.content, payload.filename);
            }

            // Handle assessment progress loaded response
            if (action === 'assessmentProgressLoaded') {
                console.log('ðŸ“¡ Received assessmentProgressLoaded response:', { success, payload, error });
                window.assessmentStarted = true; // Mark as started to prevent timeout fallback

                if (success && payload) {
                    console.log('âœ… Assessment progress loaded:', payload);
                    // Resume assessment from saved progress
                    resumeAssessmentFromProgress(payload);
                } else if (success && payload === null) {
                    console.log('â„¹ï¸ No saved progress found, starting fresh assessment');
                    // Start assessment from beginning
                    startFreshAssessment();
                } else {
                    console.error('âŒ Failed to load assessment progress:', error);
                    showNotification('Failed to load saved progress: ' + (error || 'Unknown error'), 'error');
                    // Start assessment from beginning as fallback
                    startFreshAssessment();
                }
            }

            // Handle assessment questions loaded response
            if (action === 'assessmentQuestionsLoaded') {
                console.log('ðŸ“¡ Received assessmentQuestionsLoaded response:', { success, payload, error });

                if (success && payload && payload.questions) {
                    console.log('âœ… Assessment questions loaded:', payload.questions.length, 'questions');

                    // Get the current assessment and add the questions to it
                    const assessment = window.currentAssessment;
                    if (assessment) {
                        assessment.questions = payload.questions;
                        assessment.questionData = payload.questions;

                        console.log('âœ… Questions added to assessment, starting fresh assessment');
                        // Now start the assessment with the loaded questions
                        startFreshAssessment();
                    } else {
                        console.error('âŒ No current assessment found to add questions to');
                        showNotification('Error: Assessment context lost. Please try again.', 'error');
                    }
                } else {
                    console.error('âŒ Failed to load assessment questions:', error);
                    showNotification('Failed to load assessment questions: ' + (error || 'Unknown error'), 'error');
                }
            }

            // Handle assessment results response
            if (action === 'assessmentResultsLoaded') {
                console.log('Assessment results loaded:', payload);
                if (success && payload) {
                    populateAssessmentResults(payload);
                } else {
                    // Show no results state
                    document.getElementById('resultsLoadingState').classList.add('hidden');
                    document.getElementById('noResultsState').classList.remove('hidden');
                }
            }

            // Handle export results response
            if (action === 'assessmentResultsExported') {
                if (success && payload) {
                    // Download the exported file
                    downloadTextFile(payload.content, payload.filename);
                    showNotification('Assessment results exported successfully!', 'success');
                } else {
                    showNotification('Failed to export results: ' + (error || 'Unknown error'), 'error');
                }
            }
        });

        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        'fa-info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            // Add to page
            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Load assessment timeline
        function loadAssessmentTimeline() {
            window.parent.postMessage({
                action: 'loadTimeline'
            }, '*');
        }

        // Display timeline entries
        function displayTimelineEntries(timelineEntries) {
            const timelineContainer = document.getElementById('assessmentTimeline');

            if (!timelineEntries || timelineEntries.length === 0) {
                timelineContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Complete an assessment to see your timeline and scoring history</p>
                    </div>
                `;
                return;
            }

            const timelineHtml = timelineEntries.map((entry, index) => {
                const date = new Date(entry.submittedAt).toLocaleDateString();
                const time = new Date(entry.submittedAt).toLocaleTimeString();
                const maturityColor = getMaturityColor(entry.overallScore);

                return `
                    <div class="flex items-start space-x-4 p-4 border rounded-lg hover:bg-gray-50">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full ${maturityColor} flex items-center justify-center text-white font-bold">
                                ${entry.overallScore}
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="text-lg font-medium text-gray-900">${entry.assessmentTitle}</h4>
                                <span class="text-sm text-gray-500">${date} ${time}</span>
                            </div>
                            <div class="mt-2">
                                <div class="flex items-center space-x-4 text-sm text-gray-600">
                                    <span>Overall Score: <strong>${entry.overallScore}/5</strong></span>
                                    <span>Maturity: <strong>${entry.maturityLevel}</strong></span>
                                    <span>Risks Identified: <strong>${entry.risksIdentified}</strong></span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">Domain Scores:</h5>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    ${Object.entries(entry.domainScores || {}).map(([domain, data]) => `
                                        <div class="text-xs bg-gray-100 rounded px-2 py-1">
                                            <span class="font-medium">${domain}:</span> ${data.average}/5
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-2">
                                <button onclick="viewTimelineAssessmentResults('${entry.assessmentId}', '${entry.assessmentTitle}')"
                                        class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                    <i class="fas fa-chart-line mr-1"></i> View Results
                                </button>
                                <button onclick="downloadTimelineAssessmentReport('${entry.assessmentId}', '${entry.assessmentTitle}')"
                                        class="px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700">
                                    <i class="fas fa-download mr-1"></i> Download Report
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            timelineContainer.innerHTML = timelineHtml;
        }

        // Get maturity color based on score
        function getMaturityColor(score) {
            if (score >= 4.5) return 'bg-purple-500';
            if (score >= 3.5) return 'bg-green-500';
            if (score >= 2.5) return 'bg-blue-500';
            if (score >= 1.5) return 'bg-yellow-500';
            if (score >= 0.5) return 'bg-orange-500';
            return 'bg-red-500';
        }

        // Get maturity badge class for table display
        function getMaturityBadgeClass(score) {
            if (score >= 4.5) return 'bg-purple-100 text-purple-800';
            if (score >= 3.5) return 'bg-green-100 text-green-800';
            if (score >= 2.5) return 'bg-blue-100 text-blue-800';
            if (score >= 1.5) return 'bg-yellow-100 text-yellow-800';
            if (score >= 0.5) return 'bg-orange-100 text-orange-800';
            return 'bg-red-100 text-red-800';
        }

        // Download text file
        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function () {


            updateRiskMatrix(risks);


            renderDPIAsTable(dpias);
           // renderAssessmentsTable(assessments);
            //   renderQuestionsTable(questions);
            //  renderTemplates(templates);

            // Load assessment timeline when page loads
            loadAssessmentTimeline();

            // Update dashboard statistics
          //  updateDashboardStatistics();

            // Add event listeners
            document.getElementById('searchRisk').addEventListener('input', handleRiskSearchChange);
            document.getElementById('searchRisk').addEventListener('focus', function () {
                if (document.getElementById('searchRisk').value.trim() !== '') {
                    document.getElementById('riskSearchResults').classList.add('active');
                }
            });
            document.getElementById('searchRisk').addEventListener('blur', function (e) {
                // Small delay to allow for clicking on results
                setTimeout(function () {
                    document.getElementById('riskSearchResults').classList.remove('active');
                }, 200);
            });

            document.getElementById('searchAsset').addEventListener('input', handleAssetSearchChange);
            document.getElementById('searchFramework').addEventListener('input', handleFrameworkSearchChange);
            document.getElementById('searchDPIA').addEventListener('input', handleDPIASearchChange);
            document.getElementById('searchAssessment').addEventListener('input', handleAssessmentSearchChange);
            document.getElementById('searchQuestion').addEventListener('input', handleQuestionSearchChange);

            document.getElementById('addRiskButton').addEventListener('click', openAddRiskModal);
            document.getElementById('addAssetButton').addEventListener('click', openAddAssetModal);
            document.getElementById('addFrameworkButton').addEventListener('click', openAddFrameworkModal);
            document.getElementById('addDPIAButton').addEventListener('click', openAddDpiaModal);

            document.getElementById('addRiskForm').addEventListener('submit', handleSaveRisk);
            document.getElementById('editRiskForm').addEventListener('submit', handleUpdateRisk);

            document.getElementById('addAssetForm').addEventListener('submit', handleSaveAsset);
            document.getElementById('editAssetForm').addEventListener('submit', handleUpdateAsset);
            document.getElementById('editAssetBtn').addEventListener('click', openEditAssetModal);

            document.getElementById('addFrameworkForm').addEventListener('submit', handleSaveFramework);
            document.getElementById('editFrameworkForm').addEventListener('submit', handleUpdateFramework);
            document.getElementById('addControlForm').addEventListener('submit', handleAddControl);
            document.getElementById('editControlForm').addEventListener('submit', handleEditControl);

            document.getElementById('addDpiaForm').addEventListener('submit', handleSaveDpia);
            document.getElementById('editDpiaForm').addEventListener('submit', handleUpdateDpia);

            // Add question button event listener
            const addQuestionBtn = document.getElementById('addQuestionBtn');
            if (addQuestionBtn) {
                console.log('Found addQuestionBtn, adding click event listener');
                addQuestionBtn.addEventListener('click', function () {
                    console.log('addQuestionBtn clicked');
                    toggleQuestionForm(true);
                });
            } else {
                console.error('addQuestionBtn element not found!');
            }
            document.getElementById('questionForm').addEventListener('submit', handleAddQuestion);
            document.getElementById('editQuestionForm').addEventListener('submit', handleEditQuestion);

            // Add event listeners for question filters
            document.getElementById('filterQuestionType').addEventListener('change', applyQuestionFilters);
            document.getElementById('filterQuestionCategory').addEventListener('change', applyQuestionFilters);
            document.getElementById('searchQuestion').addEventListener('input', function () {
                applyQuestionFilters();
            });

            // Add event listeners for multiple choice "allow multiple" checkboxes
            document.getElementById('multipleAllowMultiple').addEventListener('change', function () {
                const allowMultiple = this.checked;
                const optionsList = document.getElementById('multipleChoiceOptionsList');
                const checkboxes = optionsList.querySelectorAll('.correct-option');

                if (!allowMultiple && checkboxes.length > 0) {
                    // If switching to single selection, ensure only one option is checked
                    let hasChecked = false;
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            if (hasChecked) {
                                cb.checked = false;
                            } else {
                                hasChecked = true;
                            }
                        }
                    });

                    // If none are checked, check the first one
                    if (!hasChecked && checkboxes.length > 0) {
                        checkboxes[0].checked = true;
                    }
                }
            });

            document.getElementById('editMultipleAllowMultiple').addEventListener('change', function () {
                const allowMultiple = this.checked;
                const optionsList = document.getElementById('editMultipleChoiceOptionsList');
                const checkboxes = optionsList.querySelectorAll('.correct-option');

                if (!allowMultiple && checkboxes.length > 0) {
                    // If switching to single selection, ensure only one option is checked
                    let hasChecked = false;
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            if (hasChecked) {
                                cb.checked = false;
                            } else {
                                hasChecked = true;
                            }
                        }
                    });

                    // If none are checked, check the first one
                    if (!hasChecked && checkboxes.length > 0) {
                        checkboxes[0].checked = true;
                    }
                }
            });

            /* ------------------------------------------------------------------
          Global helpers / flags
       -------------------------------------------------------------------*/
            let draftTemplate = null;       // holds the â€œnewâ€ template until Save
            const TEMP_ID_LEN = 5;          // we make a 5-digit random tempId

            /* ------------------------------------------------------------------
               1.  CREATE  TEMPLATE  (opens modal only)
            -------------------------------------------------------------------*/
            document.getElementById('createTemplateBtn')
                .addEventListener('click', () => {

                    console.log('Create Template button clicked');
                    const today = new Date().toISOString().split('T')[0];
                    const tempId = Math.floor(10 ** (TEMP_ID_LEN - 1) + Math.random() * 9 * 10 ** (TEMP_ID_LEN - 1));

                    draftTemplate = {           // â† keep it in memory until Save
                        name: '',
                        description: '',
                        questionCount: 0,
                        lastUpdated: today,
                        questionIds: [],
                        customId: tempId.toString(),
                        id: tempId                // numeric temp ID used only on the client
                    };
                    console.log('Draft template created:', draftTemplate);

                    /* show modal + pre-fill */
                    const modal = document.getElementById('editTemplateModal');
                    if (modal) modal.style.display = 'block';

                    document.getElementById('editTemplateId').value = tempId;
                    document.getElementById('editTemplateName').value = '';
                    document.getElementById('editTemplateDescription').value = '';
                    document.getElementById('editTemplateQuestions').innerHTML =
                        '<p class="text-sm text-gray-500">No questions added to this template yet.</p>';
                    document.getElementById('templateModalTitle').textContent = 'New Assessment Template';
                });

            /* ------------------------------------------------------------------
               2.  SAVE  TEMPLATE  (new OR existing)
            -------------------------------------------------------------------*/
            const saveTemplateBtn = document.getElementById('saveTemplateButton');
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', (event) => {

                    console.log('Save Template button clicked');
                    event.preventDefault();               // prevent default form submit

                    /* pull current field values */
                    const idField = document.getElementById('editTemplateId').value.trim();
                    const name = document.getElementById('editTemplateName').value.trim();
                    const desc = document.getElementById('editTemplateDescription').value.trim();
                    const today = new Date().toISOString().split('T')[0];

                    /* Is this a brand-new template? */
                    const isNew = idField.length === TEMP_ID_LEN;   // our temp IDs are 5 digits

                    if (isNew) {
                        /* populate the draft with fresh data */
                        draftTemplate.name = name;
                        draftTemplate.description = desc;
                        draftTemplate.lastUpdated = today;

                        /* finally send it to Wix DB */
                        window.parent.postMessage(
                            { action: 'addTemplate', payload: draftTemplate },
                            '*'
                        );
                        console.log('ðŸŸ¢ addTemplate sent â†’', draftTemplate);

                    } else {
                        /* existing template â€“ call your normal edit logic */
                        console.log('ðŸ“ Editing existing template:', idField);
                        handleEditTemplate(event);          // your original function
                    }

                    /* close the modal (optional) */
                    document.getElementById('editTemplateModal').style.display = 'none';
                });
            }

            /* ------------------------------------------------------------------
               3.  Existing listeners stay as they were
            -------------------------------------------------------------------*/
            const editTemplateForm = document.getElementById('editTemplateForm');
            if (editTemplateForm) {
                editTemplateForm.addEventListener('submit', (event) => {
                    console.log('Form submit event triggered');
                    handleEditTemplate(event);
                });
            } else {
                console.error('Edit template form not found');
            }

            document.getElementById('cloneTemplateForm')
                .addEventListener('submit', handleCloneTemplate);

            document.getElementById('saveSettingsBtn')
                .addEventListener('click', () => alert('Settings saved successfully!'));

            document.getElementById('cloneTemplateForm').addEventListener('submit', handleCloneTemplate);

            document.getElementById('saveSettingsBtn').addEventListener('click', function () {
                alert('Settings saved successfully!');
            })

            // Add a direct event listener to the Save Template button
            // We'll set up a MutationObserver to watch for the button to be added to the DOM
            console.log('Setting up MutationObserver for saveTemplateButton');
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                        for (let i = 0; i < mutation.addedNodes.length; i++) {
                            const node = mutation.addedNodes[i];
                            if (node.id === 'saveTemplateButton') {
                                console.log('Save Template button found by MutationObserver');
                                node.addEventListener('click', function (event) {
                                    console.log('Save Template button clicked (from MutationObserver)');
                                    handleEditTemplate(event);
                                });
                            } else if (node.nodeType === 1) {
                                const button = node.querySelector('#saveTemplateButton');
                                if (button) {
                                    console.log('Save Template button found in added node by MutationObserver');
                                    button.addEventListener('click', function (event) {
                                        console.log('Save Template button clicked (from nested MutationObserver)');
                                        handleEditTemplate(event);
                                    });
                                }
                            }
                        }
                    }
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });

            // Also try to find it now
            const saveTemplateButton = document.getElementById('saveTemplateButton');
            if (saveTemplateButton) {
                console.log('Found Save Template button in document ready, adding click event listener');
                saveTemplateButton.addEventListener('click', function (event) {
                    console.log('Save Template button clicked from document ready');
                    handleEditTemplate(event);
                });
            } else {
                console.log('Save Template button not found in document ready');
            }

            // Also set up a MutationObserver for the Add Question button
            console.log('Setting up MutationObserver for addQuestionToTemplateButton');
            const addQuestionObserver = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                        for (let i = 0; i < mutation.addedNodes.length; i++) {
                            const node = mutation.addedNodes[i];
                            if (node.id === 'addQuestionToTemplateButton') {
                                console.log('Add Question button found by MutationObserver');
                                node.addEventListener('click', function (event) {
                                    console.log('Add Question button clicked (from MutationObserver)');
                                    const templateId = parseInt(document.getElementById('editTemplateId').value);
                                    addQuestionToTemplate(templateId);
                                });
                            } else if (node.nodeType === 1) {
                                const button = node.querySelector('#addQuestionToTemplateButton');
                                if (button) {
                                    console.log('Add Question button found in added node by MutationObserver');
                                    button.addEventListener('click', function (event) {
                                        console.log('Add Question button clicked (from nested MutationObserver)');
                                        const templateId = parseInt(document.getElementById('editTemplateId').value);
                                        addQuestionToTemplate(templateId);
                                    });
                                }
                            }
                        }
                    }
                });
            });

            addQuestionObserver.observe(document.body, { childList: true, subtree: true });

            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('mobileMenuButton').addEventListener('click', toggleSidebar);

            // Initialize the risk matrix with data
            updateRiskMatrix(risks);

            // Add risk matrix cell click handlers AFTER updating the matrix
            const cells = document.querySelectorAll('.risk-matrix-cell');
            cells.forEach(cell => {
                // Remove any existing event listeners to prevent duplicates
                cell.removeEventListener('click', handleMatrixCellClick);
                // Add the click event listener
                cell.addEventListener('click', handleMatrixCellClick);

                // Add a visual indicator that the cell is clickable
                cell.style.cursor = 'pointer';
            });
        });

        // Module Navigation
        function switchModule(moduleName) {
            // Hide all modules
            const allModules = document.querySelectorAll('main > div');
            allModules.forEach(module => {
                module.classList.add('hidden');
            });

            // Show selected module
            const selectedModule = document.getElementById(`${moduleName}-module`);
            if (selectedModule) {
                selectedModule.classList.remove('hidden');
            }

            // Update module title
            const moduleTitle = document.getElementById('moduleTitle');
            const titles = {
                'dashboard': 'Dashboard Overview',
                'risk': 'Risk Management',
                'asset': 'Asset Registry',
                'frameworks': 'Compliance Frameworks',
                'dpias': 'Data Protection Impact Assessments',
                'assessments': 'Security Assessments',
                'admin': 'Admin Portal'
            };
            moduleTitle.textContent = titles[moduleName] || 'Dashboard';

            // Update active menu item
            const menuItems = document.querySelectorAll('nav > div');
            menuItems.forEach(item => {
                item.classList.remove('bg-indigo-700');
                item.classList.add('hover:bg-indigo-700');
            });

            // Find the clicked menu item and make it active
            const clickedItem = Array.from(menuItems).find(item => {
                return item.textContent.trim().toLowerCase().includes(moduleName.toLowerCase());
            });

            if (clickedItem) {
                clickedItem.classList.add('bg-indigo-700');
                clickedItem.classList.remove('hover:bg-indigo-700');
            }

            // Close sidebar on mobile after selection
            if (window.innerWidth < 768) {
                toggleSidebar(true);
            }
        }

        // Dashboard Card Navigation - Navigate to module when dashboard card is clicked
        function navigateToDashboardModule(moduleName) {
            // Update the active navigation item
            const navItems = {
                'risk': 'navRisk',
                'asset': 'navAsset',
                'frameworks': 'navFramework',
                'dpias': 'navDpia',
                'assessments': 'navAssessment'
            };

            const navItemId = navItems[moduleName];
            if (navItemId) {
                setActiveNav(navItemId);
            }

            // Switch to the selected module
            switchModule(moduleName);
        }

        // Admin Portal tab switching
        function switchAdminTab(tabName) {
            // Hide all tab contents
            document.getElementById('assessmentsTabContent').classList.add('hidden');
            document.getElementById('questionsTabContent').classList.add('hidden');
            document.getElementById('settingsTabContent').classList.add('hidden');

            // Show selected tab content
            document.getElementById(`${tabName}TabContent`).classList.remove('hidden');

            // Update tab styling
            document.getElementById('assessmentsTab').classList.remove('tab-active');
            document.getElementById('questionsTab').classList.remove('tab-active');
            document.getElementById('settingsTab').classList.remove('tab-active');
            document.getElementById('assessmentsTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            document.getElementById('questionsTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            document.getElementById('settingsTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

            // Set active tab
            document.getElementById(`${tabName}Tab`).classList.add('tab-active');
            document.getElementById(`${tabName}Tab`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        }

        // Toggle question form
        function toggleQuestionForm(show) {
            console.log('toggleQuestionForm called with show =', show);
            const formContainer = document.getElementById('questionFormContainer');

            if (!formContainer) {
                console.error('questionFormContainer element not found!');
                return;
            }

            console.log('formContainer before:', formContainer.classList.contains('hidden') ? 'hidden' : 'visible');

            if (show) {
                formContainer.classList.remove('hidden');
                console.log('Removed hidden class');
            } else {
                formContainer.classList.add('hidden');
                document.getElementById('questionForm').reset();
                console.log('Added hidden class and reset form');
            }

            console.log('formContainer after:', formContainer.classList.contains('hidden') ? 'hidden' : 'visible');
        }

        // Toggle question type dropdown in add form
        function toggleQuestionTypeDropdown() {
            const dropdown = document.getElementById('questionTypeDropdown');
            dropdown.classList.toggle('hidden');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeQuestionTypeDropdown(e) {
                if (!e.target.closest('#questionTypeButton') && !e.target.closest('#questionTypeDropdown')) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', closeQuestionTypeDropdown);
                }
            });
        }

        // Select question type in add form
        function selectQuestionType(value, displayText) {
            document.getElementById('questionType').value = value;
            document.getElementById('selectedQuestionType').textContent = displayText;
            document.getElementById('questionTypeDropdown').classList.add('hidden');

            // Show additional fields based on question type
            updateQuestionTypeFields(value, 'add');
        }

        // Toggle question type dropdown in edit form
        function toggleEditQuestionTypeDropdown() {
            const dropdown = document.getElementById('editQuestionTypeDropdown');
            dropdown.classList.toggle('hidden');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeEditQuestionTypeDropdown(e) {
                if (!e.target.closest('#editQuestionTypeButton') && !e.target.closest('#editQuestionTypeDropdown')) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', closeEditQuestionTypeDropdown);
                }
            });
        }

        // Select question type in edit form
        function selectEditQuestionType(value, displayText) {
            document.getElementById('editQuestionType').value = value;
            document.getElementById('selectedEditQuestionType').textContent = displayText;
            document.getElementById('editQuestionTypeDropdown').classList.add('hidden');

            // Show additional fields based on question type
            updateQuestionTypeFields(value, 'edit');
        }

        // Update fields based on question type
        function updateQuestionTypeFields(type, formType) {
            const prefix = formType === 'edit' ? 'edit' : '';
            const multipleChoiceContainer = document.getElementById(prefix + 'MultipleChoiceOptions');
            const ratingScaleContainer = document.getElementById(prefix + 'RatingScaleOptions');
            const fileUploadContainer = document.getElementById(prefix + 'FileUploadOptions');

            // Hide all containers first
            if (multipleChoiceContainer) multipleChoiceContainer.classList.add('hidden');
            if (ratingScaleContainer) ratingScaleContainer.classList.add('hidden');
            if (fileUploadContainer) fileUploadContainer.classList.add('hidden');

            // Show the appropriate container based on type
            if (type === 'multiple' && multipleChoiceContainer) {
                multipleChoiceContainer.classList.remove('hidden');
            } else if (type === 'rating' && ratingScaleContainer) {
                ratingScaleContainer.classList.remove('hidden');
            } else if (type === 'file' && fileUploadContainer) {
                fileUploadContainer.classList.remove('hidden');
            }
        }

        // Add a multiple choice option in the add form
        function addMultipleChoiceOption() {
            const optionsList = document.getElementById('multipleChoiceOptionsList');
            const newOption = document.createElement('div');
            newOption.className = 'flex items-center';
            newOption.innerHTML = `
                <div class="flex-shrink-0 mr-2">
                    <input type="checkbox" class="correct-option h-4 w-4 text-indigo-600 border-gray-300 rounded" title="Mark as correct answer">
                </div>
                <input type="text" class="w-full p-2 border rounded-md" placeholder="Enter an option...">
                <button type="button" class="ml-2 text-red-600" onclick="removeOption(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            optionsList.appendChild(newOption);

            // If this is the first option, we might want to check it by default
            if (optionsList.children.length === 1) {
                const checkbox = newOption.querySelector('.correct-option');
                checkbox.checked = true;
            }

            // If "allow multiple" is not checked, ensure only one option can be marked as correct
            const allowMultiple = document.getElementById('multipleAllowMultiple').checked;
            if (!allowMultiple) {
                const checkbox = newOption.querySelector('.correct-option');
                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        // Uncheck all other options
                        const allCheckboxes = optionsList.querySelectorAll('.correct-option');
                        allCheckboxes.forEach(cb => {
                            if (cb !== this) cb.checked = false;
                        });
                    }
                });
            }
        }

        // Remove a multiple choice option in the add form
        function removeOption(button) {
            const optionItem = button.closest('.flex.items-center');
            optionItem.remove();
        }

        // Add a multiple choice option in the edit form
        function addEditMultipleChoiceOption() {
            const optionsList = document.getElementById('editMultipleChoiceOptionsList');
            const newOption = document.createElement('div');
            newOption.className = 'flex items-center';
            newOption.innerHTML = `
                <div class="flex-shrink-0 mr-2">
                    <input type="checkbox" class="correct-option h-4 w-4 text-indigo-600 border-gray-300 rounded" title="Mark as correct answer">
                </div>
                <input type="text" class="w-full p-2 border rounded-md" placeholder="Enter an option...">
                <button type="button" class="ml-2 text-red-600" onclick="removeEditOption(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            optionsList.appendChild(newOption);

            // If this is the first option, we might want to check it by default
            if (optionsList.children.length === 1) {
                const checkbox = newOption.querySelector('.correct-option');
                checkbox.checked = true;
            }

            // If "allow multiple" is not checked, ensure only one option can be marked as correct
            const allowMultiple = document.getElementById('editMultipleAllowMultiple').checked;
            if (!allowMultiple) {
                const checkbox = newOption.querySelector('.correct-option');
                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        // Uncheck all other options
                        const allCheckboxes = optionsList.querySelectorAll('.correct-option');
                        allCheckboxes.forEach(cb => {
                            if (cb !== this) cb.checked = false;
                        });
                    }
                });
            }
        }

        // Remove a multiple choice option in the edit form
        function removeEditOption(button) {
            const optionItem = button.closest('.flex.items-center');
            optionItem.remove();
        }

        // Get multiple choice options from the form
        function getMultipleChoiceOptions(formType) {
            const prefix = formType === 'edit' ? 'edit' : '';
            const optionsList = document.getElementById(prefix + 'MultipleChoiceOptionsList');
            const optionItems = optionsList.querySelectorAll('.flex.items-center');
            const options = [];
            const correctOptions = [];

            optionItems.forEach((item, index) => {
                const textInput = item.querySelector('input[type="text"]');
                const correctCheckbox = item.querySelector('.correct-option');

                const value = textInput.value.trim();
                if (value) {
                    options.push({
                        text: value,
                        isCorrect: correctCheckbox.checked
                    });

                    if (correctCheckbox.checked) {
                        correctOptions.push(index);
                    }
                }
            });

            return {
                options: options,
                correctOptions: correctOptions,
                allowMultiple: document.getElementById(prefix + 'MultipleAllowMultiple').checked
            };
        }

        // Toggle sidebar (especially for mobile)
        function toggleSidebar(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            if (forceClose || !sidebar.classList.contains('collapsed')) {
                sidebar.classList.add('collapsed');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.remove('collapsed');
                overlay.classList.add('active');
            }
        }

        // Toggle framework readiness status (from table)
        function toggleFrameworkReadiness(frameworkId, currentReadiness) {
            // Handle both function signatures - if called with parameters, use them
            if (arguments.length >= 2) {
                const newReadiness = currentReadiness === 'ready' ? 'not-ready' : 'ready';

                // Send update to backend
                window.parent.postMessage({
                    action: 'updateFrameworkReadiness',
                    payload: {
                        id: frameworkId,
                        readiness: newReadiness
                    }
                }, '*');

                // Update local framework data
                const frameworkIndex = frameworks.findIndex(f =>
                    String(f.id) === String(frameworkId) ||
                    String(f._id) === String(frameworkId) ||
                    String(f.customId) === String(frameworkId)
                );

                if (frameworkIndex !== -1) {
                    frameworks[frameworkIndex].readiness = newReadiness;
                    renderFrameworksTable(frameworks);
                }
                return;
            }

            // If called without parameters, handle modal toggle (fallback to original logic)
            const frameworkIdStr = document.getElementById('toggleReadinessBtn')?.getAttribute('data-framework-id');
            if (frameworkIdStr) {
                const framework = frameworks.find(f =>
                    String(f.id) === frameworkIdStr ||
                    String(f._id) === frameworkIdStr ||
                    String(f.customId) === frameworkIdStr
                );

                if (framework) {
                    const newReadiness = framework.readiness === 'ready' ? 'not-ready' : 'ready';
                    window.parent.postMessage({
                        action: 'updateFrameworkReadiness',
                        payload: {
                            id: framework._id || framework.id,
                            readiness: newReadiness
                        }
                    }, '*');
                }
            }
        }

        // Render risks table
        function renderRisksTable(risksData) {
            const tableBody = document.getElementById('risksTableBody');
            tableBody.innerHTML = '';

            risksData.forEach(risk => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.onclick = () => openRiskModal(risk);

                // Determine source label and styling
                const isAdminSource = risk.source === 'admin';
                const sourceLabel = isAdminSource ? 'Admin' : 'Member';
                const sourceBadgeClass = isAdminSource ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${risk.name}</div>
                        <div class="text-xs mt-1">
                            <span class="px-2 py-1 rounded-full ${sourceBadgeClass}">
                                ${sourceLabel}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${risk.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getLikelihoodBadgeClass(risk.likelihood)}">
                            ${risk.likelihood}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getImpactBadgeClass(risk.impact)}">
                            ${risk.impact}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getLevelBadgeClass(risk.level)}">
                            ${risk.level}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(risk.status)}">
                            ${risk.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button
                            class="text-indigo-600 hover:text-indigo-900 mr-2"
                            onclick="openRiskModal(${risk.id}); event.stopPropagation();"
                        >
                            View
                        </button>
                        ${!isAdminSource ? `
                        <button
                            class="text-green-600 hover:text-green-900"
                            onclick="openEditRiskModal(${risk.id}); event.stopPropagation();"
                        >
                            Edit
                        </button>
                        ` : ''}
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Render assets table
        function renderAssetsTable(assetsData) {
            const tableBody = document.getElementById('assetsTableBody');
            if (!tableBody) return; // Skip if table doesn't exist yet

            tableBody.innerHTML = '';

            assetsData.forEach(asset => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.onclick = () => openAssetModal(asset);

                // Determine source label and styling
                const isAdminSource = asset.source === 'admin';
                const sourceLabel = isAdminSource ? 'Admin' : 'Member';
                const sourceBadgeClass = isAdminSource ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${asset.name}</div>
                        <div class="text-xs mt-1">
                            <span class="px-2 py-1 rounded-full ${sourceBadgeClass}">
                                ${sourceLabel}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${asset.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${asset.owner}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${asset.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${asset.cost || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getCriticalityBadgeClass(asset.criticality)}">
                            ${asset.criticality}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button
                            class="text-indigo-600 hover:text-indigo-900 mr-2"
                            onclick="openAssetModal(${asset.id}); event.stopPropagation();"
                        >
                            View
                        </button>
                        ${!isAdminSource ? `
                        <button
                            class="text-green-600 hover:text-green-900"
                            onclick="openEditAssetModal(${asset.id}); event.stopPropagation();"
                        >
                            Edit
                        </button>
                        ` : ''}
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Render frameworks table
        function renderFrameworksTable(frameworksData) {
            const tableBody = document.getElementById('frameworksTableBody');
            if (!tableBody) return; // Skip if table doesn't exist yet

            tableBody.innerHTML = '';

            frameworksData.forEach(framework => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.onclick = () => openFrameworkModal(framework);

                // Determine source label and styling
                const isAdminSource = framework.source === 'admin';
                const sourceLabel = isAdminSource ? 'Admin' : 'Member';
                const sourceBadgeClass = isAdminSource ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';

                // Calculate controls count
                const controlsCount = Array.isArray(framework.controls) ? framework.controls.length : (framework.controls || 0);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${framework.name}</div>
                        <div class="text-xs mt-1">
                            <span class="px-2 py-1 rounded-full ${sourceBadgeClass}">
                                ${sourceLabel}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 max-w-xs">
                        <div class="text-sm text-gray-900 truncate" title="${framework.description}">
                            ${framework.description}
                        </div>
                        ${framework.description && framework.description.length > 50 ? `<button class="text-indigo-600 hover:text-indigo-900 text-xs mt-1" onclick="showDescriptionModal('${framework.name}', \`${framework.description.replace(/`/g, '\\`')}\`); event.stopPropagation();">View Full</button>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${controlsCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-32 bg-gray-200 rounded-full h-2.5">
                            <div
                                class="h-2.5 rounded-full ${getComplianceColorClass(framework.compliance)}"
                                style="width: ${framework.compliance}%"
                            ></div>
                        </div>
                        <span class="text-xs text-gray-500 ml-2">${framework.compliance}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${framework.status === 'Active' ? 'badge-active' : 'badge-low'}">
                            ${framework.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button
                            class="px-2 py-1 text-xs rounded-full cursor-pointer ${framework.readiness === 'ready' ? 'badge-low' : 'badge-high'}"
                            onclick="toggleFrameworkReadiness('${framework.id || framework._id}', '${framework.readiness}'); event.stopPropagation();"
                            title="Click to toggle readiness status"
                        >
                            ${framework.readiness === 'ready' ? 'Ready' : 'Not Ready'}
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button
                            class="text-indigo-600 hover:text-indigo-900 mr-2"
                            onclick="window.openFrameworkModalById('${framework.id || framework._id}'); event.stopPropagation();"
                        >
                            View
                        </button>
                        ${!isAdminSource ? `
                        <button
                            class="text-green-600 hover:text-green-900"
                            onclick="window.openEditFrameworkModalById('${framework.id || framework._id}'); event.stopPropagation();"
                        >
                            Edit
                        </button>
                        ` : ''}
                    </td>
                `;

                tableBody.appendChild(row);
            });

        }

        // // Update dashboard statistics with dynamic data
        // function updateDashboardStatistics() {
        //     console.log('ðŸ“Š Updating dashboard statistics');

        //     // Update Total Risks count
        //     const totalRisks = risks ? risks.length : 0;
        //    // document.getElementById('totalRisksCount').textContent = totalRisks;
        //     console.log('ðŸ“ˆ Total Risks:', totalRisks);

        //     // Update Total Assets count
        //     const totalAssets = assets ? assets.length : 0;
        //  //   document.getElementById('totalAssetsCount').textContent = totalAssets;
        //     console.log('ðŸ“ˆ Total Assets:', totalAssets);

        //     // Update Frameworks count
        //     const totalFrameworks = frameworks ? frameworks.length : 0;
        //  //   document.getElementById('totalFrameworksCount').textContent = totalFrameworks;
        //     console.log('ðŸ“ˆ Total Frameworks:', totalFrameworks);

        //     // Update Assessments count
        //     const totalAssessments = assessments ? assessments.length : 0;
        //     document.getElementById('totalAssessmentsCount').textContent = totalAssessments;
        //     console.log('ðŸ“ˆ Total Assessments:', totalAssessments);

        //     console.log('âœ… Dashboard statistics updated successfully');
        // }

        // Render DPIAs table
        function renderDPIAsTable(dpiasData) {
            const tableBody = document.getElementById('dpiasTableBody');
            if (!tableBody) return; // Skip if table doesn't exist yet

            tableBody.innerHTML = '';

            dpiasData.forEach(dpia => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.onclick = () => openDpiaModal(dpia);

                // Determine source label and styling
                const isAdminSource = dpia.source === 'admin';
                const sourceLabel = isAdminSource ? 'Admin' : 'Member';
                const sourceBadgeClass = isAdminSource ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${dpia.name}</div>
                        <div class="text-xs mt-1">
                            <span class="px-2 py-1 rounded-full ${sourceBadgeClass}">
                                ${sourceLabel}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${dpia.department}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(dpia.status)}">
                            ${dpia.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${dpia.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getLevelBadgeClass(dpia.risk)}">
                            ${dpia.risk}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button
                            class="text-indigo-600 hover:text-indigo-900 mr-2"
                            onclick="openDpiaModal(${dpia.id}); event.stopPropagation();"
                        >
                            View
                        </button>
                        ${!isAdminSource ? `
                        <button
                            class="text-green-600 hover:text-green-900"
                            onclick="openEditDpiaModal(${dpia.id}); event.stopPropagation();"
                        >
                            Edit
                        </button>
                        ` : ''}
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

          function renderAssessmentsTable(assessmentsData) {
            console.log(assessmentsData,"assessments 1212")
            const tableBody = document.getElementById('assessmentsTableBody');
            if (!tableBody) return; // Skip if table doesn't exist yet

            tableBody.innerHTML = '';

            assessmentsData.forEach(assessment => {

                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.onclick = () => openAssessmentModal(assessment);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${assessment.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(assessment.userStatus)}">
                            ${assessment.userStatus}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${assessment.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-32 bg-gray-200 rounded-full h-2.5">
                            <div
                                class="h-2.5 rounded-full ${getCompletionColorClass(parseInt(assessment.userProgress))}"
                                style="width: ${assessment.userProgress}"
                            ></div>
                        </div>
                        <span class="text-xs text-gray-500 ml-2">${assessment.userProgress}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${assessment.overallScore !== undefined ?
                            `<div class="flex items-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getMaturityBadgeClass(assessment.overallScore)}">
                                    ${assessment.overallScore}/5
                                </span>
                                <span class="ml-2 text-xs text-gray-500">${assessment.maturityLevel || ''}</span>
                            </div>` :
                            '<span class="text-gray-400 text-sm">Not completed</span>'
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="openAssessmentModal(${assessment.id}); event.stopPropagation();">View</button>
                        ${assessment.status === 'Not Started' ?
                        `<button class="text-green-600 hover:text-green-900" onclick="startAssessment(${assessment.id}); event.stopPropagation();">Start</button>` :
                        ''
                    }
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Render questions table
        function renderQuestionsTable(questionsData) {
            const tableBody = document.getElementById('questionsTableBody');
            if (!tableBody) return; // Skip if table doesn't exist yet

            tableBody.innerHTML = '';

            questionsData.forEach(question => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                row.innerHTML = `
                    <td class="px-6 py-4">${question.text}</td>
                    <td class="px-6 py-4">${formatQuestionType(question.type)}</td>
                    <td class="px-6 py-4">${question.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="openEditQuestionModal(${question.id})">Edit</button>
                        <button class="text-red-600 hover:text-red-900" onclick="openDeleteQuestionModal(${question.id})">Delete</button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Question Modal Functions
        function openEditQuestionModal(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (!question) return;

            // Populate the form fields
            document.getElementById('editQuestionId').value = question.id;
            document.getElementById('editQuestionText').value = question.text;
            document.getElementById('editQuestionType').value = question.type;
            document.getElementById('selectedEditQuestionType').textContent = formatQuestionType(question.type);
            document.getElementById('editQuestionCategory').value = question.category;
            document.getElementById('editQuestionHelp').value = question.help || '';

            // Show/hide type-specific fields
            updateQuestionTypeFields(question.type, 'edit');

            // Populate type-specific fields
            if (question.type === 'multiple' && question.options) {
                // Clear existing options
                const optionsList = document.getElementById('editMultipleChoiceOptionsList');
                optionsList.innerHTML = '';

                // Set the "allow multiple" checkbox
                document.getElementById('editMultipleAllowMultiple').checked = question.allowMultiple || false;

                // Add each option
                question.options.forEach((option, index) => {
                    const optionItem = document.createElement('div');
                    optionItem.className = 'flex items-center';

                    // Check if this option is marked as correct
                    const isCorrect = question.correctOptions && question.correctOptions.includes(index);

                    optionItem.innerHTML = `
                        <div class="flex-shrink-0 mr-2">
                            <input type="checkbox" class="correct-option h-4 w-4 text-indigo-600 border-gray-300 rounded" title="Mark as correct answer" ${isCorrect ? 'checked' : ''}>
                        </div>
                        <input type="text" class="w-full p-2 border rounded-md" value="${option}" placeholder="Enter an option...">
                        <button type="button" class="ml-2 text-red-600" onclick="removeEditOption(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    optionsList.appendChild(optionItem);

                    // Add event listener for the correct checkbox
                    if (!question.allowMultiple) {
                        const checkbox = optionItem.querySelector('.correct-option');
                        checkbox.addEventListener('change', function () {
                            if (this.checked) {
                                // Uncheck all other options
                                const allCheckboxes = optionsList.querySelectorAll('.correct-option');
                                allCheckboxes.forEach(cb => {
                                    if (cb !== this) cb.checked = false;
                                });
                            }
                        });
                    }
                });

                // Add an empty option if there are none
                if (!question.options.length) {
                    addEditMultipleChoiceOption();
                }
            } else if (question.type === 'rating' && question.ratingScale) {
                document.getElementById('editRatingMin').value = question.ratingScale.min || 1;
                document.getElementById('editRatingMax').value = question.ratingScale.max || 5;

                if (question.ratingScale.labels) {
                    document.getElementById('editRatingLabels').value = question.ratingScale.labels.join(', ');
                } else {
                    document.getElementById('editRatingLabels').value = '';
                }
            } else if (question.type === 'file' && question.fileUpload) {
                document.getElementById('editFileMaxSize').value = question.fileUpload.maxSize || 10;

                if (question.fileUpload.allowedTypes) {
                    document.getElementById('editFileTypes').value = question.fileUpload.allowedTypes.join(', ');
                } else {
                    document.getElementById('editFileTypes').value = '';
                }
            }

            // Show the modal
            document.getElementById('editQuestionModal').style.display = 'block';
        }

        function closeEditQuestionModal() {
            document.getElementById('editQuestionModal').style.display = 'none';
            document.getElementById('editQuestionForm').reset();
        }

        function openDeleteQuestionModal(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (!question) return;

            // Store the question ID
            document.getElementById('deleteQuestionId').value = question.id;

            // Show the modal
            document.getElementById('deleteQuestionModal').style.display = 'block';
        }

        function closeDeleteQuestionModal() {
            document.getElementById('deleteQuestionModal').style.display = 'none';
        }

        function confirmDeleteQuestion() {
            const questionId = parseInt(document.getElementById('deleteQuestionId').value);
            if (!questionId) return;

            // Find the question index
            const questionIndex = questions.findIndex(q => q.id === questionId);
            if (questionIndex === -1) return;

            // Remove the question from the array
            questions.splice(questionIndex, 1);

            // Re-render the questions table
            renderQuestionsTable(questions);

            // Close the modal
            closeDeleteQuestionModal();

            // Show success message with a toast notification
            const successToast = document.createElement('div');
            successToast.className = 'toast-notification toast-success';
            successToast.textContent = 'Question deleted successfully';
            document.body.appendChild(successToast);

            // Remove the toast after 3 seconds
            setTimeout(() => {
                successToast.remove();
            }, 3000);
        }

        // Handle edit question form submission
        function handleEditQuestion(event) {
            event.preventDefault();

            const questionId = parseInt(document.getElementById('editQuestionId').value);
            if (!questionId) return;

            // Find the question index
            const questionIndex = questions.findIndex(q => q.id === questionId);
            if (questionIndex === -1) return;

            try {
                const text = document.getElementById('editQuestionText').value.trim();
                const type = document.getElementById('editQuestionType').value;
                const category = document.getElementById('editQuestionCategory').value;
                const help = document.getElementById('editQuestionHelp').value.trim();

                // Validate inputs
                if (!text) {
                    throw new Error('Question text is required');
                }

                if (text.length < 5) {
                    throw new Error('Question text must be at least 5 characters long');
                }

                // Update the question basic properties
                questions[questionIndex].text = text;
                questions[questionIndex].type = type;
                questions[questionIndex].category = category;
                questions[questionIndex].help = help;

                // Update type-specific properties
                if (type === 'multiple') {
                    const multipleData = getMultipleChoiceOptions('edit');
                    if (multipleData.options.length < 2) {
                        throw new Error('Multiple choice questions must have at least 2 options');
                    }

                    // Check if at least one option is marked as correct
                    if (multipleData.correctOptions.length === 0) {
                        throw new Error('At least one option must be marked as correct');
                    }

                    questions[questionIndex].options = multipleData.options.map(opt => opt.text);
                    questions[questionIndex].correctOptions = multipleData.correctOptions;
                    questions[questionIndex].allowMultiple = multipleData.allowMultiple;
                } else if (type === 'rating') {
                    const min = parseInt(document.getElementById('editRatingMin').value);
                    const max = parseInt(document.getElementById('editRatingMax').value);
                    const labels = document.getElementById('editRatingLabels').value.trim();

                    if (min >= max) {
                        throw new Error('Maximum value must be greater than minimum value');
                    }

                    questions[questionIndex].ratingScale = {
                        min: min,
                        max: max
                    };

                    if (labels) {
                        const labelArray = labels.split(',').map(label => label.trim());
                        if (labelArray.length !== (max - min + 1)) {
                            throw new Error(`Number of labels (${labelArray.length}) must match the scale range (${max - min + 1})`);
                        }
                        questions[questionIndex].ratingScale.labels = labelArray;
                    }
                } else if (type === 'file') {
                    const allowedTypes = document.getElementById('editFileTypes').value.trim();
                    const maxSize = parseInt(document.getElementById('editFileMaxSize').value);

                    questions[questionIndex].fileUpload = {
                        maxSize: maxSize
                    };

                    if (allowedTypes) {
                        questions[questionIndex].fileUpload.allowedTypes = allowedTypes.split(',').map(type => type.trim());
                    }
                }

                // Log the updated question
                console.log('Updated question:', questions[questionIndex]);

                // Re-render the questions table
                renderQuestionsTable(questions);

                // Close the modal
                closeEditQuestionModal();

                // Show success message with a toast notification
                const successToast = document.createElement('div');
                successToast.className = 'toast-notification toast-success';
                successToast.textContent = 'Question updated successfully';
                document.body.appendChild(successToast);

                // Remove the toast after 3 seconds
                setTimeout(() => {
                    successToast.remove();
                }, 3000);
            } catch (error) {
                // Show error message
                alert(error.message);
                console.error('Error updating question:', error);
            }
        }

        // Handle add question form submission
        function handleAddQuestion(event) {
            event.preventDefault();

            // Hide any previous error messages
            const errorElement = document.getElementById('questionFormError');
            errorElement.classList.add('hidden');
            errorElement.textContent = '';

            try {
                // Get form values
                const text = document.getElementById('questionText').value.trim();
                const type = document.getElementById('questionType').value;
                const category = document.getElementById('questionCategory').value;
                const help = document.getElementById('questionHelp').value.trim();

                // Validate inputs
                if (!text) {
                    throw new Error('Question text is required');
                }

                if (text.length < 5) {
                    throw new Error('Question text must be at least 5 characters long');
                }

                // Check for duplicate questions
                const isDuplicate = questions.some(q =>
                    q.text.toLowerCase() === text.toLowerCase() &&
                    q.type === type &&
                    q.category === category
                );

                if (isDuplicate) {
                    throw new Error('A similar question already exists');
                }

                // Create a new question ID (max ID + 1)
                const newId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;

                // Create the new question
                const newQuestion = {
                    id: newId,
                    text,
                    type,
                    category,
                    help
                };

                // Add type-specific properties
                if (type === 'multiple') {
                    const multipleData = getMultipleChoiceOptions('add');
                    if (multipleData.options.length < 2) {
                        throw new Error('Multiple choice questions must have at least 2 options');
                    }

                    // Check if at least one option is marked as correct
                    if (multipleData.correctOptions.length === 0) {
                        throw new Error('At least one option must be marked as correct');
                    }

                    newQuestion.options = multipleData.options.map(opt => opt.text);
                    newQuestion.correctOptions = multipleData.correctOptions;
                    newQuestion.allowMultiple = multipleData.allowMultiple;
                } else if (type === 'rating') {
                    const min = parseInt(document.getElementById('ratingMin').value);
                    const max = parseInt(document.getElementById('ratingMax').value);
                    const labels = document.getElementById('ratingLabels').value.trim();

                    if (min >= max) {
                        throw new Error('Maximum value must be greater than minimum value');
                    }

                    newQuestion.ratingScale = {
                        min: min,
                        max: max
                    };

                    if (labels) {
                        const labelArray = labels.split(',').map(label => label.trim());
                        if (labelArray.length !== (max - min + 1)) {
                            throw new Error(`Number of labels (${labelArray.length}) must match the scale range (${max - min + 1})`);
                        }
                        newQuestion.ratingScale.labels = labelArray;
                    }
                } else if (type === 'file') {
                    const allowedTypes = document.getElementById('fileTypes').value.trim();
                    const maxSize = parseInt(document.getElementById('fileMaxSize').value);

                    newQuestion.fileUpload = {
                        maxSize: maxSize
                    };

                    if (allowedTypes) {
                        newQuestion.fileUpload.allowedTypes = allowedTypes.split(',').map(type => type.trim());
                    }
                }

                // Log the new question data
                console.log('Adding new question:', newQuestion);

                // Add the question to the array
                questions.push(newQuestion);

                // Re-render the questions table
                renderQuestionsTable(questions);

                // Apply filters to show the new question
                applyQuestionFilters();

                // Reset the form
                document.getElementById('questionForm').reset();

                // Close the form
                toggleQuestionForm(false);

                // Show success message with a toast notification
                const successToast = document.createElement('div');
                successToast.className = 'toast-notification toast-success';
                successToast.textContent = 'Question added successfully';
                document.body.appendChild(successToast);

                // Remove the toast after 3 seconds
                setTimeout(() => {
                    successToast.remove();
                }, 3000);

                return true;
            } catch (error) {
                // Show error message in the form
                errorElement.textContent = error.message;
                errorElement.classList.remove('hidden');

                // Log the error
                console.error('Error adding question:', error);
                return false;
            }
        }

        // Render assessment templates
        function renderTemplates(templatesData) {
            console.log('renderTemplates called with data:', templatesData);
            // console.log('Templates data type:', typeof templatesData);
            // console.log('Is templates data an array?', Array.isArray(templatesData));



            const container = document.getElementById('templatesContainer');
            if (!container) {
                console.error('Templates container not found');
                return; // Skip if container doesn't exist yet
            }

            container.innerHTML = '';


            // First, let's clean up any templates with missing data
            templatesData.forEach(template => {

                // Make sure template has all required properties with default values if missing
                if (!template.name || template.name.trim() === '') {
                    template.name = '';
                    console.warn('Template with ID', template.id, 'has no name, setting default');
                }

                if (!template.description) {
                    template.description = '';
                }

                if (!template.questionIds) {
                    template.questionIds = [];
                    console.warn('Template with ID', template.id, 'has no questionIds array, creating empty array');
                }

                template.questionCount = template.questionIds.length;

                if (!template.lastUpdated) {
                    template.lastUpdated = new Date().toISOString().split('T')[0].replace(/-/g, '-');
                    console.warn('Template with ID', template.id, 'has no lastUpdated date, setting to today');
                }
            });

            console.log('Templates after validation:', templatesData);

            // Now render the templates
            templatesData.forEach(template => {
                // console.log('Rendering template:', template);

                const card = document.createElement('div');
                card.className = 'border rounded-lg p-4 hover:shadow-md transition-shadow';


                // Create a sanitized version of the template data to ensure proper display
                const displayName = template.name || 'Untitled Template';
                const displayDescription = template.description || '';
                const displayQuestionCount = template.questionCount || 0;
                const displayLastUpdated = template.lastUpdated || new Date().toISOString().split('T')[0].replace(/-/g, '-');



                card.innerHTML = `
                    <h4 class="font-medium text-lg mb-2">${displayName}</h4>
                    <p class="text-sm text-gray-600 mb-2">${displayDescription}</p>
                    <p class="text-sm text-gray-500 mb-2">Questions: ${displayQuestionCount}</p>
                    <p class="text-xs text-gray-400 mb-4">Last Updated: ${displayLastUpdated}</p>
                    <div class="flex justify-end space-x-2">
                        <button class="text-indigo-600 text-sm hover:text-indigo-900" onclick="openEditTemplateModal('${template.id}'); return false;">Edit</button>
                        <button class="text-indigo-600 text-sm hover:text-indigo-900" onclick="openCloneTemplateModal(${template.id}); return false;">Clone</button>
                        <button class="text-red-600 text-sm hover:text-red-900" onclick="openDeleteTemplateModal(${template.id}); return false;">Delete</button>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Template Modal Functions
        function openEditTemplateModal(templateId) {
            console.log('Opening edit template modal for template ID:', templateId);
            const template = templates.find(t => t.id === templateId || t._id === templateId);

            if (!template) {
                console.error('Template not found with ID:', templateId);
                return;
            }

            console.log('Found template:', template);
            console.log('Template name:', template.name);
            console.log('Template description:', template.description);

            // Populate the form fields
            const idField = document.getElementById('editTemplateId');
            const nameField = document.getElementById('editTemplateName');
            const descriptionField = document.getElementById('editTemplateDescription');

            if (!idField || !nameField || !descriptionField) {
                console.error('Form fields not found:', {
                    idField: !!idField,
                    nameField: !!nameField,
                    descriptionField: !!descriptionField
                });
                alert('Error: Form fields not found');
                return;
            }

            idField.value = template.id;
            nameField.value = template.name || '';
            descriptionField.value = template.description || '';

            console.log('Set form field values:', {
                idField: idField.value,
                nameField: nameField.value,
                descriptionField: descriptionField.value
            });

            // Populate the questions list
            const questionsContainer = document.getElementById('editTemplateQuestions');
            questionsContainer.innerHTML = '';

            // Get the questions for this template
            if (template.questionIds && template.questionIds.length > 0) {
                console.log('Template has question IDs:', template.questionIds);

                // Filter out question IDs that don't exist in the questions array
                const validQuestionIds = template.questionIds.filter(id => questions.some(q => q.id === id));
                console.log('Valid question IDs:', validQuestionIds);

                if (validQuestionIds.length > 0) {
                    validQuestionIds.forEach(questionId => {
                        const question = questions.find(q => q.id === questionId);
                        if (question) {
                            console.log('Adding question to list:', question);
                            const questionItem = document.createElement('div');
                            questionItem.className = 'flex justify-between items-center p-2 bg-white rounded border';
                            questionItem.innerHTML = `
                                <div>
                                    <p class="text-sm font-medium">${question.text}</p>
                                    <p class="text-xs text-gray-500">${formatQuestionType(question.type)} | ${question.category}</p>
                                </div>
                                <button
                                    type="button"
                                    class="text-red-600 hover:text-red-900"
                                    onclick="removeQuestionFromTemplate(${template.id}, ${question.id}); return false;"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            questionsContainer.appendChild(questionItem);
                        }
                    });
                } else {
                    console.log('No valid questions found for template');
                    questionsContainer.innerHTML = '<p class="text-sm text-gray-500">No questions added to this template yet.</p>';
                }
            } else {
                console.log('Template has no question IDs');
                questionsContainer.innerHTML = '<p class="text-sm text-gray-500">No questions added to this template yet.</p>';
            }

            // Update the modal title to "Edit Assessment Template"
            const modalTitle = document.getElementById('templateModalTitle');
            if (modalTitle) {
                modalTitle.textContent = 'Edit Assessment Template';
                console.log('Updated modal title to "Edit Assessment Template"');
            } else {
                console.error('templateModalTitle not found');
            }

            // Show the modal
            document.getElementById('editTemplateModal').style.display = 'block';

            console.log('Edit template modal displayed with form fields populated');

            // Make sure the Add Question button has the correct event listener
            const addQuestionButton = document.getElementById('addQuestionToTemplateButton');
            if (addQuestionButton) {
                console.log('Found Add Question button in openEditTemplateModal');

                // Remove any existing event listeners to prevent duplicates
                const newAddQuestionButton = addQuestionButton.cloneNode(true);
                addQuestionButton.parentNode.replaceChild(newAddQuestionButton, addQuestionButton);

                // Add the event listener
                newAddQuestionButton.addEventListener('click', function (event) {
                    console.log('Add Question button clicked from openEditTemplateModal');
                    const template = templates.find(t => t.id === templateId || t._id === templateId);
                    console.log('Template ID for adding question:', templateId);

                    if (!templateId) {
                        console.error('No template ID found');
                        alert('Error: No template ID found');
                        return;
                    }

                    // Call the function to add a question to the template
                    addQuestionToTemplate(templateId);
                });
            } else {
                console.error('Add Question button not found in openEditTemplateModal');
            }
        }

        function closeEditTemplateModal() {
            document.getElementById('editTemplateModal').style.display = 'none';
            document.getElementById('editTemplateForm').reset();
        }

        function openCloneTemplateModal(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            // Populate the form fields
            document.getElementById('sourceTemplateId').value = template.id;
            document.getElementById('sourceTemplateName').textContent = template.name;
            document.getElementById('cloneTemplateName').value = `${template.name} (Copy)`;

            // Show the modal
            document.getElementById('cloneTemplateModal').style.display = 'block';
        }

        function closeCloneTemplateModal() {
            document.getElementById('cloneTemplateModal').style.display = 'none';
            document.getElementById('cloneTemplateForm').reset();
        }

        function openDeleteTemplateModal(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            // Populate the confirmation dialog
            document.getElementById('deleteTemplateId').value = template.id;
            document.getElementById('deleteTemplateName').textContent = template.name;

            // Show the modal
            document.getElementById('deleteTemplateModal').style.display = 'block';
        }

        function closeDeleteTemplateModal() {
            document.getElementById('deleteTemplateModal').style.display = 'none';
        }

        function confirmDeleteTemplate() {
            const templateId = parseInt(document.getElementById('deleteTemplateId').value);
            if (!templateId) return;

            // Find the template index
            const templateIndex = templates.findIndex(t => t.id === templateId);
            if (templateIndex === -1) return;

            // Remove the template from the array
            templates.splice(templateIndex, 1);

            // Re-render the templates
            renderTemplates(templates);

            // Close the modal
            closeDeleteTemplateModal();

            // Show success message
            alert('Template deleted successfully');
        }

        function addQuestionToTemplate(templateId) {
            console.log('addQuestionToTemplate called with templateId:', templateId);

            if (!templateId) {
                console.error('No template ID provided');
                alert('Error: No template ID provided');
                return;
            }

            console.log('Templates array:', templates);

            const template = templates.find(t => t.id === templateId);
            console.log('Found template:', template);

            if (!template) {
                console.error('Template not found with ID:', templateId);
                alert('Error: Template not found with ID: ' + templateId);
                return;
            }

            // Open modal
            openAddQuestionToTemplateModal(templateId);
        }


        // Function to remove a question from a template
        function removeQuestionFromTemplate(templateId, questionId) {
            console.log('removeQuestionFromTemplate called with templateId:', templateId, 'questionId:', questionId);

            const template = templates.find(t => t.id === templateId);
            if (!template) {
                console.error('Template not found with ID:', templateId);
                return;
            }

            if (!template.questionIds) {
                console.error('Template has no questionIds array');
                return;
            }

            console.log('Current template question IDs:', template.questionIds);

            // Find the index of the question in the template's questionIds array
            const questionIndex = template.questionIds.indexOf(questionId);
            console.log('Question index in array:', questionIndex);

            if (questionIndex === -1) {
                console.error('Question ID not found in template');
                return;
            }

            // Remove the question from the template
            template.questionIds.splice(questionIndex, 1);
            console.log('Updated template question IDs:', template.questionIds);

            // Update the question count
            template.questionCount = template.questionIds.length;
            console.log('Updated question count:', template.questionCount);

            // Update the last updated date
            template.lastUpdated = new Date().toISOString().split('T')[0].replace(/-/g, '-');

            // Re-render the template questions
            openEditTemplateModal(templateId);

            // Show success message with a toast notification
            const successToast = document.createElement('div');
            successToast.className = 'toast-notification toast-success';
            successToast.textContent = 'Question removed from template';
            document.body.appendChild(successToast);

            // Remove the toast after 3 seconds
            setTimeout(() => {
                successToast.remove();
            }, 3000);
        }

        // Open modal to add a question to a template
        function openAddQuestionToTemplateModal(templateId) {
            console.log('openAddQuestionToTemplateModal called with templateId:', templateId);

            templateId = parseInt(templateId);
            console.log('Parsed templateId:', templateId);
            console.log('Templates array:', templates);

            const template = templates.find(t => t.id === templateId || t._id === templateId);
            console.log('Found template:', template);

            if (!template) {
                console.error('Template not found with ID:', templateId);
                alert('Error: Template not found with ID: ' + templateId);
                return;
            }

            // Store the template ID for later use
            document.getElementById('addQuestionToTemplateId').value = templateId;

            // Populate the questions list
            const questionsContainer = document.getElementById('availableQuestionsList');
            if (!questionsContainer) {
                console.error('availableQuestionsList element not found');
                alert('Error: Questions container not found');
                return;
            }

            questionsContainer.innerHTML = '';

            // Initialize questionIds array if it doesn't exist
            if (!template.questionIds) {
                template.questionIds = [];
            }

            console.log('Template question IDs:', template.questionIds);
            console.log('All questions:', questions);

            // Get all questions that are not already in the template
            const availableQuestions = questions.filter(q => {
                return !template.questionIds.includes(q.id);
            });

            console.log('Available questions:', availableQuestions);

            if (availableQuestions.length > 0) {
                availableQuestions.forEach(question => {
                    console.log('Adding available question to list:', question);
                    const questionItem = document.createElement('div');
                    questionItem.className = 'flex items-start p-2 hover:bg-gray-50';
                    questionItem.innerHTML = `
                        <input
                            type="checkbox"
                            id="question_${question.id}"
                            value="${question.id}"
                            class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                        >
                        <label for="question_${question.id}" class="ml-2 block">
                            <span class="text-sm font-medium">${question.text}</span>
                            <span class="block text-xs text-gray-500">${formatQuestionType(question.type)} | ${question.category}</span>
                        </label>
                    `;
                    questionsContainer.appendChild(questionItem);
                });
            } else {
                console.log('No available questions found');
                questionsContainer.innerHTML = '<p class="text-sm text-gray-500 p-2">No more questions available to add.</p>';
            }

            // Show the modal
            const modal = document.getElementById('addQuestionToTemplateModal');
            if (!modal) {
                console.error('addQuestionToTemplateModal element not found');
                alert('Error: Add question modal not found');
                return;
            }

            modal.style.display = 'block';

            // Add event listener to the Add Selected Questions button
            const addSelectedQuestionsButton = document.getElementById('addSelectedQuestionsButton');
            if (addSelectedQuestionsButton) {
                console.log('Found Add Selected Questions button, adding click event listener');

                // Create a completely new button
                const newAddSelectedQuestionsButton = document.createElement('button');
                newAddSelectedQuestionsButton.id = 'addSelectedQuestionsButton';
                newAddSelectedQuestionsButton.type = 'button';
                newAddSelectedQuestionsButton.className = 'px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700';
                newAddSelectedQuestionsButton.textContent = 'Add Selected Questions';

                // Replace the old button
                addSelectedQuestionsButton.parentNode.replaceChild(newAddSelectedQuestionsButton, addSelectedQuestionsButton);

                // Add the event listener
                newAddSelectedQuestionsButton.addEventListener('click', function (event) {
                    console.log('Add Selected Questions button clicked');
                    handleAddQuestionsToTemplate(event);
                });
            } else {
                console.error('Add Selected Questions button not found');
            }
        }

        // Close add question to template modal
        function closeAddQuestionToTemplateModal() {
            document.getElementById('addQuestionToTemplateModal').style.display = 'none';
        }

        // Handle adding selected questions to template
        function handleAddQuestionsToTemplate(event) {
            console.log('handleAddQuestionsToTemplate called');
            event.preventDefault();

            const templateIdElement = document.getElementById('addQuestionToTemplateId');
            if (!templateIdElement) {
                console.error('addQuestionToTemplateId element not found');
                alert('Error: Template ID element not found');
                return;
            }

            const templateId = parseInt(templateIdElement.value);
            console.log('Template ID value:', templateIdElement.value);
            console.log('Parsed Template ID:', templateId);



            console.log('Templates array:', templates);
            const template = templates.find(t => t.id === templateId);
            console.log('Template found:', template);

            if (!template) {
                console.error('Template not found with ID:', templateId);
                alert('Error: Template not found with ID: ' + templateId);
                return;
            }

            // Initialize questionIds array if it doesn't exist
            if (!template.questionIds) {
                template.questionIds = [];
            }

            // Get all checked questions
            const checkboxes = document.querySelectorAll('#availableQuestionsList input[type="checkbox"]:checked');
            console.log('Checked checkboxes:', checkboxes.length);
            const selectedQuestionIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            console.log('Selected question IDs:', selectedQuestionIds);

            if (selectedQuestionIds.length === 0) {
                alert('Please select at least one question to add.');
                return;
            }

            // Add selected questions to the template
            selectedQuestionIds.forEach(questionId => {
                if (!template.questionIds.includes(questionId)) {
                    template.questionIds.push(questionId);
                }
            });

            // Update the question count
            template.questionCount = template.questionIds.length;
            console.log('Updated question count:', template.questionCount);
            console.log('Updated template question IDs:', template.questionIds);

            // Update the last updated date
            template.lastUpdated = new Date().toISOString().split('T')[0].replace(/-/g, '-');

            // Close the add questions modal
            closeAddQuestionToTemplateModal();

            // Refresh the edit template modal
            openEditTemplateModal(templateId);

            // Show success message with a toast notification
            const successToast = document.createElement('div');
            successToast.className = 'toast-notification toast-success';
            successToast.textContent = `${selectedQuestionIds.length} question(s) added to template`;
            document.body.appendChild(successToast);

            // Remove the toast after 3 seconds
            setTimeout(() => {
                successToast.remove();
            }, 3000);

            return false; // Prevent form submission
        }
        /* container that holds every template card/row */
        const listBox = document.getElementById('templatesContainer'); // adjust ID

        listBox.addEventListener('click', (e) => {
            const btn = e.target.closest('.edit-btn');
            if (!btn) return;                      // not an Edit click

            const tplId = btn.dataset.tplId;
            openEditModal(tplId);
        });

        function openEditModal(id) {
            const idx = templates.findIndex(t =>
                String(t.id) === id || String(t.customId) === id || String(t._id) === id);

            if (idx === -1) { console.error('Template not found:', id); return; }

            const t = templates[idx];

            /* show modal */
            document.getElementById('editTemplateModal').style.display = 'block';
            document.getElementById('templateModalTitle').textContent = 'Edit Assessment Template';

            /* pre-fill fields */
            document.getElementById('editTemplateId').value = t._id || t.customId || t.id;
            document.getElementById('editTemplateName').value = t.name;
            document.getElementById('editTemplateDescription').value = t.description;

            /* render question list */
            const qBox = document.getElementById('editTemplateQuestions');
            qBox.innerHTML = (t.questionIds && t.questionIds.length)
                ? t.questionIds.map(q => `<p>${q}</p>`).join('')
                : '<p class="text-sm text-gray-500">No questions added to this template yet.</p>';
        }

        const idRaw = document.getElementById('editTemplateId').value.trim();

        /* compare as strings */
        let templateIndex = templates.findIndex(t =>
            String(t.id) === idRaw || String(t.customId) === idRaw || String(t._id) === idRaw
        );

        let isNewTemplate = templateIndex === -1;


        // Handle edit template form submission
        function handleEditTemplate(event) {
            console.log('handleEditTemplate called with event:', event);
            console.log('Event type:', event.type);
            console.log('Event target:', event.target);
            event.preventDefault();

            try {
                console.log('Getting template ID from form');
                const templateIdElement = document.getElementById('editTemplateId');
                console.log('Template ID element:', templateIdElement);

                if (!templateIdElement) {
                    console.error('editTemplateId element not found');
                    alert('Error: Could not find template ID field');
                    return;
                }

                const templateId = parseInt(templateIdElement.value);
                console.log('Template ID value:', templateIdElement.value);
                console.log('Parsed Template ID:', templateId);

                // For new templates, we might not have a valid ID yet
                // In this case, we'll create a new template
                let isNewTemplate = false;
                let templateIndex = -1;

                if (!templateId) {
                    console.log('No template ID found or invalid ID - this might be a new template');
                    isNewTemplate = true;
                } else {
                    console.log('Current templates array:', templates);
                    console.log('Templates array length:', templates.length);

                    // Find the template
                    templateIndex = templates.findIndex(t => t.id === templateId);
                    console.log('Template index:', templateIndex);

                    if (templateIndex === -1) {
                        console.log('Template not found with ID:', templateId, '- treating as new template');
                        isNewTemplate = true;
                    }
                }

                // If this is a new template and wasn't found in the array
                if (isNewTemplate) {
                    console.log('Creating a new template');

                    // Generate a new ID
                    const newId = templates.length > 0 ? Math.max(...templates.map(t => parseInt(t.id) || 0)) + 1 : 1;
                    console.log('Generated new ID for template:', newId);

                    // Create a new template object
                    const newTemplate = {
                        id: newId,
                        name: '',
                        description: '',
                        questionCount: 0,
                        lastUpdated: new Date().toISOString().split('T')[0].replace(/-/g, '-'),
                        questionIds: []
                    };

                    // Add it to the templates array
                    templates.push(newTemplate);
                    templateIndex = templates.length - 1;
                    console.log('Added new template at index:', templateIndex);
                }

                // Get the updated values
                const nameElement = document.getElementById('editTemplateName');
                const descriptionElement = document.getElementById('editTemplateDescription');

                if (!nameElement || !descriptionElement) {
                    console.error('Form elements not found', {
                        nameElement,
                        descriptionElement
                    });
                    alert('Error: Form elements not found');
                    return;
                }

                // Get the values and validate them
                let name = nameElement.value.trim();
                const description = descriptionElement.value.trim();
                const lastUpdated = new Date().toISOString().split('T')[0].replace(/-/g, '-');

                // If name is empty, set a default
                if (!name) {
                    name = 'Untitled Template';
                    nameElement.value = name;
                    console.warn('Template name was empty, setting to default:', name);
                }

                console.log('Updating template with values:', {
                    name,
                    description,
                    lastUpdated,
                    nameElementValue: nameElement.value,
                    descriptionElementValue: descriptionElement.value
                });

                // Update the template
                console.log('Before update, template values:', {
                    name: templates[templateIndex].name,
                    description: templates[templateIndex].description,
                    lastUpdated: templates[templateIndex].lastUpdated
                });

                templates[templateIndex].name = name;
                templates[templateIndex].description = description;
                templates[templateIndex].lastUpdated = lastUpdated;

                console.log('After update, template values:', {
                    name: templates[templateIndex].name,
                    description: templates[templateIndex].description,
                    lastUpdated: templates[templateIndex].lastUpdated
                });

                console.log('Updated template properties:', {
                    name: templates[templateIndex].name,
                    description: templates[templateIndex].description,
                    lastUpdated: templates[templateIndex].lastUpdated
                });

                // Preserve the questionIds if they exist
                if (!templates[templateIndex].questionIds) {
                    templates[templateIndex].questionIds = [];
                }

                // Update the question count
                templates[templateIndex].questionCount = templates[templateIndex].questionIds.length;

                console.log('Updated template:', templates[templateIndex]);
                console.log('Updated templates array:', templates);

                // Log the templates array before re-rendering
                console.log('Templates array before re-rendering in handleEditTemplate:', JSON.stringify(templates));

                // Re-render the templates
                console.log('Calling renderTemplates');
                renderTemplates(templates);

                // Log the templates array after re-rendering
                console.log('Templates array after re-rendering in handleEditTemplate:', JSON.stringify(templates));

                // Close the modal
                console.log('Closing modal');
                closeEditTemplateModal();

                // Show success message with a toast notification
                console.log('Creating success toast');
                const successToast = document.createElement('div');
                successToast.className = 'toast-notification toast-success';

                // Show different message based on whether this was a new template or an update
                if (isNewTemplate) {
                    successToast.textContent = 'Template created successfully';
                } else {
                    successToast.textContent = 'Template updated successfully';
                }

                document.body.appendChild(successToast);

                // Remove the toast after 3 seconds
                setTimeout(() => {
                    successToast.remove();
                }, 3000);

                console.log('Template update completed successfully');
                return true;
            } catch (error) {
                console.error('Error in handleEditTemplate:', error);
                console.error('Error stack:', error.stack);
                alert('An error occurred while saving the template. Please try again.');
                return false;
            }
        }

        // Handle clone template form submission
        function handleCloneTemplate(event) {
            event.preventDefault();

            const sourceTemplateId = parseInt(document.getElementById('sourceTemplateId').value);
            if (!sourceTemplateId) return;

            // Find the source template
            const sourceTemplate = templates.find(t => t.id === sourceTemplateId);
            if (!sourceTemplate) return;

            // Create a new template ID (max ID + 1)
            const newId = Math.max(...templates.map(t => t.id)) + 1;

            // Create the cloned template
            const clonedTemplate = {
                id: newId,
                name: document.getElementById('cloneTemplateName').value,
                description: sourceTemplate.description,
                questionCount: sourceTemplate.questionCount,
                questionIds: sourceTemplate.questionIds ? [...sourceTemplate.questionIds] : [],
                lastUpdated: new Date().toISOString().split('T')[0].replace(/-/g, '-')
            };

            // Add the cloned template to the array
            templates.push(clonedTemplate);

            // Re-render the templates
            renderTemplates(templates);

            // Close the modal
            closeCloneTemplateModal();

            // Show success message with a toast notification
            const successToast = document.createElement('div');
            successToast.className = 'toast-notification toast-success';
            successToast.textContent = 'Template cloned successfully';
            document.body.appendChild(successToast);

            // Remove the toast after 3 seconds
            setTimeout(() => {
                successToast.remove();
            }, 3000);
        }

        // Format question type for display
        function formatQuestionType(type) {
            const types = {
                'text': 'Text Response',
                'yesno': 'Yes/No',
                'multiple': 'Multiple Choice',
                'rating': 'Rating Scale',
                'file': 'File Upload'
            };

            return types[type] || type;
        }

        // Update risk matrix with data
        function updateRiskMatrix(risksData) {
            // Define the matrix positions
            const positions = {
                'High': 3,
                'Medium': 2,
                'Low': 1,
                'Very Low': 0
            };

            const impactPositions = {
                'Low': 0,
                'Medium': 1,
                'High': 2,
                'Critical': 3
            };

            // Clear all cells
            const cells = document.querySelectorAll('.risk-matrix-cell');
            cells.forEach(cell => {
                const div = cell.querySelector('div');
                const countSpan = div.querySelector('span:first-child');
                const textSpan = div.querySelector('span:last-child');

                countSpan.textContent = '0';
                textSpan.textContent = 'Risks';

                // Clear any existing risk data
                cell.setAttribute('data-risks', '[]');
            });

            // Count risks for each position
            const riskCounts = {};
            risksData.forEach(risk => {
                const likelihoodPos = positions[risk.likelihood] || 0;
                const impactPos = impactPositions[risk.impact] || 0;
                const key = `${likelihoodPos}-${impactPos}`;

                if (!riskCounts[key]) {
                    riskCounts[key] = [];
                }

                riskCounts[key].push(risk);
            });

            // Update cell counts
            for (const [position, risks] of Object.entries(riskCounts)) {
                const cell = document.querySelector(`[data-position="${position}"]`);
                if (cell) {
                    const div = cell.querySelector('div');
                    const countSpan = div.querySelector('span:first-child');
                    const textSpan = div.querySelector('span:last-child');

                    countSpan.textContent = risks.length;
                    textSpan.textContent = risks.length === 1 ? 'Risk' : 'Risks';

                    // Store the risks in data attribute for click handler
                    cell.setAttribute('data-risks', JSON.stringify(risks.map(r => r.id)));

                    // Add a visual indicator that this cell has risks
                    if (risks.length > 0) {
                        cell.classList.add('has-risks');
                        cell.style.opacity = '1';
                    } else {
                        cell.classList.remove('has-risks');
                        cell.style.opacity = '0.8';
                    }
                }
            }

            // Re-add click handlers after updating the matrix
            cells.forEach(cell => {
                // Remove any existing event listeners to prevent duplicates
                cell.removeEventListener('click', handleMatrixCellClick);
                // Add the click event listener
                cell.addEventListener('click', handleMatrixCellClick);
            });

            console.log('Risk matrix updated with', risksData.length, 'risks');
        }

        // Handle matrix cell click
        function handleMatrixCellClick(event) {
            event.preventDefault();
            event.stopPropagation();

            const cell = event.currentTarget;
            console.log('Matrix cell clicked:', cell.getAttribute('data-position'));

            try {
                // Get risk IDs from the data attribute
                const riskIdsStr = cell.getAttribute('data-risks') || '[]';
                console.log('Risk IDs string:', riskIdsStr);

                const riskIds = JSON.parse(riskIdsStr);
                console.log('Parsed risk IDs:', riskIds);

                if (!riskIds || riskIds.length === 0) {
                    // Show a message that there are no risks in this cell
                    console.log('No risks in this cell');
                    showCustomAlert('No risks in this cell');
                    return;
                }

                // Find the risks
                const cellRisks = risks.filter(risk => riskIds.includes(risk.id));
                console.log('Found risks:', cellRisks);

                // If only one risk, open its details
                if (cellRisks.length === 1) {
                    console.log('Opening single risk modal');
                    openRiskModal(cellRisks[0]);
                } else {
                    // Show the matrix risks modal with multiple risks
                    console.log('Opening matrix risks modal with', cellRisks.length, 'risks');
                    openMatrixRisksModal(cell, cellRisks);
                }
            } catch (error) {
                console.error('Error handling matrix cell click:', error);
                showCustomAlert('An error occurred while processing the risk data. Please try again.');
            }
        }

        // Open matrix risks modal
        function openMatrixRisksModal(cell, cellRisks) {
            console.log('Opening matrix risks modal with cell:', cell, 'and risks:', cellRisks);

            if (!cellRisks || cellRisks.length === 0) {
                console.error('No risks provided to openMatrixRisksModal');
                return;
            }

            try {
                // Get the position data to determine likelihood and impact
                const position = cell.getAttribute('data-position');
                console.log('Cell position:', position);

                const [likelihoodPos, impactPos] = position.split('-').map(Number);

                // Map position back to text values
                const likelihoodMap = { 3: 'High', 2: 'Medium', 1: 'Low', 0: 'Very Low' };
                const impactMap = { 3: 'Critical', 2: 'High', 1: 'Medium', 0: 'Low' };

                const likelihood = likelihoodMap[likelihoodPos];
                const impact = impactMap[impactPos];
                console.log('Likelihood:', likelihood, 'Impact:', impact);

                // Set the modal title and description
                document.getElementById('matrixRisksTitle').textContent = `${cellRisks.length} Risks in Selected Cell`;
                document.getElementById('matrixRisksDescription').textContent = `${likelihood} Likelihood Ã— ${impact} Impact`;

                // Set the cell color based on the cell's class
                const cellColorDiv = document.getElementById('matrixRisksCellColor');
                if (cell.classList.contains('risk-critical')) {
                    cellColorDiv.className = 'w-6 h-6 rounded bg-red-500';
                } else if (cell.classList.contains('risk-high')) {
                    cellColorDiv.className = 'w-6 h-6 rounded bg-orange-500';
                } else if (cell.classList.contains('risk-medium')) {
                    cellColorDiv.className = 'w-6 h-6 rounded bg-yellow-400';
                } else {
                    cellColorDiv.className = 'w-6 h-6 rounded bg-green-400';
                }

                // Populate the risks list
                const risksList = document.getElementById('matrixRisksList');
                risksList.innerHTML = '';

                cellRisks.forEach(risk => {
                    console.log('Adding risk to modal:', risk.name);

                    const item = document.createElement('li');
                    item.className = 'py-3 cursor-pointer hover:bg-gray-100';
                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-medium">${risk.name}</h4>
                                <p class="text-sm text-gray-500 mt-1">${risk.category}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(risk.status)}">${risk.status}</span>
                                <button class="text-indigo-600 hover:text-indigo-900">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    // Add click handler to view risk details
                    item.addEventListener('click', () => {
                        console.log('Risk item clicked:', risk);
                        closeMatrixRisksModal();
                        openRiskModal(risk);
                    });

                    risksList.appendChild(item);
                });

                // Show the modal
                const modal = document.getElementById('matrixRisksModal');
                modal.style.display = 'block';
                console.log('Matrix risks modal displayed');

                // Add a click handler to close the modal when clicking outside
                window.addEventListener('click', function closeOnOutsideClick(event) {
                    if (event.target === modal) {
                        closeMatrixRisksModal();
                        window.removeEventListener('click', closeOnOutsideClick);
                    }
                });
            } catch (error) {
                console.error('Error opening matrix risks modal:', error);
                showCustomAlert('An error occurred while displaying the risks. Please try again.');
            }
        }

        // Close matrix risks modal
        function closeMatrixRisksModal() {
            // console.log('Closing matrix risks modal');
            const modal = document.getElementById('matrixRisksModal');
            modal.style.display = 'none';

            // Clear the risks list to free up memory
            const risksList = document.getElementById('matrixRisksList');
            risksList.innerHTML = '';
        }

        // Search functions
        function handleRiskSearchChange(event) {
            const query = event.target.value.toLowerCase();

            if (query.trim() === '') {
                document.getElementById('riskSearchResults').classList.remove('active');
                renderRisksTable(risks);
                updateRiskMatrix(risks);
                return;
            }

            const filteredRisks = risks.filter(risk => {
                return (
                    risk.name.toLowerCase().includes(query) ||
                    risk.category.toLowerCase().includes(query) ||
                    risk.level.toLowerCase().includes(query) ||
                    risk.status.toLowerCase().includes(query) ||
                    risk.owner?.toLowerCase().includes(query) ||
                    risk.description?.toLowerCase().includes(query)
                );
            });

            // Update the search results dropdown
            const resultsList = document.getElementById('searchResultsList');
            const resultsCount = document.getElementById('searchResultsCount');

            resultsList.innerHTML = '';
            resultsCount.textContent = `${filteredRisks.length} results found`;

            filteredRisks.forEach(risk => {
                const item = document.createElement('li');
                item.className = 'py-2 px-4 hover:bg-gray-100 cursor-pointer';
                item.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${risk.name}</span>
                        <span class="text-xs ${getLevelBadgeClass(risk.level)} px-2 py-1 rounded-full">${risk.level}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate">${risk.description}</p>
                `;

                item.addEventListener('click', () => {
                    openRiskModal(risk);
                    document.getElementById('riskSearchResults').classList.remove('active');
                });

                resultsList.appendChild(item);
            });

            // Show the search results dropdown
            document.getElementById('riskSearchResults').classList.add('active');

            // Also update the table and matrix
            renderRisksTable(filteredRisks);
            updateRiskMatrix(filteredRisks);
        }

        function handleAssetSearchChange(event) {
            const query = event.target.value.toLowerCase();

            const filteredAssets = assets.filter(asset => {
                return (
                    asset.name.toLowerCase().includes(query) ||
                    asset.type.toLowerCase().includes(query) ||
                    asset.owner.toLowerCase().includes(query) ||
                    asset.location.toLowerCase().includes(query) ||
                    asset.criticality.toLowerCase().includes(query)
                );
            });

            renderAssetsTable(filteredAssets);
        }

        function handleFrameworkSearchChange(event) {
            const query = event.target.value.toLowerCase();

            const filteredFrameworks = frameworks.filter(framework => {
                return (
                    framework.name.toLowerCase().includes(query) ||
                    framework.description.toLowerCase().includes(query) ||
                    framework.status.toLowerCase().includes(query)
                );
            });

            renderFrameworksTable(filteredFrameworks);
        }

        function handleDPIASearchChange(event) {
            const query = event.target.value.toLowerCase();

            const filteredDPIAs = dpias.filter(dpia => {
                return (
                    dpia.name.toLowerCase().includes(query) ||
                    dpia.department.toLowerCase().includes(query) ||
                    dpia.status.toLowerCase().includes(query) ||
                    dpia.risk.toLowerCase().includes(query)
                );
            });

            renderDPIAsTable(filteredDPIAs);
        }

        function handleAssessmentSearchChange(event) {
            const query = event.target.value.toLowerCase();

            const filteredAssessments = assessments.filter(assessment => {
                return (
                    assessment.name.toLowerCase().includes(query) ||
                    assessment.type.toLowerCase().includes(query) ||
                    assessment.status.toLowerCase().includes(query) ||
                    assessment.assignee?.toLowerCase().includes(query) ||
                    assessment.framework?.toLowerCase().includes(query)
                );
            });

            renderAssessmentsTable(filteredAssessments);
        }

        function handleQuestionSearchChange(event) {
            applyQuestionFilters();
        }

        // Toggle type dropdown
        function toggleTypeDropdown() {
            const dropdown = document.getElementById('typeDropdown');
            dropdown.classList.toggle('hidden');

            // Close the category dropdown if it's open
            document.getElementById('categoryDropdown').classList.add('hidden');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeTypeDropdown(e) {
                if (!e.target.closest('#typeFilterButton') && !e.target.closest('#typeDropdown')) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', closeTypeDropdown);
                }
            });
        }

        // Toggle category dropdown
        function toggleCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('hidden');

            // Close the type dropdown if it's open
            document.getElementById('typeDropdown').classList.add('hidden');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeCategoryDropdown(e) {
                if (!e.target.closest('#categoryFilterButton') && !e.target.closest('#categoryDropdown')) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', closeCategoryDropdown);
                }
            });
        }

        // Select type filter
        function selectType(value, displayText) {
            document.getElementById('filterQuestionType').value = value;
            document.getElementById('selectedType').textContent = displayText;
            document.getElementById('typeDropdown').classList.add('hidden');
            applyQuestionFilters();
        }

        // Select category filter
        function selectCategory(value, displayText) {
            document.getElementById('filterQuestionCategory').value = value;
            document.getElementById('selectedCategory').textContent = displayText;
            document.getElementById('categoryDropdown').classList.add('hidden');
            applyQuestionFilters();
        }

        // Apply filters to questions
        function applyQuestionFilters() {
            console.log('Applying question filters');

            const searchQuery = document.getElementById('searchQuestion').value.toLowerCase();
            const typeFilter = document.getElementById('filterQuestionType').value;
            const categoryFilter = document.getElementById('filterQuestionCategory').value;

            console.log('Filters:', { searchQuery, typeFilter, categoryFilter });

            const filteredQuestions = questions.filter(question => {
                // Apply search query filter
                const matchesSearch = searchQuery === '' ||
                    question.text.toLowerCase().includes(searchQuery) ||
                    question.type.toLowerCase().includes(searchQuery) ||
                    question.category.toLowerCase().includes(searchQuery) ||
                    (question.help && question.help.toLowerCase().includes(searchQuery));

                // Apply type filter (case-insensitive comparison)
                const matchesType = typeFilter === '' ||
                    question.type.toLowerCase() === typeFilter.toLowerCase();

                // Apply category filter (case-insensitive comparison)
                const matchesCategory = categoryFilter === '' ||
                    question.category.toLowerCase() === categoryFilter.toLowerCase();

                // Return true only if all filters match
                return matchesSearch && matchesType && matchesCategory;
            });

            console.log('Filtered questions:', filteredQuestions.length, 'of', questions.length);
            renderQuestionsTable(filteredQuestions);

            // Update filter counts
            const totalQuestions = questions.length;
            const filteredCount = filteredQuestions.length;

            // Add a filter count element to show how many questions are being displayed
            const filterCountElement = document.getElementById('questionFilterCount');
            if (filterCountElement) {
                filterCountElement.textContent = `Showing ${filteredCount} of ${totalQuestions} questions`;
            } else {
                // Create the filter count element if it doesn't exist
                const filterContainer = document.querySelector('#questionsTabContent .flex.justify-between');
                if (filterContainer) {
                    const countElement = document.createElement('div');
                    countElement.id = 'questionFilterCount';
                    countElement.className = 'text-sm text-gray-500';
                    countElement.textContent = `Showing ${filteredCount} of ${totalQuestions} questions`;
                    filterContainer.appendChild(countElement);
                }
            }

            // Update the filter button styles to indicate active filters
            const typeButton = document.getElementById('typeFilterButton');
            if (typeFilter) {
                typeButton.classList.add('bg-indigo-50', 'border-indigo-300');
                typeButton.classList.remove('bg-white');
            } else {
                typeButton.classList.remove('bg-indigo-50', 'border-indigo-300');
                typeButton.classList.add('bg-white');
            }

            const categoryButton = document.getElementById('categoryFilterButton');
            if (categoryFilter) {
                categoryButton.classList.add('bg-indigo-50', 'border-indigo-300');
                categoryButton.classList.remove('bg-white');
            } else {
                categoryButton.classList.remove('bg-indigo-50', 'border-indigo-300');
                categoryButton.classList.add('bg-white');
            }
        }

        // Calculate risk level based on likelihood and impact
        function calculateRiskLevel(likelihood, impact) {
            const likelihoodMap = { 'Very Low': 1, 'Low': 2, 'Medium': 3, 'High': 4 };
            const impactMap = { 'Low': 1, 'Medium': 2, 'High': 3, 'Critical': 4 };

            const score = likelihoodMap[likelihood] * impactMap[impact];

            if (score >= 12) return 'Critical';
            if (score >= 8) return 'High';
            if (score >= 4) return 'Medium';
            return 'Low';
        }

        // Update risk level in add/edit form
        function updateRiskLevel() {
            const likelihood = document.getElementById('newRiskLikelihood').value;
            const impact = document.getElementById('newRiskImpact').value;
            const level = calculateRiskLevel(likelihood, impact);

            document.getElementById('newRiskLevel').value = level;
        }

        // Update risk level in edit form
        function updateEditRiskLevel() {
            const likelihood = document.getElementById('editRiskLikelihood').value;
            const impact = document.getElementById('editRiskImpact').value;
            const level = calculateRiskLevel(likelihood, impact);

            document.getElementById('editRiskLevel').value = level;
        }

        function openRiskModal(riskData) {
            let riskId;

            // Determine if input is an object or ID
            if (typeof riskData === 'object' && riskData !== null) {
                riskId = (riskData.id || riskData._id);
            } else {
                riskId = (riskData);
            }

            // Find risk by ID (ensure string comparison)
            const risk = risks.find(r => (r.id) === riskId);

            // if (!risk) {
            //     console.warn('Risk not found for ID:', riskId);
            //     return;
            // }

            // Fill modal fields
            document.getElementById('riskDetailsTitle').textContent = risk.name;
            document.getElementById('riskDetailsBadge').textContent = `${risk.level} Risk`;
            document.getElementById('riskDetailsBadge').className = `ml-3 px-2 py-1 text-xs rounded-full ${getLevelBadgeClass(risk.level)}`;
            document.getElementById('riskDetailsDescription').textContent = risk.description;
            document.getElementById('riskDetailsControls').textContent = risk.controls || 'No controls specified.';
            document.getElementById('riskDetailsCategory').textContent = risk.category;
            document.getElementById('riskDetailsStatus').textContent = risk.status;
            document.getElementById('riskDetailsStatus').className = `px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(risk.status)}`;
            document.getElementById('riskDetailsOwner').textContent = risk.owner || 'Not assigned';
            document.getElementById('riskDetailsReviewDate').textContent = risk.reviewDate || 'Not scheduled';
            document.getElementById('riskDetailsLikelihood').textContent = risk.likelihood;
            document.getElementById('riskDetailsLikelihood').className = `px-2 py-1 text-xs rounded-full ${getLikelihoodBadgeClass(risk.likelihood)}`;
            document.getElementById('riskDetailsImpact').textContent = risk.impact;
            document.getElementById('riskDetailsImpact').className = `px-2 py-1 text-xs rounded-full ${getImpactBadgeClass(risk.impact)}`;
            document.getElementById('riskDetailsFormula').textContent = `${risk.likelihood} Likelihood Ã— ${risk.impact} Impact = ${risk.level} Risk`;

            // Handle edit button visibility based on source
            const editBtn = document.getElementById('editRiskBtn');
            if (editBtn) {
                editBtn.setAttribute('data-risk-id', String(risk.id || risk._id));

                // Hide edit button if this is an admin item
                if (risk.source === 'admin') {
                    editBtn.style.display = 'none';
                } else {
                    editBtn.style.display = 'inline-block';
                }
            }

            // Show modal
            const modal = document.getElementById('riskDetailsModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }


        // Close risk details modal
        function closeRiskModal() {
            document.getElementById('riskDetailsModal').style.display = 'none';
        }

        // Open add risk modal
        function openAddRiskModal() {
            // Reset form
            document.getElementById('addRiskForm').reset();
            updateRiskLevel(); // Update the level based on default selections

            // Show modal
            document.getElementById('addRiskModal').style.display = 'block';
        }

        // Close add risk modal
        function closeAddRiskModal() {
            document.getElementById('addRiskModal').style.display = 'none';
        }

        function openEditRiskModal() {
            const editBtn = document.getElementById('editRiskBtn');
            if (!editBtn) return console.warn('#editRiskBtn not found');

            const riskId = editBtn.getAttribute('data-risk-id'); // keep it as string!
            console.log('editRiskBtn risk ID:', riskId);

            if (!riskId) return console.warn('No data-risk-id set on #editRiskBtn');
            console.log('Loaded risks:', risks);

            // Find risk by full string match, support both _id and customId
            const risk = risks.find(r =>
                String(r._id) === riskId ||
                String(r.id) === riskId ||
                String(r.customId) === riskId
            );

            if (!risk) {
                console.warn(`Risk with id ${riskId} not found`);
                return;
            }

            // Fill form fields
            document.getElementById('editRiskId').value = risk._id || risk.id;
            document.getElementById('editRiskName').value = risk.name || '';
            document.getElementById('editRiskCategory').value = risk.category || '';
            document.getElementById('editRiskLikelihood').value = risk.likelihood || '';
            document.getElementById('editRiskImpact').value = risk.impact || '';
            document.getElementById('editRiskStatus').value = risk.status || '';
            document.getElementById('editRiskOwner').value = risk.owner || '';
            document.getElementById('editRiskDescription').value = risk.description || '';
            document.getElementById('editRiskControls').value = risk.controls || '';
            document.getElementById('editRiskLevel').value = risk.level || '';

            // Open modal
            closeRiskModal();
            const modal = document.getElementById('editRiskModal');
            if (modal) modal.style.display = 'block';
            else console.warn('#editRiskModal not found in DOM');
        }



        // Close edit risk modal
        function closeEditRiskModal() {
            document.getElementById('editRiskModal').style.display = 'none';
        }

        function handleSaveRisk(event) {
            event.preventDefault();

            const name = document.getElementById('newRiskName').value;
            const category = document.getElementById('newRiskCategory').value;
            const likelihood = document.getElementById('newRiskLikelihood').value;
            const impact = document.getElementById('newRiskImpact').value;
            const level = calculateRiskLevel(likelihood, impact);
            const status = document.getElementById('newRiskStatus').value;
            const owner = document.getElementById('newRiskOwner').value;
            const description = document.getElementById('newRiskDescription').value;
            const controls = document.getElementById('newRiskControls').value;

            const reviewDate = new Date();
            reviewDate.setMonth(reviewDate.getMonth() + 6);
            const formattedDate = reviewDate.toISOString().split('T')[0];

            const newRisk = {
                name,
                category,
                likelihood,
                impact,
                level,
                status,
                owner,
                description,
                controls,
                reviewDate: formattedDate
            };

            // Send to Wix to save
            window.parent.postMessage({ action: 'addRisk', payload: newRisk }, '*');

            // Optionally show spinner or toast
            closeAddRiskModal();
        }


        function handleUpdateRisk(event) {
            event.preventDefault();

            const id = document.getElementById('editRiskId').value; // string _id
            const name = document.getElementById('editRiskName').value;
            const category = document.getElementById('editRiskCategory').value;
            const likelihood = document.getElementById('editRiskLikelihood').value;
            const impact = document.getElementById('editRiskImpact').value;
            const level = calculateRiskLevel(likelihood, impact);
            const status = document.getElementById('editRiskStatus').value;
            const owner = document.getElementById('editRiskOwner').value;
            const description = document.getElementById('editRiskDescription').value;
            const controls = document.getElementById('editRiskControls').value;
            const reviewDate = new Date();
            reviewDate.setMonth(reviewDate.getMonth() + 6);
            const formattedDate = reviewDate.toISOString().split('T')[0];


            const updatedRisk = {
                _id: id, // REQUIRED for update in Wix
                name,
                category,
                likelihood,
                impact,
                level,
                status,
                owner,
                description,
                controls,
                reviewDate: formattedDate // âœ… INCLUDE IN PAYLOAD
            };

            // Send update request to Wix
            window.parent.postMessage({ action: 'updateRisk', payload: updatedRisk }, '*');

            closeEditRiskModal();
        }


        // Confirm delete risk
        function confirmDeleteRisk() {
            const id = document.getElementById('editRiskId').value;
            const risk = risks.find(r =>
                String(r.id) === id || String(r._id) === id || String(r.customId) === id
            );

            if (!risk) return;

            document.getElementById('confirmDeleteText').textContent =
                `Are you sure you want to delete the risk "${risk.name}"? This action cannot be undone.`;

            document.getElementById('confirmDeleteBtn').onclick = function () {
                deleteRisk(risk._id || risk.id);
            };

            closeEditRiskModal();
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }


        function deleteRisk(id) {
            // Send delete request to Wix
            window.parent.postMessage({ action: 'deleteRisk', payload: { _id: id } }, '*');

            closeConfirmDeleteModal();
        }


        // Close confirm delete modal
        function closeConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
        }



        // Open asset details modal
        function openAssetModal(assetData) {
            let asset;

            if (typeof assetData === 'number') {
                // If an ID was passed
                asset = assets.find(a => a.id === assetData);
            } else {
                // If an asset object was passed
                asset = assetData;
            }

            if (!asset) return;

            // Find related risks
            const relatedRisks = risks.filter(risk => asset.risks?.includes(risk.id));

            // Fill in modal fields
            document.getElementById('assetDetailsTitle').textContent = asset.name;
            document.getElementById('assetDetailsBadge').textContent = `${asset.criticality} Criticality`;
            document.getElementById('assetDetailsBadge').className = `ml-3 px-2 py-1 text-xs rounded-full ${getCriticalityBadgeClass(asset.criticality)}`;
            document.getElementById('assetDetailsDescription').textContent = asset.description || 'No description provided.';
            document.getElementById('assetDetailsPurpose').textContent = asset.purpose || 'No purpose specified.';

            // Populate risks list
            const risksList = document.getElementById('assetDetailsRisks');
            risksList.innerHTML = '';

            if (relatedRisks.length === 0) {
                risksList.innerHTML = '<li class="text-gray-500">No risks associated with this asset.</li>';
            } else {
                relatedRisks.forEach(risk => {
                    const item = document.createElement('li');
                    item.textContent = risk.name;
                    risksList.appendChild(item);
                });
            }

            document.getElementById('assetDetailsType').textContent = asset.type;
            document.getElementById('assetDetailsOwner').textContent = asset.owner;
            document.getElementById('assetDetailsLocation').textContent = asset.location;
            document.getElementById('assetDetailsReview').textContent = asset.lastReview || 'Not reviewed';
            document.getElementById('assetDetailsStatus').textContent = asset.status;
            document.getElementById('assetDetailsStatus').className = `px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(asset.status)}`;
            document.getElementById('assetDetailsClassification').textContent = asset.classification;
            document.getElementById('assetDetailsClassification').className = `px-2 py-1 text-xs rounded-full ${getClassificationBadgeClass(asset.classification)}`;

            // Handle edit button visibility based on source
            const editAssetBtn = document.getElementById('editAssetBtn');
            if (editAssetBtn) {
                editAssetBtn.setAttribute('data-asset-id', asset._id || asset.id || asset.customId);

                // Hide edit button if this is an admin item
                if (asset.source === 'admin') {
                    editAssetBtn.style.display = 'none';
                } else {
                    editAssetBtn.style.display = 'inline-block';
                }
            }

            // Show the modal
            document.getElementById('assetDetailsModal').style.display = 'block';
        }

        // Close asset details modal
        function closeAssetModal() {
            document.getElementById('assetDetailsModal').style.display = 'none';
        }

        // Open add asset modal
        function openAddAssetModal() {
            console.log("assets addedd")
            // Reset form
            document.getElementById('addAssetForm').reset();

            // Populate risks checkboxes
            populateRisksCheckboxes('newAssetRisksContainer', []);

            // Show modal
            document.getElementById('addAssetModal').style.display = 'block';
        }

        // Close add asset modal
        function closeAddAssetModal() {
            document.getElementById('addAssetModal').style.display = 'none';
        }

        // Open edit asset modal
        function openEditAssetModal() {
            const editBtn = document.getElementById('editAssetBtn');
            if (!editBtn) return console.warn('#editAssetBtn not found');

            const assetId = editBtn.getAttribute('data-asset-id'); // string UUID
            if (!assetId) return console.warn('No data-asset-id on #editAssetBtn');
            console.log(assets, "assets")
            const asset = assets.find(a =>
                String(a._id) === assetId ||
                String(a.id) === assetId ||
                String(a.customId) === assetId
            );

            if (!asset) {
                console.warn(`Asset with ID ${assetId} not found`);
                return;
            }

            document.getElementById('editAssetId').value = asset._id || asset.id;
            document.getElementById('editAssetName').value = asset.name;
            document.getElementById('editAssetType').value = asset.type;
            document.getElementById('editAssetOwner').value = asset.owner || '';
            document.getElementById('editAssetLocation').value = asset.location || '';
            document.getElementById('editAssetCriticality').value = asset.criticality;
            document.getElementById('editAssetStatus').value = asset.status;
            document.getElementById('editAssetClassification').value = asset.classification;
            document.getElementById('editAssetCost').value = asset.cost || '';
            document.getElementById('editAssetDescription').value = asset.description || '';
            document.getElementById('editAssetPurpose').value = asset.purpose || '';

            populateRisksCheckboxes('editAssetRisksContainer', asset.risks || []);

            closeAssetModal();
            document.getElementById('editAssetModal').style.display = 'block';
        }



        // Close edit asset modal
        function closeEditAssetModal() {
            document.getElementById('editAssetModal').style.display = 'none';
        }

        // Close confirm delete modal
        function closeConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
        }

        // Populate risks checkboxes for asset forms
        function populateRisksCheckboxes(containerId, selectedRiskIds) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (risks.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No risks available.</p>';
                return;
            }

            risks.forEach(risk => {
                const isChecked = selectedRiskIds.includes(risk.id);
                const checkboxId = `${containerId}_risk_${risk.id}`;

                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                checkboxDiv.innerHTML = `
                    <input
                        type="checkbox"
                        id="${checkboxId}"
                        value="${risk.id}"
                        class="h-4 w-4 text-indigo-600 border-gray-300 rounded"
                        ${isChecked ? 'checked' : ''}
                    />
                    <label for="${checkboxId}" class="ml-2 text-sm text-gray-700">
                        ${risk.name} <span class="text-xs text-gray-500">(${risk.level} Risk)</span>
                    </label>
                `;

                container.appendChild(checkboxDiv);
            });
        }

        // Handle save asset form submission
        function handleSaveAsset(event) {
            event.preventDefault();

            const name = document.getElementById('newAssetName').value;
            const type = document.getElementById('newAssetType').value;
            const owner = document.getElementById('newAssetOwner').value;
            const location = document.getElementById('newAssetLocation').value;
            const criticality = document.getElementById('newAssetCriticality').value;
            const status = document.getElementById('newAssetStatus').value;
            const classification = document.getElementById('newAssetClassification').value;
            const cost = parseFloat(document.getElementById('newAssetCost').value) || 0;
            const description = document.getElementById('newAssetDescription').value;
            const purpose = document.getElementById('newAssetPurpose').value;

            const selectedRisks = Array.from(
                document.querySelectorAll('#newAssetRisksContainer input[type="checkbox"]:checked')
            ).map(cb => cb.value); // string IDs

            const lastReview = new Date().toISOString().split('T')[0];

            const newAsset = {
                name, type, owner, location, criticality, status, classification, cost,
                description, purpose, risks: selectedRisks, lastReview
            };

            window.parent.postMessage({ action: 'addAsset', payload: newAsset }, '*');

            closeAddAssetModal();
        }


        function handleUpdateAsset(event) {
            event.preventDefault();

            const id = document.getElementById('editAssetId').value;

            const name = document.getElementById('editAssetName').value;
            const type = document.getElementById('editAssetType').value;
            const owner = document.getElementById('editAssetOwner').value;
            const location = document.getElementById('editAssetLocation').value;
            const criticality = document.getElementById('editAssetCriticality').value;
            const status = document.getElementById('editAssetStatus').value;
            const classification = document.getElementById('editAssetClassification').value;
            const cost = parseFloat(document.getElementById('editAssetCost').value) || 0;
            const description = document.getElementById('editAssetDescription').value;
            const purpose = document.getElementById('editAssetPurpose').value;
            const lastReview = new Date().toISOString().split('T')[0];
            const selectedRisks = Array.from(
                document.querySelectorAll('#editAssetRisksContainer input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            const updatedAsset = {
                _id: id,
                name, type, owner, location, criticality, status, classification, cost,
                description, purpose, risks: selectedRisks, lastReview
            };

            window.parent.postMessage({ action: 'updateAsset', payload: updatedAsset }, '*');

            closeEditAssetModal();
        }


        function confirmDeleteAsset() {
            console.log("delete button")
            const id = document.getElementById('editAssetId').value;
            console.log(id, "id")
            const asset = assets.find(a => a._id === id || a.id === id);

            if (!asset) return;

            document.getElementById('confirmDeleteText').textContent =
                `Are you sure you want to delete the asset "${asset.name}"? This action cannot be undone.`;
            console.log(asset, "asset details")

            document.getElementById('confirmDeleteBtn').onclick = function () {
                deleteAsset(asset.id)
            };

            closeEditAssetModal();
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }

        function deleteAsset(id) {
            window.parent.postMessage({ action: 'deleteAsset', payload: { _id: id } }, '*')
            closeConfirmDeleteModal();
        }


        // Open framework details modal
        window.openFrameworkModal = function(frameworkData) {
            let framework;

            if (typeof frameworkData === 'number' || typeof frameworkData === 'string') {
                // If an ID was passed, search in both user and admin frameworks
                framework = frameworks.find(f => f.id === frameworkData || f._id === frameworkData);
            } else {
                // If a framework object was passed
                framework = frameworkData;
            }

            if (!framework) {
                console.warn('Framework not found:', frameworkData);
                return;
            }

            // Fill in modal fields
            document.getElementById('frameworkDetailsTitle').textContent = framework.name;
            document.getElementById('frameworkDetailsStatus').textContent = framework.status;
            document.getElementById('frameworkDetailsStatus').className = `ml-3 px-2 py-1 text-xs rounded-full ${framework.status === 'Active' ? 'badge-active' : 'badge-low'}`;

            // Calculate controls count properly
            const controlsCount = Array.isArray(framework.controls) ? framework.controls.length : (framework.controls || 0);
            document.getElementById('frameworkDetailsControls').textContent = controlsCount;

            document.getElementById('frameworkDetailsCompliance').textContent = `${framework.compliance}%`;
            document.getElementById('frameworkDetailsLastAssessment').textContent = framework.lastAssessment;
            document.getElementById('frameworkDetailsDescription').textContent = framework.description;

            // Set readiness status
            const readinessCard = document.getElementById('frameworkReadinessCard');
            const readinessText = document.getElementById('frameworkDetailsReadiness');
            const toggleBtn = document.getElementById('toggleReadinessBtn');

            if (framework.readiness === 'ready') {
                readinessCard.className = 'bg-green-50 p-4 rounded-lg';
                readinessText.textContent = 'Ready';
                readinessText.className = 'text-xl font-bold text-green-700';
                toggleBtn.textContent = 'Mark as Not Ready';
                toggleBtn.className = 'text-sm px-3 py-1 rounded bg-green-200 hover:bg-green-300 text-green-800';
            } else {
                readinessCard.className = 'bg-yellow-50 p-4 rounded-lg';
                readinessText.textContent = 'Not Ready';
                readinessText.className = 'text-xl font-bold text-yellow-700';
                toggleBtn.textContent = 'Mark as Ready';
                toggleBtn.className = 'text-sm px-3 py-1 rounded bg-yellow-200 hover:bg-yellow-300 text-yellow-800';
            }

            // Handle edit button visibility based on source
            const editFrameworkBtn = document.getElementById('editFrameworkBtn');
            const uploadDocumentBtn = document.getElementById('uploadDocumentBtn');
            const addCommentBtn = document.getElementById('addCommentBtn');

            if (editFrameworkBtn) {
                editFrameworkBtn.setAttribute('data-framework-id', framework._id || framework.id || framework.customId);

                // Hide edit button if this is an admin item
                if (framework.source === 'admin') {
                    editFrameworkBtn.style.display = 'none';
                } else {
                    editFrameworkBtn.style.display = 'inline-block';
                }
            }

            // Show upload and comment buttons for user-created frameworks
            if (uploadDocumentBtn) {
                uploadDocumentBtn.setAttribute('data-framework-id', framework._id || framework.id || framework.customId);
                if (framework.source === 'admin') {
                    uploadDocumentBtn.style.display = 'none';
                } else {
                    uploadDocumentBtn.style.display = 'inline-block';
                }
            }

            if (addCommentBtn) {
                addCommentBtn.setAttribute('data-framework-id', framework._id || framework.id || framework.customId);
                if (framework.source === 'admin') {
                    addCommentBtn.style.display = 'none';
                } else {
                    addCommentBtn.style.display = 'inline-block';
                }
            }

            // Store framework ID on toggle button (readiness can be changed by anyone)
            toggleBtn.setAttribute('data-framework-id', framework._id || framework.id || framework.customId);

            // Populate domains
            const domainsContainer = document.getElementById('frameworkDetailsDomains');
            domainsContainer.innerHTML = '';

            // Check if domains exist and is an array
            if (framework.domains && Array.isArray(framework.domains) && framework.domains.length > 0) {
                framework.domains.forEach(domain => {
                    const domainElement = document.createElement('div');
                    domainElement.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <span class="text-sm">${domain.name || 'Unknown Domain'}</span>
                            <span class="text-sm">${domain.compliance || 0}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${domain.compliance || 0}%"></div>
                        </div>
                    `;

                    domainsContainer.appendChild(domainElement);
                });
            } else {
                // Show placeholder when no domains are available
                domainsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p class="text-sm">No domains configured for this framework</p>
                    </div>
                `;
            }

            // Populate controls
            const controlsContainer = document.getElementById('frameworkDetailsControlsList');
            controlsContainer.innerHTML = '';

            // Check if controls exist and is an array
            if (framework.controls && Array.isArray(framework.controls) && framework.controls.length > 0) {
                let controlsHtml = '';

                framework.controls.forEach((control, index) => {
                    // Get control status color
                    let statusColor = 'bg-gray-100 text-gray-800';
                    if (control.status === 'Implemented') {
                        statusColor = 'bg-green-100 text-green-800';
                    } else if (control.status === 'Planned') {
                        statusColor = 'bg-blue-100 text-blue-800';
                    } else if (control.status === 'In Progress') {
                        statusColor = 'bg-yellow-100 text-yellow-800';
                    } else if (control.status === 'Not Started') {
                        statusColor = 'bg-red-100 text-red-800';
                    }

                    controlsHtml += `
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 hover:border-indigo-300 transition">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-900">${control.name || 'Unnamed Control'}</h5>
                                    <p class="text-sm text-gray-600 mt-1">${control.description || 'No description'}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded ${statusColor}">
                                    ${control.status || 'Unknown'}
                                </span>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs text-gray-600">
                                ${control.type ? `<span class="px-2 py-1 bg-white rounded border border-gray-200"><i class="fas fa-tag mr-1"></i>${control.type}</span>` : ''}
                                ${control.owner ? `<span class="px-2 py-1 bg-white rounded border border-gray-200"><i class="fas fa-user mr-1"></i>${control.owner}</span>` : ''}
                                ${control.reviewFrequency ? `<span class="px-2 py-1 bg-white rounded border border-gray-200"><i class="fas fa-calendar mr-1"></i>${control.reviewFrequency}</span>` : ''}
                            </div>
                        </div>
                    `;
                });

                controlsContainer.innerHTML = controlsHtml;
            } else {
                // Show placeholder when no controls are available
                controlsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-shield-alt text-2xl mb-2"></i>
                        <p class="text-sm">No controls added to this framework</p>
                    </div>
                `;
            }

            // Populate documents
            const documentsContainer = document.getElementById('frameworkDetailsDocuments');
            documentsContainer.innerHTML = '';

            // Check if documents exist and is an array
            if (framework.documents && Array.isArray(framework.documents) && framework.documents.length > 0) {
                let documentsHtml = '';

                framework.documents.forEach(document => {
                    // Get file icon based on type
                    let fileIcon = 'fas fa-file';
                    if (document.type && document.type.includes('pdf')) {
                        fileIcon = 'fas fa-file-pdf text-red-500';
                    } else if (document.type && (document.type.includes('doc') || document.type.includes('word'))) {
                        fileIcon = 'fas fa-file-word text-blue-500';
                    } else if (document.type && (document.type.includes('xls') || document.type.includes('excel'))) {
                        fileIcon = 'fas fa-file-excel text-green-500';
                    } else if (document.type && document.type.includes('image')) {
                        fileIcon = 'fas fa-file-image text-purple-500';
                    }

                    documentsHtml += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center space-x-3">
                                <i class="${fileIcon}"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">${document.name}</p>
                                    <p class="text-xs text-gray-500">
                                        ${document.size ? window.formatFileSize(document.size) : 'Unknown size'} â€¢
                                        ${document.uploadDate ? window.formatDate(document.uploadDate) : 'Unknown date'}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button
                                    onclick="window.viewDocument('${document.url}', '${document.name}', '${document.type}')"
                                    class="text-indigo-600 hover:text-indigo-900 text-sm font-medium"
                                    title="View document"
                                >
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                            </div>
                        </div>
                    `;
                });

                documentsContainer.innerHTML = documentsHtml;
            } else {
                // Show placeholder when no documents are available
                documentsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-file-upload text-2xl mb-2"></i>
                        <p class="text-sm">No documents uploaded for this framework</p>
                    </div>
                `;
            }

            // Populate comments using the new function
            populateFrameworkComments(framework);

            // Populate activities
            const activitiesContainer = document.getElementById('frameworkDetailsActivities');
            activitiesContainer.innerHTML = '';

            // Check if activities exist and is an array
            if (framework.activities && Array.isArray(framework.activities) && framework.activities.length > 0) {
                let activitiesHtml = '';

                framework.activities.forEach(activity => {
                    activitiesHtml += `
                        <div class="flex items-start">
                            <div class="min-w-[80px] text-xs text-gray-500">${activity.date || 'Unknown'}</div>
                            <div>
                                <p class="text-sm">${activity.action || 'No action specified'}</p>
                                <p class="text-xs text-gray-500">${activity.user || 'Unknown user'}</p>
                            </div>
                        </div>
                    `;
                });

                activitiesContainer.innerHTML = activitiesHtml;
            } else {
                // Show placeholder when no activities are available
                activitiesContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p class="text-sm">No recent activities</p>
                    </div>
                `;
            }

            // Show the modal
            document.getElementById('frameworkDetailsModal').style.display = 'block';
        };

        // Close framework details modal
        function closeFrameworkModal() {
            document.getElementById('frameworkDetailsModal').style.display = 'none';
        }

        // Open document upload modal
        function openDocumentUploadModal() {
            const frameworkId = document.getElementById('uploadDocumentBtn')?.getAttribute('data-framework-id');
            if (!frameworkId) {
                showCustomAlert('Error: No framework selected for document upload.');
                return;
            }

            // Use a simple file input dialog
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.txt,.png,.jpg,.jpeg';

            fileInput.onchange = function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    console.log(`ðŸ“ Selected ${files.length} file(s) for upload`);
                    handleDocumentUpload(files, frameworkId);
                }
            };

            fileInput.click();
        }

        // Handle document upload
        function handleDocumentUpload(files, frameworkId) {
            console.log('ðŸ“¤ Starting document upload for framework:', frameworkId);
            console.log('ðŸ“ Files to upload:', files.length);

            // Find the framework
            const framework = frameworks.find(f => String(f._id) === frameworkId || String(f.id) === frameworkId);
            if (!framework) {
                showCustomAlert('Error: Framework not found.');
                return;
            }

            // Convert files to base64
            const filePromises = Array.from(files).map(file => convertFileToBase64(file));

            Promise.all(filePromises).then(fileDataArray => {
                console.log('âœ… Files converted to base64:', fileDataArray.length);

                // Send files to Wix backend for upload
                const fileUploadData = {
                    frameworkId: framework._id || frameworkId,
                    files: fileDataArray
                };

                const updatedFrameworkData = {
                    ...framework,
                    _id: framework._id || frameworkId,
                    name: framework.name,
                    description: framework.description,
                    controls: framework.controls || [],
                    compliance: framework.compliance,
                    status: framework.status,
                    readiness: framework.readiness,
                    domains: framework.domains || [],
                    frameworkControls: framework.frameworkControls || [],
                    controlsData: framework.controlsData || [],
                    comments: framework.comments || [], // Preserve comments
                    activities: [
                        { date: new Date().toISOString().split('T')[0], action: `${fileDataArray.length} document(s) uploaded`, user: 'Admin User' },
                        ...(framework.activities || [])
                    ]
                };

                console.log('ðŸ“‹ Sending upload request with', fileDataArray.length, 'files');
                console.log('ðŸ’¾ Preserving comments:', updatedFrameworkData.comments.length);

                // Send upload request to Wix backend
                window.parent.postMessage({
                    action: 'uploadFrameworkFiles',
                    payload: fileUploadData,
                    frameworkData: updatedFrameworkData
                }, '*');

                showCustomAlert(`âœ… Uploading ${fileDataArray.length} document(s)...`);

                // Close the framework details modal after upload
                setTimeout(() => {
                    closeFrameworkModal();
                }, 1000);

            }).catch(error => {
                console.error('âŒ Error processing files:', error);
                showCustomAlert('Error processing files. Please try again.');
            });
        }

        // Open add comment modal
        function openAddCommentModal() {
            const frameworkId = document.getElementById('addCommentBtn')?.getAttribute('data-framework-id');
            if (!frameworkId) {
                showCustomAlert('Error: No framework selected for comment.');
                return;
            }

            // Store the framework ID for use in the save function
            window.currentCommentFrameworkId = frameworkId;

            // Clear the form
            document.getElementById('addCommentForm').reset();

            // Show the modal
            document.getElementById('addCommentModal').style.display = 'block';
        }

        // Close add comment modal
        function closeAddCommentModal() {
            document.getElementById('addCommentModal').style.display = 'none';
            document.getElementById('addCommentForm').reset();
            window.currentCommentFrameworkId = null;
        }

        // Handle save comment
        function handleSaveComment(event) {
            event.preventDefault();

            const frameworkId = window.currentCommentFrameworkId;
            const commentText = document.getElementById('commentText').value.trim();

            if (!frameworkId) {
                showCustomAlert('Error: No framework selected.');
                return;
            }

            if (!commentText) {
                showCustomAlert('Please enter a comment.');
                return;
            }

            // Find the framework
            const framework = frameworks.find(f => f._id === frameworkId || f.id === frameworkId || f.customId === frameworkId);
            if (!framework) {
                showCustomAlert('Error: Framework not found.');
                return;
            }

            // Create comment object
            const newComment = {
                id: Date.now().toString(),
                author: 'Current User', // Will be replaced with actual user name from backend
                text: commentText,
                date: new Date().toISOString(),
                frameworkId: frameworkId
            };

            console.log('ðŸ’¬ Adding comment:', newComment);

            // Initialize comments array if it doesn't exist
            if (!framework.comments) {
                framework.comments = [];
            }

            // Add comment to framework
            framework.comments.push(newComment);

            // Send to backend
            window.parent.postMessage({
                action: 'addComment',
                payload: {
                    frameworkId: frameworkId,
                    comment: newComment
                }
            }, '*');

            console.log('ðŸ“¤ Comment sent to backend');

            // Update the display
            populateFrameworkComments(framework);

            // Close modal and show success message
            closeAddCommentModal();
            showCustomAlert('Comment added successfully!');
        }

        // Populate comments in framework details
        function populateFrameworkComments(framework) {
            const commentsContainer = document.getElementById('frameworkDetailsComments');
            if (!commentsContainer) return;

            commentsContainer.innerHTML = '';

            // Check if comments exist and is an array
            if (framework.comments && Array.isArray(framework.comments) && framework.comments.length > 0) {
                let commentsHtml = '';

                framework.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="text-sm font-medium text-gray-900">${comment.author || 'Anonymous'}</span>
                                    <span class="text-xs text-gray-500 ml-2">
                                        <i class="fas fa-clock mr-1"></i>${comment.date ? window.formatDate(comment.date) : 'Unknown date'}
                                    </span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 leading-relaxed">${comment.text || 'No comment text'}</p>
                        </div>
                    `;
                });

                commentsContainer.innerHTML = commentsHtml;
            } else {
                // Show placeholder when no comments are available
                commentsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        <i class="fas fa-comments text-3xl mb-2 opacity-50"></i>
                        <p class="text-sm">No comments yet. Be the first to comment!</p>
                    </div>
                `;
            }
        }

        // Open DPIA details modal
        function openDpiaModal(dpiaData) {
            let dpia;

            if (typeof dpiaData === 'number') {
                // If an ID was passed
                dpia = dpias.find(d => d.id === dpiaData);
            } else {
                // If a DPIA object was passed
                dpia = dpiaData;
            }

            if (!dpia) return;

            // Fill in modal fields
            document.getElementById('dpiaDetailsTitle').textContent = dpia.name;
            document.getElementById('dpiaDetailsStatus').textContent = dpia.status;
            document.getElementById('dpiaDetailsStatus').className = `ml-3 px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(dpia.status)}`;
            document.getElementById('dpiaDetailsActivity').textContent = dpia.activity;
            document.getElementById('dpiaDetailsDataCategories').textContent = dpia.dataCategories;
            document.getElementById('dpiaDetailsRiskAssessment').textContent = dpia.riskAssessment;
            document.getElementById('dpiaDetailsDepartment').textContent = dpia.department;
            document.getElementById('dpiaDetailsDate').textContent = dpia.date;
            document.getElementById('dpiaDetailsRiskLevel').textContent = dpia.risk;
            document.getElementById('dpiaDetailsRiskLevel').className = `px-2 py-1 text-xs rounded-full ${getLevelBadgeClass(dpia.risk)}`;
            document.getElementById('dpiaDetailsReviewer').textContent = dpia.reviewer || 'Not assigned';
            document.getElementById('dpiaDetailsProgress').style.width = `${dpia.progress}%`;
            document.getElementById('dpiaDetailsProgressText').textContent = `${dpia.progress}%`;

            // Handle edit button visibility based on source
            const editDpiaBtn = document.getElementById('editDpiaBtn');
            if (editDpiaBtn) {
                // Hide edit button if this is an admin item
                if (dpia.source === 'admin') {
                    editDpiaBtn.style.display = 'none';
                } else {
                    editDpiaBtn.style.display = 'inline-block';
                }
            }

            // Show the modal
            document.getElementById('dpiaDetailsModal').style.display = 'block';
        }

        // Close DPIA details modal
        function closeDpiaModal() {
            document.getElementById('dpiaDetailsModal').style.display = 'none';
        }

        // Open Add DPIA modal
        function openAddDpiaModal() {
            // Set default date to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('newDpiaDate').value = formattedDate;

            // Show the modal
            document.getElementById('addDpiaModal').style.display = 'block';
        }

        // Close Add DPIA modal
        function closeAddDpiaModal() {
            document.getElementById('addDpiaModal').style.display = 'none';
            document.getElementById('addDpiaForm').reset();
        }

        // Handle save DPIA
        function handleSaveDpia(e) {
            e.preventDefault();

            // Get form values
            const name = document.getElementById('newDpiaName').value;
            const department = document.getElementById('newDpiaDepartment').value;
            const status = document.getElementById('newDpiaStatus').value;
            const date = document.getElementById('newDpiaDate').value;
            const risk = document.getElementById('newDpiaRisk').value;
            const reviewer = document.getElementById('newDpiaReviewer').value;
            const progress = parseInt(document.getElementById('newDpiaProgress').value);
            const activity = document.getElementById('newDpiaActivity').value;
            const dataCategories = document.getElementById('newDpiaDataCategories').value;
            const riskAssessment = document.getElementById('newDpiaRiskAssessment').value;

            // Create new DPIA object
            const newDpia = {
                id: dpias.length > 0 ? Math.max(...dpias.map(d => d.id)) + 1 : 1,
                name,
                department,
                status,
                date,
                risk,
                reviewer,
                progress,
                activity,
                dataCategories,
                riskAssessment
            };
            // Send to backend (Wix page code)
            window.parent.postMessage({ action: 'addDpia', payload: newDpia }, '*');

            // // Add to dpias array
            // dpias.push(newDpia);

            // Update UI
            renderDPIAsTable(dpias);

            // Close modal
            closeAddDpiaModal();

            // Show success message
            alert('DPIA added successfully!');
        }

        // Open Edit DPIA modal
        function openEditDpiaModal() {
            const dpiaTitle = document.getElementById('dpiaDetailsTitle').textContent.trim();

            // Find the DPIA by name (safer to use id or customId if available)
            const dpia = dpias.find(d => d.name === dpiaTitle);

            if (!dpia) {
                console.warn(`No DPIA found with name "${dpiaTitle}"`);
                return;
            }

            // Fill the form fields
            document.getElementById('editDpiaId').value = dpia._id || dpia.id || '';
            document.getElementById('editDpiaName').value = dpia.name;
            document.getElementById('editDpiaDepartment').value = dpia.department;
            document.getElementById('editDpiaStatus').value = dpia.status;
            document.getElementById('editDpiaDate').value = dpia.date;
            document.getElementById('editDpiaRisk').value = dpia.risk;
            document.getElementById('editDpiaReviewer').value = dpia.reviewer || '';
            document.getElementById('editDpiaProgress').value = dpia.progress;
            document.getElementById('editDpiaActivity').value = dpia.activity;
            document.getElementById('editDpiaDataCategories').value = dpia.dataCategories;
            document.getElementById('editDpiaRiskAssessment').value = dpia.riskAssessment;

            // Swap modals
            closeDpiaModal();
            document.getElementById('editDpiaModal').style.display = 'block';
        }


        // Close Edit DPIA modal
        function closeEditDpiaModal() {
            document.getElementById('editDpiaModal').style.display = 'none';
        }

        // Handle update DPIA
        document.getElementById('editDpiaForm').addEventListener('submit', handleUpdateDpia);

        function handleUpdateDpia(e) {
            e.preventDefault();

            const id = document.getElementById('editDpiaId').value; // don't parseInt

            const updatedDpia = {
                _id: id,
                name: document.getElementById('editDpiaName').value,
                department: document.getElementById('editDpiaDepartment').value,
                status: document.getElementById('editDpiaStatus').value,
                date: document.getElementById('editDpiaDate').value,
                risk: document.getElementById('editDpiaRisk').value,
                reviewer: document.getElementById('editDpiaReviewer').value,
                progress: parseInt(document.getElementById('editDpiaProgress').value),
                activity: document.getElementById('editDpiaActivity').value,
                dataCategories: document.getElementById('editDpiaDataCategories').value,
                riskAssessment: document.getElementById('editDpiaRiskAssessment').value
            };

            window.parent.postMessage({ action: 'updateDpia', payload: updatedDpia }, '*');

            closeEditDpiaModal();
        }


        // Confirm delete DPIA
        function confirmDeleteDpia() {
            const id = document.getElementById('editDpiaId').value;
            const dpia = dpias.find(d => d.id === id || d._id === id);

            if (!dpia) return;

            // Set confirmation message
            document.getElementById('confirmDeleteText').textContent =
                `Are you sure you want to delete the DPIA "${dpia.name}"? This action cannot be undone.`;

            // Set delete action
            document.getElementById('confirmDeleteBtn').onclick = function () {
                deleteDpia(dpia._id || dpia.id);
            };

            // Hide edit modal and show confirmation
            closeEditDpiaModal();
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }


        // Delete DPIA
        function deleteDpia(id) {
            if (!id) return;

            window.parent.postMessage({
                action: 'deleteDpia',
                payload: { _id: id }
            }, '*');

            // Update UI
            renderDPIAsTable(dpias);

            // Close edit modal
            closeEditDpiaModal();

            // Show success message
            alert('DPIA deleted successfully!');
            // ðŸ§¼ Close confirm modal AFTER slight delay (simulate backend confirmation)
            setTimeout(() => {
                closeConfirmDeleteModal();
                // Optionally show toast or reload here
                // showToast("DPIA deleted successfully.");
            }, 500); // adjust delay if needed

        }

        // Open assessment details modal
        // Open assessment details modal
        function openAssessmentModal(assessmentData) {
            let assessment;

            if (typeof assessmentData === 'number') {
                // If an ID was passed
                assessment = assessments.find(a => a.id === assessmentData);
            } else if (typeof assessmentData === 'string') {
                // If a string ID was passed, try to find by id or _id
                assessment = assessments.find(a => a.id === assessmentData || a._id === assessmentData);
            } else {
                // If an assessment object was passed
                assessment = assessmentData;
            }

            if (!assessment) {
                console.error('Assessment not found:', assessmentData);
                return;
            }

            // Handle different data structures (database vs hardcoded)
            const assessmentName = assessment.name || assessment.title || 'Unnamed Assessment';
            const assessmentType = assessment.type || 'Unknown';
            const assessmentStatus = assessment.userStatus || 'Unknown';
            const assessmentDescription = assessment.description || 'No description provided.';
            const assessmentCompletion = assessment.userProgress || '0%';
            const assessmentQuestions = assessment.questions.length;

            // Calculate completed questions based on progress percentage
            const progressPercentage = parseInt(assessment.userProgress) || 0;
            const assessmentCompleted = Math.round((progressPercentage / 100) * assessmentQuestions);
            const assessmentPending = assessmentQuestions - assessmentCompleted;
            const assessmentIssues = assessment.issues || 0;
            const assessmentDueDate = assessment.dueDate || assessment.date || 'Not set';
            const assessmentAssignee = assessment.assignee || (assessment.assignedUsers && assessment.assignedUsers.length > 0 ? assessment.assignedUsers[0] : 'Not assigned');
            const assessmentFramework = assessment.framework || 'Custom';

            // Fill in modal fields
            document.getElementById('assessmentDetailsTitle').textContent = assessmentName;
            document.getElementById('assessmentDetailsStatus').textContent = assessmentStatus;
            document.getElementById('assessmentDetailsStatus').className = `ml-3 px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(assessmentStatus)}`;
            document.getElementById('assessmentDetailsDescription').textContent = assessmentDescription;
            document.getElementById('assessmentDetailsCompletion').textContent = assessmentCompletion;
            document.getElementById('assessmentDetailsProgressBar').style.width = assessmentCompletion;
            document.getElementById('assessmentDetailsTotalQuestions').textContent = assessmentQuestions;
            document.getElementById('assessmentDetailsCompleted').textContent = assessmentCompleted;
            document.getElementById('assessmentDetailsPending').textContent = assessmentPending;
            document.getElementById('assessmentDetailsIssues').textContent = assessmentIssues;
            document.getElementById('assessmentDetailsType').textContent = assessmentType;
            document.getElementById('assessmentDetailsDueDate').textContent = assessmentDueDate;
            document.getElementById('assessmentDetailsAssignee').textContent = assessmentAssignee;
            document.getElementById('assessmentDetailsFramework').textContent = assessmentFramework;

            // Populate activities
            const activitiesContainer = document.getElementById('assessmentDetailsActivities');
            activitiesContainer.innerHTML = '';

            const activities = assessment.activities || [];
            if (activities.length === 0) {
                activitiesContainer.innerHTML = '<p class="text-sm text-gray-500">No recent activities</p>';
            } else {
                activities.forEach(activity => {
                    const activityElement = document.createElement('div');
                    activityElement.className = 'flex items-start';
                    activityElement.innerHTML = `
                        <div class="min-w-[80px] text-xs text-gray-500">${activity.date}</div>
                        <div>
                            <p class="text-sm">${activity.action}</p>
                            <p class="text-xs text-gray-500">${activity.user}</p>
                        </div>
                    `;

                    activitiesContainer.appendChild(activityElement);
                });
            }

            // Show/hide View Results button based on assessment status
            const viewResultsBtn = document.getElementById('viewResultsBtn');
            if (assessmentStatus === 'Completed' || assessmentStatus === 'completed') {
                viewResultsBtn.classList.remove('hidden');
            } else {
                viewResultsBtn.classList.add('hidden');
            }

            // Show the modal
            document.getElementById('assessmentDetailsModal').style.display = 'block';
        }

        // Close assessment details modal
        function closeAssessmentModal() {
            document.getElementById('assessmentDetailsModal').style.display = 'none';
        }

        // Start assessment
        function startAssessment(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            // Populate the start assessment modal
            document.getElementById('startAssessmentName').textContent = assessment.name;
            document.getElementById('startAssessmentDescription').textContent = assessment.description || 'No description provided.';
            document.getElementById('startAssessmentFramework').textContent = assessment.framework || 'Custom';
            document.getElementById('startAssessmentQuestions').textContent = assessment.questions;
            document.getElementById('startAssessmentDueDate').textContent = assessment.dueDate;
            document.getElementById('startAssessmentAssignee').textContent = assessment.assignee || 'Not assigned';

            // Set up the confirm button
            document.getElementById('confirmStartAssessmentBtn').onclick = function () {
                confirmStartAssessment(assessmentId);
            };

            // Show the modal
            document.getElementById('startAssessmentModal').style.display = 'block';
        }

        // Close start assessment modal
        function closeStartAssessmentModal() {
            document.getElementById('startAssessmentModal').style.display = 'none';
        }

        // Confirm start assessment
        function confirmStartAssessment(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            // Update assessment status
            assessment.status = 'In Progress';
            assessment.completion = '0%';
            assessment.completed = 0;
            assessment.pending = assessment.questions;

            // Add activity
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            assessment.activities.unshift({
                date: formattedDate,
                action: 'Assessment started',
                user: assessment.assignee || 'User'
            });

            // Update UI
            renderAssessmentsTable(assessments);

            // Close modal
            closeStartAssessmentModal();

            // Show success message
            alert('Assessment started successfully! You can now proceed with answering the questions.');

            // Open the assessment modal to show details
            openAssessmentModal(assessmentId);
        }

        // View assessment
          function viewAssessment() {
            try {
                console.log('ðŸŽ¯ Starting viewAssessment function');

                // Reset the assessment started flag
                window.assessmentStarted = false;

                // Get the current assessment ID from the details modal
                const titleElement = document.getElementById('assessmentDetailsTitle');
                if (!titleElement) {
                    console.error('âŒ assessmentDetailsTitle element not found');
                    showNotification('Assessment title element not found. Please refresh the page.', 'error');
                    return;
                }

                const assessmentTitle = titleElement.textContent;
                console.log('ðŸ” Looking for assessment with title:', assessmentTitle);
                console.log('ðŸ“‹ Available assessments:', assessments);

                if (!assessments || assessments.length === 0) {
                    console.error('âŒ No assessments available');
                    showNotification('No assessments available. Please refresh the page.', 'error');
                    return;
                }

                const assessment = assessments.find(a => (a.name || a.title) === assessmentTitle);
                console.log('âœ… Found assessment:', assessment);

                if (!assessment) {
                    console.error('âŒ Assessment not found for title:', assessmentTitle);
                    console.log('ðŸ“‹ Available assessment titles:', assessments.map(a => a.name || a.title));
                    showNotification('Assessment not found. Please try again.', 'error');
                    return;
                }

                // Store the current assessment globally for the progress handler
                window.currentAssessment = assessment;
                console.log('ðŸ’¾ Stored current assessment globally');

                // Close the details modal
                closeAssessmentModal();

                // Check if we're in an iframe or standalone
                const isInIframe = window !== window.parent;
                console.log('ðŸ” Running in iframe:', isInIframe);

                if (isInIframe) {
                    // Request saved progress from database
                    const assessmentId = assessment._id || assessment.id;
                    console.log('ðŸ“¡ Requesting saved progress for assessment:', assessmentId);

                    window.parent.postMessage({
                        action: 'getAssessmentProgress',
                        payload: {
                            assessmentId: assessmentId
                        }
                    }, '*');

                    console.log('âœ… Progress request sent, waiting for response...');

                    // Set a timeout fallback in case parent doesn't respond
                    setTimeout(() => {
                        if (window.currentAssessment && !window.assessmentStarted) {
                            console.log('â° Timeout: No response from parent, starting fresh assessment');
                            window.assessmentStarted = true;
                            startFreshAssessment();
                        }
                    }, 2000); // 2 second timeout

                    // The response will be handled by the assessmentProgressLoaded handler
                    // which will call either resumeAssessmentFromProgress() or startFreshAssessment()
                } else {
                    // Running standalone, start assessment directly
                    console.log('ðŸ  Running standalone, starting fresh assessment directly');
                    startFreshAssessment();
                }

            } catch (error) {
                console.error('âŒ Error in viewAssessment:', error);
                showNotification('Error loading assessment: ' + error.message, 'error');
            }
        }

        // Close assessment view modal
        function closeAssessmentViewModal() {
            document.getElementById('assessmentViewModal').style.display = 'none';
        }

        // TEST FUNCTION: Force show modal for debugging
        function testShowModal() {
            console.log('ðŸ§ª TEST: Force showing modal...');
            const modal = document.getElementById('assessmentViewModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('ðŸ§ª TEST: Modal display set to block');
                console.log('ðŸ§ª TEST: Modal computed style:', window.getComputedStyle(modal).display);

                // Add some test content
                const titleElement = document.getElementById('assessmentViewTitle');
                const questionContainer = document.getElementById('assessmentQuestionContainer');

                if (titleElement) {
                    titleElement.textContent = 'TEST ASSESSMENT';
                }

                if (questionContainer) {
                    questionContainer.innerHTML = `
                        <div class="question-container mb-6 p-4 border rounded-lg" data-question-index="0">
                            <div class="mb-4">
                                <h4 class="text-lg font-medium mb-2">1. Test Question</h4>
                                <p class="text-gray-700 mb-4">This is a test question to verify the modal is working.</p>
                                <textarea class="w-full p-3 border rounded-md" rows="3" placeholder="Enter your answer..."></textarea>
                            </div>
                        </div>
                    `;
                }

                console.log('ðŸ§ª TEST: Modal should be visible with test content');
            } else {
                console.error('ðŸ§ª TEST: Modal element not found!');
            }
        }

        // Add test function to window for console access
        window.testShowModal = testShowModal;

        // Resume assessment from saved progress
        function resumeAssessmentFromProgress(progressData) {
            console.log('ðŸ”„ Resuming assessment from saved progress:', progressData);

            // Store the progress data globally for access
            window.currentAssessmentProgress = progressData;

            // Use the globally stored current assessment instead of searching
            const assessment = window.currentAssessment;

            if (!assessment) {
                console.error('âŒ Assessment not found for resuming. Available assessments:', assessments);
                console.error('âŒ Progress data:', progressData);
                showNotification('Assessment not found. Starting fresh.', 'warning');
                startFreshAssessment();
                return;
            }

            console.log('âœ… Using assessment for resume:', assessment);

            // Load the saved answers
            const savedAnswers = progressData.answers || {};
            console.log('ðŸ“ Saved answers:', savedAnswers);

            // Calculate the last answered question index
            let lastAnsweredIndex = -1;
            const questionKeys = Object.keys(savedAnswers);
            if (questionKeys.length > 0) {
                // Find the highest question index that has been answered
                lastAnsweredIndex = Math.max(...questionKeys.map(key => parseInt(key)));
            }

            // Get questions from assessment
            const assessmentQuestions = assessment.questionData || assessment.questions || assessment.questionsData || [];
            console.log('ðŸ“‹ Assessment questions found:', assessmentQuestions.length);

            if (assessmentQuestions.length === 0) {
                console.error('âŒ No questions found in assessment:', assessment);
                showNotification('No questions found in assessment. Please try again.', 'error');
                return;
            }

            // Determine where to resume (next unanswered question or last answered + 1)
            const resumeIndex = Math.min(lastAnsweredIndex + 1, assessmentQuestions.length - 1);

            console.log(`ðŸ“ Resuming at question ${resumeIndex + 1}, last answered: ${lastAnsweredIndex + 1}`);

            // Show the assessment modal and populate with saved data
            showAssessmentModalWithProgress(assessment, savedAnswers, resumeIndex);
        }

        // Start fresh assessment (no saved progress)
        function startFreshAssessment() {
            console.log('ðŸ†• Starting fresh assessment');

            try {
                // Use the globally stored current assessment
                const assessment = window.currentAssessment;

                if (!assessment) {
                    console.error('âŒ Assessment not found for starting fresh. Available assessments:', assessments);
                    showNotification('Assessment not found. Please try selecting the assessment again.', 'error');
                    return;
                }

                console.log('âœ… Starting fresh assessment:', assessment);

                // Show the assessment modal starting from question 0
                showAssessmentModalWithProgress(assessment, {}, 0);

            } catch (error) {
                console.error('âŒ Error in startFreshAssessment:', error);
                showNotification('Error starting assessment: ' + error.message, 'error');
            }
        }

        // Show assessment modal with progress data
        function showAssessmentModalWithProgress(assessment, savedAnswers, startQuestionIndex) {
            console.log('ðŸŽ¯ Showing assessment modal with progress:', {
                assessment: assessment.name || assessment.title,
                savedAnswersCount: Object.keys(savedAnswers).length,
                startIndex: startQuestionIndex
            });

            try {
                // Handle different data structures (database vs hardcoded)
                const assessmentName = assessment.name || assessment.title || 'Unnamed Assessment';
                const assessmentStatus = assessment.userStatus || 'Unknown';

                // Get questions from the assessment (try different possible properties)
                console.log('ðŸ” Full assessment object:', assessment);
                console.log('ðŸ” Assessment keys:', Object.keys(assessment));

                let assessmentQuestions = assessment.questionData || assessment.questions || assessment.questionsData || [];

                console.log('ðŸ“‹ Raw questions data:', assessmentQuestions);
                console.log('ðŸ“‹ Questions type:', typeof assessmentQuestions);
                console.log('ðŸ“‹ Is array?', Array.isArray(assessmentQuestions));

                // If no questions found in standard properties, check if we need to load them
                if (!assessmentQuestions || assessmentQuestions.length === 0) {
                    console.log('âš ï¸ No questions found in standard properties, checking assessment type...');
                    console.log('ðŸ” Assessment type:', assessment.type);
                    console.log('ðŸ” Assessment ID:', assessment._id || assessment.id);

                    // For now, let's create some sample questions to test the functionality
                    console.log('ðŸ”§ Creating sample questions for testing...');

                    assessmentQuestions = [
                        {
                            questionText: "What is the primary purpose of this assessment?",
                            answerType: "single",
                            options: ["Security Review", "Compliance Check", "Risk Assessment", "Other"],
                            required: true
                        },
                        {
                            questionText: "Please describe the scope of this assessment:",
                            answerType: "text",
                            required: true
                        },
                        {
                            questionText: "What is the risk level of this assessment?",
                            answerType: "single",
                            options: ["Low", "Medium", "High", "Critical"],
                            required: true
                        },
                        {
                            questionText: "Additional comments or observations:",
                            answerType: "text",
                            required: false
                        }
                    ];

                    console.log('âœ… Created', assessmentQuestions.length, 'sample questions');

                    // TODO: Replace this with actual question loading from database
                    // For now, this allows us to test the assessment functionality

                    // Uncomment this section when the parent window handler is ready:
                    /*
                    // Check if this is a database assessment that needs questions loaded
                    if (assessment.type === 'database' || assessment._id) {
                        console.log('ðŸ“¡ Database assessment detected, requesting questions from parent...');

                        // Request questions from the parent window
                        window.parent.postMessage({
                            action: 'getAssessmentQuestions',
                            payload: {
                                assessmentId: assessment._id || assessment.id,
                                assessmentType: assessment.type
                            }
                        }, '*');

                        return; // Exit here and wait for the response
                    } else {
                        console.error('âŒ No questions found in assessment:', assessment);
                        console.error('âŒ Available properties:', Object.keys(assessment));
                        showNotification('No questions found in this assessment.', 'error');
                        return;
                    }
                    */
                }

                console.log('ðŸ“‹ Found', assessmentQuestions.length, 'questions in assessment');
                console.log('âœ… About to populate modal header...');

                // Populate assessment view modal header
                const titleElement = document.getElementById('assessmentViewTitle');
                const statusElement = document.getElementById('assessmentViewStatus');
                const completionElement = document.getElementById('assessmentViewCompletion');
                const progressBarElement = document.getElementById('assessmentViewProgressBar');

                console.log('ðŸ” Modal elements found:', {
                    titleElement: !!titleElement,
                    statusElement: !!statusElement,
                    completionElement: !!completionElement,
                    progressBarElement: !!progressBarElement
                });

                if (!titleElement || !statusElement || !completionElement || !progressBarElement) {
                    console.error('âŒ Required modal elements not found');
                    console.error('âŒ Missing elements:', {
                        titleElement: !titleElement ? 'MISSING' : 'found',
                        statusElement: !statusElement ? 'MISSING' : 'found',
                        completionElement: !completionElement ? 'MISSING' : 'found',
                        progressBarElement: !progressBarElement ? 'MISSING' : 'found'
                    });
                    showNotification('Assessment modal elements not found. Please refresh the page.', 'error');
                    return;
                }

                titleElement.textContent = assessmentName;
                statusElement.textContent = assessmentStatus;
                completionElement.textContent = `Question ${startQuestionIndex + 1} of ${assessmentQuestions.length}`;

                // Set progress bar
                const progressPercentage = ((startQuestionIndex + 1) / assessmentQuestions.length) * 100;
                progressBarElement.style.width = `${progressPercentage}%`;

                // Generate questions HTML with saved answers populated
                console.log('ðŸ”§ Generating questions HTML...');
                console.log('ðŸ”§ Questions to process:', assessmentQuestions);

                let questionsHTML = '';
                try {
                    questionsHTML = assessmentQuestions.map((question, index) => {
                        console.log(`ðŸ”§ Processing question ${index + 1}:`, question);
                        const savedAnswer = savedAnswers[index];
                        const html = generateQuestionHTML(question, index, savedAnswer);
                        console.log(`âœ… Generated HTML for question ${index + 1}`);
                        return html;
                    }).join('');
                    console.log('âœ… All questions HTML generated successfully');
                } catch (htmlError) {
                    console.error('âŒ Error generating questions HTML:', htmlError);
                    showNotification('Error generating questions: ' + htmlError.message, 'error');
                    return;
                }

                // Set questions container
                const questionContainer = document.getElementById('assessmentQuestionContainer');
                console.log('ðŸ” Question container found:', !!questionContainer);

                if (!questionContainer) {
                    console.error('âŒ Question container not found');
                    showNotification('Question container not found. Please refresh the page.', 'error');
                    return;
                }

                console.log('ðŸ“ Setting questions HTML to container...');
                questionContainer.innerHTML = questionsHTML;
                console.log('âœ… Questions HTML populated, length:', questionsHTML.length);

                // Show the assessment view modal
                console.log('ðŸŽ¯ About to show modal...');
                const modal = document.getElementById('assessmentViewModal');
                console.log('ðŸ” Modal element found:', !!modal);

                if (!modal) {
                    console.error('âŒ Assessment view modal not found');
                    showNotification('Assessment modal not found. Please refresh the page.', 'error');
                    return;
                }

                console.log('ðŸ“± Setting modal display to block...');
                modal.style.display = 'block';
                console.log('âœ… Assessment modal displayed');
                console.log('ðŸ” Modal current style:', modal.style.display);

                // Initialize auto-save listeners
                console.log('ðŸ”§ Setting up auto-save listeners...');
                try {
                    setupAutoSaveListeners();
                    console.log('âœ… Auto-save listeners setup complete');
                } catch (autoSaveError) {
                    console.error('âŒ Error setting up auto-save listeners:', autoSaveError);
                }

                // Set up navigation with resume functionality
                console.log('ðŸ§­ Setting up assessment navigation...');
                try {
                    setupAssessmentNavigation(assessment, assessmentQuestions, startQuestionIndex, savedAnswers);
                    console.log('âœ… Assessment navigation setup complete');
                } catch (navError) {
                    console.error('âŒ Error setting up navigation:', navError);
                }

                console.log('ðŸŽ‰ Assessment modal setup completed successfully!');

            } catch (error) {
                console.error('âŒ Error in showAssessmentModalWithProgress:', error);
                showNotification('Error loading assessment: ' + error.message, 'error');
            }
        }

        // Generate HTML for a single question with optional saved answer
        function generateQuestionHTML(question, index, savedAnswer = null) {
            try {
                console.log(`ðŸ”§ Generating HTML for question ${index + 1}:`, question);

                const questionText = question.questionText || question.text || `Question ${index + 1}`;
                const answerType = question.answerType || question.type || 'text';
                const options = question.options || [];
                const isRequired = question.required !== false; // Default to required unless explicitly false

                console.log(`ðŸ“ Question ${index + 1}: type=${answerType}, options=${options.length}, savedAnswer=`, savedAnswer);

                // Debug the options structure
                if (options.length > 0) {
                    console.log(`ðŸ” First option structure:`, options[0]);
                    console.log(`ðŸ” First option type:`, typeof options[0]);
                    if (typeof options[0] === 'object') {
                        console.log(`ðŸ” First option keys:`, Object.keys(options[0]));
                    }
                }

                let inputHTML = '';

            switch (answerType) {
                case 'text':
                    inputHTML = `<textarea name="question_${index}" class="w-full p-3 border rounded-md" rows="3"
                        placeholder="Enter your answer..." ${isRequired ? 'required' : ''}>${savedAnswer || ''}</textarea>`;
                    break;

                case 'single':
                    inputHTML = options.map(option => {
                        // Handle both string options and object options
                        const optionText = typeof option === 'string' ? option : (option.text || option.label || option.value || 'Option');
                        const optionValue = typeof option === 'string' ? option : (option.value || option.text || option.label || 'Option');
                        const isChecked = savedAnswer === optionValue ? 'checked' : '';

                        console.log(`ðŸ“ Processing option:`, { option, optionText, optionValue, isChecked });

                        return `
                            <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                                <input type="radio" name="question_${index}" value="${optionValue}" ${isChecked} ${isRequired ? 'required' : ''}>
                                <span>${optionText}</span>
                            </label>
                        `;
                    }).join('');
                    break;

                case 'multiple':
                    const savedMultiple = Array.isArray(savedAnswer) ? savedAnswer : [];
                    inputHTML = options.map(option => {
                        // Handle both string options and object options
                        const optionText = typeof option === 'string' ? option : (option.text || option.label || option.value || 'Option');
                        const optionValue = typeof option === 'string' ? option : (option.value || option.text || option.label || 'Option');
                        const isChecked = savedMultiple.includes(optionValue) ? 'checked' : '';

                        console.log(`ðŸ“ Processing multiple option:`, { option, optionText, optionValue, isChecked });

                        return `
                            <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                                <input type="checkbox" name="question_${index}" value="${optionValue}" ${isChecked}>
                                <span>${optionText}</span>
                            </label>
                        `;
                    }).join('');
                    break;

                case 'yesno':
                    const yesChecked = savedAnswer === 'Yes' ? 'checked' : '';
                    const noChecked = savedAnswer === 'No' ? 'checked' : '';
                    inputHTML = `
                        <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                            <input type="radio" name="question_${index}" value="Yes" ${yesChecked} ${isRequired ? 'required' : ''}>
                            <span>Yes</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                            <input type="radio" name="question_${index}" value="No" ${noChecked} ${isRequired ? 'required' : ''}>
                            <span>No</span>
                        </label>
                    `;
                    break;

                case 'maturity':
                    const maturityLabels = {
                        0: 'Not in place',
                        1: 'Informal',
                        2: 'Partially in place',
                        3: 'Fully in place',
                        4: 'Measured and monitored',
                        5: 'Best practice'
                    };

                    inputHTML = Object.entries(maturityLabels).map(([value, label]) => {
                        const isChecked = savedAnswer == value ? 'checked' : '';
                        return `
                            <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                                <input type="radio" name="question_${index}" value="${value}" ${isChecked} ${isRequired ? 'required' : ''}>
                                <span><strong>${value}</strong> - ${label}</span>
                            </label>
                        `;
                    }).join('');
                    break;

                default:
                    inputHTML = `<input type="text" class="w-full p-3 border rounded-md"
                        placeholder="Enter your answer..." value="${savedAnswer || ''}" ${isRequired ? 'required' : ''}>`;
            }

            return `
                <div class="question-container mb-6 p-4 border rounded-lg" data-question-index="${index}"
                     style="display: none;">
                    <div class="mb-4">
                        <h4 class="text-lg font-medium mb-2">${index + 1}. ${questionText}</h4>
                        ${question.description ? `<p class="text-gray-600 text-sm mb-3">${question.description}</p>` : ''}
                        ${question.domain ? `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full mb-3">${question.domain}</span>` : ''}
                    </div>
                    <div class="space-y-2">
                        ${inputHTML}
                    </div>
                    ${question.guidance ? `<div class="mt-3 p-3 bg-gray-50 rounded text-sm text-gray-700"><strong>Guidance:</strong> ${question.guidance}</div>` : ''}
                </div>
            `;

            } catch (error) {
                console.error(`âŒ Error generating HTML for question ${index + 1}:`, error);
                return `
                    <div class="question-container mb-6 p-4 border rounded-lg bg-red-50" data-question-index="${index}"
                         style="display: none;">
                        <div class="mb-4">
                            <h4 class="text-lg font-medium mb-2 text-red-700">${index + 1}. Error loading question</h4>
                            <p class="text-red-600 text-sm">There was an error loading this question. Please refresh the page.</p>
                        </div>
                    </div>
                `;
            }
        }

        // Setup assessment navigation with resume functionality
        function setupAssessmentNavigation(assessment, assessmentQuestions, startQuestionIndex, savedAnswers) {
            const totalQuestions = assessmentQuestions.length;
            let currentQuestionIndex = startQuestionIndex;

            console.log(`ðŸ§­ Setting up navigation: starting at question ${currentQuestionIndex + 1} of ${totalQuestions}`);

            // Show the current question
            document.querySelector(`[data-question-index="${currentQuestionIndex}"]`).style.display = 'block';

            // Global variables for progress tracking
            window.currentQuestionIndex = currentQuestionIndex;
            window.totalQuestions = totalQuestions;
            window.currentAssessment = assessment;

            // Initialize progress display
            if (typeof updateProgressDisplay === 'function') {
                updateProgressDisplay();
            }

            // Update button states based on current position
            function updateButtonStates() {
                const prevBtn = document.getElementById('prevQuestionBtn');
                const nextBtn = document.getElementById('nextQuestionBtn');

                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.disabled = currentQuestionIndex === totalQuestions - 1;
            }

            // Initialize button states
            updateButtonStates();

            // Next question button
            document.getElementById('nextQuestionBtn').onclick = function () {
                if (currentQuestionIndex < totalQuestions - 1) {
                    // Auto-save before moving to next question
                    autoSaveAssessmentProgress(assessment.id);

                    // Hide current question
                    document.querySelector(`[data-question-index="${currentQuestionIndex}"]`).style.display = 'none';

                    // Show next question
                    currentQuestionIndex++;
                    window.currentQuestionIndex = currentQuestionIndex; // Update global variable
                    document.querySelector(`[data-question-index="${currentQuestionIndex}"]`).style.display = 'block';

                    // Update button states and progress
                    updateButtonStates();
                    updateProgressDisplay();

                    console.log(`âž¡ï¸ Moved to question ${currentQuestionIndex + 1}`);
                }
            };

            // Previous question button
            document.getElementById('prevQuestionBtn').onclick = function () {
                if (currentQuestionIndex > 0) {
                    // Auto-save before moving to previous question
                    autoSaveAssessmentProgress(assessment.id);

                    // Hide current question
                    document.querySelector(`[data-question-index="${currentQuestionIndex}"]`).style.display = 'none';

                    // Show previous question
                    currentQuestionIndex--;
                    window.currentQuestionIndex = currentQuestionIndex; // Update global variable
                    document.querySelector(`[data-question-index="${currentQuestionIndex}"]`).style.display = 'block';

                    // Update button states and progress
                    updateButtonStates();
                    updateProgressDisplay();

                    console.log(`â¬…ï¸ Moved to question ${currentQuestionIndex + 1}`);
                }
            };

            // Submit assessment button
            document.getElementById('submitAssessmentBtn').onclick = function () {
                console.log('ðŸŽ¯ Submit Assessment button clicked');

                // Auto-save before submitting
                autoSaveAssessmentProgress(assessment.id);

                // Call the submit assessment function
                const assessmentId = assessment._id || assessment.id;
                console.log('ðŸ“¤ Submitting assessment with ID:', assessmentId);

                submitAssessment(assessmentId);
            };

            // Show resume notification if we're not starting from the beginning
            if (startQuestionIndex > 0) {
                const answeredCount = Object.keys(savedAnswers).length;
                showNotification(
                    `Assessment resumed! You have ${answeredCount} saved answers. Starting from question ${startQuestionIndex + 1}.`,
                    'success'
                );
            }
        }

        // Setup auto-save listeners for assessment form elements
        function setupAutoSaveListeners() {
            const questionContainer = document.getElementById('assessmentQuestionContainer');

            if (!questionContainer) {
                console.warn('âš ï¸ Question container not found for auto-save setup');
                return;
            }

            // Add event listeners for all input types with real-time progress updates
            questionContainer.addEventListener('change', (event) => {
                if (event.target.matches('input, textarea, select')) {
                    // Update progress immediately when answer changes
                    if (typeof updateProgressDisplay === 'function') {
                        updateProgressDisplay();
                    }

                    // Debounce auto-save to avoid too frequent saves
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(() => {
                        const assessment = window.currentAssessment;
                        if (assessment) {
                            autoSaveAssessmentProgress(assessment.id || assessment._id);
                        }
                    }, 1000); // Save 1 second after user stops typing/selecting
                }
            });

            // Also listen for input events for text areas (real-time typing)
            questionContainer.addEventListener('input', (event) => {
                if (event.target.matches('textarea')) {
                    // Update progress immediately when text changes
                    if (typeof updateProgressDisplay === 'function') {
                        updateProgressDisplay();
                    }

                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(() => {
                        const assessment = window.currentAssessment;
                        if (assessment) {
                            autoSaveAssessmentProgress(assessment.id || assessment._id);
                        }
                    }, 2000); // Save 2 seconds after user stops typing
                }
            });

            // Listen for rating button clicks to update progress immediately
            questionContainer.addEventListener('click', (event) => {
                if (event.target.matches('.rating-btn')) {
                    // Update progress immediately when rating is selected
                    setTimeout(() => {
                        if (typeof updateProgressDisplay === 'function') {
                            updateProgressDisplay();
                        }
                    }, 100); // Small delay to ensure DOM is updated
                }
            });

            console.log('âœ… Auto-save listeners setup complete');
        }

        // Save assessment progress
      function saveAssessmentProgress(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId || a._id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found for saving progress:', assessmentId);
                return;
            }

            console.log('Saving progress for assessment:', assessment);

            // Collect all answers from the form
            const answers = [];
            const questionContainer = document.getElementById('assessmentQuestionContainer');
            const questionElements = questionContainer.querySelectorAll('[data-question-index]');

            questionElements.forEach((questionElement, index) => {
                const questionIndex = questionElement.getAttribute('data-question-index');
                const question = (assessment.questionData || assessment.questions || [])[questionIndex];

                if (!question) return;

                let answer = null;
                const answerType = question.answerType || question.type || 'text';

                switch (answerType) {
                    case 'single':
                    case 'yesno':
                        const radioInput = questionElement.querySelector(`input[name="q${questionIndex}"]:checked`);
                        answer = radioInput ? radioInput.value : null;
                        break;
                    case 'multiple':
                        const checkboxInputs = questionElement.querySelectorAll(`input[name="q${questionIndex}"]:checked`);
                        answer = Array.from(checkboxInputs).map(input => input.value);
                        break;
                    case 'rating':
                        const ratingBtn = questionElement.querySelector('.rating-btn.selected');
                        answer = ratingBtn ? ratingBtn.getAttribute('data-value') : null;
                        break;
                    case 'maturity':
                        const maturityInput = questionElement.querySelector(`input[name="q${questionIndex}"]:checked`);
                        answer = maturityInput ? parseInt(maturityInput.value) : null;
                        break;
                    case 'file':
                        const fileInput = questionElement.querySelector(`input[name="q${questionIndex}"]`);
                        answer = fileInput && fileInput.files.length > 0 ? fileInput.files[0].name : null;
                        break;
                    default: // text
                        const textInput = questionElement.querySelector(`textarea[name="q${questionIndex}"]`);
                        answer = textInput ? textInput.value : null;
                        break;
                }

                answers.push({
                    questionIndex: parseInt(questionIndex),
                    question: {
                        questionText: question.questionText || question.text,
                        answerType: answerType,
                        domain: question.domain || question.category || 'General',
                        text: question.questionText || question.text
                    },
                    answer: answer,
                    timestamp: new Date().toISOString()
                });
            });

            // Calculate progress
            const answeredQuestions = answers.filter(a => a.answer !== null && a.answer !== '' && (Array.isArray(a.answer) ? a.answer.length > 0 : true)).length;
            const totalQuestions = (assessment.questionData || assessment.questions || []).length;
            const progressPercentage = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;

            // Prepare progress data for database
            const progressData = {
                assessmentId: assessment._id || assessment.id,
                assessmentTitle: assessment.title || assessment.name,
                answers: answers,
                progress: progressPercentage,
                completed: answeredQuestions,
                pending: totalQuestions - answeredQuestions,
                totalQuestions: totalQuestions,
                lastSaved: new Date().toISOString(),
                status: progressPercentage === 100 ? 'completed' : 'in progress'
            };

            console.log('Sending progress data to database:', progressData);

            // Send to Wix database
            window.parent.postMessage({
                action: 'saveAssessmentProgress',
                payload: progressData
            }, '*');

            // Update local assessment object
            assessment.completion = progressPercentage + '%';
            assessment.completed = answeredQuestions;
            assessment.pending = totalQuestions - answeredQuestions;

            // Update UI with question count format
            const currentQuestion = Math.min(answeredQuestions + 1, totalQuestions);
            document.getElementById('assessmentViewCompletion').textContent = `Question ${currentQuestion} of ${totalQuestions}`;
            document.getElementById('assessmentViewProgressBar').style.width = `${progressPercentage}%`;

            // Success message will be shown by the message handler
        }

        // Auto-save assessment progress (silent save without user notification)
        function autoSaveAssessmentProgress(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId || a._id === assessmentId);
            if (!assessment) {
                console.error('Assessment not found for auto-saving progress:', assessmentId);
                return;
            }

            // Update auto-save status
            const autoSaveStatus = document.getElementById('autoSaveStatus');
            if (autoSaveStatus) {
                autoSaveStatus.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Saving...';
            }

            // Collect all answers from the form
            const answers = [];
            const questionContainer = document.getElementById('assessmentQuestionContainer');
            const questionElements = questionContainer.querySelectorAll('[data-question-index]');

            questionElements.forEach((questionElement, index) => {
                const questionIndex = questionElement.getAttribute('data-question-index');
                const question = (assessment.questionData || assessment.questions || [])[questionIndex];

                if (!question) return;

                let answer = null;
                const answerType = question.answerType || question.type || 'text';

                switch (answerType) {
                    case 'single':
                    case 'yesno':
                        const radioInput = questionElement.querySelector(`input[name="q${questionIndex}"]:checked`);
                        answer = radioInput ? radioInput.value : null;
                        break;
                    case 'multiple':
                        const checkboxInputs = questionElement.querySelectorAll(`input[name="q${questionIndex}"]:checked`);
                        answer = Array.from(checkboxInputs).map(input => input.value);
                        break;
                    case 'rating':
                        const ratingBtn = questionElement.querySelector('.rating-btn.selected');
                        answer = ratingBtn ? ratingBtn.getAttribute('data-value') : null;
                        break;
                    case 'maturity':
                        const maturityInput = questionElement.querySelector(`input[name="q${questionIndex}"]:checked`);
                        answer = maturityInput ? parseInt(maturityInput.value) : null;
                        break;
                    case 'file':
                        const fileInput = questionElement.querySelector(`input[name="q${questionIndex}"]`);
                        answer = fileInput && fileInput.files.length > 0 ? fileInput.files[0].name : null;
                        break;
                    default: // text
                        const textInput = questionElement.querySelector(`textarea[name="q${questionIndex}"]`);
                        answer = textInput ? textInput.value : null;
                        break;
                }

                answers.push({
                    questionIndex: parseInt(questionIndex),
                    question: {
                        questionText: question.questionText || question.text,
                        answerType: answerType,
                        domain: question.domain || question.category || 'General',
                        text: question.questionText || question.text
                    },
                    answer: answer,
                    timestamp: new Date().toISOString()
                });
            });

            // Calculate progress
            const answeredQuestions = answers.filter(a => a.answer !== null && a.answer !== '' && (Array.isArray(a.answer) ? a.answer.length > 0 : true)).length;
            const totalQuestions = (assessment.questionData || assessment.questions || []).length;
            const progressPercentage = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;

            // Prepare progress data for database
            const progressData = {
                assessmentId: assessment._id || assessment.id,
                assessmentTitle: assessment.title || assessment.name,
                answers: answers,
                progress: progressPercentage,
                completed: answeredQuestions,
                pending: totalQuestions - answeredQuestions,
                totalQuestions: totalQuestions,
                lastSaved: new Date().toISOString(),
                status: progressPercentage === 100 ? 'completed' : 'in progress',
                autoSave: true // Flag to indicate this is an auto-save
            };

            // Send to Wix database
            window.parent.postMessage({
                action: 'saveAssessmentProgress',
                payload: progressData
            }, '*');

            // Update local assessment object
            assessment.completion = progressPercentage + '%';
            assessment.completed = answeredQuestions;
            assessment.pending = totalQuestions - answeredQuestions;

            // Update progress bar in the modal if it's open
            const progressBarElement = document.getElementById('assessmentViewProgressBar');
            const completionElement = document.getElementById('assessmentViewCompletion');

            if (progressBarElement && completionElement) {
                progressBarElement.style.width = `${progressPercentage}%`;
                const currentQuestion = Math.min(answeredQuestions + 1, totalQuestions);
                completionElement.textContent = `Question ${currentQuestion} of ${totalQuestions} (${answeredQuestions} answered)`;
                console.log(`ðŸ“Š Auto-save progress updated: ${answeredQuestions}/${totalQuestions} answered (${progressPercentage}%)`);
            }

            // Update auto-save status after a short delay
            setTimeout(() => {
                if (autoSaveStatus) {
                    autoSaveStatus.innerHTML = '<i class="fas fa-check mr-1 text-green-500"></i>Saved';
                    setTimeout(() => {
                        autoSaveStatus.innerHTML = '<i class="fas fa-save mr-1"></i>Auto-save enabled';
                    }, 2000);
                }
            }, 500);
        }

        // Submit assessment
       function submitAssessment(assessmentId) {
            console.log('ðŸŽ¯ submitAssessment called with ID:', assessmentId);
            console.log('ðŸ” Available assessments:', assessments.map(a => ({ id: a.id, _id: a._id, title: a.title })));

            const assessment = assessments.find(a => a.id === assessmentId || a._id === assessmentId);
            if (!assessment) {
                console.error('âŒ Assessment not found for submission:', assessmentId);
                showNotification('Assessment not found. Please try again.', 'error');
                return;
            }

            console.log('âœ… Found assessment for submission:', assessment.title || assessment.name);
            console.log('ðŸ“‹ Assessment questions:', (assessment.questionData || assessment.questions || []).length);

            // Collect all answers from the form
            console.log('ðŸ“ Collecting answers from form...');
            const answers = [];
            const questionContainer = document.getElementById('assessmentQuestionContainer');
            const questionElements = questionContainer.querySelectorAll('[data-question-index]');

            console.log('ðŸ” Found', questionElements.length, 'question elements');
            let hasUnansweredRequired = false;

            questionElements.forEach((questionElement, index) => {
                const questionIndex = questionElement.getAttribute('data-question-index');
                const question = (assessment.questionData || assessment.questions || [])[questionIndex];

                console.log(`ðŸ“ Processing question ${parseInt(questionIndex) + 1}:`, question?.questionText || question?.text);

                if (!question) {
                    console.warn(`âš ï¸ Question not found for index ${questionIndex}`);
                    return;
                }

                let answer = null;
                const answerType = question.answerType || question.type || 'text';
                console.log(`ðŸ” Question type: ${answerType}`);

                switch (answerType) {
                    case 'single':
                    case 'yesno':
                        const radioInput = questionElement.querySelector(`input[name="question_${questionIndex}"]:checked`);
                        answer = radioInput ? radioInput.value : null;
                        break;
                    case 'multiple':
                        const checkboxInputs = questionElement.querySelectorAll(`input[name="question_${questionIndex}"]:checked`);
                        answer = Array.from(checkboxInputs).map(input => input.value);
                        break;
                    case 'rating':
                        const ratingBtn = questionElement.querySelector('.rating-btn.selected');
                        answer = ratingBtn ? ratingBtn.getAttribute('data-value') : null;
                        break;
                    case 'maturity':
                        const maturityInput = questionElement.querySelector(`input[name="question_${questionIndex}"]:checked`);
                        answer = maturityInput ? parseInt(maturityInput.value) : null;
                        break;
                    case 'file':
                        const fileInput = questionElement.querySelector(`input[name="question_${questionIndex}"]`);
                        answer = fileInput && fileInput.files.length > 0 ? fileInput.files[0].name : null;
                        break;
                    default: // text
                        const textInput = questionElement.querySelector(`textarea[name="question_${questionIndex}"]`);
                        answer = textInput ? textInput.value : null;
                        break;
                }

                console.log(`âœ… Answer for question ${parseInt(questionIndex) + 1}:`, answer);

                // Check if required question is unanswered
                if (question.required && (answer === null || answer === '' || (Array.isArray(answer) && answer.length === 0))) {
                    console.log(`âš ï¸ Required question ${parseInt(questionIndex) + 1} is unanswered`);
                    hasUnansweredRequired = true;
                }

                answers.push({
                    questionIndex: parseInt(questionIndex),
                    question: {
                        questionText: question.questionText || question.text,
                        answerType: answerType,
                        domain: question.domain || question.category || 'General',
                        text: question.questionText || question.text
                    },
                    answer: answer,
                    timestamp: new Date().toISOString()
                });
            });

            // Validate required questions
            console.log('ðŸ” Total answers collected:', answers.length);
            console.log('ðŸ” Has unanswered required questions:', hasUnansweredRequired);

            if (hasUnansweredRequired) {
                console.log('âŒ Submission blocked: unanswered required questions');
                alert('Please answer all required questions before submitting.');
                return;
            }

            // Prepare submission data for database
            const submissionData = {
                assessmentId: assessment._id || assessment.id,
                assessmentTitle: assessment.title || assessment.name,
                answers: answers,
                progress: 100,
                completed: answers.length,
                pending: 0,
                totalQuestions: (assessment.questionData || assessment.questions || []).length,
                submittedAt: new Date().toISOString(),
                status: 'completed'
            };

            console.log('ðŸ“¤ Sending submission data to database:', submissionData);
            console.log('ðŸ” Assessment ID being submitted:', submissionData.assessmentId);
            console.log('ðŸ” Assessment object used:', {
                id: assessment.id,
                _id: assessment._id,
                title: assessment.title,
                name: assessment.name
            });

            // Send to Wix database
            window.parent.postMessage({
                action: 'submitAssessment',
                payload: submissionData
            }, '*');

            // Update local assessment object
            assessment.status = 'Completed';
            assessment.userStatus = 'Completed';
            assessment.completion = '100%';
            assessment.userProgress = '100%';
            assessment.completed = (assessment.questionData || assessment.questions || []).length;
            assessment.pending = 0;

            console.log('âœ… Assessment submitted successfully!');
            console.log('ðŸ“Š Final submission stats:', {
                totalQuestions: submissionData.totalQuestions,
                answersCollected: submissionData.answers.length,
                progress: submissionData.progress + '%'
            });

            // Show success message
            showNotification('Assessment submitted successfully! Thank you for completing the assessment.', 'success');

            // Update UI
            renderAssessmentsTable(assessments);

            // Close modal after a short delay to let user see the success message
            setTimeout(() => {
                closeAssessmentViewModal();
            }, 1500);

            // Success message will be shown by the message handler
        }

        // Global progress tracking functions
        window.updateProgressDisplay = function updateProgressDisplay() {
            const currentQuestion = (window.currentQuestionIndex || 0) + 1;
            const totalQuestions = window.totalQuestions || 0;
            const assessment = window.currentAssessment;

            if (!assessment || totalQuestions === 0) {
                console.log('âš ï¸ Cannot update progress: missing assessment data');
                return;
            }

            // Calculate progress based on current question position (not answered questions)
            const progressPercentage = totalQuestions > 0 ? Math.round((currentQuestion / totalQuestions) * 100) : 0;

            // Also calculate answered questions for display purposes
            const answeredCount = calculateAnsweredQuestions();

            // Update completion text to show both current question and progress
            const completionElement = document.getElementById('assessmentViewCompletion');
            const progressBarElement = document.getElementById('assessmentViewProgressBar');

            if (completionElement) {
                completionElement.textContent = `Question ${currentQuestion} of ${totalQuestions} (${answeredCount} answered)`;
            }

            // Update progress bar based on current question position
            if (progressBarElement) {
                progressBarElement.style.width = `${progressPercentage}%`;
            }

            // Show submit button only on the last question
            const submitContainer = document.getElementById('submitAssessmentContainer');
            const nextBtn = document.getElementById('nextQuestionBtn');

            if (window.currentQuestionIndex === totalQuestions - 1) {
                if (submitContainer) submitContainer.classList.remove('hidden');
                if (nextBtn) nextBtn.style.display = 'none';
            } else {
                if (submitContainer) submitContainer.classList.add('hidden');
                if (nextBtn) nextBtn.style.display = 'block';
            }

            console.log(`ðŸ“Š Progress updated: ${answeredCount}/${totalQuestions} answered (${progressPercentage}%)`);
        }

        // Helper function to calculate answered questions in real-time
        window.calculateAnsweredQuestions = function calculateAnsweredQuestions() {
            let answeredCount = 0;
            const questionContainer = document.getElementById('assessmentQuestionContainer');
            const assessment = window.currentAssessment;

            if (!questionContainer || !assessment) {
                return 0;
            }

            const questionElements = questionContainer.querySelectorAll('[data-question-index]');

            questionElements.forEach((questionElement) => {
                const questionIndex = questionElement.getAttribute('data-question-index');
                const question = (assessment.questionData || assessment.questions || [])[questionIndex];

                if (!question) return;

                let hasAnswer = false;
                const answerType = question.answerType || question.type || 'text';

                switch (answerType) {
                    case 'single':
                    case 'yesno':
                        const radioInput = questionElement.querySelector(`input[name="q${questionIndex}"]:checked`);
                        hasAnswer = !!radioInput;
                        break;
                    case 'multiple':
                        const checkboxInputs = questionElement.querySelectorAll(`input[name="q${questionIndex}"]:checked`);
                        hasAnswer = checkboxInputs.length > 0;
                        break;
                    case 'rating':
                        const ratingBtn = questionElement.querySelector('.rating-btn.selected');
                        hasAnswer = !!ratingBtn;
                        break;
                    case 'maturity':
                        const maturityInput = questionElement.querySelector(`input[name="q${questionIndex}"]:checked`);
                        hasAnswer = !!maturityInput;
                        break;
                    case 'file':
                        const fileInput = questionElement.querySelector(`input[name="q${questionIndex}"]`);
                        hasAnswer = fileInput && fileInput.files.length > 0;
                        break;
                    default: // text
                        const textInput = questionElement.querySelector(`textarea[name="q${questionIndex}"]`);
                        hasAnswer = textInput && textInput.value.trim() !== '';
                        break;
                }

                if (hasAnswer) {
                    answeredCount++;
                }
            });

            return answeredCount;
        }

        // Helper functions for badge classes
        function getLevelBadgeClass(level) {
            switch (level) {
                case 'Critical': return 'badge-critical';
                case 'High': return 'badge-high';
                case 'Medium': return 'badge-medium';
                case 'Low': return 'badge-low';
                default: return 'badge-low';
            }
        }

        function getLikelihoodBadgeClass(likelihood) {
            switch (likelihood) {
                case 'High': return 'badge-high';
                case 'Medium': return 'badge-medium';
                case 'Low': return 'badge-low';
                case 'Very Low': return 'badge-low';
                default: return 'badge-medium';
            }
        }

        function getImpactBadgeClass(impact) {
            switch (impact) {
                case 'Critical': return 'badge-critical';
                case 'High': return 'badge-high';
                case 'Medium': return 'badge-medium';
                case 'Low': return 'badge-low';
                default: return 'badge-medium';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Active': return 'badge-active';
                case 'Mitigated': return 'badge-mitigated';
                case 'Accepted': return 'badge-medium';
                case 'Transferred': return 'badge-critical';
                case 'Avoided': return 'badge-low';
                case 'Completed': return 'badge-mitigated';
                case 'In Progress': return 'badge-medium';
                case 'Not Started': return 'badge-low';
                default: return 'badge-active';
            }
        }

        function getCriticalityBadgeClass(criticality) {
            switch (criticality) {
                case 'Critical': return 'badge-critical';
                case 'High': return 'badge-high';
                case 'Medium': return 'badge-medium';
                case 'Low': return 'badge-low';
                default: return 'badge-medium';
            }
        }

        function getClassificationBadgeClass(classification) {
            switch (classification) {
                case 'Restricted': return 'badge-critical';
                case 'Confidential': return 'badge-high';
                case 'Internal': return 'badge-medium';
                case 'Public': return 'badge-low';
                default: return 'badge-medium';
            }
        }

        function getComplianceColorClass(compliance) {
            if (compliance > 90) return 'bg-green-600';
            if (compliance > 70) return 'bg-blue-600';
            if (compliance > 50) return 'bg-yellow-600';
            return 'bg-red-600';
        }

        function getCompletionColorClass(completion) {
            if (completion === 100) return 'bg-green-600';
            if (completion > 50) return 'bg-blue-600';
            if (completion > 0) return 'bg-yellow-600';
            return 'bg-gray-600';
        }

        // Framework functions



        // Open add framework modal
        function openAddFrameworkModal() {
            // Reset form
            document.getElementById('addFrameworkForm').reset();

            // Clear domains except for the first one
            const domainsContainer = document.getElementById('newFrameworkDomains');
            domainsContainer.innerHTML = `
                <div class="flex items-center space-x-2">
                    <input
                        type="text"
                        class="domain-name p-2 border rounded-md flex-grow"
                        placeholder="Domain name"
                    />
                    <input
                        type="number"
                        class="domain-compliance p-2 border rounded-md w-24"
                        placeholder="Compliance %"
                        min="0"
                        max="100"
                    />
                    <button type="button" class="p-2 text-red-500" onclick="removeDomainField(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            // Reset controls panel
            document.getElementById('newFrameworkControlsList').style.display = 'none';
            document.getElementById('newFrameworkControlsList').innerHTML = '<p class="text-sm text-gray-500">No controls available. Add controls after creating the framework.</p>';
            document.getElementById('newFrameworkTotalControls').value = '0';

            // Show modal
            document.getElementById('addFrameworkModal').style.display = 'block';
        }

        // Close add framework modal
        function closeAddFrameworkModal() {
            document.getElementById('addFrameworkModal').style.display = 'none';
        }

        // Helper function to open framework modal by ID
        window.openFrameworkModalById = function(frameworkId) {
            console.log('ðŸ” Opening framework modal for ID:', frameworkId);
            console.log('ðŸ“‹ Available frameworks:', frameworks.length);

            const framework = frameworks.find(f =>
                String(f.id) === String(frameworkId) ||
                String(f._id) === String(frameworkId) ||
                String(f.customId) === String(frameworkId)
            );

            if (framework) {
                console.log('âœ… Framework found:', framework.name);
                openFrameworkModal(framework);
            } else {
                console.warn('âŒ Framework not found with ID:', frameworkId);
                console.log('Available framework IDs:', frameworks.map(f => ({ id: f.id, _id: f._id, customId: f.customId, name: f.name })));
            }
        };

        // Helper function to open edit framework modal by ID
        window.openEditFrameworkModalById = function(frameworkId) {
            console.log('âœï¸ Opening edit framework modal for ID:', frameworkId);

            const framework = frameworks.find(f =>
                String(f.id) === String(frameworkId) ||
                String(f._id) === String(frameworkId) ||
                String(f.customId) === String(frameworkId)
            );

            if (framework) {
                console.log('âœ… Framework found for editing:', framework.name);
                openEditFrameworkModal(framework);
            } else {
                console.warn('âŒ Framework not found for editing with ID:', frameworkId);
                console.log('Available framework IDs:', frameworks.map(f => ({ id: f.id, _id: f._id, customId: f.customId, name: f.name })));
            }
        };

        // Open edit framework modal
        window.openEditFrameworkModal = function(frameworkData) {
            let framework;

            if (frameworkData) {
                // If framework data is passed as parameter, use it directly
                framework = frameworkData;
            } else {
                // Fallback to old method: get ID from button attribute
                const editBtn = document.getElementById('editFrameworkBtn');
                if (!editBtn) return console.warn('#editFrameworkBtn not found');

                const frameworkId = editBtn.getAttribute('data-framework-id'); // string UUID
                if (!frameworkId) return console.warn('Missing data-framework-id on editFrameworkBtn');

                framework = frameworks.find(f =>
                    String(f._id) === frameworkId || String(f.id) === frameworkId || String(f.customId) === frameworkId
                );

                if (!framework) return console.warn(`Framework with ID ${frameworkId} not found`);
            }

            // Fill in form fields
            document.getElementById('editFrameworkId').value = framework._id || framework.id;
            document.getElementById('editFrameworkName').value = framework.name;
            document.getElementById('editFrameworkDescription').value = framework.description;

            // Calculate controls count properly
            const controlsCount = Array.isArray(framework.controls) ? framework.controls.length : (framework.controls || 0);
            document.getElementById('editFrameworkControls').value = controlsCount;

            console.log('âœï¸ Opening edit framework modal for:', framework.name);
            console.log('ðŸ“Š Framework controls:', framework.controls);
            console.log('ðŸ“Š Framework controlsData:', framework.controlsData);
            console.log('ðŸ“ˆ Controls count:', controlsCount);

            document.getElementById('editFrameworkStatus').value = framework.status;

            if (framework.readiness === 'ready') {
                document.getElementById('editReadinessReady').checked = true;
            } else {
                document.getElementById('editReadinessNotReady').checked = true;
            }

            populateEditDomains(framework.domains || []);

            // Populate current documents
            populateEditCurrentDocuments(framework.documents || []);

            // Populate framework controls
            console.log('ðŸ”„ Calling populateFrameworkControls...');
            populateFrameworkControls();

            // Clear file input
            document.getElementById('editFrameworkDocuments').value = '';

            closeFrameworkModal();
            document.getElementById('editFrameworkModal').style.display = 'block';
        };


        // Close edit framework modal
        function closeEditFrameworkModal() {
            document.getElementById('editFrameworkModal').style.display = 'none';
        }

        // Add domain field to the specified container
        function addDomainField(containerId) {
            const container = document.getElementById(containerId);
            const domainField = document.createElement('div');
            domainField.className = 'flex items-center space-x-2';
            domainField.innerHTML = `
                <input
                    type="text"
                    class="domain-name p-2 border rounded-md flex-grow"
                    placeholder="Domain name"
                />
                <input
                    type="number"
                    class="domain-compliance p-2 border rounded-md w-24"
                    placeholder="Compliance %"
                    min="0"
                    max="100"
                />
                <button type="button" class="p-2 text-red-500" onclick="removeDomainField(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(domainField);
        }

        // Remove domain field
        function removeDomainField(button) {
            const domainField = button.parentElement;
            domainField.remove();
        }

        // Populate edit domains
        function populateEditDomains(domains) {
            const container = document.getElementById('editFrameworkDomains');
            container.innerHTML = '';

            domains.forEach(domain => {
                const domainField = document.createElement('div');
                domainField.className = 'flex items-center space-x-2';
                domainField.innerHTML = `
                    <input
                        type="text"
                        class="domain-name p-2 border rounded-md flex-grow"
                        value="${domain.name}"
                        placeholder="Domain name"
                    />
                    <input
                        type="number"
                        class="domain-compliance p-2 border rounded-md w-24"
                        value="${domain.compliance}"
                        placeholder="Compliance %"
                        min="0"
                        max="100"
                    />
                    <button type="button" class="p-2 text-red-500" onclick="removeDomainField(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(domainField);
            });
        }

        // Populate edit current documents
        function populateEditCurrentDocuments(documents) {
            const container = document.getElementById('editFrameworkCurrentDocuments');
            if (!container) {
                console.warn('editFrameworkCurrentDocuments container not found');
                return;
            }

            container.innerHTML = '';

            if (documents && Array.isArray(documents) && documents.length > 0) {
                // Create header using innerHTML
                const headerHtml = `
                    <div class="mb-3">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Current Documents (${documents.length})</h4>
                    </div>
                `;

                // Create documents list using innerHTML
                let documentsListHtml = `
                    <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                `;

                documents.forEach(document => {
                    // Get file icon based on type
                    let fileIcon = 'fas fa-file text-gray-500';
                    if (document.type && document.type.includes('pdf')) {
                        fileIcon = 'fas fa-file-pdf text-red-500';
                    } else if (document.type && (document.type.includes('doc') || document.type.includes('word'))) {
                        fileIcon = 'fas fa-file-word text-blue-500';
                    } else if (document.type && (document.type.includes('xls') || document.type.includes('excel'))) {
                        fileIcon = 'fas fa-file-excel text-green-500';
                    } else if (document.type && document.type.includes('image')) {
                        fileIcon = 'fas fa-file-image text-purple-500';
                    }

                    documentsListHtml += `
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-2">
                                <i class="${fileIcon}"></i>
                                <span class="text-gray-700 truncate">${document.name}</span>
                            </div>
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <span>${document.size ? window.formatFileSize(document.size) : 'Unknown'}</span>
                                <button
                                    onclick="window.viewDocument('${document.url}', '${document.name}', '${document.type}')"
                                    class="text-indigo-600 hover:text-indigo-900"
                                    title="View document"
                                >
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                documentsListHtml += `</div>`;

                container.innerHTML = headerHtml + documentsListHtml;
            } else {
                // Show no documents message
                container.innerHTML = `
                    <div class="text-sm text-gray-500 italic mb-3">
                        No documents currently uploaded for this framework.
                    </div>
                `;
            }
        }

        // Get domains from form
        function getDomainsFromForm(containerId) {
            const container = document.getElementById(containerId);
            const domainFields = container.querySelectorAll('.flex.items-center');
            const domains = [];

            domainFields.forEach(field => {
                const nameInput = field.querySelector('.domain-name');
                const complianceInput = field.querySelector('.domain-compliance');

                if (nameInput.value.trim() !== '') {
                    domains.push({
                        name: nameInput.value.trim(),
                        compliance: parseInt(complianceInput.value) || 0
                    });
                }
            });

            return domains;
        }

        // Toggle controls panel in Add New Framework modal
        function toggleNewFrameworkControlsPanel() {
            const controlsList = document.getElementById('newFrameworkControlsList');
            const isHidden = controlsList.style.display === 'none';

            if (isHidden) {
                controlsList.style.display = 'block';
                populateNewFrameworkControls();
            } else {
                controlsList.style.display = 'none';
            }
        }

        // Populate controls in Add New Framework modal
        function populateNewFrameworkControls() {
            const controlsList = document.getElementById('newFrameworkControlsList');

            // Extract unique controls from existing frameworks
            const controlsMap = new Map();

            frameworks.forEach(framework => {
                if (framework.controlsData && Array.isArray(framework.controlsData)) {
                    framework.controlsData.forEach(control => {
                        if (control && control.id) {
                            controlsMap.set(control.id, control);
                        }
                    });
                }
            });

            const uniqueControls = Array.from(controlsMap.values());

            if (uniqueControls.length === 0) {
                controlsList.innerHTML = '<p class="text-sm text-gray-500">No controls available. Add controls after creating the framework.</p>';
                return;
            }

            // Render checkboxes for each control
            let controlsHtml = '';
            uniqueControls.forEach(control => {
                controlsHtml += `
                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" class="new-framework-control-checkbox h-4 w-4 text-indigo-600 rounded"
                            data-control-id="${control.id}" data-control-name="${control.name || 'Unknown'}" />
                        <span class="ml-2 text-sm text-gray-700">${control.name || 'Unknown Control'}</span>
                    </label>
                `;
            });

            controlsList.innerHTML = controlsHtml;

            // Add event listeners to update total controls count
            document.querySelectorAll('.new-framework-control-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateNewFrameworkTotalControls);
            });
        }

        // Update total controls count when checkboxes change
        function updateNewFrameworkTotalControls() {
            const selectedCount = document.querySelectorAll('.new-framework-control-checkbox:checked').length;
            document.getElementById('newFrameworkTotalControls').value = selectedCount;
        }

        // Get selected controls from Add New Framework modal
        function getNewFrameworkSelectedControls() {
            const selectedCheckboxes = document.querySelectorAll('.new-framework-control-checkbox:checked');
            const selectedControls = [];

            selectedCheckboxes.forEach(checkbox => {
                const controlId = checkbox.getAttribute('data-control-id');
                const controlName = checkbox.getAttribute('data-control-name');

                // Find the full control object from frameworks
                let controlObj = null;
                for (let framework of frameworks) {
                    if (framework.controlsData && Array.isArray(framework.controlsData)) {
                        controlObj = framework.controlsData.find(c => String(c.id) === String(controlId));
                        if (controlObj) break;
                    }
                }

                if (controlObj) {
                    selectedControls.push(controlObj);
                } else {
                    // Create a minimal control object if not found
                    selectedControls.push({
                        id: controlId,
                        name: controlName
                    });
                }
            });

            return selectedControls;
        }

        // Handle save framework form submission - Following admin.html pattern
        function handleSaveFramework(event) {
            event.preventDefault();

            // Validate form
            if (!validateNewFrameworkForm()) return;

            // Collect framework data following admin.html pattern
            const frameworkData = collectNewFrameworkData();

            console.log('ðŸ“ Creating new framework:', frameworkData.name);
            console.log('ðŸ“Š Total controls:', frameworkData.controls);
            console.log('ðŸ’¾ Framework data:', frameworkData);

            // Send to backend via postMessage
            window.parent.postMessage({ action: 'addFramework', payload: frameworkData }, '*');

            // Close modal
            closeAddFrameworkModal();
        }

        // Validate new framework form - Following admin.html pattern
        function validateNewFrameworkForm() {
            const name = document.getElementById('newFrameworkName').value.trim();
            const description = document.getElementById('newFrameworkDescription').value.trim();
            const status = document.getElementById('newFrameworkStatus').value;
            const totalControls = document.getElementById('newFrameworkTotalControls').value;

            if (!name) {
                alert('Please enter a framework name');
                document.getElementById('newFrameworkName').focus();
                return false;
            }
            if (!description) {
                alert('Please enter a description');
                return false;
            }
            if (!status) {
                alert('Please select a status');
                return false;
            }
            if (!totalControls || totalControls < 0) {
                alert('Please enter a valid number of controls');
                return false;
            }
            return true;
        }

        // Collect new framework data - Following admin.html pattern
        function collectNewFrameworkData() {
            // Get domains
            const domains = getDomainsFromForm('newFrameworkDomains');

            // Calculate average compliance
            let totalCompliance = 0;
            domains.forEach(domain => {
                totalCompliance += domain.compliance;
            });
            const compliance = domains.length > 0 ? Math.round(totalCompliance / domains.length) : 0;

            // Get selected controls
            const selectedControls = getNewFrameworkSelectedControls();

            // Create current date for last assessment
            const currentDate = new Date();
            const formattedDate = currentDate.toISOString().split('T')[0];

            return {
                id: frameworks.length + 1,
                name: document.getElementById('newFrameworkName').value,
                description: document.getElementById('newFrameworkDescription').value,
                controls: selectedControls.length > 0 ? selectedControls : parseInt(document.getElementById('newFrameworkTotalControls').value),
                controlsData: selectedControls,
                compliance,
                status: document.getElementById('newFrameworkStatus').value,
                readiness: document.querySelector('input[name="readiness"]:checked').value,
                lastAssessment: formattedDate,
                domains,
                activities: [
                    { date: formattedDate, action: 'addFramework', user: 'Admin User' }
                ]
            };
        }

        // Helper function to get controls from the displayed list in the modal
        function getDisplayedFrameworkControls() {
            const controlsList = document.getElementById('frameworkControlsList');
            const controlItems = controlsList.querySelectorAll('[data-control-id]');
            const displayedControls = [];

            controlItems.forEach(item => {
                const controlId = item.getAttribute('data-control-id');
                // Find the control in the global controls array or framework controls
                const control = controls.find(c => String(c.id) === String(controlId));
                if (control) {
                    displayedControls.push(control);
                }
            });

            console.log('ðŸ“‹ Displayed controls in modal:', displayedControls.length);
            return displayedControls;
        }

        // Handle update framework form submission
        function handleUpdateFramework(event) {
            event.preventDefault();

            const id = document.getElementById('editFrameworkId').value; // keep as string

            const name = document.getElementById('editFrameworkName').value;
            const description = document.getElementById('editFrameworkDescription').value;
            const status = document.getElementById('editFrameworkStatus').value;
            const readiness = document.querySelector('input[name="editReadiness"]:checked').value;
            const domains = getDomainsFromForm('editFrameworkDomains');

            console.log('ðŸ“ Domains collected from form:', domains);
            console.log('ðŸ“ Domains count:', domains.length);
            console.log('ðŸ“ Domains details:', JSON.stringify(domains));

            // Handle uploaded files
            const fileInput = document.getElementById('editFrameworkDocuments');
            const uploadedFiles = fileInput.files;

            const compliance = domains.length
                ? Math.round(domains.reduce((sum, d) => sum + d.compliance, 0) / domains.length)
                : 0;

            const formattedDate = new Date().toISOString().split('T')[0];

            const framework = frameworks.find(f => String(f._id) === id || String(f.id) === id);
            if (!framework) return;

            console.log('ðŸ“ Framework before update:', framework);
            console.log('ðŸ“ Framework domains before update:', framework.domains);

            // Get framework controls - prioritize the displayed controls in the modal
            let frameworkControls = [];

            // First, try to get controls from the displayed list in the modal
            const displayedControls = getDisplayedFrameworkControls();
            if (displayedControls.length > 0) {
                frameworkControls = displayedControls;
                console.log('âœ… Got controls from displayed list in modal');
            } else if (framework.controls && Array.isArray(framework.controls)) {
                // Fallback to framework.controls if nothing is displayed
                frameworkControls = [...framework.controls];
                console.log('âœ… Got controls from framework.controls array (fallback)');
            } else if (framework.controlsData && Array.isArray(framework.controlsData)) {
                // Fallback to framework.controlsData if nothing is displayed
                frameworkControls = [...framework.controlsData];
                console.log('âœ… Got controls from framework.controlsData array (fallback)');
            }

            console.log('ðŸ“ Updating framework:', framework.name);
            console.log('ðŸ“Š Framework controls:', framework.controls);
            console.log('ðŸ“Š Framework controlsData:', framework.controlsData);
            console.log('ðŸ“ˆ Controls to send:', frameworkControls.length);
            console.log('ðŸ“‹ Full controls array:', frameworkControls);

            // If files are uploaded, convert them to base64 and send to Wix for upload
            if (uploadedFiles.length > 0) {
                // Convert files to base64 for transmission
                const filePromises = Array.from(uploadedFiles).map(file => convertFileToBase64(file));

                Promise.all(filePromises).then(fileDataArray => {
                    // Send files to Wix backend for upload
                    const fileUploadData = {
                        frameworkId: framework._id || id,
                        files: fileDataArray
                    };

                    const updatedFrameworkData = {
                        ...framework,
                        _id: framework._id || id,
                        name,
                        description,
                        controls: frameworkControls, // Use the actual controls array, not the count
                        compliance,
                        status,
                        readiness,
                        domains,
                        frameworkControls, // Include the controls array for frontend use
                        controlsData: frameworkControls, // Include controls data for database storage
                        comments: framework.comments || [], // Preserve existing comments
                        activities: [
                            { date: formattedDate, action: `Framework updated with ${uploadedFiles.length} document(s)`, user: 'Admin User' },
                            ...(framework.activities || [])
                        ]
                    };

                    console.log('ðŸ“ Updated framework data with comments:', updatedFrameworkData.comments ? updatedFrameworkData.comments.length : 0);
                    console.log('ðŸ—‚ï¸ Updated framework data with domains:', updatedFrameworkData.domains ? updatedFrameworkData.domains.length : 0);

                    // Send upload request to Wix backend
                    window.parent.postMessage({
                        action: 'uploadFrameworkFiles',
                        payload: fileUploadData,
                        frameworkData: updatedFrameworkData
                    }, '*');

                    alert(`Uploading ${uploadedFiles.length} document(s)...`);
                    closeEditFrameworkModal();
                }).catch(error => {
                    console.error('Error processing files:', error);
                    alert('Error processing files. Please try again.');
                });
            } else {
                // No files uploaded, just update framework data
                const updatedFramework = {
                    ...framework,
                    _id: framework._id || id,
                    name,
                    description,
                    controls: frameworkControls, // Use the actual controls array, not the count
                    compliance,
                    status,
                    readiness,
                    domains,
                    frameworkControls, // Include the controls array for frontend use
                    controlsData: frameworkControls, // Include controls data for database storage
                    comments: framework.comments || [], // Preserve existing comments
                    activities: [
                        { date: formattedDate, action: 'Framework updated', user: 'Admin User' },
                        ...(framework.activities || [])
                    ]
                };

                console.log('ðŸ“ Updated framework data with comments:', updatedFramework.comments ? updatedFramework.comments.length : 0);
                console.log('ðŸ—‚ï¸ Updated framework data with domains:', updatedFramework.domains ? updatedFramework.domains.length : 0);

                window.parent.postMessage({ action: 'updateFramework', payload: updatedFramework }, '*');
                closeEditFrameworkModal();
            }
        }

        // Helper function to convert file to base64 for transmission to Wix
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result, // base64 data
                        uploadDate: new Date().toISOString()
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Confirm delete framework
        function confirmDeleteFramework() {
            const id = document.getElementById('editFrameworkId').value;
            const framework = frameworks.find(f => String(f._id) === id || String(f.id) === id);

            if (!framework) return;

            document.getElementById('confirmDeleteText').textContent =
                `Are you sure you want to delete the framework "${framework.name}"? This action cannot be undone.`;

            document.getElementById('confirmDeleteBtn').onclick = function () {
                deleteFramework(framework._id || framework.id);
            };

            closeEditFrameworkModal();
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }

        function deleteFramework(id) {
            if (!id) return;
            window.parent.postMessage({ action: 'deleteFramework', payload: { _id: id } }, '*');
            closeConfirmDeleteModal();
        }


        // Toggle framework readiness (from modal)
        function toggleFrameworkReadiness() {
            // Get the framework ID from the button
            const frameworkIdStr = document.getElementById('toggleReadinessBtn').getAttribute('data-framework-id');

            // Find the framework using string comparison to handle both string and number IDs
            const framework = frameworks.find(f =>
                String(f.id) === frameworkIdStr ||
                String(f._id) === frameworkIdStr ||
                String(f.customId) === frameworkIdStr
            );

            if (!framework) {
                console.warn('Framework not found for ID:', frameworkIdStr);
                return;
            }

            // Toggle readiness
            const newReadiness = framework.readiness === 'ready' ? 'not-ready' : 'ready';

            // Send update to backend
            window.parent.postMessage({
                action: 'updateFrameworkReadiness',
                payload: {
                    id: framework._id || framework.id,
                    readiness: newReadiness
                }
            }, '*');

            // Update local data
            const frameworkIndex = frameworks.findIndex(f =>
                String(f.id) === frameworkIdStr ||
                String(f._id) === frameworkIdStr ||
                String(f.customId) === frameworkIdStr
            );

            if (frameworkIndex !== -1) {
                frameworks[frameworkIndex].readiness = newReadiness;

                // Create current date for activity
                const currentDate = new Date();
                const formattedDate = currentDate.toISOString().split('T')[0];

                // Create new activity
                const newActivity = {
                    date: formattedDate,
                    action: `Framework marked as ${newReadiness === 'ready' ? 'ready' : 'not ready'}`,
                    user: 'Admin User'
                };

                // Add activity (ensure activities array exists)
                if (!frameworks[frameworkIndex].activities || !Array.isArray(frameworks[frameworkIndex].activities)) {
                    frameworks[frameworkIndex].activities = [];
                }
                frameworks[frameworkIndex].activities = [newActivity, ...frameworks[frameworkIndex].activities];

                // Update UI
                renderFrameworksTable(frameworks);

                // Update the modal with the updated framework data
                openFrameworkModal(frameworks[frameworkIndex]);
            }
        }

        // CONTROLS MANAGEMENT FUNCTIONS

        // Open Add Control Modal
        function openAddControlModal() {
            console.log('ðŸŽ›ï¸ Opening Add Control Modal');

            // Close edit framework modal first
            closeEditFrameworkModal();

            // Populate framework checkboxes
            populateFrameworkCheckboxes();

            // Clear form
            document.getElementById('addControlForm').reset();

            // Open modal
            document.getElementById('addControlModal').style.display = 'block';
        }

        // Close Add Control Modal
        function closeAddControlModal() {
            document.getElementById('addControlModal').style.display = 'none';

            // Reopen edit framework modal if there's a framework being edited
            const frameworkId = document.getElementById('editFrameworkId');
            if (frameworkId && frameworkId.value) {
                document.getElementById('editFrameworkModal').style.display = 'block';
            }
        }

        // Populate framework checkboxes in Add Control modal
        function populateFrameworkCheckboxes() {
            const container = document.getElementById('frameworkCheckboxes');
            container.innerHTML = '';

            if (!frameworks || frameworks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No frameworks available</p>';
                return;
            }

            // Get current framework ID being edited (if any)
            const currentFrameworkId = document.getElementById('editFrameworkId') ?
                document.getElementById('editFrameworkId').value : null;

            frameworks.forEach(framework => {
                const frameworkId = framework._id || framework.id;
                const isCurrentFramework = currentFrameworkId && String(frameworkId) === String(currentFrameworkId);

                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center space-x-2';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="fw_${frameworkId}"
                           value="${frameworkId}"
                           class="rounded border-gray-300"
                           ${isCurrentFramework ? 'checked' : ''}>
                    <label for="fw_${frameworkId}" class="text-sm text-gray-700">
                        ${framework.name}
                    </label>
                `;
                container.appendChild(checkboxDiv);
            });
        }

        // Handle Add Control form submission
        function handleAddControl(event) {
            event.preventDefault();

            const name = document.getElementById('newControlName').value;
            const description = document.getElementById('newControlDescription').value;
            const type = document.getElementById('newControlType').value;
            const status = document.getElementById('newControlStatus').value;
            const owner = document.getElementById('newControlOwner').value;
            const reviewFrequency = document.getElementById('newControlReviewFrequency').value;

            // Get selected frameworks
            const selectedFrameworks = [];
            const checkboxes = document.querySelectorAll('#frameworkCheckboxes input[type="checkbox"]:checked');

            console.log('ðŸ” Total checkboxes found:', document.querySelectorAll('#frameworkCheckboxes input[type="checkbox"]').length);
            console.log('âœ… Checked checkboxes found:', checkboxes.length);

            checkboxes.forEach(checkbox => {
                console.log('ðŸ“Œ Selected framework ID:', checkbox.value, 'Name:', checkbox.nextElementSibling?.textContent);
                selectedFrameworks.push(checkbox.value);
            });

            if (selectedFrameworks.length === 0) {
                alert('Please select at least one framework for this control.');
                console.log('âŒ No frameworks selected');
                return;
            }

            const newControl = {
                id: Date.now(), // Temporary ID
                name,
                description,
                type,
                status,
                owner,
                reviewFrequency,
                frameworks: selectedFrameworks,
                createdDate: new Date().toISOString().split('T')[0]
            };

            console.log('ðŸ’¾ Adding new control:', newControl);
            console.log('ðŸ“‹ Selected frameworks:', selectedFrameworks);

            // Add to global controls array
            controls.push(newControl);

            // Add this control to ALL selected frameworks
            selectedFrameworks.forEach(selectedFrameworkId => {
                const framework = frameworks.find(f =>
                    String(f._id) === String(selectedFrameworkId) || String(f.id) === String(selectedFrameworkId)
                );

                if (framework) {
                    // Ensure controls is an array
                    if (!framework.controls || !Array.isArray(framework.controls)) {
                        framework.controls = [];
                    }

                    // Check if control already exists to avoid duplicates
                    const existingControl = framework.controls.find(c => c.id === newControl.id);
                    if (!existingControl) {
                        // Add control to framework's controls array
                        framework.controls.push(newControl);
                        console.log('âœ… Control added to framework:', framework.name);
                    } else {
                        console.log('âš ï¸ Control already exists in framework:', framework.name);
                    }
                } else {
                    console.log('âš ï¸ Framework not found for ID:', selectedFrameworkId);
                }
            });

            // Send control data to backend via postMessage
            window.parent.postMessage({
                action: 'addControl',
                payload: newControl
            }, '*');

            // Close add control modal and return to edit framework modal
            closeAddControlModal();

            // Refresh the controls display in the edit modal
            setTimeout(() => {
                populateFrameworkControls();
            }, 100);
        }

        // Populate controls list in framework edit modal
        function populateFrameworkControls() {
            const currentFrameworkId = document.getElementById('editFrameworkId').value;
            const controlsList = document.getElementById('frameworkControlsList');
            const emptyState = document.getElementById('frameworkControlsEmpty');

            if (!currentFrameworkId) {
                controlsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            // Get current framework
            const currentFramework = frameworks.find(f =>
                String(f._id) === currentFrameworkId || String(f.id) === currentFrameworkId
            );

            console.log('ðŸ” Populating controls for framework:', currentFrameworkId);
            console.log('ðŸ“‹ Current framework:', currentFramework);
            console.log('ðŸ“Š Framework controls:', currentFramework?.controls);
            console.log('ðŸ“Š Framework controlsData:', currentFramework?.controlsData);

            let frameworkControls = [];

            // Get controls from framework's controls array (newly added controls) OR controlsData (database field)
            if (currentFramework) {
                // Try controls first, then controlsData
                const controlsArray = currentFramework.controls || currentFramework.controlsData || [];
                if (Array.isArray(controlsArray)) {
                    frameworkControls = [...controlsArray];
                    console.log('âœ… Got controls from framework:', frameworkControls.length);
                }
            }

            // Also get controls from global controls array that are associated with this framework
            if (controls && controls.length > 0) {
                const globalFrameworkControls = controls.filter(control =>
                    control.frameworks && control.frameworks.includes(currentFrameworkId)
                );

                console.log('ðŸŒ Global controls for this framework:', globalFrameworkControls.length);

                // Merge with framework controls, avoiding duplicates
                globalFrameworkControls.forEach(globalControl => {
                    const exists = frameworkControls.some(fwControl => fwControl.id === globalControl.id);
                    if (!exists) {
                        frameworkControls.push(globalControl);
                    }
                });
            }

            console.log('ðŸ“ˆ Total controls to display:', frameworkControls.length);

            // Update the Total Controls field with the actual count
            const totalControlsInput = document.getElementById('editFrameworkControls');
            if (totalControlsInput) {
                totalControlsInput.value = frameworkControls.length;
                console.log('âœ… Updated Total Controls field to:', frameworkControls.length);
            }

            if (frameworkControls.length === 0) {
                controlsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            controlsList.innerHTML = '';

            frameworkControls.forEach(control => {
                const controlDiv = document.createElement('div');
                controlDiv.className = 'bg-white border rounded-lg p-3 flex justify-between items-start';
                controlDiv.setAttribute('data-control-id', control.id); // Add data attribute for retrieval

                const statusClass = getControlStatusClass(control.status);
                const typeIcon = getControlTypeIcon(control.type);

                controlDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <i class="${typeIcon} text-gray-500"></i>
                            <h5 class="font-medium text-gray-900">${control.name}</h5>
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                ${control.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${control.description || 'No description'}</p>
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            <span><i class="fas fa-user mr-1"></i>${control.owner || 'Unassigned'}</span>
                            <span><i class="fas fa-clock mr-1"></i>${control.reviewFrequency}</span>
                            <span><i class="fas fa-calendar mr-1"></i>${control.createdDate}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editControl('${control.id}')"
                                class="text-indigo-600 hover:text-indigo-900 text-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeControlFromFramework('${control.id}', '${currentFrameworkId}')"
                                class="text-red-600 hover:text-red-900 text-sm">
                            <i class="fas fa-unlink"></i>
                        </button>
                    </div>
                `;

                controlsList.appendChild(controlDiv);
            });
        }

        // Helper functions for control display
        function getControlStatusClass(status) {
            switch (status) {
                case 'Implemented': return 'bg-green-100 text-green-800';
                case 'Partially Implemented': return 'bg-yellow-100 text-yellow-800';
                case 'Not Implemented': return 'bg-red-100 text-red-800';
                case 'Not Applicable': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getControlTypeIcon(type) {
            switch (type) {
                case 'Preventive': return 'fas fa-shield-alt';
                case 'Detective': return 'fas fa-search';
                case 'Corrective': return 'fas fa-tools';
                case 'Administrative': return 'fas fa-file-alt';
                case 'Technical': return 'fas fa-cog';
                case 'Physical': return 'fas fa-lock';
                default: return 'fas fa-shield-alt';
            }
        }

        // Edit control function
        function editControl(controlId) {
            console.log('âœï¸ Editing control:', controlId);

            // Find the control in global controls array or current framework
            let control = controls.find(c => c.id == controlId);

            // If not found in global controls, check current framework's controls
            if (!control) {
                const currentFrameworkId = document.getElementById('editFrameworkId').value;
                const currentFramework = frameworks.find(f =>
                    String(f._id) === currentFrameworkId || String(f.id) === currentFrameworkId
                );

                if (currentFramework && currentFramework.controls) {
                    control = currentFramework.controls.find(c => c.id == controlId);
                }
            }

            if (!control) {
                alert('Control not found');
                return;
            }

            // Close edit framework modal
            closeEditFrameworkModal();

            // Populate edit control form
            document.getElementById('editControlId').value = control.id;
            document.getElementById('editControlName').value = control.name || '';
            document.getElementById('editControlDescription').value = control.description || '';
            document.getElementById('editControlType').value = control.type || 'Preventive';
            document.getElementById('editControlStatus').value = control.status || 'Not Implemented';
            document.getElementById('editControlOwner').value = control.owner || '';
            document.getElementById('editControlReviewFrequency').value = control.reviewFrequency || 'Annual';

            // Populate framework checkboxes for edit
            populateEditControlFrameworkCheckboxes(control.frameworks || []);

            // Open edit control modal
            document.getElementById('editControlModal').style.display = 'block';
        }

        // Populate framework checkboxes in Edit Control modal
        function populateEditControlFrameworkCheckboxes(selectedFrameworks) {
            const container = document.getElementById('editFrameworkCheckboxes');
            container.innerHTML = '';

            if (!frameworks || frameworks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No frameworks available</p>';
                return;
            }

            frameworks.forEach(framework => {
                const frameworkId = framework._id || framework.id;
                const isSelected = selectedFrameworks.includes(String(frameworkId));

                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center space-x-2';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="edit_fw_${frameworkId}"
                           value="${frameworkId}"
                           class="rounded border-gray-300"
                           ${isSelected ? 'checked' : ''}>
                    <label for="edit_fw_${frameworkId}" class="text-sm text-gray-700">
                        ${framework.name}
                    </label>
                `;
                container.appendChild(checkboxDiv);
            });
        }

        // Close Edit Control Modal
        function closeEditControlModal() {
            document.getElementById('editControlModal').style.display = 'none';

            // Reopen edit framework modal if there's a framework being edited
            const frameworkId = document.getElementById('editFrameworkId');
            if (frameworkId && frameworkId.value) {
                document.getElementById('editFrameworkModal').style.display = 'block';
            }
        }

        // Handle Edit Control form submission (for form submit event)
        function handleEditControl(event) {
            event.preventDefault();
            handleEditControlSubmit();
        }

        // Handle Edit Control submission (for button click)
        function handleEditControlSubmit() {
            console.log('ðŸ”„ Processing control update...');

            const controlId = document.getElementById('editControlId').value;
            const name = document.getElementById('editControlName').value.trim();
            const description = document.getElementById('editControlDescription').value.trim();
            const type = document.getElementById('editControlType').value;
            const status = document.getElementById('editControlStatus').value;
            const owner = document.getElementById('editControlOwner').value.trim();
            const reviewFrequency = document.getElementById('editControlReviewFrequency').value;

            // Validation
            if (!name) {
                alert('Please enter a control name.');
                return;
            }

            // Get selected frameworks
            const selectedFrameworks = [];
            const checkboxes = document.querySelectorAll('#editFrameworkCheckboxes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedFrameworks.push(checkbox.value);
            });

            if (selectedFrameworks.length === 0) {
                alert('Please select at least one framework for this control.');
                return;
            }

            // Find original control to preserve creation date
            let originalControl = controls.find(c => c.id == controlId);
            if (!originalControl) {
                const currentFrameworkId = document.getElementById('editFrameworkId').value;
                const currentFramework = frameworks.find(f =>
                    String(f._id) === currentFrameworkId || String(f.id) === currentFrameworkId
                );
                if (currentFramework && currentFramework.controls) {
                    originalControl = currentFramework.controls.find(c => c.id == controlId);
                }
            }

            const updatedControl = {
                id: parseInt(controlId),
                name,
                description,
                type,
                status,
                owner,
                reviewFrequency,
                frameworks: selectedFrameworks,
                createdDate: originalControl ? originalControl.createdDate : new Date().toISOString().split('T')[0]
            };

            console.log('ðŸ’¾ Updating control:', updatedControl);

            // Update in global controls array
            const controlIndex = controls.findIndex(c => c.id == controlId);
            if (controlIndex !== -1) {
                controls[controlIndex] = updatedControl;
                console.log('âœ… Updated in global controls array');
            }

            // Update in current framework's controls array
            const currentFrameworkId = document.getElementById('editFrameworkId').value;
            const currentFramework = frameworks.find(f =>
                String(f._id) === currentFrameworkId || String(f.id) === currentFrameworkId
            );

            if (currentFramework && currentFramework.controls) {
                const frameworkControlIndex = currentFramework.controls.findIndex(c => c.id == controlId);
                if (frameworkControlIndex !== -1) {
                    currentFramework.controls[frameworkControlIndex] = updatedControl;
                    console.log('âœ… Updated in framework controls array');
                }
            }

            // Send to Wix to save
            window.parent.postMessage({ action: 'updateControl', payload: updatedControl }, '*');
            console.log('ðŸ“¤ Sent update to Wix backend');

            // Close edit control modal and return to edit framework modal
            closeEditControlModal();

            // Refresh the controls display in the edit modal
            setTimeout(() => {
                populateFrameworkControls();
                console.log('ðŸ”„ Refreshed framework controls display');
            }, 100);
        }

        // Confirm delete control
        function confirmDeleteControl() {
            console.log('ðŸ—‘ï¸ Delete control requested');

            const controlId = document.getElementById('editControlId').value;
            const controlName = document.getElementById('editControlName').value;

            if (!controlId) {
                alert('Error: No control selected for deletion.');
                return;
            }

            if (!confirm(`Are you sure you want to delete the control "${controlName}"?\n\nThis will remove it from all frameworks and cannot be undone.`)) {
                console.log('âŒ Delete cancelled by user');
                return;
            }

            console.log('ðŸ—‘ï¸ Deleting control:', controlId, controlName);

            // Remove from global controls array
            const originalLength = controls.length;
            controls = controls.filter(c => c.id != controlId);
            console.log(`ðŸ—‘ï¸ Removed from global controls: ${originalLength} â†’ ${controls.length}`);

            // Remove from all frameworks
            frameworks.forEach(framework => {
                if (framework.controls && Array.isArray(framework.controls)) {
                    const beforeLength = framework.controls.length;
                    framework.controls = framework.controls.filter(c => c.id != controlId);
                    if (beforeLength !== framework.controls.length) {
                        console.log(`ðŸ—‘ï¸ Removed from framework "${framework.name}": ${beforeLength} â†’ ${framework.controls.length}`);
                    }
                }
            });

            // Send delete request to Wix
            window.parent.postMessage({
                action: 'deleteControl',
                payload: { controlId: parseInt(controlId) }
            }, '*');
            console.log('ðŸ“¤ Sent delete request to Wix backend');

            // Close modal and refresh display
            closeEditControlModal();

            setTimeout(() => {
                populateFrameworkControls();
                console.log('ðŸ”„ Refreshed framework controls display after deletion');
            }, 100);
        }

        // Remove control from framework
        function removeControlFromFramework(controlId, frameworkId) {
            if (!confirm('Are you sure you want to remove this control from the framework?')) {
                return;
            }

            const control = controls.find(c => c.id == controlId);
            if (control && control.frameworks) {
                control.frameworks = control.frameworks.filter(fwId => fwId !== frameworkId);

                // If control is no longer associated with any frameworks, remove it entirely
                if (control.frameworks.length === 0) {
                    controls = controls.filter(c => c.id != controlId);
                }

                // Send update to Wix
                window.parent.postMessage({
                    action: 'updateControl',
                    payload: { controlId, frameworkId, action: 'remove' }
                }, '*');

                // Refresh display
                populateFrameworkControls();
            }
        }

        // Mobile-specific functions
        function isMobileDevice() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Mobile touch feedback
        function addMobileTouchFeedback() {
            if (!isMobileDevice()) return;

            // Add touch feedback to all interactive elements
            document.addEventListener('touchstart', function(e) {
                const target = e.target.closest('.btn, button, .cursor-pointer, .risk-matrix-cell');
                if (target) {
                    target.style.transform = 'scale(0.95)';
                    target.style.transition = 'transform 0.1s ease';
                }
            });

            document.addEventListener('touchend', function(e) {
                const target = e.target.closest('.btn, button, .cursor-pointer, .risk-matrix-cell');
                if (target) {
                    setTimeout(() => {
                        target.style.transform = '';
                    }, 100);
                }
            });
        }

        // Enhanced Navigation Management
        function setActiveNav(activeNavId) {
            // Remove active class from all navigation items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                // Hide chevron for inactive items
                const chevron = item.querySelector('.fa-chevron-right');
                if (chevron) {
                    chevron.parentElement.style.opacity = '0';
                }
            });

            // Add active class to selected navigation item
            const activeNav = document.getElementById(activeNavId);
            if (activeNav) {
                activeNav.classList.add('active');
                // Show chevron for active item
                const chevron = activeNav.querySelector('.fa-chevron-right');
                if (chevron) {
                    chevron.parentElement.style.opacity = '1';
                }
            }

            // Close mobile sidebar after selection
            if (isMobileDevice()) {
                setTimeout(() => {
                    closeSidebar();
                }, 300);
            }
        }

        // Initialize navigation on page load
        function initializeNavigation() {
            // Set default active navigation
            const defaultNav = document.getElementById('navRisk');
            if (defaultNav) {
                setActiveNav('navRisk');
            }

            // Add hover effects for chevron arrows
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const chevron = item.querySelector('.fa-chevron-right');
                if (chevron) {
                    item.addEventListener('mouseenter', () => {
                        if (!item.classList.contains('active')) {
                            chevron.parentElement.style.opacity = '0.5';
                        }
                    });

                    item.addEventListener('mouseleave', () => {
                        if (!item.classList.contains('active')) {
                            chevron.parentElement.style.opacity = '0';
                        }
                    });
                }
            });
        }

        // Mobile sidebar management
        function initializeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const mobileMenuButton = document.getElementById('mobileMenuButton');

            if (isMobileDevice()) {
                // Ensure sidebar starts closed on mobile
                sidebar.classList.add('collapsed');
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }

            // Handle orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    if (isMobileDevice()) {
                        closeSidebar();
                    }
                    window.scrollTo(0, 0);
                }, 100);
            });
        }

        // Enhanced sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            if (isMobileDevice()) {
                const isActive = sidebar.classList.contains('active');

                if (isActive) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            }
        }

        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.add('active');
            sidebar.classList.remove('collapsed');
            overlay.classList.add('active');

            // Prevent body scroll when sidebar is open
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.remove('active');
            sidebar.classList.add('collapsed');
            overlay.classList.remove('active');

            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Mobile-optimized modal handling
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';

                if (isMobileDevice()) {
                    // Prevent background scroll on mobile
                    document.body.style.overflow = 'hidden';

                    // Auto-focus first input on mobile (with delay to prevent keyboard issues)
                    setTimeout(() => {
                        const firstInput = modal.querySelector('input, textarea, select');
                        if (firstInput && firstInput.type !== 'hidden') {
                            firstInput.focus();
                        }
                    }, 300);
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';

                if (isMobileDevice()) {
                    // Restore background scroll
                    document.body.style.overflow = '';
                }
            }
        }

        // Custom Alert Functions - Replace browser alert with custom modal
        function showCustomAlert(message) {
            const modal = document.getElementById('customAlertModal');
            const messageElement = document.getElementById('customAlertMessage');

            if (modal && messageElement) {
                messageElement.textContent = message;
                modal.style.display = 'block';

                // Focus the OK button for accessibility
                const okButton = modal.querySelector('button');
                if (okButton) {
                    setTimeout(() => okButton.focus(), 100);
                }
            }
        }

        function closeCustomAlert() {
            const modal = document.getElementById('customAlertModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Description Modal Functions
        function showDescriptionModal(title, description) {
            const modal = document.getElementById('descriptionModal');
            const titleElement = document.getElementById('descriptionModalTitle');
            const contentElement = document.getElementById('descriptionModalContent');

            if (modal && titleElement && contentElement) {
                titleElement.textContent = title;
                contentElement.textContent = description;
                modal.style.display = 'block';
            }
        }

        function closeDescriptionModal() {
            const modal = document.getElementById('descriptionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Mobile-optimized table scrolling
        function initializeMobileTableScroll() {
            const tables = document.querySelectorAll('.responsive-table');

            tables.forEach(table => {
                if (isMobileDevice()) {
                    // Add scroll indicators for mobile
                    table.addEventListener('scroll', function() {
                        const scrollLeft = this.scrollLeft;
                        const scrollWidth = this.scrollWidth;
                        const clientWidth = this.clientWidth;

                        // Add visual indicators for scrollable content
                        if (scrollLeft > 0) {
                            this.classList.add('scrolled-left');
                        } else {
                            this.classList.remove('scrolled-left');
                        }

                        if (scrollLeft < scrollWidth - clientWidth - 1) {
                            this.classList.add('scrolled-right');
                        } else {
                            this.classList.remove('scrolled-right');
                        }
                    });
                }
            });
        }

        // Mobile-specific initialization
        function initializeMobileOptimizations() {
            if (isMobileDevice()) {
                console.log('ðŸ“± Initializing mobile optimizations...');

                // Add mobile class to body
                document.body.classList.add('mobile-device');

                // Initialize mobile features
                addMobileTouchFeedback();
                initializeMobileSidebar();
                initializeMobileTableScroll();

                // Optimize viewport for mobile
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover');
                }

                console.log('âœ… Mobile optimizations initialized');
            }
        }

        // Initialize mobile optimizations when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileOptimizations();
            initializeNavigation();
        });

        // Re-initialize on window resize
        window.addEventListener('resize', function() {
            if (isMobileDevice()) {
                initializeMobileOptimizations();
            }
        });

        // Document viewing and downloading functions
        window.viewDocument = function(url, name, type) {
            console.log('ðŸ“„ Viewing document:', name, type);

            if (url.startsWith('data:')) {
                // For data URLs, open in new tab
                const newWindow = window.open();
                if (newWindow) {
                    if (type && type.includes('pdf')) {
                        // For PDFs, embed in an iframe
                        newWindow.document.write(`
                            <html>
                                <head>
                                    <title>${name}</title>
                                    <style>
                                        body { margin: 0; padding: 0; }
                                        iframe { width: 100%; height: 100vh; border: none; }
                                    </style>
                                </head>
                                <body>
                                    <iframe src="${url}" type="application/pdf"></iframe>
                                </body>
                            </html>
                        `);
                    } else if (type && type.includes('image')) {
                        // For images, display directly
                        newWindow.document.write(`
                            <html>
                                <head>
                                    <title>${name}</title>
                                    <style>
                                        body { margin: 0; padding: 20px; text-align: center; background: #f5f5f5; }
                                        img { max-width: 100%; height: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                                        h3 { color: #333; margin-bottom: 20px; }
                                    </style>
                                </head>
                                <body>
                                    <h3>${name}</h3>
                                    <img src="${url}" alt="${name}" />
                                </body>
                            </html>
                        `);
                    } else {
                        // For other file types, try to display or show download option
                        newWindow.document.write(`
                            <html>
                                <head>
                                    <title>${name}</title>
                                    <style>
                                        body { font-family: Arial, sans-serif; padding: 40px; text-align: center; }
                                        .container { max-width: 600px; margin: 0 auto; }
                                        .file-icon { font-size: 64px; color: #6b7280; margin-bottom: 20px; }
                                        .file-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                                        .file-info { color: #6b7280; margin-bottom: 30px; }
                                        .download-btn {
                                            background: #4f46e5; color: white; padding: 12px 24px;
                                            border: none; border-radius: 6px; font-size: 16px;
                                            cursor: pointer; text-decoration: none; display: inline-block;
                                        }
                                        .download-btn:hover { background: #4338ca; }
                                    </style>
                                </head>
                                <body>
                                    <div class="container">
                                        <div class="file-icon">ðŸ“„</div>
                                        <div class="file-name">${name}</div>
                                        <div class="file-info">This file type cannot be previewed in the browser</div>
                                        <a href="${url}" download="${name}" class="download-btn">
                                            <i class="fas fa-download"></i> Download File
                                        </a>
                                    </div>
                                </body>
                            </html>
                        `);
                    }
                } else {
                    alert('Unable to open document viewer. Please check your popup blocker settings.');
                }
            } else {
                // For regular URLs, open directly
                window.open(url, '_blank');
            }
        };

        window.downloadDocument = function(url, name) {
            console.log('ðŸ’¾ Downloading document:', name);

            try {
                // Create a temporary link element
                const link = document.createElement('a');
                link.href = url;
                link.download = name;
                link.style.display = 'none';

                // Add to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('âœ… Download initiated for:', name);
            } catch (error) {
                console.error('âŒ Error downloading document:', error);
                alert('Error downloading document. Please try again.');
            }
        };

        // Helper function to format file size
        window.formatFileSize = function(bytes) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        // Helper function to format date
        window.formatDate = function(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return 'Invalid date';
            }
        };

        // Assessment Results Functions
        let currentAssessmentForResults = null;

        // View Assessment Results Function
        function viewAssessmentResults() {
            console.log('View assessment results called');

            // Get the current assessment from the details modal
            const titleElement = document.getElementById('assessmentDetailsTitle');
            if (!titleElement) {
                console.error('Assessment title element not found');
                alert('Assessment not found!');
                return;
            }

            const assessmentTitle = titleElement.textContent;
            const assessment = assessments.find(a => a.name === assessmentTitle || a.title === assessmentTitle);

            if (!assessment) {
                console.error('Assessment not found with title:', assessmentTitle);
                alert('Assessment not found!');
                return;
            }

            currentAssessmentForResults = assessment;

            // Show the results modal
            document.getElementById('assessmentResultsModal').style.display = 'block';

            // Set assessment title
            document.getElementById('assessmentResultsTitle').textContent = `Results: ${assessment.name || assessment.title}`;

            // Show loading state
            document.getElementById('resultsLoadingState').classList.remove('hidden');
            document.getElementById('noResultsState').classList.add('hidden');
            document.getElementById('resultsContent').classList.add('hidden');

            // Request assessment results from database
            console.log('Requesting assessment results for:', assessment._id || assessment.id);

            // Send request to database via parent window (Wix)
            window.parent.postMessage({
                action: 'getAssessmentResults',
                payload: {
                    assessmentId: assessment._id || assessment.id,
                    assessmentTitle: assessment.name || assessment.title
                }
            }, '*');
        }

        // Close Assessment Results Modal
        function closeAssessmentResultsModal() {
            document.getElementById('assessmentResultsModal').style.display = 'none';
            currentAssessmentForResults = null;
        }

        // Function to populate assessment results modal
        function populateAssessmentResults(resultsData) {
            console.log('Populating assessment results:', resultsData);

            // Hide loading state
            document.getElementById('resultsLoadingState').classList.add('hidden');

            if (!resultsData || !resultsData.responses || resultsData.responses.length === 0) {
                // Show no results state
                document.getElementById('noResultsState').classList.remove('hidden');
                return;
            }

            // Show results content
            document.getElementById('resultsContent').classList.remove('hidden');

            // Populate assessment overview
            document.getElementById('resultAssessmentName').textContent = resultsData.assessmentTitle || 'Assessment';
            document.getElementById('resultAssessmentDescription').textContent = resultsData.description || 'No description available';

            // Calculate summary statistics using pre-calculated values
            const responses = resultsData.responses;
            const totalQuestions = responses.length > 0 ? (responses[0].totalQuestions || responses[0].answers.length) : 0;
            let totalMaturityScore = 0;
            let totalRisksIdentified = 0;
            let completedResponses = 0;
            let latestSubmission = null;

            responses.forEach(response => {
                if (response.status === 'completed') {
                    completedResponses++;

                    // Use pre-calculated maturity score
                    if (response.maturityScore !== undefined && response.maturityScore !== null) {
                        totalMaturityScore += response.maturityScore;
                    }

                    // Use pre-calculated risks
                    if (response.risksIdentified && Array.isArray(response.risksIdentified)) {
                        totalRisksIdentified += response.risksIdentified.length;
                    }

                    // Track latest submission
                    if (response.submittedAt) {
                        const submissionDate = new Date(response.submittedAt);
                        if (!latestSubmission || submissionDate > latestSubmission) {
                            latestSubmission = submissionDate;
                        }
                    }
                }
            });

            // Calculate average maturity score
            const avgMaturityScore = completedResponses > 0 ? (totalMaturityScore / completedResponses).toFixed(1) : 0;

            // Update summary statistics
            document.getElementById('resultTotalQuestions').textContent = totalQuestions;
            document.getElementById('resultMaturityScore').textContent = `${avgMaturityScore}/5`;
            document.getElementById('resultRisksIdentified').textContent = totalRisksIdentified;
            document.getElementById('resultSubmissionDate').textContent = latestSubmission ?
                latestSubmission.toLocaleDateString() : 'Not submitted';

            // Populate questions and answers for the first completed response
            populateQuestionsAndAnswers(responses);

            // Populate domain scores and risks if available
            if (responses.length > 0 && responses[0].domainScores) {
                populateDomainScores(responses[0].domainScores);
            }

            if (responses.length > 0 && responses[0].risksIdentified) {
                populateIdentifiedRisks(responses[0].risksIdentified);
            }
        }

        // Function to populate questions and answers
        function populateQuestionsAndAnswers(responses) {
            const container = document.getElementById('questionsAnswersContainer');
            container.innerHTML = '';

            if (responses.length === 0 || !responses[0].answers) {
                container.innerHTML = '<p class="text-gray-500">No answers recorded yet.</p>';
                return;
            }

            const answers = responses[0].answers;
            answers.forEach((answer, index) => {
                const question = answer.question;
                const userAnswer = answer.answer;

                let answerDisplay = '';
                let answerClass = 'text-gray-600';

                if (userAnswer === null || userAnswer === '') {
                    answerDisplay = '<em>Not answered</em>';
                    answerClass = 'text-yellow-600';
                } else if (Array.isArray(userAnswer)) {
                    answerDisplay = userAnswer.join(', ');
                    answerClass = 'text-green-600';
                } else {
                    answerDisplay = userAnswer.toString();
                    answerClass = 'text-green-600';

                    // Special formatting for maturity scores
                    if (question.answerType === 'maturity') {
                        const score = parseInt(userAnswer);
                        const maturityLabels = {
                            0: 'Not in place',
                            1: 'Informal',
                            2: 'Partially in place',
                            3: 'Fully in place',
                            4: 'Measured and monitored',
                            5: 'Best practice'
                        };
                        answerDisplay = `${score}/5 - ${maturityLabels[score] || 'Unknown'}`;
                        answerClass = score < 3 ? 'text-red-600' : score < 4 ? 'text-yellow-600' : 'text-green-600';
                    }
                }

                const questionCard = document.createElement('div');
                questionCard.className = 'bg-white border border-gray-200 rounded-lg p-4';
                questionCard.innerHTML = `
                    <h6 class="font-medium mb-2">Question ${index + 1}</h6>
                    <p class="text-gray-700 mb-3">${question.questionText || question.text}</p>
                    <div class="mt-2">
                        <strong>Answer:</strong>
                        <span class="${answerClass}">${answerDisplay}</span>
                    </div>
                    ${question.domain ? `<small class="text-gray-500 block mt-2">Domain: ${question.domain}</small>` : ''}
                `;
                container.appendChild(questionCard);
            });
        }

        // Function to populate domain scores
        function populateDomainScores(domainScores) {
            if (!domainScores || Object.keys(domainScores).length === 0) return;

            const container = document.getElementById('domainScoresContainer');
            const scoresList = document.getElementById('domainScoresList');

            container.classList.remove('hidden');
            scoresList.innerHTML = '';

            Object.entries(domainScores).forEach(([domain, score]) => {
                const scoreCard = document.createElement('div');
                scoreCard.className = 'bg-white border border-gray-200 rounded-lg p-4 text-center';
                scoreCard.innerHTML = `
                    <h5 class="text-lg font-bold text-indigo-600">${score.toFixed(1)}/5</h5>
                    <p class="text-sm text-gray-600">${domain}</p>
                `;
                scoresList.appendChild(scoreCard);
            });
        }

        // Function to populate identified risks
        function populateIdentifiedRisks(risks) {
            if (!risks || risks.length === 0) return;

            const container = document.getElementById('identifiedRisksContainer');
            const risksList = document.getElementById('identifiedRisksList');

            container.classList.remove('hidden');
            risksList.innerHTML = '';

            risks.forEach(risk => {
                const riskCard = document.createElement('div');
                riskCard.className = 'bg-red-50 border border-red-200 rounded-lg p-4';
                riskCard.innerHTML = `
                    <h6 class="font-medium text-red-800 mb-2">${risk.question || 'Risk Identified'}</h6>
                    <p class="text-red-700 text-sm">${risk.description || 'Low maturity score indicates potential risk'}</p>
                    ${risk.domain ? `<small class="text-red-600 block mt-2">Domain: ${risk.domain}</small>` : ''}
                `;
                risksList.appendChild(riskCard);
            });
        }

        // Function to export assessment results
        function exportAssessmentResults() {
            if (!currentAssessmentForResults) {
                alert('No assessment selected for export.');
                return;
            }

            // Send export request to database
            window.parent.postMessage({
                action: 'exportAssessmentResults',
                payload: {
                    assessmentId: currentAssessmentForResults._id || currentAssessmentForResults.id,
                    assessmentTitle: currentAssessmentForResults.name || currentAssessmentForResults.title
                }
            }, '*');
        }

        // Function to view assessment results from timeline
        function viewTimelineAssessmentResults(assessmentId, assessmentTitle) {
            console.log('View timeline assessment results called for:', assessmentId, assessmentTitle);

            // Create a temporary assessment object for the results modal
            currentAssessmentForResults = {
                _id: assessmentId,
                id: assessmentId,
                name: assessmentTitle,
                title: assessmentTitle
            };

            // Show the results modal
            document.getElementById('assessmentResultsModal').style.display = 'block';

            // Set assessment title
            document.getElementById('assessmentResultsTitle').textContent = `Results: ${assessmentTitle}`;

            // Show loading state
            document.getElementById('resultsLoadingState').classList.remove('hidden');
            document.getElementById('noResultsState').classList.add('hidden');
            document.getElementById('resultsContent').classList.add('hidden');

            // Request assessment results from database
            console.log('Requesting assessment results for timeline entry:', assessmentId);

            // Send request to database via parent window (Wix)
            window.parent.postMessage({
                action: 'getAssessmentResults',
                payload: {
                    assessmentId: assessmentId,
                    assessmentTitle: assessmentTitle
                }
            }, '*');
        }

        // Function to download assessment report from timeline
        function downloadTimelineAssessmentReport(assessmentId, assessmentTitle) {
            console.log('Download timeline assessment report called for:', assessmentId, assessmentTitle);

            // Send export request to database
            window.parent.postMessage({
                action: 'exportAssessmentResults',
                payload: {
                    assessmentId: assessmentId,
                    assessmentTitle: assessmentTitle
                }
            }, '*');

            // Show notification
            showNotification('Generating report for download...', 'info');
        }
    </script>
</body>

</html>